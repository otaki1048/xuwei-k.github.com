<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>mapper/net/liftweb/mapper/ManyToMany.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2006-2011 WorldWide Conferencing, LLC
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> net.liftweb
<span class="keyword">package</span> mapper

<span class="keyword">import</span> net.liftweb.util._
<span class="keyword">import</span> net.liftweb.common._

<span class="comment">/**
 * Add this trait to a Mapper to add support for many-to-many relationships
 * @author nafg
 */</span>
<span class="keyword">trait</span> <a title="trait ManyToMany extends java.lang.Object with net.liftweb.mapper.BaseKeyedMapper with ScalaObject" id="11294">ManyToMany</a> <span title="ScalaObject" class="keyword">extends</span> <a href="Mapper.scala.html#11637" title="net.liftweb.mapper.BaseKeyedMapper">BaseKeyedMapper</a> <span class="delimiter">{</span>
  <span class="keyword">this</span>: KeyedMapper<span class="delimiter">[</span>_, _<span class="delimiter">]</span> =&gt;

  <span class="keyword">type</span> <a title="ManyToMany.this.TheKeyType" id="156343">K</a> = <span title="ManyToMany.this.TheKeyType">TheKeyType</span>
  <span class="keyword">type</span> <a title="ManyToMany.this.KeyedMapperType" id="156344">T</a> = <span title="ManyToMany.this.KeyedMapperType">KeyedMapperType</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="List[ManyToMany.this.MappedManyToMany[_, _, _]]" id="156346">manyToManyFields</a>: <span title="List[ManyToMany.this.MappedManyToMany[_, _, _]]">List</span><span class="delimiter">[</span>MappedManyToMany<span class="delimiter">[</span>_,_,_<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="object Nil">Nil</span>

  <span class="comment">/**
   * An override for save to propagate the save to all children
   * of this parent.
   * Returns false as soon as the parent or a one-to-many field returns false.
   * If they are all successful returns true.
   */</span>
  <span class="keyword">abstract</span> <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="156348">save</a> = <span class="delimiter">{</span>
    <a href="#11294" title="&lt;none&gt; extends net.liftweb.mapper.ManyToMany with net.liftweb.mapper.KeyedMapper[_, _]" class="keyword">super</a>.<a href="Mapper.scala.html#147053" title="=&gt; Boolean">save</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#156346" title="=&gt; List[ManyToMany.this.MappedManyToMany[_, _, _]]">manyToManyFields</a>.<span title="(p: ManyToMany.this.MappedManyToMany[_, _, _] =&gt; Boolean)Boolean">forall</span><span class="delimiter">(</span><a href="#156480" title="ManyToMany.this.MappedManyToMany[_, _, _]">_</a>.<a href="#156438" title="=&gt; Boolean">save</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * An override for delete_! to propogate the deletion to all children
   * of this parent.
   * Returns false as soon as the parent or a one-to-many field returns false.
   * If they are all successful returns true.
   */</span>
  <span class="keyword">abstract</span> <span class="keyword">override</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="156349">delete_!</a> = <span class="delimiter">{</span>
    <a href="#11294" title="&lt;none&gt; extends net.liftweb.mapper.ManyToMany with net.liftweb.mapper.KeyedMapper[_, _]" class="keyword">super</a>.<a href="Mapper.scala.html#147202" title="=&gt; Boolean">delete_!</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
      <a href="#156346" title="=&gt; List[ManyToMany.this.MappedManyToMany[_, _, _]]">manyToManyFields</a>.<span title="(p: ManyToMany.this.MappedManyToMany[_, _, _] =&gt; Boolean)Boolean">forall</span><span class="delimiter">(</span> <a href="#156603" title="ManyToMany.this.MappedManyToMany[_, _, _]">_</a>.<a href="#156439" title="=&gt; Boolean">delete_!</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>


  <span class="comment">/**
   * This is the base class to extend for fields that track many-to-many relationships.
   * @param joinMeta The singleton of the join table
   * @param thisField The foreign key in the join table that refers to this mapper's primaryKey.
   * @param otherField The foreign key in the join table that refers to the other mapper's primaryKey
   * @param otherMeta The singleton of the other mapper
   * @param qp Any QueryParams to limit entries in the join table (other than matching thisField to primaryKey)
   * To limit children based on fields in the other table (not the join table), it is currently necessary
   * to point the join mapper to a view which pulls the join table's fields as well as fields of the other table.
   */</span>
  <span class="keyword">class</span> <a title="class MappedManyToMany[O &lt;: net.liftweb.mapper.Mapper[O], K2, T2 &lt;: net.liftweb.mapper.KeyedMapper[K2,T2]] extends java.lang.Object with scala.collection.mutable.Buffer[T2] with ScalaObject" id="156350">MappedManyToMany</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: net.liftweb.mapper.Mapper[O]" id="156351">O</a>&lt;:Mapper<span class="delimiter">[</span>O<span class="delimiter">]</span>, <a title="&gt;: Nothing &lt;: Any" id="156352">K2</a>, <a title="&gt;: Nothing &lt;: net.liftweb.mapper.KeyedMapper[K2,T2]" id="156353">T2</a> &lt;: KeyedMapper<span class="delimiter">[</span>K2,T2<span class="delimiter">]</span><span class="delimiter">]</span><a href="#156350" title="ScalaObject" class="delimiter">(</a>
    <span class="keyword">val</span> <a title="net.liftweb.mapper.MetaMapper[O]" id="156649">joinMeta</a>: <a href="MetaMapper.scala.html#11668" title="net.liftweb.mapper.MetaMapper[O]">MetaMapper</a><span class="delimiter">[</span>O<span class="delimiter">]</span>,
    <a title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &lt;: net.liftweb.mapper.KeyedMapper[_, _]]" id="156650">thisField</a>: <a href="MappedForeignKey.scala.html#11449" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &lt;: net.liftweb.mapper.KeyedMapper[_, _]]">MappedForeignKey</a><span class="delimiter">[</span>K,O,_ &lt;: KeyedMapper<span class="delimiter">[</span>_,_<span class="delimiter">]</span><span class="delimiter">]</span>,
    <span class="keyword">val</span> <a title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]" id="156651">otherField</a>: <a href="MappedForeignKey.scala.html#11449" title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]">MappedForeignKey</a><span class="delimiter">[</span>K2, O, T2<span class="delimiter">]</span>,
    <span class="keyword">val</span> <a title="net.liftweb.mapper.MetaMapper[T2]" id="156652">otherMeta</a>: <a href="MetaMapper.scala.html#11668" title="net.liftweb.mapper.MetaMapper[T2]">MetaMapper</a><span class="delimiter">[</span>T2<span class="delimiter">]</span>,
    <span class="keyword">val</span> <a title="net.liftweb.mapper.QueryParam[O]*" id="156653">qp</a>: <span title="net.liftweb.mapper.QueryParam[O]*">QueryParam</span><span class="delimiter">[</span>O<span class="delimiter">]</span>*<span class="delimiter">)</span> <span class="keyword">extends</span> scala.collection.mutable.<span title="scala.collection.mutable.Buffer[T2]">Buffer</span><span class="delimiter">[</span>T2<span class="delimiter">]</span> <span class="delimiter">{</span>

    <span class="keyword">def</span> <a title="[A](join: O)(f: net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T] =&gt; A)A" id="156407">thisFK</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="156409">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="O" id="156532">join</a>: <a href="#156351" title="O">O</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T] =&gt; A" id="156533">f</a>: MappedForeignKey<span class="delimiter">[</span>K,O,_&gt;:T<span class="delimiter">]</span> =&gt; A<span class="delimiter">)</span>: <a href="#156409" title="A">A</a> =
      <a href="#156650" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &lt;: net.liftweb.mapper.KeyedMapper[_, _]]">thisField</a>.<a href="MappedField.scala.html#147394" title="(actual: O)net.liftweb.mapper.MappedField[Any,O]">actualField</a><span class="delimiter">(</span><a href="#156532" title="O">join</a><span class="delimiter">)</span> <span title="A" class="keyword">match</span> <span class="delimiter">{</span> <span class="keyword">case</span> <a title="A" id="156667">mfk</a>: <a href="MappedForeignKey.scala.html#11449" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K,O,ManyToMany.this.T]">MappedForeignKey</a><span class="delimiter">[</span>K,O,T<span class="delimiter">]</span> =&gt; <a href="#156533" title="(v1: net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T])A">f</a><span class="delimiter">(</span><a href="#156667" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K,O,ManyToMany.this.T]">mfk</a><span class="delimiter">)</span> <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="[A](join: O)(f: net.liftweb.mapper.MappedForeignKey[K2,O,T2] =&gt; A)A" id="156410">otherFK</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="156412">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="O" id="156498">join</a>: <a href="#156351" title="O">O</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="net.liftweb.mapper.MappedForeignKey[K2,O,T2] =&gt; A" id="156499">f</a>: MappedForeignKey<span class="delimiter">[</span>K2,O,T2<span class="delimiter">]</span> =&gt; A<span class="delimiter">)</span>: <a href="#156412" title="A">A</a> =
      <a href="#156651" title="=&gt; net.liftweb.mapper.MappedForeignKey[K2,O,T2]">otherField</a>.<a href="MappedField.scala.html#147394" title="(actual: O)net.liftweb.mapper.MappedField[K2,O]">actualField</a><span class="delimiter">(</span><a href="#156498" title="O">join</a><span class="delimiter">)</span> <span title="A" class="keyword">match</span> <span class="delimiter">{</span> <span class="keyword">case</span> <a title="A" id="156671">mfk</a>: <a href="MappedForeignKey.scala.html#11449" title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]">MappedForeignKey</a><span class="delimiter">[</span>K2,O,T2<span class="delimiter">]</span> =&gt; <a href="#156499" title="(v1: net.liftweb.mapper.MappedForeignKey[K2,O,T2])A">f</a><span class="delimiter">(</span><a href="#156671" title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]">mfk</a><span class="delimiter">)</span> <span class="delimiter">}</span>

    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; List[T2]" id="156413">children</a>: <span title="List[T2]">List</span><span class="delimiter">[</span>T2<span class="delimiter">]</span> = <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(f: O =&gt; scala.collection.GenTraversableOnce[T2])(implicit bf: scala.collection.generic.CanBuildFrom[List[O],T2,List[T2]])List[T2]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,T2,List[T2]]" class="delimiter">(</span><a href="#156410" title="(join: O)(f: net.liftweb.mapper.MappedForeignKey[K2,O,T2] =&gt; net.liftweb.common.Box[T2])net.liftweb.common.Box[T2]">otherFK</a><span class="delimiter">(</span><a href="#156703" title="O">_</a><span class="delimiter">)</span><a href="../../../../common/net/liftweb/common/Box.scala.html#28624" title="(in: net.liftweb.common.Box[T2])Iterable[T2]" class="delimiter">(</a><a href="#156709" title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]">_</a>.<a href="MappedForeignKey.scala.html#155168" title="=&gt; net.liftweb.common.Box[T2]">obj</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">protected</span> <span class="keyword">var</span> <a title="List[O]" id="156415">_joins</a>: <span title="List[O]">List</span><span class="delimiter">[</span>O<span class="delimiter">]</span> = _

    <span class="comment">/**
     * Get the list of instances of joinMeta
     */</span>
    <span class="keyword">def</span> <a title="=&gt; List[O]" id="156417">joins</a> = <a href="#156415" title="=&gt; List[O]">_joins</a> <span class="comment">// read only to the public</span>
    <span class="keyword">protected</span> <span class="keyword">var</span> <a title="List[O]" id="156419">removedJoins</a>: <span title="List[O]">List</span><span class="delimiter">[</span>O<span class="delimiter">]</span> = <span title="object Nil">Nil</span>


    <a href="#156437" title="=&gt; List[T2]">refresh</a>
    <a href="#156346" title="(x$1: List[ManyToMany.this.MappedManyToMany[_, _, _]])Unit">manyToManyFields</a> <span title="(x: ManyToMany.this.MappedManyToMany[_, _, _])List[ManyToMany.this.MappedManyToMany[_, _, _]]">::=</span> <a href="#156350" title="ManyToMany.this.MappedManyToMany[O,K2,T2]" class="keyword">this</a>

    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(e: T2)(join: O)Boolean" id="156421">isJoinForChild</a><span class="delimiter">(</span><a title="T2" id="157060">e</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="O" id="157061">join</a>: <a href="#156351" title="O">O</a><span class="delimiter">)</span> = <a href="#156651" title="=&gt; net.liftweb.mapper.MappedForeignKey[K2,O,T2]">otherField</a>.<a href="MappedField.scala.html#147394" title="(actual: O)net.liftweb.mapper.MappedField[K2,O]">actualField</a><span class="delimiter">(</span><a href="#157061" title="O">join</a><span class="delimiter">)</span>.<a href="MappedField.scala.html#147450" title="=&gt; K2">is</a> <span title="(x$1: Any)Boolean">==</span> <a href="#157060" title="T2">e</a>.<a href="Mapper.scala.html#147132" title="=&gt; net.liftweb.mapper.MappedField[K2,T2] with net.liftweb.mapper.IndexedField[K2]">primaryKeyField</a>.<a href="MappedField.scala.html#147450" title="=&gt; K2">is</a>
    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(e: T2)Option[O]" id="156422">joinForChild</a><span class="delimiter">(</span><a title="T2" id="157067">e</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span>: <span title="Option[O]">Option</span><span class="delimiter">[</span>O<span class="delimiter">]</span> =
      <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(p: O =&gt; Boolean)Option[O]">find</span><span class="delimiter">(</span><a href="#156421" title="(e: T2)(join: O)Boolean">isJoinForChild</a><a href="#157077" title="O" class="delimiter">(</a><a href="#157067" title="T2">e</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(e: T2)O" id="156423">own</a><span class="delimiter">(</span><a title="T2" id="157078">e</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span>: <a href="#156351" title="O">O</a> = <span class="delimiter">{</span>
      <a href="#156422" title="(e: T2)Option[O]">joinForChild</a><span class="delimiter">(</span><a href="#157078" title="T2">e</a><span class="delimiter">)</span> <span title="O" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="O">None</span> =&gt;
          <a href="#156419" title="=&gt; List[O]">removedJoins</a>.<span title="(p: O =&gt; Boolean)Option[O]">find</span> <span class="delimiter">{</span> <span class="comment">// first check if we can recycle a removed join</span>
            <a href="#156651" title="=&gt; net.liftweb.mapper.MappedForeignKey[K2,O,T2]">otherField</a>.<a href="MappedField.scala.html#147394" title="(actual: O)net.liftweb.mapper.MappedField[K2,O]">actualField</a><span class="delimiter">(</span><a href="#157088" title="O">_</a><span class="delimiter">)</span>.<a href="MappedField.scala.html#147450" title="=&gt; K2">is</a> <span title="(x$1: Any)Boolean">==</span> <a href="#157078" title="T2">e</a>.<a href="Mapper.scala.html#147132" title="=&gt; net.liftweb.mapper.MappedField[K2,T2] with net.liftweb.mapper.IndexedField[K2]">primaryKeyField</a>
          <span class="delimiter">}</span> <span title="O" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="O">Some</span><span class="delimiter">(</span><a title="O" id="157093">removedJoin</a><span class="delimiter">)</span> =&gt;
              <a href="#156419" title="(x$1: List[O])Unit">removedJoins</a> = <a href="#156419" title="=&gt; List[O]">removedJoins</a> <span title="(p: O =&gt; Boolean)List[O]">filter</span> <a href="#157093" title="O">removedJoin</a>.<a href="#157099" title="(x$1: AnyRef)Boolean">ne</a>
              <a href="#157093" title="O">removedJoin</a> <span class="comment">// well, noLongerRemovedJoin...</span>
            <span class="keyword">case</span> <span title="O">None</span> =&gt;
              <span class="keyword">val</span> <a title="O" id="157100">newJoin</a> = <a href="#156649" title="=&gt; net.liftweb.mapper.MetaMapper[O]">joinMeta</a>.<a href="MetaMapper.scala.html#146838" title="=&gt; O">create</a>
              <a href="#156407" title="(join: O)(f: net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T] =&gt; O)O">thisFK</a><span class="delimiter">(</span><a href="#157100" title="O">newJoin</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#157108" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T]">_</a>.<a href="MappedForeignKey.scala.html#155178" title="(v: ManyToMany.this.T)O">apply</a><span class="delimiter">(</span><a href="#11294" title="&lt;none&gt; extends net.liftweb.mapper.ManyToMany with net.liftweb.mapper.KeyedMapper[_, _]">ManyToMany</a>.<span class="keyword">this</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#156410" title="(join: O)(f: net.liftweb.mapper.MappedForeignKey[K2,O,T2] =&gt; O)O">otherFK</a><span class="delimiter">(</span><a href="#157100" title="O">newJoin</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#157158" title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]">_</a>.<a href="MappedForeignKey.scala.html#155178" title="(v: T2)O">apply</a><span class="delimiter">(</span><a href="#157078" title="T2">e</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#157100" title="O">newJoin</a>
          <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="O">Some</span><span class="delimiter">(</span><a title="O" id="157190">join</a><span class="delimiter">)</span> =&gt;
          <a href="#157190" title="O">join</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(e: T2)Option[O]" id="156424">unown</a><span class="delimiter">(</span><a title="T2" id="157191">e</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#156422" title="(e: T2)Option[O]">joinForChild</a><span class="delimiter">(</span><a href="#157191" title="T2">e</a><span class="delimiter">)</span> <span title="Option[O]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Some[O]">Some</span><span class="delimiter">(</span><a title="O" id="157195">join</a><span class="delimiter">)</span> =&gt;
          <a href="#156419" title="(x$1: List[O])Unit">removedJoins</a> = <a href="#157195" title="O">join</a> <a href="#157197" title="(x: O)List[O]">::</a> <a href="#156419" title="=&gt; List[O]">removedJoins</a>
          <span class="keyword">val</span> <a title="net.liftweb.mapper.MappedField[K2,O]" id="157196">o</a> = <a href="#156651" title="=&gt; net.liftweb.mapper.MappedForeignKey[K2,O,T2]">otherField</a>.<a href="MappedField.scala.html#147394" title="(actual: O)net.liftweb.mapper.MappedField[K2,O]">actualField</a><span class="delimiter">(</span><a href="#157195" title="O">join</a><span class="delimiter">)</span>
          <a href="#157196" title="net.liftweb.mapper.MappedField[K2,O]">o</a>.<a href="MappedField.scala.html#147418" title="(value: K2)K2">set</a><span class="delimiter">(</span><a href="#157196" title="net.liftweb.mapper.MappedField[K2,O]">o</a>.<a href="MappedField.scala.html#147388" title="=&gt; K2">defaultValue</a><span class="delimiter">)</span>
          <a href="#156407" title="(join: O)(f: net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T] =&gt; Any)Any">thisFK</a><span class="delimiter">(</span><a href="#157195" title="O">join</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T]" id="157210">f</a> =&gt; <a href="#157210" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T]">f</a>.<a href="MappedField.scala.html#147418" title="(value: Any)Any">set</a><span class="delimiter">(</span><a href="#157210" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T]">f</a>.<a href="MappedField.scala.html#147388" title="=&gt; Any">defaultValue</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="(x: O)Some[O]">Some</span><span class="delimiter">(</span><a href="#157195" title="O">join</a><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="None.type">None</span> =&gt;
          <span title="object None">None</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Get the List backing this Buffer.
     */</span>
    <span class="keyword">def</span> <a title="=&gt; List[T2]" id="156425">all</a> = <a href="#156413" title="=&gt; List[T2]">children</a>

    <span class="keyword">def</span> <a title="=&gt; Int" id="156426">length</a> = <a href="#156413" title="=&gt; List[T2]">children</a>.<span title="=&gt; Int">length</span>

    <span class="keyword">def</span> <a title="=&gt; Iterator[T2]" id="156427">iterator</a> = <a href="#156413" title="=&gt; List[T2]">children</a>.<span title="=&gt; Iterator[T2]">iterator</span>

    <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(n: Int)T2" id="156428">childAt</a><span class="delimiter">(</span><a title="Int" id="157244">n</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <a href="#156413" title="(n: Int)T2">children</a><span class="delimiter">(</span><a href="#157244" title="Int">n</a><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(n: Int)T2" id="156429">apply</a><span class="delimiter">(</span><a title="Int" id="157255">n</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <a href="#156428" title="(n: Int)T2">childAt</a><span class="delimiter">(</span><a href="#157255" title="Int">n</a><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(e: T2)Int" id="156430">indexOf</a><span class="delimiter">(</span><a title="T2" id="157260">e</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span> =
      <a href="#156413" title="=&gt; List[T2]">children</a>.<span title="(p: T2 =&gt; Boolean)Int">indexWhere</span><span class="delimiter">(</span><a href="#157260" title="T2">e</a> <a href="#157284" title="(x$1: AnyRef)Boolean">eq</a><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="(n: Int, traversable: Traversable[T2])Unit" id="156431">insertAll</a><span class="delimiter">(</span><a title="Int" id="157285">n</a>: <span title="Int">Int</span>, <a title="Traversable[T2]" id="157286">traversable</a>: <span title="Traversable[T2]">Traversable</span><span class="delimiter">[</span>T2<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Traversable[O]" id="157290">ownedJoins</a> = <a href="#157286" title="Traversable[T2]">traversable</a> <span title="(f: T2 =&gt; O)(implicit bf: scala.collection.generic.CanBuildFrom[Traversable[T2],O,Traversable[O]])Traversable[O]">map</span> <a href="#156423" title="(e: T2)O">own</a>
      <span class="keyword">val</span> <a title="Int" id="157291">n2</a> = <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(p: O =&gt; Boolean)Int">indexWhere</span><span class="delimiter">(</span><a href="#156421" title="(e: T2)(join: O)Boolean">isJoinForChild</a><a href="#157350" title="O" class="delimiter">(</a><a href="#156413" title="(n: Int)T2">children</a><a href="#157348" title="T2" class="delimiter">(</a><a href="#157285" title="Int">n</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="List[O]" id="157292">before</a> = <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(n: Int)List[O]">take</span><span class="delimiter">(</span><a href="#157291" title="Int">n2</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="List[O]" id="157293">after</a> = <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(n: Int)List[O]">drop</span><span class="delimiter">(</span><a href="#157291" title="Int">n2</a><span class="delimiter">)</span>

      <a href="#156415" title="(x$1: List[O])Unit">_joins</a> = <a href="#157292" title="List[O]">before</a> <span title="(that: scala.collection.GenTraversableOnce[O])(implicit bf: scala.collection.generic.CanBuildFrom[List[O],O,List[O]])List[O]">++</span> <a href="#157290" title="Traversable[O]">ownedJoins</a> <span title="(that: scala.collection.GenTraversableOnce[O])(implicit bf: scala.collection.generic.CanBuildFrom[List[O],O,List[O]])List[O]">++</span> <a href="#157293" title="List[O]">after</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(elem: T2)MappedManyToMany.this.type" id="156432">+=:</a><span class="delimiter">(</span><a title="T2" id="157478">elem</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#156415" title="(x$1: List[O])Unit">_joins</a> <span title="(x: O)List[O]">::=</span> <a href="#156423" title="(e: T2)O">own</a><span class="delimiter">(</span><a href="#157478" title="T2">elem</a><span class="delimiter">)</span>
      <a href="#156350" title="MappedManyToMany.this.type" class="keyword">this</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(elem: T2)MappedManyToMany.this.type" id="156433">+=</a><span class="delimiter">(</span><a title="T2" id="157488">elem</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#156415" title="(x$1: List[O])Unit">_joins</a> <span title="(that: scala.collection.GenTraversableOnce[O])(implicit bf: scala.collection.generic.CanBuildFrom[List[O],O,List[O]])List[O]">++=</span> <span title="(xs: O*)List[O]">List</span><span class="delimiter">(</span><a href="#156423" title="(e: T2)O">own</a><span class="delimiter">(</span><a href="#157488" title="T2">elem</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#156350" title="MappedManyToMany.this.type" class="keyword">this</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(n: Int, newelem: T2)Unit" id="156434">update</a><span class="delimiter">(</span><a title="Int" id="157581">n</a>: <span title="Int">Int</span>, <a title="T2" id="157582">newelem</a>: <a href="#156353" title="T2">T2</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#156424" title="(e: T2)Option[O]">unown</a><span class="delimiter">(</span><a href="#156428" title="(n: Int)T2">childAt</a><span class="delimiter">(</span><a href="#157581" title="Int">n</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="O" id="157593">join</a><span class="delimiter">)</span> =&gt;
          <span class="keyword">val</span> <a title="Int" id="157594">n2</a> = <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(elem: O)Int">indexOf</span><span class="delimiter">(</span><a href="#157593" title="O">join</a><span class="delimiter">)</span>
          <span class="keyword">val</span> <a href="#157596" title="(List[O], List[O])" class="delimiter">(</a><a href="#157595" title="List[O]" id="157596">before</a>, <a href="#157595" title="List[O]" id="157597">after</a><span class="delimiter">)</span> = <span title="(_1: List[O], _2: List[O])(List[O], List[O])" class="delimiter">(</span><a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(n: Int)List[O]">take</span><span class="delimiter">(</span><a href="#157594" title="Int">n2</a><span class="delimiter">)</span>, <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(n: Int)List[O]">drop</span><span class="delimiter">(</span><a href="#157594" title="Int">n2</a><span title="(x: Int)Int">+</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#156415" title="(x$1: List[O])Unit">_joins</a> = <a href="#157596" title="List[O]">before</a> <span title="(that: scala.collection.GenTraversableOnce[O])(implicit bf: scala.collection.generic.CanBuildFrom[List[O],O,List[O]])List[O]">++</span> <span title="(xs: O*)List[O]">List</span><span class="delimiter">(</span><a href="#156423" title="(e: T2)O">own</a><span class="delimiter">(</span><a href="#157582" title="T2">newelem</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[O])(implicit bf: scala.collection.generic.CanBuildFrom[List[O],O,List[O]])List[O]">++</span> <a href="#157597" title="List[O]">after</a>
        <span class="keyword">case</span> <span title="Unit">None</span> =&gt;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(n: Int)T2" id="156435">remove</a><span class="delimiter">(</span><a title="Int" id="157754">n</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="T2" id="157759">child</a> = <a href="#156428" title="(n: Int)T2">childAt</a><span class="delimiter">(</span><a href="#157754" title="Int">n</a><span class="delimiter">)</span>
      <a href="#156424" title="(e: T2)Option[O]">unown</a><span class="delimiter">(</span><a href="#157759" title="T2">child</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="O" id="157761">join</a><span class="delimiter">)</span> =&gt;
          <a href="#156415" title="(x$1: List[O])Unit">_joins</a> = <a href="#156417" title="=&gt; List[O]">joins</a> <span title="(p: O =&gt; Boolean)List[O]">filterNot</span> <a href="#157761" title="O">join</a>.<a href="#157767" title="(x$1: AnyRef)Boolean">eq</a>
        <span class="keyword">case</span> <span title="Unit">None</span> =&gt;
      <span class="delimiter">}</span>
      <a href="#157759" title="T2">child</a>
    <span class="delimiter">}</span>


    <span class="keyword">def</span> <a title="()Unit" id="156436">clear</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#156413" title="=&gt; List[T2]">children</a> <span title="(f: T2 =&gt; Option[O])Unit">foreach</span> <a href="#156424" title="(e: T2)Option[O]">unown</a>
      <a href="#156415" title="(x$1: List[O])Unit">_joins</a> = <span title="object Nil">Nil</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Discard the cached state of this MappedManyToMany's children and reinitialize it from the database
     */</span>
    <span class="keyword">def</span> <a title="=&gt; List[T2]" id="156437">refresh</a> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="net.liftweb.mapper.Cmp[O,ManyToMany.this.TheKeyType]" id="156783">by</a> = <span title="net.liftweb.mapper.Cmp[O,ManyToMany.this.TheKeyType]" class="keyword">new</span> <a href="MetaMapper.scala.html#11699" title="net.liftweb.mapper.Cmp[O,ManyToMany.this.TheKeyType]">Cmp</a><span class="delimiter">[</span>O, TheKeyType<span class="delimiter">]</span><span class="delimiter">(</span><a href="#156650" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &lt;: net.liftweb.mapper.KeyedMapper[_, _]]">thisField</a>, <a href="MetaMapper.scala.html#11670" title="object net.liftweb.mapper.OprEnum">OprEnum</a>.<a href="MetaMapper.scala.html#155082" title="=&gt; net.liftweb.mapper.OprEnum.Value">Eql</a>, <a href="../../../../common/net/liftweb/common/Box.scala.html#27086" title="(value: _$1)net.liftweb.common.Full[_$1]">Full</a><span class="delimiter">(</span><a href="Mapper.scala.html#147132" title="(=&gt; net.liftweb.mapper.MappedField[_$1,_$2] with net.liftweb.mapper.IndexedField[_$1]) forSome { type _$1; type _$2; type _$1; type _$2; type _$1; type _$2 }">primaryKeyField</a>.<a href="MappedField.scala.html#147450" title="=&gt; _$1">is</a><span class="delimiter">)</span>, <a href="../../../../common/net/liftweb/common/Box.scala.html#10581" title="object net.liftweb.common.Empty">Empty</a>, <a href="../../../../common/net/liftweb/common/Box.scala.html#10581" title="object net.liftweb.common.Empty">Empty</a><span class="delimiter">)</span>

      <a href="#156415" title="(x$1: List[O])Unit">_joins</a> = <a href="#156649" title="=&gt; net.liftweb.mapper.MetaMapper[O]">joinMeta</a>.<a href="MetaMapper.scala.html#146823" title="(by: net.liftweb.mapper.QueryParam[O]*)List[O]">findAll</a><span class="delimiter">(</span> <span class="delimiter">(</span><a href="#156783" title="net.liftweb.mapper.Cmp[O,ManyToMany.this.TheKeyType]">by</a> <a href="#156808" title="(x: net.liftweb.mapper.QueryParam[O])List[net.liftweb.mapper.QueryParam[O]]">::</a> <a href="#156653" title="=&gt; net.liftweb.mapper.QueryParam[O]*">qp</a>.<span title="=&gt; List[net.liftweb.mapper.QueryParam[O]]">toList</span><span class="delimiter">)</span>: _*<span class="delimiter">)</span>
      <a href="#156425" title="=&gt; List[T2]">all</a>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Save the state of this MappedManyToMany to the database.
     * This will do the following:
     * 1) Prune join table instances whose &quot;child&quot; foreign key's value is its defaultValue, i.e., -1
     * 2) Set all join table instances' &quot;parent&quot; foreign key
     * 3) Delete all join table instances whose child instance was removed
     * 4) Save all child instances
     * 5) If step 3 succeeds save all join instances
     * 6) Return true if steps 2-4 all returned true; otherwise false
     */</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="156438">save</a> = <span class="delimiter">{</span>
      <a href="#156415" title="(x$1: List[O])Unit">_joins</a> = <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(p: O =&gt; Boolean)List[O]">filter</span> <span class="delimiter">{</span> <a title="O" id="156497">join</a> =&gt;
        <a href="#156410" title="(join: O)(f: net.liftweb.mapper.MappedForeignKey[K2,O,T2] =&gt; Boolean)Boolean">otherFK</a><span class="delimiter">(</span><a href="#156497" title="O">join</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]" id="156507">f</a> =&gt; <a href="#156507" title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]">f</a>.<a href="MappedField.scala.html#147450" title="=&gt; K2">is</a> <span title="(x$1: Any)Boolean">!=</span> <a href="#156507" title="net.liftweb.mapper.MappedForeignKey[K2,O,T2]">f</a>.<a href="MappedField.scala.html#147388" title="=&gt; K2">defaultValue</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#156415" title="=&gt; List[O]">_joins</a> <span title="(f: O =&gt; Any)Unit">foreach</span> <span class="delimiter">{</span> <a href="#156407" title="(join: O)(f: net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T] =&gt; Any)Any">thisFK</a><span class="delimiter">(</span><a href="#156531" title="O">_</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#156543" title="net.liftweb.mapper.MappedForeignKey[ManyToMany.this.K, O, _ &gt;: ManyToMany.this.T]">_</a> <a href="MappedField.scala.html#147418" title="(value: Any)Any">set</a> <a href="#11294" title="ManyToMany.this.type">ManyToMany</a>.<span class="keyword">this</span>.<a href="Mapper.scala.html#147132" title="(=&gt; net.liftweb.mapper.MappedField[_$1,_$2] with net.liftweb.mapper.IndexedField[_$1]) forSome { type _$1; type _$2; type _$1; type _$2; type _$1; type _$2 }">primaryKeyField</a>.<a href="MappedField.scala.html#147450" title="=&gt; _$1">is</a><span class="delimiter">)</span> <span class="delimiter">}</span>

      <a href="#156419" title="=&gt; List[O]">removedJoins</a>.<span title="(p: O =&gt; Boolean)Boolean">forall</span> <span class="delimiter">{</span><a href="#156566" title="O">_</a>.<a href="Mapper.scala.html#147091" title="=&gt; Boolean">delete_!</a><span class="delimiter">}</span> <span title="(x: Boolean)Boolean">&amp;</span> <span class="delimiter">(</span> <span class="comment">// continue saving even if deleting fails</span>
        <a href="#156413" title="=&gt; List[T2]">children</a>.<span title="(p: T2 =&gt; Boolean)Boolean">forall</span><span class="delimiter">(</span><a href="#156581" title="T2">_</a>.<a href="Mapper.scala.html#147084" title="()Boolean">save</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
          <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(p: O =&gt; Boolean)Boolean">forall</span><span class="delimiter">(</span><a href="#156590" title="O">_</a>.<a href="Mapper.scala.html#147084" title="()Boolean">save</a><span class="delimiter">)</span>
      <span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Deletes all join rows, including those
     * marked for removal.
     * Returns true if both succeed, otherwise false
     */</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="156439">delete_!</a> = <span class="delimiter">{</span>
      <a href="#156419" title="=&gt; List[O]">removedJoins</a>.<span title="(p: O =&gt; Boolean)Boolean">forall</span><span class="delimiter">(</span><a href="#156615" title="O">_</a>.<a href="Mapper.scala.html#147091" title="=&gt; Boolean">delete_!</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;</span>
        <a href="#156417" title="=&gt; List[O]">joins</a>.<span title="(p: O =&gt; Boolean)Boolean">forall</span><span class="delimiter">(</span><a href="#156624" title="O">_</a>.<a href="Mapper.scala.html#147091" title="=&gt; Boolean">delete_!</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>


        </pre>
    </body>
</html>