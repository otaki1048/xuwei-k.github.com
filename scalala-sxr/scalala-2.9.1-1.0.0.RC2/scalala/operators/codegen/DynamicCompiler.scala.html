<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>scalala/operators/codegen/DynamicCompiler.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2010 Twitter, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> scalala
<span class="keyword">package</span> operators.codegen

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> java.util.jar.JarFile
<span class="keyword">import</span> scala.collection.mutable
<span class="keyword">import</span> scala.io.Source
<span class="keyword">import</span> scala.tools.nsc.<span class="delimiter">{</span>Global, Settings<span class="delimiter">}</span>
<span class="keyword">import</span> scala.tools.nsc.interpreter.AbstractFileClassLoader
<span class="keyword">import</span> scala.tools.nsc.io.<span class="delimiter">{</span>AbstractFile, VirtualDirectory<span class="delimiter">}</span>
<span class="keyword">import</span> scala.tools.nsc.reporters.AbstractReporter
<span class="keyword">import</span> scala.tools.nsc.util.<span class="delimiter">{</span>BatchSourceFile, Position<span class="delimiter">}</span>

<span class="keyword">import</span> java.net.URLClassLoader

<span class="comment">/**
 * Class for dynamically defining classes and loading them at runtime.
 * Based on on Twitter's Eval helper class with modifications by dramage.
 *
 * This class is pretty slow to initialize, actually.
 *
 * https://github.com/twitter/util/blob/master/util-eval/src/main/scala/com/twitter/util/Eval.scala
 */</span>
<span class="keyword">object</span> <a title="object scalala.operators.codegen.DynamicCompiler" id="17232">DynamicCompiler</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scalala.operators.codegen.DynamicCompiler.StringCompiler" id="425411">compiler</a> = <span title="scalala.operators.codegen.DynamicCompiler.StringCompiler" class="keyword">new</span> <a href="#425421" title="scalala.operators.codegen.DynamicCompiler.StringCompiler">StringCompiler</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="object None">None</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(className: String, code: String)Class[_]" id="425413">define</a><span class="delimiter">(</span><a title="String" id="425423">className</a> : <span title="String">String</span>, <a title="String" id="425424">code</a> : <span title="String">String</span><span class="delimiter">)</span> : <span title="Class[_]">Class</span><span class="delimiter">[</span>_<span class="delimiter">]</span> =
    <a href="#440303" title="(code: String, className: String, resetState: Boolean)Class[_]">compiler</a><span class="delimiter">(</span><a href="#425424" title="String">code</a>, <a href="#425423" title="String">className</a><span class="delimiter">)</span>;
  
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="List[java.lang.String]" id="425415">compilerPath</a> = <span class="keyword">try</span> <span class="delimiter">{</span>
    <a href="#425418" title="(className: String)List[java.lang.String]">jarPathOfClass</a><span class="delimiter">(</span><span title="java.lang.String(&quot;scala.tools.nsc.Interpreter&quot;)" class="string">&quot;scala.tools.nsc.Interpreter&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <a title="Nothing" id="442040">e</a> =&gt;
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String, x$2: java.lang.Throwable)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unable to load scala interpreter from classpath (scala-compiler jar is missing?)&quot;)" class="string">&quot;Unable to load scala interpreter from classpath (scala-compiler jar is missing?)&quot;</span>, <a href="#442040" title="java.lang.Throwable">e</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="List[java.lang.String]" id="425417">libPath</a> = <span class="keyword">try</span> <span class="delimiter">{</span>
    <a href="#425418" title="(className: String)List[java.lang.String]">jarPathOfClass</a><span class="delimiter">(</span><span title="java.lang.String(&quot;scala.ScalaObject&quot;)" class="string">&quot;scala.ScalaObject&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <a title="Nothing" id="442043">e</a> =&gt;
      <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String, x$2: java.lang.Throwable)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Unable to load scala base object from classpath (scala-library jar is missing?)&quot;)" class="string">&quot;Unable to load scala base object from classpath (scala-library jar is missing?)&quot;</span>, <a href="#442043" title="java.lang.Throwable">e</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/*
   * For a given FQ classname, trick the resource finder into telling us the containing jar.
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(className: String)List[java.lang.String]" id="425418">jarPathOfClass</a><span class="delimiter">(</span><a title="String" id="441769">className</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="keyword">try</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="441772">resource</a> = <a href="#441769" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">className</a>.<span title="(separator: Char)Array[String]">split</span><span title="(xs: Array[String])scala.collection.mutable.ArrayOps[String]" class="delimiter">(</span><span title="Char(\'.\')" class="char">'.'</span><span class="delimiter">)</span>.<span title="(start: String, sep: String, end: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span>, <span title="java.lang.String(&quot;/&quot;)" class="string">&quot;/&quot;</span>, <span title="java.lang.String(&quot;.class&quot;)" class="string">&quot;.class&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="441773">path</a> = <span title="()java.lang.Class[_]">getClass</span>.<span title="(x$1: java.lang.String)java.net.URL">getResource</span><span class="delimiter">(</span><a href="#441772" title="String">resource</a><span class="delimiter">)</span>.<span title="()java.lang.String">getPath</span>
    <span class="keyword">val</span> <a title="Int" id="441774">indexOfFile</a> = <a href="#441773" title="java.lang.String">path</a>.<span title="(x$1: java.lang.String)Int">indexOf</span><span class="delimiter">(</span><span title="java.lang.String(&quot;file:&quot;)" class="string">&quot;file:&quot;</span><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <span title="Int(5)" class="int">5</span>
    <span class="keyword">val</span> <a title="Int" id="441775">indexOfSeparator</a> = <a href="#441773" title="java.lang.String">path</a>.<span title="(x$1: Int)Int">lastIndexOf</span><span class="delimiter">(</span><span title="Int(33)" class="char">'!'</span><span class="delimiter">)</span>
    <span title="(xs: java.lang.String*)List[java.lang.String]">List</span><span class="delimiter">(</span><a href="#441773" title="java.lang.String">path</a>.<span title="(x$1: Int, x$2: Int)java.lang.String">substring</span><span class="delimiter">(</span><a href="#441774" title="Int">indexOfFile</a>, <a href="#441775" title="Int">indexOfSeparator</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  
  <span class="comment">/*
   * Try to guess our app's classpath.
   * This is probably fragile.
   */</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="List[String]" id="425420">impliedClassPath</a>: <span title="List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.URLClassLoader" id="455870">parent</a> =
      <span title="java.net.URLClassLoader" class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">this</span>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.ClassLoader">getClassLoader</span>.<span title="[T0]=&gt; Boolean">isInstanceOf</span><span title="Boolean" class="delimiter">[</span><span title="java.net.URLClassLoader">URLClassLoader</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">this</span>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.ClassLoader">getClassLoader</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.net.URLClassLoader" class="delimiter">[</span><span title="java.net.URLClassLoader">URLClassLoader</span><span class="delimiter">]</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <span title="object java.lang.ClassLoader">ClassLoader</span>.<span title="()java.lang.ClassLoader">getSystemClassLoader</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.net.URLClassLoader" class="delimiter">[</span><span title="java.net.URLClassLoader">URLClassLoader</span><span class="delimiter">]</span>
      <span class="delimiter">}</span>
      
    <span class="keyword">val</span> <a title="List[java.lang.String]" id="455871">currentClassPath</a> = <a href="#455870" title="java.net.URLClassLoader">parent</a>.<span title="(xs: Array[java.net.URL])scala.collection.mutable.ArrayOps[java.net.URL]">getURLs</span>.
      <span title="(f: java.net.URL =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.net.URL],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#456393" title="java.net.URL">_</a>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span>.<span title="(p: java.lang.String =&gt; Boolean)Array[java.lang.String]">filter</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#456602" title="java.lang.String">_</a>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><span title="java.lang.String(&quot;file:&quot;)" class="string">&quot;file:&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#457050" title="java.lang.String">_</a>.<span title="(x$1: Int)java.lang.String">substring</span><span class="delimiter">(</span><span title="Int(5)" class="int">5</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[java.lang.String]">toList</span>

    <span class="comment">// if there's just one thing in the classpath, and it's a jar, assume an executable jar.</span>
    <a href="#455871" title="List[java.lang.String]">currentClassPath</a> <a href="#457188" title="(prefix: List[java.lang.String])List[java.lang.String]">:::</a> <span class="delimiter">(</span><span title="List[java.lang.String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#455871" title="List[java.lang.String]">currentClassPath</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#455871" title="(n: Int)java.lang.String">currentClassPath</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)Boolean">endsWith</span><span class="delimiter">(</span><span title="java.lang.String(&quot;.jar&quot;)" class="string">&quot;.jar&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.lang.String" id="457207">jarFile</a> = <a href="#455871" title="(n: Int)java.lang.String">currentClassPath</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.io.File" id="457208">relativeRoot</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#457207" title="java.lang.String">jarFile</a><span class="delimiter">)</span>.<span title="()java.io.File">getParentFile</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.lang.String" id="457209">nestedClassPath</a> = <span title="java.util.jar.JarFile" class="keyword">new</span> <span title="java.util.jar.JarFile">JarFile</span><span class="delimiter">(</span><a href="#457207" title="java.lang.String">jarFile</a><span class="delimiter">)</span>.<span title="()java.util.jar.Manifest">getManifest</span>.<span title="()java.util.jar.Attributes">getMainAttributes</span>.<span title="(x$1: java.lang.String)java.lang.String">getValue</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Class-Path&quot;)" class="string">&quot;Class-Path&quot;</span><span class="delimiter">)</span>
      <span title="List[java.lang.String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#457209" title="java.lang.String">nestedClassPath</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="object Nil">Nil</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#457209" title="java.lang.String">nestedClassPath</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot; &quot;)" class="string">&quot; &quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span> <span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">{</span> <a title="java.lang.String" id="457963">f</a> =&gt; <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#457208" title="java.io.File">relativeRoot</a>, <a href="#457963" title="java.lang.String">f</a><span class="delimiter">)</span>.<span title="()java.lang.String">getAbsolutePath</span> <span class="delimiter">}</span>.<span title="=&gt; List[java.lang.String]">toList</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="object Nil">Nil</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  
  <span class="comment">/**
   * Dynamic scala compiler. Lots of (slow) state is created, so it may be advantageous to keep
   * around one of these and reuse it.
   */</span>
  <span class="keyword">private</span> <span class="keyword">class</span> <a title="class StringCompiler extends java.lang.Object with ScalaObject" id="425421">StringCompiler</a><a href="#425421" title="ScalaObject" class="delimiter">(</a><a title="Int" id="440304">lineOffset</a>: <span title="Int">Int</span>, <a title="Option[java.io.File]" id="440305">targetDir</a>: <span title="Option[java.io.File]">Option</span><span class="delimiter">[</span>File<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.tools.nsc.io.AbstractFile" id="440283">target</a> = <a href="#440305" title="Option[java.io.File]">targetDir</a> <span title="scala.tools.nsc.io.AbstractFile" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="scala.tools.nsc.io.AbstractFile">Some</span><span class="delimiter">(</span><a title="java.io.File" id="440309">dir</a><span class="delimiter">)</span> =&gt; <span title="object scala.tools.nsc.io.AbstractFile">AbstractFile</span>.<span title="(path: scala.tools.nsc.io.Path)scala.tools.nsc.io.AbstractFile">getDirectory</span><span class="delimiter">(</span><a href="#440309" title="implicit scala.tools.nsc.io.Path.jfile2path : (jfile: scala.tools.nsc.io.package.JFile)scala.tools.nsc.io.Path">dir</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="scala.tools.nsc.io.VirtualDirectory">None</span> =&gt; <span title="scala.tools.nsc.io.VirtualDirectory" class="keyword">new</span> <span title="scala.tools.nsc.io.VirtualDirectory">VirtualDirectory</span><span class="delimiter">(</span><span title="java.lang.String(&quot;(memory)&quot;)" class="string">&quot;(memory)&quot;</span>, <span title="object None">None</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,java.lang.Class[_]]" id="440285">cache</a> = <span title="()scala.collection.mutable.HashMap[String,Class[_]]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,Class[_]]">HashMap</span><span class="delimiter">[</span>String, Class<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="scala.tools.nsc.Settings" id="440287">settings</a> = <span title="()scala.tools.nsc.Settings" class="keyword">new</span> <span title="scala.tools.nsc.Settings">Settings</span>
    <a href="#440287" title="=&gt; scala.tools.nsc.Settings">settings</a>.<span title="=&gt; StringCompiler.this.settings.BooleanSetting">deprecation</span>.<span title="(arg: StringCompiler.this.settings.deprecation.T)Unit">value</span> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">// enable detailed deprecation warnings</span>
    <a href="#440287" title="=&gt; scala.tools.nsc.Settings">settings</a>.<span title="=&gt; StringCompiler.this.settings.BooleanSetting">unchecked</span>.<span title="(arg: StringCompiler.this.settings.unchecked.T)Unit">value</span> = <span title="Boolean(true)" class="keyword">true</span> <span class="comment">// enable detailed unchecked warnings</span>
    <a href="#440287" title="=&gt; scala.tools.nsc.Settings">settings</a>.<span title="=&gt; StringCompiler.this.settings.OutputDirs">outputDirs</span>.<span title="(dir: scala.tools.nsc.io.AbstractFile)Unit">setSingleOutput</span><span class="delimiter">(</span><a href="#440283" title="=&gt; scala.tools.nsc.io.AbstractFile">target</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="List[java.lang.String]" id="440289">pathList</a> = <a href="#425414" title="=&gt; List[java.lang.String]">compilerPath</a> <a href="#441768" title="(prefix: List[java.lang.String])List[java.lang.String]">:::</a> <a href="#425416" title="=&gt; List[java.lang.String]">libPath</a>
    <a href="#440287" title="=&gt; scala.tools.nsc.Settings">settings</a>.<span title="=&gt; StringCompiler.this.settings.PathSetting">bootclasspath</span>.<span title="(arg: StringCompiler.this.settings.bootclasspath.T)Unit">value</span> = <a href="#440289" title="=&gt; List[java.lang.String]">pathList</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="object java.io.File">File</span>.<span title="java.lang.String">pathSeparator</span><span class="delimiter">)</span>
    <a href="#440287" title="=&gt; scala.tools.nsc.Settings">settings</a>.<span title="=&gt; StringCompiler.this.settings.PathSetting">classpath</span>.<span title="(arg: StringCompiler.this.settings.classpath.T)Unit">value</span> = <span class="delimiter">(</span><a href="#440289" title="=&gt; List[java.lang.String]">pathList</a> <a href="#458160" title="(prefix: List[String])List[String]">:::</a> <a href="#425419" title="=&gt; List[String]">impliedClassPath</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="object java.io.File">File</span>.<span title="java.lang.String">pathSeparator</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="reporter extends scala.tools.nsc.reporters.AbstractReporter" id="440291">reporter</a> = <a href="#442058" title="scala.tools.nsc.reporters.AbstractReporter{val messages: scala.collection.mutable.ListBuffer[List[String]]}" class="keyword">new</a> <a title="anonymous class $anon extends scala.tools.nsc.reporters.AbstractReporter" id="442058">AbstractReporter</a> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.tools.nsc.Settings" id="442081">settings</a> = <a href="#425421" title="StringCompiler.this.type">StringCompiler</a>.<span class="keyword">this</span>.<a href="#440287" title="=&gt; scala.tools.nsc.Settings">settings</a>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[List[String]]" id="442083">messages</a> = <span title="scala.collection.mutable.ListBuffer[List[String]]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.ListBuffer[List[String]]">ListBuffer</span><span class="delimiter">[</span>List<span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">]</span>

      <span class="keyword">def</span> <a title="(pos: scala.tools.nsc.util.Position, message: String, severity: this.Severity)Unit" id="442085">display</a><span class="delimiter">(</span><a title="scala.tools.nsc.util.Position" id="442480">pos</a>: <span title="scala.tools.nsc.util.Position">Position</span>, <a title="String" id="442481">message</a>: <span title="String">String</span>, <a title="this.Severity" id="442482">severity</a>: <span title="this.Severity">Severity</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#442482" title="this.Severity">severity</a>.<span title="(x$1: Int)Unit">count</span> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
        <span class="keyword">val</span> <a title="java.lang.String" id="442640">severityName</a> = <a href="#442482" title="this.Severity">severity</a> <span title="java.lang.String" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a href="#442058" title="java.lang.String(&quot;error: &quot;)">ERROR</a>   =&gt; <span title="java.lang.String(&quot;error: &quot;)" class="string">&quot;error: &quot;</span>
          <span class="keyword">case</span> <a href="#442058" title="java.lang.String(&quot;warning: &quot;)">WARNING</a> =&gt; <span title="java.lang.String(&quot;warning: &quot;)" class="string">&quot;warning: &quot;</span>
          <span class="keyword">case</span> <span title="java.lang.String(&quot;&quot;)">_</span> =&gt; <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span>
        <span class="delimiter">}</span>
        <a href="#442083" title="=&gt; scala.collection.mutable.ListBuffer[List[String]]">messages</a> <span title="(x: List[String])this.messages.type">+=</span> <span class="delimiter">(</span><a href="#442640" title="java.lang.String">severityName</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;line &quot;)" class="string">&quot;line &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span class="delimiter">(</span><a href="#442480" title="scala.tools.nsc.util.Position">pos</a>.<span title="=&gt; Int">line</span> <span title="(x: Int)Int">-</span> <a href="#440304" title="Int">lineOffset</a><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;: &quot;)" class="string">&quot;: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#442481" title="String">message</a><span class="delimiter">)</span> <a href="#442655" title="(x: java.lang.String)List[java.lang.String]">::</a>
          <span class="delimiter">(</span><span title="List[java.lang.String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#442480" title="scala.tools.nsc.util.Position">pos</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#442480" title="scala.tools.nsc.util.Position">pos</a>.<span title="(source: scala.tools.nsc.util.SourceFile)scala.tools.nsc.util.Position">inUltimateSource</span><span class="delimiter">(</span><a href="#442480" title="scala.tools.nsc.util.Position">pos</a>.<span title="=&gt; scala.tools.nsc.util.SourceFile">source</span><span class="delimiter">)</span>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">lineContent</span>.<span title="=&gt; String">stripLineEnd</span> <a href="#442660" title="(x: java.lang.String)List[java.lang.String]">::</a>
              <span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot; &quot;</span> <span title="(n: Int)String">*</span> <span class="delimiter">(</span><a href="#442480" title="scala.tools.nsc.util.Position">pos</a>.<span title="=&gt; Int">column</span> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;^&quot;)" class="string">&quot;^&quot;</span><span class="delimiter">)</span> <a href="#442666" title="(x: java.lang.String)List[java.lang.String]">::</a>
              <span title="object Nil">Nil</span>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span title="object Nil">Nil</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="keyword">def</span> <a title="()Unit" id="442086">displayPrompt</a> <span title="Unit" class="delimiter">{</span>
        <span class="comment">// no.</span>
      <span class="delimiter">}</span>

      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="442087">reset</a> <span class="delimiter">{</span>
        <a href="#442058" title="scala.tools.nsc.reporters.AbstractReporter{val messages: scala.collection.mutable.ListBuffer[List[String]]}" class="keyword">super</a>.<span title="()Unit">reset</span>
        <a href="#442083" title="=&gt; scala.collection.mutable.ListBuffer[List[String]]">messages</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="scala.tools.nsc.Global" id="440293">global</a> = <span title="scala.tools.nsc.Global" class="keyword">new</span> <span title="scala.tools.nsc.Global">Global</span><span class="delimiter">(</span><a href="#440287" title="=&gt; scala.tools.nsc.Settings">settings</a>, <a href="#440291" title="=&gt; scala.tools.nsc.reporters.AbstractReporter{val messages: scala.collection.mutable.ListBuffer[List[String]]}">reporter</a><span class="delimiter">)</span>

    <span class="comment">/*
     * Class loader for finding classes compiled by this StringCompiler.
     * After each reset, this class loader will not be able to find old compiled classes.
     */</span>
    <span class="keyword">var</span> <a title="scala.tools.nsc.interpreter.AbstractFileClassLoader" id="440296">classLoader</a> = <span title="scala.tools.nsc.interpreter.AbstractFileClassLoader" class="keyword">new</span> <span title="scala.tools.nsc.interpreter.AbstractFileClassLoader">AbstractFileClassLoader</span><span class="delimiter">(</span><a href="#440283" title="=&gt; scala.tools.nsc.io.AbstractFile">target</a>, <a href="#425421" title="StringCompiler.this.type" class="keyword">this</a>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.ClassLoader">getClassLoader</span><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="()Unit" id="440298">reset</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#440305" title="Option[java.io.File]">targetDir</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit">None</span> =&gt; <span class="delimiter">{</span>
          <a href="#440283" title="=&gt; scala.tools.nsc.io.AbstractFile">target</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="scala.tools.nsc.io.VirtualDirectory" class="delimiter">[</span><span title="scala.tools.nsc.io.VirtualDirectory">VirtualDirectory</span><span class="delimiter">]</span>.<span title="()Unit">clear</span>
        <span class="delimiter">}</span>
        <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="java.io.File" id="458175">t</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#440283" title="=&gt; scala.tools.nsc.io.AbstractFile">target</a>.<span title="(f: scala.tools.nsc.io.AbstractFile =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="scala.tools.nsc.io.AbstractFile" id="458198">abstractFile</a> =&gt;
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#458198" title="scala.tools.nsc.io.AbstractFile">abstractFile</a>.<span title="=&gt; scala.tools.nsc.io.package.JFile">file</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">||</span> <a href="#458198" title="scala.tools.nsc.io.AbstractFile">abstractFile</a>.<span title="=&gt; scala.tools.nsc.io.package.JFile">file</span>.<span title="()java.lang.String">getName</span>.<span title="(x$1: java.lang.String)Boolean">endsWith</span><span class="delimiter">(</span><span title="java.lang.String(&quot;.class&quot;)" class="string">&quot;.class&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#458198" title="scala.tools.nsc.io.AbstractFile">abstractFile</a>.<span title="()Unit">delete</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#440285" title="=&gt; scala.collection.mutable.HashMap[String,java.lang.Class[_]]">cache</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#440291" title="=&gt; scala.tools.nsc.reporters.AbstractReporter{val messages: scala.collection.mutable.ListBuffer[List[String]]}">reporter</a>.<span title="()Unit">reset</span>
      <a href="#440296" title="(x$1: scala.tools.nsc.interpreter.AbstractFileClassLoader)Unit">classLoader</a> = <span title="scala.tools.nsc.interpreter.AbstractFileClassLoader" class="keyword">new</span> <span title="scala.tools.nsc.interpreter.AbstractFileClassLoader">AbstractFileClassLoader</span><span class="delimiter">(</span><a href="#440283" title="=&gt; scala.tools.nsc.io.AbstractFile">target</a>, <a href="#425421" title="StringCompiler.this.type" class="keyword">this</a>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.ClassLoader">getClassLoader</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">object</span> <a title="object StringCompiler.this.Debug" id="440299">Debug</a> <span title="ScalaObject" class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Boolean" id="455828">enabled</a> =
        <span title="object java.lang.System">System</span>.<span title="(x$1: java.lang.String)java.lang.String">getProperty</span><span class="delimiter">(</span><span title="java.lang.String(&quot;eval.debug&quot;)" class="string">&quot;eval.debug&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>

      <span class="keyword">def</span> <a title="(code: String)Unit" id="455830">printWithLineNumbers</a><span class="delimiter">(</span><a title="String" id="458214">code</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="(text: String, xs: Any*)Unit">printf</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Code follows (%d bytes)\012&quot;)" class="string">&quot;Code follows (%d bytes)\n&quot;</span>, <a href="#458214" title="String">code</a>.<span title="()Int">length</span><span class="delimiter">)</span>

        <span class="keyword">var</span> <a title="Int" id="458216">numLines</a> = <span title="Int(0)" class="int">0</span>
        <a href="#458214" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">code</a>.<span title="=&gt; Iterator[String]">lines</span> <span title="(f: String =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> line: <span title="String">String</span> =&gt;
          <a href="#458216" title="Int">numLines</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
          <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="#458216" title="Int">numLines</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">toString</span>.<span title="(len: Int, elem: Char)(implicit bf: scala.collection.generic.CanBuildFrom[String,Char,String])String">padTo</span><span title="=&gt; scala.collection.generic.CanBuildFrom[String,Char,String]" class="delimiter">(</span><span title="Int(5)" class="int">5</span>, <span title="Char(\' \')" class="char">' '</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;| &quot;)" class="string">&quot;| &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#458234" title="String">line</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(className: String)Option[Class[_]]" id="440301">findClass</a><span class="delimiter">(</span><a title="String" id="455832">className</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Option[Class[_]]">Option</span><span class="delimiter">[</span>Class<span class="delimiter">[</span>_<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="#425421" title="(x$1: Option[java.lang.Class[_]])Option[java.lang.Class[_]]">synchronized</a> <span class="delimiter">{</span>
        <a href="#440285" title="=&gt; scala.collection.mutable.HashMap[String,java.lang.Class[_]]">cache</a>.<span title="(key: String)Option[java.lang.Class[_]]">get</span><span class="delimiter">(</span><a href="#455832" title="String">className</a><span class="delimiter">)</span>.<span title="(alternative: =&gt; Option[java.lang.Class[_]])Option[java.lang.Class[_]]">orElse</span> <span class="delimiter">{</span>
          <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="java.lang.Class[_]" id="458392">cls</a> = <a href="#440296" title="=&gt; scala.tools.nsc.interpreter.AbstractFileClassLoader">classLoader</a>.<span title="(x$1: java.lang.String)java.lang.Class[_]">loadClass</span><span class="delimiter">(</span><a href="#455832" title="String">className</a><span class="delimiter">)</span>
            <a href="#440285" title="(key: String, value: java.lang.Class[_])Unit">cache</a><span class="delimiter">(</span><a href="#455832" title="String">className</a><span class="delimiter">)</span> = <a href="#458392" title="java.lang.Class[_]">cls</a>
            <span title="(x: java.lang.Class[?0])Some[java.lang.Class[?0]]">Some</span><span class="delimiter">(</span><a href="#458392" title="java.lang.Class[_]">cls</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <a title="None.type" id="458412">e</a>: <span title="java.lang.ClassNotFoundException">ClassNotFoundException</span> =&gt; <span title="object None">None</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Compile scala code. It can be found using the above class loader.
     */</span>
    <span class="keyword">def</span> <a title="(code: String)Unit" id="440302">apply</a><span class="delimiter">(</span><a title="String" id="455839">code</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#440299" title="object StringCompiler.this.Debug">Debug</a>.<a href="#455828" title="=&gt; Boolean">enabled</a><span class="delimiter">)</span>
        <a href="#440299" title="object StringCompiler.this.Debug">Debug</a>.<a href="#455830" title="(code: String)Unit">printWithLineNumbers</a><span class="delimiter">(</span><a href="#455839" title="String">code</a><span class="delimiter">)</span>

      <span class="comment">// if you're looking for the performance hit, it's 1/2 this line...</span>
      <span class="keyword">val</span> <a title="StringCompiler.this.global.Run" id="458439">compiler</a> = <span title="StringCompiler.this.global.Run" class="keyword">new</span> <a href="#440293" title="=&gt; scala.tools.nsc.Global">global</a>.<span title="StringCompiler.this.global.Run">Run</span>
      <span class="keyword">val</span> <a title="List[scala.tools.nsc.util.BatchSourceFile]" id="458440">sourceFiles</a> = <span title="(xs: scala.tools.nsc.util.BatchSourceFile*)List[scala.tools.nsc.util.BatchSourceFile]">List</span><span class="delimiter">(</span><span title="(sourceName: String, cs: Seq[Char])scala.tools.nsc.util.BatchSourceFile" class="keyword">new</span> <span title="scala.tools.nsc.util.BatchSourceFile">BatchSourceFile</span><span class="delimiter">(</span><span title="java.lang.String(&quot;(inline)&quot;)" class="string">&quot;(inline)&quot;</span>, <a href="#455839" title="implicit scala.LowPriorityImplicits.wrapString : (s: String)scala.collection.immutable.WrappedString">code</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="comment">// ...and 1/2 this line:</span>
      <a href="#458439" title="StringCompiler.this.global.Run">compiler</a>.<span title="(_sources: List[scala.tools.nsc.util.SourceFile])Unit">compileSources</span><span class="delimiter">(</span><a href="#458440" title="List[scala.tools.nsc.util.BatchSourceFile]">sourceFiles</a><span class="delimiter">)</span>

      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#440291" title="=&gt; scala.tools.nsc.reporters.AbstractReporter{val messages: scala.collection.mutable.ListBuffer[List[String]]}">reporter</a>.<span title="=&gt; Boolean">hasErrors</span> <span title="(x: Boolean)Boolean">||</span> <a href="#440291" title="=&gt; scala.tools.nsc.reporters.AbstractReporter{val messages: scala.collection.mutable.ListBuffer[List[String]]}">reporter</a>.<span title="=&gt; StringCompiler.this.reporter.Severity">WARNING</span>.<span title="=&gt; Int">count</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="Nothing" class="keyword">throw</span> <span title="scalala.operators.codegen.DynamicCompiler.CompilerException" class="keyword">new</span> <a href="#425422" title="scalala.operators.codegen.DynamicCompiler.CompilerException">CompilerException</a><span class="delimiter">(</span><a href="#440291" title="=&gt; scala.tools.nsc.reporters.AbstractReporter{val messages: scala.collection.mutable.ListBuffer[List[String]]}">reporter</a>.<a href="#442744" title="=&gt; scala.collection.mutable.ListBuffer[List[String]]">messages</a>.<span title="=&gt; List[List[String]]">toList</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Compile a new class, load it, and return it. Thread-safe.
     */</span>
    <span class="keyword">def</span> <a title="(code: String, className: String, resetState: Boolean)Class[_]" id="440303">apply</a><span class="delimiter">(</span><a title="String" id="455843">code</a>: <span title="String">String</span>, <a title="String" id="455844">className</a>: <span title="String">String</span>, <a title="Boolean" id="455849">resetState</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>: <span title="Class[_]">Class</span><span class="delimiter">[</span>_<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="#425421" title="(x$1: Class[_$3])Class[_$3]">synchronized</a> <span class="delimiter">{</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#455849" title="Boolean">resetState</a><span class="delimiter">)</span> <a href="#440298" title="()Unit">reset</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#440301" title="(className: String)Option[Class[_]]">findClass</a><span class="delimiter">(</span><a href="#455844" title="String">className</a><span class="delimiter">)</span>.<span title="(default: =&gt; Class[_])Class[_]">getOrElse</span> <span class="delimiter">{</span>
          <a href="#440302" title="(code: String)Unit">apply</a><span class="delimiter">(</span><a href="#455843" title="String">code</a><span class="delimiter">)</span>
          <a href="#440301" title="(className: String)Option[Class[_]]">findClass</a><span class="delimiter">(</span><a href="#455844" title="String">className</a><span class="delimiter">)</span>.<span title="=&gt; Class[_]">get</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">class</span> <a title="class CompilerException extends java.lang.Exception with ScalaObject" id="425422">CompilerException</a><a href="#425422" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="List[List[String]]" id="458535">messages</a>: <span title="List[List[String]]">List</span><span class="delimiter">[</span>List<span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="java.lang.Exception">Exception</span><span class="delimiter">(</span>
    <span title="java.lang.String(&quot;Compiler exception &quot;)" class="string">&quot;Compiler exception &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#458535" title="List[List[String]]">messages</a>.<span title="(f: List[String] =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[List[List[String]],String,List[String]])List[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,String,List[String]]" class="delimiter">(</span><a href="#458579" title="List[String]">_</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="java.lang.String(&quot;\012&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
<span class="delimiter">}</span>


        </pre>
    </body>
</html>