<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>netty-server/unfiltered/netty/resources.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> unfiltered.netty

<span class="keyword">import</span> org.jboss.netty.channel._
<span class="keyword">import</span> java.nio.charset.Charset

<span class="keyword">object</span> <a title="object unfiltered.netty.Mimes" id="11436">Mimes</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> javax.activation.MimetypesFileTypeMap

  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="javax.activation.MimetypesFileTypeMap" id="41294">underlying</a> =
    <span title="(x$1: java.io.InputStream)javax.activation.MimetypesFileTypeMap" class="keyword">new</span> <span title="javax.activation.MimetypesFileTypeMap">MimetypesFileTypeMap</span><span class="delimiter">(</span><span title="()java.lang.Class[_]">getClass</span>.<span title="(x$1: java.lang.String)java.io.InputStream">getResourceAsStream</span><span class="delimiter">(</span><span title="java.lang.String(&quot;/mime.types&quot;)" class="string">&quot;/mime.types&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(path: String)java.lang.String" id="41295">apply</a><span class="delimiter">(</span><a title="String" id="41404">path</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="#41293" title="=&gt; javax.activation.MimetypesFileTypeMap">underlying</a>.<span title="(x$1: java.lang.String)java.lang.String">getContentType</span><span class="delimiter">(</span><a href="#41404" title="String">path</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object unfiltered.netty.Dates" id="11370">Dates</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> java.text.SimpleDateFormat
  <span class="keyword">import</span> java.util.<span class="delimiter">{</span>Date, Locale, TimeZone<span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="java.lang.String" id="41414">HttpDateFormat</a> = <span title="java.lang.String(&quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;)" class="string">&quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="41416">HttpDateGMTTimezone</a> = <span title="java.lang.String(&quot;GMT&quot;)" class="string">&quot;GMT&quot;</span>
  <span class="keyword">def</span> <a title="(d: Long)String" id="41418">format</a><span class="delimiter">(</span><a title="Long" id="41618">d</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="String">String</span> =
    <a href="#41620" title="java.text.SimpleDateFormat" class="keyword">new</a> <a title="anonymous class $anon extends java.text.SimpleDateFormat" id="41620">SimpleDateFormat</a><span class="delimiter">(</span><a href="#41414" title="=&gt; java.lang.String">HttpDateFormat</a>, <span title="object java.util.Locale">Locale</span>.<span title="java.util.Locale">US</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#41620" title="(x$1: java.util.TimeZone)Unit">setTimeZone</a><span class="delimiter">(</span><span title="object java.util.TimeZone">TimeZone</span>.<span title="(x$1: java.lang.String)java.util.TimeZone">getTimeZone</span><span class="delimiter">(</span><a href="#41416" title="=&gt; java.lang.String">HttpDateGMTTimezone</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(x$1: Any)java.lang.String">format</span><span class="delimiter">(</span><a href="#41618" title="Long">d</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(d: java.util.Date)String" id="41419">format</a><span class="delimiter">(</span><a title="java.util.Date" id="42266">d</a>: <span title="java.util.Date">Date</span><span class="delimiter">)</span>: <span title="String">String</span> = <a href="#41418" title="(d: Long)String">format</a><span class="delimiter">(</span><a href="#42266" title="java.util.Date">d</a>.<span title="()Long">getTime</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** Extracts HttpRequest if a retrieval method */</span>
<span class="keyword">object</span> <a title="object unfiltered.netty.Retrieval" id="11523">Retrieval</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> unfiltered.request.<span class="delimiter">{</span>HttpRequest, GET, HEAD<span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="[T](r: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]" id="42276">unapply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="42278">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="42280">r</a>: <a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#9907" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#9869" title="object unfiltered.request.GET">GET</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#42286" title="(req: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]">unapply</a><span class="delimiter">(</span><a href="#42280" title="unfiltered.request.HttpRequest[T]">r</a><span class="delimiter">)</span>.<span title="(alternative: =&gt; Option[unfiltered.request.HttpRequest[T]])Option[unfiltered.request.HttpRequest[T]]">orElse</span> <span class="delimiter">{</span> <a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#9875" title="object unfiltered.request.HEAD">HEAD</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#42286" title="(req: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]">unapply</a><span class="delimiter">(</span><a href="#42280" title="unfiltered.request.HttpRequest[T]">r</a><span class="delimiter">)</span> <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object unfiltered.netty.Resources" id="42512">Resources</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">val</span> <a title="java.nio.charset.Charset" id="42322">utf8</a> = <span title="object java.nio.charset.Charset">Charset</span>.<span title="(x$1: java.lang.String)java.nio.charset.Charset">forName</span><span class="delimiter">(</span><span title="java.lang.String(&quot;UTF-8&quot;)" class="string">&quot;UTF-8&quot;</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.nio.charset.Charset" id="42324">iso88591</a> = <span title="object java.nio.charset.Charset">Charset</span>.<span title="(x$1: java.lang.String)java.nio.charset.Charset">forName</span><span class="delimiter">(</span><span title="java.lang.String(&quot;ISO-8859-1&quot;)" class="string">&quot;ISO-8859-1&quot;</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** Serves static resources.
 *  Adapted from Netty's example HttpStaticFileServerHandler
 */</span>
case <span class="keyword">class</span> <a title="(x$0: unfiltered.netty.Resources)Option[(java.net.URL, Int, Boolean)]" id="44640">Resources</a><a href="#44640" title="ScalaObject" class="delimiter">(</a><a title="java.net.URL" id="44603">base</a>: java.net.<span title="java.net.URL">URL</span>,
                     <a title="=&gt; Int" id="44604">cacheSeconds</a>: <span title="Int">Int</span> = <span title="Int(60)" class="int">60</span>,
                     <a title="=&gt; Boolean" id="44605">passOnFail</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> unfiltered.netty.async.<a href="../../../netty/unfiltered/netty/async/plans.scala.html#12028" title="unfiltered.netty.async.Plan">Plan</a> <span class="keyword">with</span> <a href="../../../netty/unfiltered/netty/exceptions.scala.html#11540" title="unfiltered.netty.ServerErrorResponse">ServerErrorResponse</a> <span class="delimiter">{</span>
  <span class="keyword">import</span> <a href="#42512" title="object unfiltered.netty.Resources">Resources</a>._

  <span class="keyword">import</span> unfiltered.request._
  <span class="keyword">import</span> unfiltered.response._

  <span class="keyword">import</span> scala.util.control.<span title="object scala.util.control.Exception">Exception</span>.allCatch

  <span class="keyword">import</span> java.util.<span class="delimiter">{</span>Calendar, GregorianCalendar<span class="delimiter">}</span>
  <span class="keyword">import</span> java.io.<span class="delimiter">{</span>File, FileNotFoundException, RandomAccessFile<span class="delimiter">}</span>
  <span class="keyword">import</span> java.net.URLDecoder

  <span class="keyword">import</span> org.jboss.netty.channel.<span class="delimiter">{</span>
    DefaultFileRegion, ChannelFuture, ChannelFutureListener,
    ChannelFutureProgressListener<span class="delimiter">}</span>
  <span class="keyword">import</span> org.jboss.netty.handler.codec.http.<span class="delimiter">{</span>
    HttpHeaders, HttpResponse =&gt; NHttpResponse<span class="delimiter">}</span>
  <span class="keyword">import</span> org.jboss.netty.handler.stream.ChunkedFile
  <span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffers

  <span class="keyword">import</span> java.nio.channels.ClosedChannelException

  <span class="comment">// Returning Pass here will send the request upstream, otherwise</span>
  <span class="comment">// this method handles the request itself</span>
  <span class="keyword">def</span> <a title="[T &lt;: org.jboss.netty.handler.codec.http.HttpResponse](rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any" id="42395">passOr</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: org.jboss.netty.handler.codec.http.HttpResponse" id="42397">T</a> &lt;: NHttpResponse<span class="delimiter">]</span><span class="delimiter">(</span><a title="=&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse]" id="42635">rf</a>: =&gt; ResponseFunction<span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span><span class="delimiter">)</span>
                                <span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" id="42636">req</a>: <a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#9907" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]">HttpRequest</a><span class="delimiter">[</span>ReceivedMessage<span class="delimiter">]</span><span class="delimiter">)</span> =
    <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#44605" title="=&gt; Boolean">passOnFail</a><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/pass.scala.html#10992" title="object unfiltered.response.Pass">Pass</a> <span class="keyword">else</span> <a href="#42636" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13891" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#42654" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])Unit">respond</a><span class="delimiter">(</span><a href="#42635" title="=&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse]">rf</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] =&gt; Any" id="42398">forbid</a> = <a href="#42395" title="(rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">passOr</a><a href="#42857" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" class="delimiter">(</a><a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#10737" title="object unfiltered.response.Forbidden">Forbidden</a><span class="delimiter">)</span>_

  <span class="keyword">def</span> <a title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] =&gt; Any" id="42399">notFound</a> = <a href="#42395" title="(rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">passOr</a><a href="#42864" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" class="delimiter">(</a><a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#10917" title="object unfiltered.response.NotFound">NotFound</a><span class="delimiter">)</span>_

  <span class="keyword">def</span> <a title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] =&gt; Any" id="42400">badRequest</a> = <a href="#42395" title="(rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">passOr</a><a href="#42883" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" class="delimiter">(</a><a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#10581" title="object unfiltered.response.BadRequest">BadRequest</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/types.scala.html#11010" title="object unfiltered.response.PlainTextContent">PlainTextContent</a><span class="delimiter">)</span>_

  <span class="keyword">def</span> <a title="=&gt; PartialFunction[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse],Any]" id="42401">intent</a> = <a href="#42896" title="Any" class="delimiter">{</a>
    <span class="keyword">case</span> <a href="#42276" title="Any">Retrieval</a><span class="delimiter">(</span><a href="../../../unfiltered/unfiltered/unfiltered/request/paths.scala.html#40242" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Some[String]">Path</a><span class="delimiter">(</span><a title="String" id="42960">path</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/request/utils.scala.html#42898" title="(a: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse])Some[(unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse], unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse])]">&amp;</a> <a title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" id="42961">req</a> =&gt; <a href="#42402" title="(uri: String)Option[java.io.File]">accessible</a><span class="delimiter">(</span><a href="#42960" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">path</a>.<span title="(n: Int)String">drop</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Any">Some</span><span class="delimiter">(</span><a title="java.io.File" id="43242">file</a><span class="delimiter">)</span> =&gt;
        <a href="../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16005" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[java.util.Date]">IfModifiedSince</a><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span> <span title="Any" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="java.util.Date" id="43265">since</a><span class="delimiter">)</span> <span class="keyword">if</span><span class="delimiter">(</span><a href="#43265" title="java.util.Date">since</a>.<span title="()Long">getTime</span> <span title="(x: Long)Boolean">==</span> <a href="#43242" title="java.io.File">file</a>.<span title="()Long">lastModified</span><span class="delimiter">)</span> =&gt;
            <span class="comment">// close immediately and do not include content-length header</span>
            <span class="comment">// http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html</span>

            <a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13891" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#42646" title="=&gt; org.jboss.netty.channel.MessageEvent">event</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span>
              <a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13891" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#42652" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">defaultResponse</a><span class="delimiter">(</span>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#10929" title="object unfiltered.response.NotModified">NotModified</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">Date</a><span class="delimiter">(</span><a href="#11370" title="object unfiltered.netty.Dates">Dates</a>.<a href="#41419" title="(d: java.util.Date)String">format</a><span class="delimiter">(</span><span title="java.util.GregorianCalendar" class="keyword">new</span> <span title="java.util.GregorianCalendar">GregorianCalendar</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.Date">getTime</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><span title="object org.jboss.netty.channel.ChannelFutureListener">ChannelFutureListener</span>.<span title="org.jboss.netty.channel.ChannelFutureListener">CLOSE</span><span class="delimiter">)</span>
          <span class="keyword">case</span> <span title="Any">_</span> =&gt;
            <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#43242" title="java.io.File">file</a>.<span title="()Boolean">isHidden</span> <span title="(x: Boolean)Boolean">||</span> <span title="=&gt; Boolean">!</span><a href="#43242" title="java.io.File">file</a>.<span title="()Boolean">exists</span><span class="delimiter">)</span> <a href="#42399" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">notFound</a><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span title="Any" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#43242" title="java.io.File">file</a>.<span title="()Boolean">isFile</span><span class="delimiter">)</span> <a href="#42398" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">forbid</a><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span class="keyword">try</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="java.io.RandomAccessFile" id="43783">raf</a> = <span title="(x$1: java.io.File, x$2: java.lang.String)java.io.RandomAccessFile" class="keyword">new</span> <span title="java.io.RandomAccessFile">RandomAccessFile</span><span class="delimiter">(</span><a href="#43242" title="java.io.File">file</a>, <span title="java.lang.String(&quot;r&quot;)" class="string">&quot;r&quot;</span><span class="delimiter">)</span>
              <span class="keyword">val</span> <a title="Long" id="43784">len</a> = <a href="#43783" title="java.io.RandomAccessFile">raf</a>.<span title="()Long">length</span>
              <span class="keyword">val</span> <a title="java.util.GregorianCalendar" id="43785">cal</a> = <span title="java.util.GregorianCalendar" class="keyword">new</span> <span title="java.util.GregorianCalendar">GregorianCalendar</span><span class="delimiter">(</span><span class="delimiter">)</span>
              <span class="keyword">var</span> <a title="~&gt; extends java.lang.Object with unfiltered.response.ResponseFunction[Any]" id="43786">heads</a> = <a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#10935" title="object unfiltered.response.Ok">Ok</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">ContentLength</a><span class="delimiter">(</span><a href="#43784" title="Long">len</a>.<span title="()java.lang.String">toString</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <span class="comment">// note: bin/text/charset not included</span>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/types.scala.html#43940" title="(staticContentType: String)unfiltered.response.ContentType">ContentType</a><span class="delimiter">(</span><a href="#41295" title="(path: String)java.lang.String">Mimes</a><span class="delimiter">(</span><a href="#43242" title="java.io.File">file</a>.<span title="()java.lang.String">getPath</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">Date</a><span class="delimiter">(</span><a href="#11370" title="object unfiltered.netty.Dates">Dates</a>.<a href="#41419" title="(d: java.util.Date)String">format</a><span class="delimiter">(</span><a href="#43785" title="java.util.GregorianCalendar">cal</a>.<span title="()java.util.Date">getTime</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">CacheControl</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;private, max-age=%d&quot;</span> <span title="(args: Any*)String">format</span> <a href="#44604" title="=&gt; Int">cacheSeconds</a><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">LastModified</a><span class="delimiter">(</span><a href="#11370" title="object unfiltered.netty.Dates">Dates</a>.<a href="#41418" title="(d: Long)String">format</a><span class="delimiter">(</span><a href="#43242" title="java.io.File">file</a>.<span title="()Long">lastModified</span><span class="delimiter">)</span><span class="delimiter">)</span>

              <a href="#43785" title="java.util.GregorianCalendar">cal</a>.<span title="(x$1: Int, x$2: Int)Unit">add</span><span class="delimiter">(</span>Calendar.<span title="Int(13)">SECOND</span>, <a href="#44604" title="=&gt; Int">cacheSeconds</a><span class="delimiter">)</span>

              <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="43787">chan</a> = <a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13891" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#42646" title="=&gt; org.jboss.netty.channel.MessageEvent">event</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
              <span class="keyword">val</span> <a title="org.jboss.netty.channel.ChannelFuture" id="43788">writeHeaders</a> = <a href="#43787" title="org.jboss.netty.channel.Channel">chan</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span>
                <a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13891" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#42652" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">defaultResponse</a><span class="delimiter">(</span>
                  <a href="#43786" title="~&gt; extends java.lang.Object with unfiltered.response.ResponseFunction[Any]">heads</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">Expires</a><span class="delimiter">(</span><a href="#11370" title="object unfiltered.netty.Dates">Dates</a>.<a href="#41419" title="(d: java.util.Date)String">format</a><span class="delimiter">(</span><a href="#43785" title="java.util.GregorianCalendar">cal</a>.<span title="()java.util.Date">getTime</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

              <span class="keyword">def</span> <a title="(future: org.jboss.netty.channel.ChannelFuture)Unit" id="43789">lastly</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="44017">future</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> =
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.<a href="../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44025" title="(message: org.jboss.netty.handler.codec.http.HttpMessage)Boolean">isKeepAlive</a><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13891" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#42642" title="=&gt; org.jboss.netty.handler.codec.http.HttpRequest">request</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                   <a href="#44017" title="org.jboss.netty.channel.ChannelFuture">future</a>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><span title="object org.jboss.netty.channel.ChannelFutureListener">ChannelFutureListener</span>.<span title="org.jboss.netty.channel.ChannelFutureListener">CLOSE</span><span class="delimiter">)</span>
                <span class="delimiter">}</span>

              <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#9869" title="object unfiltered.request.GET">GET</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#42286" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]]">unapply</a><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#43787" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()Boolean">isOpen</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13903" title="=&gt; Boolean">isSecure</a><span class="delimiter">)</span>
                  <a href="#43787" title="org.jboss.netty.channel.Channel">chan</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><span title="(x$1: java.io.RandomAccessFile, x$2: Long, x$3: Long, x$4: Int)org.jboss.netty.handler.stream.ChunkedFile" class="keyword">new</span> <span title="org.jboss.netty.handler.stream.ChunkedFile">ChunkedFile</span><span class="delimiter">(</span><a href="#43783" title="java.io.RandomAccessFile">raf</a>, <span title="Long(0L)" class="int">0</span>, <a href="#43784" title="Long">len</a>, <span title="Int(8192)" class="int">8192</span><span class="delimiter">)</span><span class="delimiter">)</span>
                <span class="keyword">else</span> <span class="delimiter">{</span>
                  <span class="comment">// using zero-copy</span>
                  <span class="keyword">val</span> <a title="org.jboss.netty.channel.DefaultFileRegion" id="44106">region</a> =
                    <span title="org.jboss.netty.channel.DefaultFileRegion" class="keyword">new</span> <span title="org.jboss.netty.channel.DefaultFileRegion">DefaultFileRegion</span><span class="delimiter">(</span><a href="#43783" title="java.io.RandomAccessFile">raf</a>.<span title="()java.nio.channels.FileChannel">getChannel</span>, <span title="Long(0L)" class="int">0</span>, <a href="#43784" title="Long">len</a><span class="delimiter">)</span>
                  <span class="keyword">val</span> <a title="org.jboss.netty.channel.ChannelFuture" id="44107">writeFile</a> = <a href="#43787" title="org.jboss.netty.channel.Channel">chan</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><a href="#44106" title="org.jboss.netty.channel.DefaultFileRegion">region</a><span class="delimiter">)</span>
                  <a href="#44107" title="org.jboss.netty.channel.ChannelFuture">writeFile</a>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><a href="#44574" title="java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" id="44574">ChannelFutureListener</a> <span class="delimiter">{</span>
                    <span class="keyword">def</span> <a title="(f: org.jboss.netty.channel.ChannelFuture)Unit" id="44578">operationComplete</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="44579">f</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> =
                      <a href="#44106" title="org.jboss.netty.channel.DefaultFileRegion">region</a>.<span title="()Unit">releaseExternalResources</span>
                  <span class="delimiter">}</span><span class="delimiter">)</span>
                  <a href="#43789" title="(future: org.jboss.netty.channel.ChannelFuture)Unit">lastly</a><span class="delimiter">(</span><a href="#44107" title="org.jboss.netty.channel.ChannelFuture">writeFile</a><span class="delimiter">)</span>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span> <span class="keyword">else</span> <a href="#43789" title="(future: org.jboss.netty.channel.ChannelFuture)Unit">lastly</a><span class="delimiter">(</span><a href="#43788" title="org.jboss.netty.channel.ChannelFuture">writeHeaders</a><span class="delimiter">)</span>
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <a title="Any" id="44584">e</a>: <span title="java.io.FileNotFoundException">FileNotFoundException</span> =&gt; <a href="#42399" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">notFound</a><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Any">_</span> =&gt; <a href="#42398" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">forbid</a><span class="delimiter">(</span><a href="#42961" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> <a title="Any" id="44598">req</a> =&gt; <a href="#42400" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">badRequest</a><span class="delimiter">(</span><a href="#44598" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Converts a raw uri to a safe system file. Attempts to prevent
   *  security holes where resources are accessed with .. paths
   *  potentially outside of the root of the web app
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(uri: String)Option[java.io.File]" id="42402">accessible</a><span class="delimiter">(</span><a title="String" id="42962">uri</a>: <span title="String">String</span><span class="delimiter">)</span> =
    <span class="delimiter">(</span><span title="util.control.Exception.Catch[Nothing]">allCatch</span>.<span title="(body: =&gt; java.lang.String)Option[java.lang.String]">opt</span> <span class="delimiter">{</span> <span title="object java.net.URLDecoder">URLDecoder</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">decode</span><span class="delimiter">(</span><a href="#42962" title="String">uri</a>, <a href="#42322" title="=&gt; java.nio.charset.Charset">utf8</a>.<span title="()java.lang.String">name</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span title="(alternative: =&gt; Option[java.lang.String])Option[java.lang.String]">orElse</span> <span class="delimiter">{</span>
      <span title="util.control.Exception.Catch[Nothing]">allCatch</span>.<span title="(body: =&gt; java.lang.String)Option[java.lang.String]">opt</span> <span class="delimiter">{</span> <span title="object java.net.URLDecoder">URLDecoder</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">decode</span><span class="delimiter">(</span><a href="#42962" title="String">uri</a>, <a href="#42324" title="=&gt; java.nio.charset.Charset">iso88591</a>.<span title="()java.lang.String">name</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span> <span title="Option[java.io.File]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Option[java.io.File]">Some</span><span class="delimiter">(</span><a title="java.lang.String" id="43000">decoded</a><span class="delimiter">)</span> =&gt;
        <a href="#43000" title="java.lang.String">decoded</a>.<span title="(x$1: Char, x$2: Char)java.lang.String">replace</span><span class="delimiter">(</span><span title="Char(\'/\')" class="char">'/'</span>, <span title="object java.io.File">File</span>.<span title="Char">separatorChar</span><span class="delimiter">)</span> <span title="Option[java.io.File]" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="None.type" id="43005">fpath</a>
            <span class="keyword">if</span><span class="delimiter">(</span><a href="#43005" title="java.lang.String">fpath</a>.<span title="(x$1: java.lang.CharSequence)Boolean">contains</span><span class="delimiter">(</span><span title="object java.io.File">File</span>.<span title="java.lang.String">separator</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;.&quot;)" class="string">&quot;.&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
               <a href="#43005" title="java.lang.String">fpath</a>.<span title="(x$1: java.lang.CharSequence)Boolean">contains</span><span class="delimiter">(</span><span title="java.lang.String(&quot;.&quot;)" class="string">&quot;.&quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="object java.io.File">File</span>.<span title="java.lang.String">separator</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
               <a href="#43005" title="java.lang.String">fpath</a>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><span title="java.lang.String(&quot;.&quot;)" class="string">&quot;.&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
               <a href="#43005" title="java.lang.String">fpath</a>.<span title="(x$1: java.lang.String)Boolean">endsWith</span><span class="delimiter">(</span><span title="java.lang.String(&quot;.&quot;)" class="string">&quot;.&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="object None">None</span>
          <span class="keyword">case</span> <a title="Some[java.io.File]" id="43008">fpath</a> =&gt;
            <span title="(x: java.io.File)Some[java.io.File]">Some</span><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><span title="(x$1: java.net.URL, x$2: java.lang.String)java.net.URL" class="keyword">new</span> java.net.<span title="java.net.URL">URL</span><span class="delimiter">(</span><a href="#44603" title="=&gt; java.net.URL">base</a>, <a href="#43008" title="java.lang.String">fpath</a><span class="delimiter">)</span>.<span title="()java.lang.String">getFile</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="None.type">_</span> =&gt; <span title="object None">None</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>