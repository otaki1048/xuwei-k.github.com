<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpPostRequestDecoder.java</title>
        <script type="text/javascript" src="../../../../../../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2011 The Netty Project
 *
 * The Netty Project licenses this file to you under the Apache License,
 * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at:
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * Repackaged for use with netty 3.x
 */</span>
<span class="keyword">package</span> org.jboss.netty.handler.codec.http;

<span class="keyword">import</span> java.io.IOException;
<span class="keyword">import</span> java.io.UnsupportedEncodingException;
<span class="keyword">import</span> java.net.URLDecoder;
<span class="keyword">import</span> java.nio.charset.Charset;
<span class="keyword">import</span> java.util.ArrayList;
<span class="keyword">import</span> java.util.List;
<span class="keyword">import</span> java.util.Map;
<span class="keyword">import</span> java.util.TreeMap;

<span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffer;
<span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffers;
<span class="keyword">import</span> org.jboss.netty.handler.codec.http.HttpPostBodyUtil.TransferEncodingMechanism;

<span class="comment">/**
 * This decoder will decode Body and can handle POST BODY.
 */</span>
public <span class="keyword">class</span> <a title="object org.jboss.netty.handler.codec.http.HttpPostRequestDecoder" id="11845">HttpPostRequestDecoder</a> <span class="delimiter">{</span>
    <span class="comment">/**
     * Factory used to create InterfaceHttpData
     */</span>
    <span class="keyword">private</span> <span class="keyword">final</span> <a href="HttpDataFactory.java.html#11887" title="org.jboss.netty.handler.codec.http.HttpDataFactory">HttpDataFactory</a> <a title="org.jboss.netty.handler.codec.http.HttpDataFactory" id="48276">factory</a>;

    <span class="comment">/**
     * Request to decode
     */</span>
    <span class="keyword">private</span> <span class="keyword">final</span> <span title="org.jboss.netty.handler.codec.http.HttpRequest">HttpRequest</span> <a title="org.jboss.netty.handler.codec.http.HttpRequest" id="48277">request</a>;

    <span class="comment">/**
     * Default charset to use
     */</span>
    <span class="keyword">private</span> <span class="keyword">final</span> Charset <a title="java.nio.charset.Charset" id="48278">charset</a>;

    <span class="comment">/**
     * Does request have a body to decode
     */</span>
    <span class="keyword">private</span> boolean <a title="Boolean" id="48279">bodyToDecode</a>;

    <span class="comment">/**
     * Does the last chunk already received
     */</span>
    <span class="keyword">private</span> boolean <a title="Boolean" id="48280">isLastChunk</a>;

    <span class="comment">/**
     * HttpDatas from Body
     */</span>
    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;<a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a>&gt; <a title="java.util.List[org.jboss.netty.handler.codec.http.InterfaceHttpData]" id="48281">bodyListHttpData</a> = <span class="keyword">new</span> ArrayList&lt;InterfaceHttpData&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;

    <span class="comment">/**
     * HttpDatas as Map from Body
     */</span>
    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;<a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a>&gt;&gt; <a title="java.util.Map[java.lang.String,java.util.List[org.jboss.netty.handler.codec.http.InterfaceHttpData]]" id="48282">bodyMapHttpData</a> = <span class="keyword">new</span> TreeMap&lt;String, List&lt;InterfaceHttpData&gt;&gt;<span class="delimiter">(</span>
            CaseIgnoringComparator.INSTANCE<span class="delimiter">)</span>;

    <span class="comment">/**
     * The current channelBuffer
     */</span>
    <span class="keyword">private</span> ChannelBuffer <a title="org.jboss.netty.buffer.ChannelBuffer" id="48283">undecodedChunk</a>;

    <span class="comment">/**
     * Does this request is a Multipart request
     */</span>
    <span class="keyword">private</span> boolean <a title="Boolean" id="48284">isMultipart</a>;

    <span class="comment">/**
     * Body HttpDatas current position
     */</span>
    <span class="keyword">private</span> int <a title="Int" id="48285">bodyListHttpDataRank</a>;

    <span class="comment">/**
     * If multipart, this is the boundary for the flobal multipart
     */</span>
    <span class="keyword">private</span> String <a title="java.lang.String" id="48286">multipartDataBoundary</a>;

    <span class="comment">/**
     * If multipart, there could be internal multiparts (mixed) to the global multipart.
     * Only one level is allowed.
     */</span>
    <span class="keyword">private</span> String <a title="java.lang.String" id="48287">multipartMixedBoundary</a>;

    <span class="comment">/**
     * Current status
     */</span>
    <span class="keyword">private</span> MultiPartStatus <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="48288">currentStatus</a> = MultiPartStatus.NOTSTARTED;

    <span class="comment">/**
     * Used in Multipart
     */</span>
    <span class="keyword">private</span> Map&lt;String, <a href="Attribute.java.html#11884" title="org.jboss.netty.handler.codec.http.Attribute">Attribute</a>&gt; <a title="java.util.Map[java.lang.String,org.jboss.netty.handler.codec.http.Attribute]" id="48289">currentFieldAttributes</a>;

    <span class="comment">/**
     * The current FileUpload that is currently in decode process
     */</span>
    <span class="keyword">private</span> <a href="FileUpload.java.html#11881" title="org.jboss.netty.handler.codec.http.FileUpload">FileUpload</a> <a title="org.jboss.netty.handler.codec.http.FileUpload" id="48290">currentFileUpload</a>;

    <span class="comment">/**
     * The current Attribute that is currently in decode process
     */</span>
    <span class="keyword">private</span> <a href="Attribute.java.html#11884" title="org.jboss.netty.handler.codec.http.Attribute">Attribute</a> <a title="org.jboss.netty.handler.codec.http.Attribute" id="48291">currentAttribute</a>;

    <span class="comment">/**
    *
    * @param request the request to decode
    * @throws NullPointerException for request
    * @throws IncompatibleDataDecoderException if the request has no body to decode
    * @throws ErrorDataDecoderException if the default charset was wrong when decoding or other errors
    */</span>
    public HttpPostRequestDecoder<a href="#11845" title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder" class="delimiter">(</a><span title="org.jboss.netty.handler.codec.http.HttpRequest">HttpRequest</span> <a title="org.jboss.netty.handler.codec.http.HttpRequest" id="48329">request</a><span class="delimiter">)</span>
            throws ErrorDataDecoderException, IncompatibleDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span><span class="keyword">new</span> DefaultHttpDataFactory<span class="delimiter">(</span>DefaultHttpDataFactory.MINSIZE<span class="delimiter">)</span>,
                request, HttpCodecUtil.DEFAULT_CHARSET<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     *
     * @param factory the factory used to create InterfaceHttpData
     * @param request the request to decode
     * @throws NullPointerException for request or factory
     * @throws IncompatibleDataDecoderException if the request has no body to decode
     * @throws ErrorDataDecoderException if the default charset was wrong when decoding or other errors
     */</span>
    public HttpPostRequestDecoder<a title="(factory: org.jboss.netty.handler.codec.http.HttpDataFactory, request: org.jboss.netty.handler.codec.http.HttpRequest)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder" id="48293" class="delimiter">(</a><a href="HttpDataFactory.java.html#11887" title="org.jboss.netty.handler.codec.http.HttpDataFactory">HttpDataFactory</a> <a title="org.jboss.netty.handler.codec.http.HttpDataFactory" id="48327">factory</a>, <span title="org.jboss.netty.handler.codec.http.HttpRequest">HttpRequest</span> <a title="org.jboss.netty.handler.codec.http.HttpRequest" id="48328">request</a><span class="delimiter">)</span>
            throws ErrorDataDecoderException, IncompatibleDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span>factory, request, HttpCodecUtil.DEFAULT_CHARSET<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     *
     * @param factory the factory used to create InterfaceHttpData
     * @param request the request to decode
     * @param charset the charset to use as default
     * @throws NullPointerException for request or charset or factory
     * @throws IncompatibleDataDecoderException if the request has no body to decode
     * @throws ErrorDataDecoderException if the default charset was wrong when decoding or other errors
     */</span>
    public HttpPostRequestDecoder<a title="(factory: org.jboss.netty.handler.codec.http.HttpDataFactory, request: org.jboss.netty.handler.codec.http.HttpRequest, charset: java.nio.charset.Charset)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder" id="48294" class="delimiter">(</a><a href="HttpDataFactory.java.html#11887" title="org.jboss.netty.handler.codec.http.HttpDataFactory">HttpDataFactory</a> <a title="org.jboss.netty.handler.codec.http.HttpDataFactory" id="48324">factory</a>, <span title="org.jboss.netty.handler.codec.http.HttpRequest">HttpRequest</span> <a title="org.jboss.netty.handler.codec.http.HttpRequest" id="48325">request</a>,
            Charset <a title="java.nio.charset.Charset" id="48326">charset</a><span class="delimiter">)</span> throws ErrorDataDecoderException,
            IncompatibleDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>factory == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException<span class="delimiter">(</span><span class="string">&quot;factory&quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>request == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException<span class="delimiter">(</span><span class="string">&quot;request&quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>charset == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException<span class="delimiter">(</span><span class="string">&quot;charset&quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">this</span>.request = request;
        HttpMethod method = request.getMethod<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>method.equals<span class="delimiter">(</span>HttpMethod.POST<span class="delimiter">)</span> || method.equals<span class="delimiter">(</span>HttpMethod.PUT<span class="delimiter">)</span> || method.equals<span class="delimiter">(</span>HttpMethod.PATCH<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            bodyToDecode = <span class="keyword">true</span>;
        <span class="delimiter">}</span>
        <span class="keyword">this</span>.charset = charset;
        <span class="keyword">this</span>.factory = factory;
        <span class="comment">// Fill default values</span>
        <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">this</span>.request.containsHeader<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TYPE<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            checkMultipart<span class="delimiter">(</span><span class="keyword">this</span>.request.getHeader<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TYPE<span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            isMultipart = <span class="keyword">false</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>!bodyToDecode<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IncompatibleDataDecoderException<span class="delimiter">(</span><span class="string">&quot;No Body to decode&quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>!<span class="keyword">this</span>.request.isChunked<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            undecodedChunk = <span class="keyword">this</span>.request.getContent<span class="delimiter">(</span><span class="delimiter">)</span>;
            isLastChunk = <span class="keyword">true</span>;
            parseBody<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * states follow
     * NOTSTARTED PREAMBLE (
     *  (HEADERDELIMITER DISPOSITION (FIELD | FILEUPLOAD))*
     *  (HEADERDELIMITER DISPOSITION MIXEDPREAMBLE
     *     (MIXEDDELIMITER MIXEDDISPOSITION MIXEDFILEUPLOAD)+
     *   MIXEDCLOSEDELIMITER)*
     * CLOSEDELIMITER)+ EPILOGUE
     *
     *  First status is: NOSTARTED

        Content-type: multipart/form-data, boundary=AaB03x     =&gt; PREAMBLE in Header

        --AaB03x                                               =&gt; HEADERDELIMITER
        content-disposition: form-data; name=&quot;field1&quot;          =&gt; DISPOSITION

        Joe Blow                                               =&gt; FIELD
        --AaB03x                                               =&gt; HEADERDELIMITER
        content-disposition: form-data; name=&quot;pics&quot;            =&gt; DISPOSITION
        Content-type: multipart/mixed, boundary=BbC04y

        --BbC04y                                               =&gt; MIXEDDELIMITER
        Content-disposition: attachment; filename=&quot;file1.txt&quot;  =&gt; MIXEDDISPOSITION
        Content-Type: text/plain

        ... contents of file1.txt ...                          =&gt; MIXEDFILEUPLOAD
        --BbC04y                                               =&gt; MIXEDDELIMITER
        Content-disposition: file; filename=&quot;file2.gif&quot;  =&gt; MIXEDDISPOSITION
        Content-type: image/gif
        Content-Transfer-Encoding: binary

          ...contents of file2.gif...                          =&gt; MIXEDFILEUPLOAD
        --BbC04y--                                             =&gt; MIXEDCLOSEDELIMITER
        --AaB03x--                                             =&gt; CLOSEDELIMITER

       Once CLOSEDELIMITER is found, last status is EPILOGUE
     */</span>
    <span class="keyword">private</span> enum <a title="object org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="47242">MultiPartStatus</a> <span class="delimiter">{</span>
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110431">NOTSTARTED</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110432">PREAMBLE</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110433">HEADERDELIMITER</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110434">DISPOSITION</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110435">FIELD</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110436">FILEUPLOAD</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110437">MIXEDPREAMBLE</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110438">MIXEDDELIMITER</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110439">MIXEDDISPOSITION</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110440">MIXEDFILEUPLOAD</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110441">MIXEDCLOSEDELIMITER</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110442">CLOSEDELIMITER</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110443">PREEPILOGUE</a>,
        <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110444">EPILOGUE</a>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Check from the request ContentType if this request is a Multipart request.
     * @param contentType
     * @throws ErrorDataDecoderException
     */</span>
    <span class="keyword">private</span> void <a title="(contentType: java.lang.String)Unit" id="48295">checkMultipart</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110488">contentType</a><span class="delimiter">)</span>
            throws ErrorDataDecoderException <span class="delimiter">{</span>
        <span class="comment">// Check if Post using &quot;multipart/form-data; boundary=--89421926422648&quot;</span>
        String<span class="delimiter">[</span><span class="delimiter">]</span> headerContentType = splitHeaderContentType<span class="delimiter">(</span>contentType<span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>headerContentType<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span>.toLowerCase<span class="delimiter">(</span><span class="delimiter">)</span>.startsWith<span class="delimiter">(</span>
                HttpHeaders.Values.MULTIPART_FORM_DATA<span class="delimiter">)</span> &amp;&amp;
                headerContentType<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>.toLowerCase<span class="delimiter">(</span><span class="delimiter">)</span>.startsWith<span class="delimiter">(</span>
                        HttpHeaders.Values.BOUNDARY<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            String<span class="delimiter">[</span><span class="delimiter">]</span> boundary = headerContentType<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>.split<span class="delimiter">(</span><span class="string">&quot;=&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>boundary.length != <span class="int">2</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span><span class="string">&quot;Needs a boundary value&quot;</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            multipartDataBoundary = <span class="string">&quot;--&quot;</span> + boundary<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>;
            isMultipart = <span class="keyword">true</span>;
            currentStatus = MultiPartStatus.HEADERDELIMITER;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            isMultipart = <span class="keyword">false</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * True if this request is a Multipart request
     * @return True if this request is a Multipart request
     */</span>
    public boolean <a title="()Boolean" id="48296">isMultipart</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> isMultipart;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * This method returns a List of all HttpDatas from body.&lt;br&gt;
     *
     * If chunked, all chunks must have been offered using offer() method.
     * If not, NotEnoughDataDecoderException will be raised.
     *
     * @return the list of HttpDatas from Body part for POST method
     * @throws NotEnoughDataDecoderException Need more chunks
     */</span>
    public List&lt;<a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a>&gt; <a title="()java.util.List[org.jboss.netty.handler.codec.http.InterfaceHttpData]" id="48297">getBodyHttpDatas</a><span class="delimiter">(</span><span class="delimiter">)</span>
            throws NotEnoughDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>!isLastChunk<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> bodyListHttpData;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * This method returns a List of all HttpDatas with the given name from body.&lt;br&gt;
     *
     * If chunked, all chunks must have been offered using offer() method.
     * If not, NotEnoughDataDecoderException will be raised.

     * @param name
     * @return All Body HttpDatas with the given name (ignore case)
     * @throws NotEnoughDataDecoderException need more chunks
     */</span>
    public List&lt;<a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a>&gt; <a title="(name: java.lang.String)java.util.List[org.jboss.netty.handler.codec.http.InterfaceHttpData]" id="48298">getBodyHttpDatas</a><span class="delimiter">(</span>String <a title="java.lang.String" id="49597">name</a><span class="delimiter">)</span>
            throws NotEnoughDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>!isLastChunk<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> bodyMapHttpData.get<span class="delimiter">(</span>name<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * This method returns the first InterfaceHttpData with the given name from body.&lt;br&gt;
     *
     * If chunked, all chunks must have been offered using offer() method.
     * If not, NotEnoughDataDecoderException will be raised.
    *
    * @param name
    * @return The first Body InterfaceHttpData with the given name (ignore case)
    * @throws NotEnoughDataDecoderException need more chunks
    */</span>
    public <a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="(name: java.lang.String)org.jboss.netty.handler.codec.http.InterfaceHttpData" id="48299">getBodyHttpData</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110489">name</a><span class="delimiter">)</span>
            throws NotEnoughDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>!isLastChunk<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        List&lt;InterfaceHttpData&gt; list = bodyMapHttpData.get<span class="delimiter">(</span>name<span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>list != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> list.get<span class="delimiter">(</span><span class="int">0</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Initialized the internals from a new chunk
     * @param chunk the new received chunk
     * @throws ErrorDataDecoderException if there is a problem with the charset decoding or
     *          other errors
     */</span>
    public void <a title="(chunk: org.jboss.netty.handler.codec.http.HttpChunk)Unit" id="48300">offer</a><span class="delimiter">(</span><span title="org.jboss.netty.handler.codec.http.HttpChunk">HttpChunk</span> <a title="org.jboss.netty.handler.codec.http.HttpChunk" id="49303">chunk</a><span class="delimiter">)</span> throws ErrorDataDecoderException <span class="delimiter">{</span>
        ChannelBuffer chunked = chunk.getContent<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>undecodedChunk == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            undecodedChunk = chunked;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="comment">//undecodedChunk = ChannelBuffers.wrappedBuffer(undecodedChunk, chunk.getContent());</span>
            <span class="comment">// less memory usage</span>
            undecodedChunk = ChannelBuffers.wrappedBuffer<span class="delimiter">(</span>
                    undecodedChunk, chunked<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>chunk.isLast<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            isLastChunk = <span class="keyword">true</span>;
        <span class="delimiter">}</span>
        parseBody<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * True if at current status, there is an available decoded InterfaceHttpData from the Body.
     *
     * This method works for chunked and not chunked request.
     *
     * @return True if at current status, there is a decoded InterfaceHttpData
     * @throws EndOfDataDecoderException No more data will be available
     */</span>
    public boolean <a title="()Boolean" id="48301">hasNext</a><span class="delimiter">(</span><span class="delimiter">)</span> throws EndOfDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.EPILOGUE<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// OK except if end of list</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>bodyListHttpDataRank &gt;= bodyListHttpData.size<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> EndOfDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">return</span> bodyListHttpData.size<span class="delimiter">(</span><span class="delimiter">)</span> &gt; <span class="int">0</span> &amp;&amp;
                bodyListHttpDataRank &lt; bodyListHttpData.size<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Returns the next available InterfaceHttpData or null if, at the time it is called, there is no more
     * available InterfaceHttpData. A subsequent call to offer(httpChunk) could enable more data.
     *
     * @return the next available InterfaceHttpData or null if none
     * @throws EndOfDataDecoderException No more data will be available
     */</span>
    public <a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="()org.jboss.netty.handler.codec.http.InterfaceHttpData" id="48302">next</a><span class="delimiter">(</span><span class="delimiter">)</span> throws EndOfDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>hasNext<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> bodyListHttpData.get<span class="delimiter">(</span>bodyListHttpDataRank++<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * This method will parse as much as possible data and fill the list and map
     * @throws ErrorDataDecoderException if there is a problem with the charset decoding or
     *          other errors
     */</span>
    <span class="keyword">private</span> void <a title="()Unit" id="48303">parseBody</a><span class="delimiter">(</span><span class="delimiter">)</span> throws ErrorDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.PREEPILOGUE ||
                currentStatus == MultiPartStatus.EPILOGUE<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>isLastChunk<span class="delimiter">)</span> <span class="delimiter">{</span>
                currentStatus = MultiPartStatus.EPILOGUE;
            <span class="delimiter">}</span>
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>isMultipart<span class="delimiter">)</span> <span class="delimiter">{</span>
            parseBodyMultipart<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            parseBodyAttributes<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Utility function to add a new decoded data
     * @param data
     */</span>
    <span class="keyword">private</span> void <a title="(data: org.jboss.netty.handler.codec.http.InterfaceHttpData)Unit" id="48304">addHttpData</a><span class="delimiter">(</span><a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="org.jboss.netty.handler.codec.http.InterfaceHttpData" id="110490">data</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>data == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        List&lt;InterfaceHttpData&gt; datas = bodyMapHttpData.get<span class="delimiter">(</span>data.getName<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>datas == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            datas = <span class="keyword">new</span> ArrayList&lt;InterfaceHttpData&gt;<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span>;
            bodyMapHttpData.put<span class="delimiter">(</span>data.getName<span class="delimiter">(</span><span class="delimiter">)</span>, datas<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        datas.add<span class="delimiter">(</span>data<span class="delimiter">)</span>;
        bodyListHttpData.add<span class="delimiter">(</span>data<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
      * This method fill the map and list with as much Attribute as possible from Body in
      * not Multipart mode.
      *
      * @throws ErrorDataDecoderException if there is a problem with the charset decoding or
      *          other errors
      */</span>
    <span class="keyword">private</span> void <a title="()Unit" id="48305">parseBodyAttributes</a><span class="delimiter">(</span><span class="delimiter">)</span> throws ErrorDataDecoderException <span class="delimiter">{</span>
        int firstpos = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
        int currentpos = firstpos;
        int equalpos = firstpos;
        int ampersandpos = firstpos;
        <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.NOTSTARTED<span class="delimiter">)</span> <span class="delimiter">{</span>
            currentStatus = MultiPartStatus.DISPOSITION;
        <span class="delimiter">}</span>
        boolean contRead = <span class="keyword">true</span>;
        <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">while</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; contRead<span class="delimiter">)</span> <span class="delimiter">{</span>
                char read = <span class="delimiter">(</span>char<span class="delimiter">)</span> undecodedChunk.readUnsignedByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                currentpos++;
                switch <span class="delimiter">(</span>currentStatus<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">case</span> DISPOSITION<span class="comment">:// search '='</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>read == <span class="char">'='</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        currentStatus = MultiPartStatus.FIELD;
                        equalpos = currentpos - <span class="int">1</span>;
                        String key = decodeAttribute<span class="delimiter">(</span>
                                undecodedChunk.toString<span class="delimiter">(</span>firstpos, equalpos - firstpos, charset<span class="delimiter">)</span>,
                                charset<span class="delimiter">)</span>;
                        currentAttribute = factory.createAttribute<span class="delimiter">(</span>request, key<span class="delimiter">)</span>;
                        firstpos = currentpos;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>read == <span class="char">'&amp;'</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// special empty FIELD</span>
                        currentStatus = MultiPartStatus.DISPOSITION;
                        ampersandpos = currentpos - <span class="int">1</span>;
                        String key = decodeAttribute<span class="delimiter">(</span>undecodedChunk.toString<span class="delimiter">(</span>firstpos, ampersandpos - firstpos, charset<span class="delimiter">)</span>, charset<span class="delimiter">)</span>;
                        currentAttribute = factory.createAttribute<span class="delimiter">(</span>request, key<span class="delimiter">)</span>;
                        currentAttribute.setValue<span class="delimiter">(</span><span class="string">&quot;&quot;</span><span class="delimiter">)</span>; <span class="comment">// empty</span>
                        addHttpData<span class="delimiter">(</span>currentAttribute<span class="delimiter">)</span>;
                        currentAttribute = <span class="keyword">null</span>;
                        firstpos = currentpos;
                        contRead = <span class="keyword">true</span>;
                    <span class="delimiter">}</span>
                    break;
                <span class="keyword">case</span> FIELD<span class="comment">:// search '&amp;' or end of line</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>read == <span class="char">'&amp;'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        currentStatus = MultiPartStatus.DISPOSITION;
                        ampersandpos = currentpos - <span class="int">1</span>;
                        setFinalBuffer<span class="delimiter">(</span>undecodedChunk.slice<span class="delimiter">(</span>firstpos, ampersandpos - firstpos<span class="delimiter">)</span><span class="delimiter">)</span>;
                        firstpos = currentpos;
                        contRead = <span class="keyword">true</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>read == HttpCodecUtil.CR<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            read = <span class="delimiter">(</span>char<span class="delimiter">)</span> undecodedChunk.readUnsignedByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                            currentpos++;
                            <span class="keyword">if</span> <span class="delimiter">(</span>read == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                                currentStatus = MultiPartStatus.PREEPILOGUE;
                                ampersandpos = currentpos - <span class="int">2</span>;
                                setFinalBuffer<span class="delimiter">(</span>
                                        undecodedChunk.slice<span class="delimiter">(</span>firstpos, ampersandpos - firstpos<span class="delimiter">)</span><span class="delimiter">)</span>;
                                firstpos = currentpos;
                                contRead = <span class="keyword">false</span>;
                            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                                <span class="comment">// Error</span>
                                contRead = <span class="keyword">false</span>;
                                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span><span class="string">&quot;Bad end of line&quot;</span><span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                            currentpos--;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>read == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                        currentStatus = MultiPartStatus.PREEPILOGUE;
                        ampersandpos = currentpos - <span class="int">1</span>;
                        setFinalBuffer<span class="delimiter">(</span>
                                undecodedChunk.slice<span class="delimiter">(</span>firstpos, ampersandpos - firstpos<span class="delimiter">)</span><span class="delimiter">)</span>;
                        firstpos = currentpos;
                        contRead = <span class="keyword">false</span>;
                    <span class="delimiter">}</span>
                    break;
                default:
                    <span class="comment">// just stop</span>
                    contRead = <span class="keyword">false</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>isLastChunk &amp;&amp; currentAttribute != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// special case</span>
                ampersandpos = currentpos;
                <span class="keyword">if</span> <span class="delimiter">(</span>ampersandpos &gt; firstpos<span class="delimiter">)</span> <span class="delimiter">{</span>
                    setFinalBuffer<span class="delimiter">(</span>
                            undecodedChunk.slice<span class="delimiter">(</span>firstpos, ampersandpos - firstpos<span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>! currentAttribute.isCompleted<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    setFinalBuffer<span class="delimiter">(</span>ChannelBuffers.EMPTY_BUFFER<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                firstpos = currentpos;
                currentStatus = MultiPartStatus.EPILOGUE;
                <span class="keyword">return</span>;
            <span class="delimiter">}</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>contRead &amp;&amp; currentAttribute != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// reset index except if to continue in case of FIELD status</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.FIELD<span class="delimiter">)</span> <span class="delimiter">{</span>
                    currentAttribute.addContent<span class="delimiter">(</span>
                            undecodedChunk.slice<span class="delimiter">(</span>firstpos, currentpos - firstpos<span class="delimiter">)</span>,
                            <span class="keyword">false</span><span class="delimiter">)</span>;
                    firstpos = currentpos;
                <span class="delimiter">}</span>
                undecodedChunk.readerIndex<span class="delimiter">(</span>firstpos<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="comment">// end of line so keep index</span>
            <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>ErrorDataDecoderException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// error while decoding</span>
            undecodedChunk.readerIndex<span class="delimiter">(</span>firstpos<span class="delimiter">)</span>;
            <span class="keyword">throw</span> e;
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// error while decoding</span>
            undecodedChunk.readerIndex<span class="delimiter">(</span>firstpos<span class="delimiter">)</span>;
            <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> void <a title="(buffer: org.jboss.netty.buffer.ChannelBuffer)Unit" id="48306">setFinalBuffer</a><span class="delimiter">(</span>ChannelBuffer <a title="org.jboss.netty.buffer.ChannelBuffer" id="110491">buffer</a><span class="delimiter">)</span> throws ErrorDataDecoderException, IOException <span class="delimiter">{</span>
        currentAttribute.addContent<span class="delimiter">(</span>buffer, <span class="keyword">true</span><span class="delimiter">)</span>;
        String value = decodeAttribute<span class="delimiter">(</span>
                currentAttribute.getChannelBuffer<span class="delimiter">(</span><span class="delimiter">)</span>.toString<span class="delimiter">(</span>charset<span class="delimiter">)</span>,
                charset<span class="delimiter">)</span>;
        currentAttribute.setValue<span class="delimiter">(</span>value<span class="delimiter">)</span>;
        addHttpData<span class="delimiter">(</span>currentAttribute<span class="delimiter">)</span>;
        currentAttribute = <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Decode component
     * @param s
     * @param charset
     * @return the decoded component
     * @throws ErrorDataDecoderException
     */</span>
    <span class="keyword">private</span> static String <a title="(s: java.lang.String, charset: java.nio.charset.Charset)java.lang.String" id="47243">decodeAttribute</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110450">s</a>, Charset <a title="java.nio.charset.Charset" id="110451">charset</a><span class="delimiter">)</span>
            throws ErrorDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>s == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;
        <span class="delimiter">}</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> URLDecoder.decode<span class="delimiter">(</span>s, charset.name<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>UnsupportedEncodingException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>charset.toString<span class="delimiter">(</span><span class="delimiter">)</span>, e<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parse the Body for multipart
     *
     * @throws ErrorDataDecoderException if there is a problem with the charset decoding or other errors
     */</span>
    <span class="keyword">private</span> void <a title="()Unit" id="48307">parseBodyMultipart</a><span class="delimiter">(</span><span class="delimiter">)</span> throws ErrorDataDecoderException <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>undecodedChunk == <span class="keyword">null</span> || undecodedChunk.readableBytes<span class="delimiter">(</span><span class="delimiter">)</span> == <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// nothing to decode</span>
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        InterfaceHttpData data = decodeMultipart<span class="delimiter">(</span>currentStatus<span class="delimiter">)</span>;
        <span class="keyword">while</span> <span class="delimiter">(</span>data != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            addHttpData<span class="delimiter">(</span>data<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.PREEPILOGUE ||
                    currentStatus == MultiPartStatus.EPILOGUE<span class="delimiter">)</span> <span class="delimiter">{</span>
                break;
            <span class="delimiter">}</span>
            data = decodeMultipart<span class="delimiter">(</span>currentStatus<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Decode a multipart request by pieces&lt;br&gt;
     * &lt;br&gt;
     * NOTSTARTED PREAMBLE (&lt;br&gt;
     *  (HEADERDELIMITER DISPOSITION (FIELD | FILEUPLOAD))*&lt;br&gt;
     *  (HEADERDELIMITER DISPOSITION MIXEDPREAMBLE&lt;br&gt;
     *     (MIXEDDELIMITER MIXEDDISPOSITION MIXEDFILEUPLOAD)+&lt;br&gt;
     *   MIXEDCLOSEDELIMITER)*&lt;br&gt;
     * CLOSEDELIMITER)+ EPILOGUE&lt;br&gt;
     *
     * Inspired from HttpMessageDecoder
     *
     * @param state
     * @return the next decoded InterfaceHttpData or null if none until now.
     * @throws ErrorDataDecoderException if an error occurs
     */</span>
    <span class="keyword">private</span> <a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="(state: org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus)org.jboss.netty.handler.codec.http.InterfaceHttpData" id="48308">decodeMultipart</a><span class="delimiter">(</span>MultiPartStatus <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110492">state</a><span class="delimiter">)</span>
            throws ErrorDataDecoderException <span class="delimiter">{</span>
        switch <span class="delimiter">(</span>state<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> NOTSTARTED:
            <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>
                    <span class="string">&quot;Should not be called with the current status&quot;</span><span class="delimiter">)</span>;
        <span class="keyword">case</span> PREAMBLE:
            <span class="comment">// Content-type: multipart/form-data, boundary=AaB03x</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>
                    <span class="string">&quot;Should not be called with the current status&quot;</span><span class="delimiter">)</span>;
        <span class="keyword">case</span> HEADERDELIMITER: <span class="delimiter">{</span>
            <span class="comment">// --AaB03x or --AaB03x--</span>
            <span class="keyword">return</span> findMultipartDelimiter<span class="delimiter">(</span>multipartDataBoundary,
                    MultiPartStatus.DISPOSITION, MultiPartStatus.PREEPILOGUE<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> DISPOSITION: <span class="delimiter">{</span>
            <span class="comment">//  content-disposition: form-data; name=&quot;field1&quot;</span>
            <span class="comment">//  content-disposition: form-data; name=&quot;pics&quot;; filename=&quot;file1.txt&quot;</span>
            <span class="comment">// and other immediate values like</span>
            <span class="comment">//  Content-type: image/gif</span>
            <span class="comment">//  Content-Type: text/plain</span>
            <span class="comment">//  Content-Type: text/plain; charset=ISO-8859-1</span>
            <span class="comment">//  Content-Transfer-Encoding: binary</span>
            <span class="comment">// The following line implies a change of mode (mixed mode)</span>
            <span class="comment">//  Content-type: multipart/mixed, boundary=BbC04y</span>
            <span class="keyword">return</span> findMultipartDisposition<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> FIELD: <span class="delimiter">{</span>
            <span class="comment">// Now get value according to Content-Type and Charset</span>
            Charset localCharset = <span class="keyword">null</span>;
            Attribute charsetAttribute = currentFieldAttributes
                    .get<span class="delimiter">(</span>HttpHeaders.Values.CHARSET<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>charsetAttribute != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    localCharset = Charset.forName<span class="delimiter">(</span>charsetAttribute.getValue<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            Attribute nameAttribute = currentFieldAttributes
                .get<span class="delimiter">(</span>HttpPostBodyUtil.NAME<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>currentAttribute == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    currentAttribute = factory.createAttribute<span class="delimiter">(</span>request, nameAttribute
                            .getValue<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NullPointerException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IllegalArgumentException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>localCharset != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    currentAttribute.setCharset<span class="delimiter">(</span>localCharset<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <span class="comment">// load data</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                loadFieldMultipart<span class="delimiter">(</span>multipartDataBoundary<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NotEnoughDataDecoderException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="keyword">null</span>;
            <span class="delimiter">}</span>
            Attribute finalAttribute = currentAttribute;
            currentAttribute = <span class="keyword">null</span>;
            currentFieldAttributes = <span class="keyword">null</span>;
            <span class="comment">// ready to load the next one</span>
            currentStatus = MultiPartStatus.HEADERDELIMITER;
            <span class="keyword">return</span> finalAttribute;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> FILEUPLOAD: <span class="delimiter">{</span>
            <span class="comment">// eventually restart from existing FileUpload</span>
            <span class="keyword">return</span> getFileUpload<span class="delimiter">(</span>multipartDataBoundary<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> MIXEDDELIMITER: <span class="delimiter">{</span>
            <span class="comment">// --AaB03x or --AaB03x--</span>
            <span class="comment">// Note that currentFieldAttributes exists</span>
            <span class="keyword">return</span> findMultipartDelimiter<span class="delimiter">(</span>multipartMixedBoundary,
                    MultiPartStatus.MIXEDDISPOSITION,
                    MultiPartStatus.HEADERDELIMITER<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> MIXEDDISPOSITION: <span class="delimiter">{</span>
            <span class="keyword">return</span> findMultipartDisposition<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> MIXEDFILEUPLOAD: <span class="delimiter">{</span>
            <span class="comment">// eventually restart from existing FileUpload</span>
            <span class="keyword">return</span> getFileUpload<span class="delimiter">(</span>multipartMixedBoundary<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> PREEPILOGUE:
            <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="keyword">case</span> EPILOGUE:
            <span class="keyword">return</span> <span class="keyword">null</span>;
        default:
            <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span><span class="string">&quot;Shouldn't reach here.&quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Find the next Multipart Delimiter
     * @param delimiter delimiter to find
     * @param dispositionStatus the next status if the delimiter is a start
     * @param closeDelimiterStatus the next status if the delimiter is a close delimiter
     * @return the next InterfaceHttpData if any
     * @throws ErrorDataDecoderException
     */</span>
    <span class="keyword">private</span> <a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="(delimiter: java.lang.String, dispositionStatus: org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus, closeDelimiterStatus: org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus)org.jboss.netty.handler.codec.http.InterfaceHttpData" id="48309">findMultipartDelimiter</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110493">delimiter</a>,
            MultiPartStatus <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110494">dispositionStatus</a>,
            MultiPartStatus <a title="org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.MultiPartStatus" id="110495">closeDelimiterStatus</a><span class="delimiter">)</span>
            throws ErrorDataDecoderException <span class="delimiter">{</span>
        <span class="comment">// --AaB03x or --AaB03x--</span>
        int readerIndex = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
        HttpPostBodyUtil.skipControlCharacters<span class="delimiter">(</span>undecodedChunk<span class="delimiter">)</span>;
        skipOneLine<span class="delimiter">(</span><span class="delimiter">)</span>;
        String newline;
        <span class="keyword">try</span> <span class="delimiter">{</span>
            newline = readLine<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NotEnoughDataDecoderException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            undecodedChunk.readerIndex<span class="delimiter">(</span>readerIndex<span class="delimiter">)</span>;
            <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>newline.equals<span class="delimiter">(</span>delimiter<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            currentStatus = dispositionStatus;
            <span class="keyword">return</span> decodeMultipart<span class="delimiter">(</span>dispositionStatus<span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>newline.equals<span class="delimiter">(</span>delimiter + <span class="string">&quot;--&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// CLOSEDELIMITER or MIXED CLOSEDELIMITER found</span>
            currentStatus = closeDelimiterStatus;
            <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.HEADERDELIMITER<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// MIXEDCLOSEDELIMITER</span>
                <span class="comment">// end of the Mixed part</span>
                currentFieldAttributes = <span class="keyword">null</span>;
                <span class="keyword">return</span> decodeMultipart<span class="delimiter">(</span>MultiPartStatus.HEADERDELIMITER<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="delimiter">}</span>
        undecodedChunk.readerIndex<span class="delimiter">(</span>readerIndex<span class="delimiter">)</span>;
        <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span><span class="string">&quot;No Multipart delimiter found&quot;</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Find the next Disposition
     * @return the next InterfaceHttpData if any
     * @throws ErrorDataDecoderException
     */</span>
    <span class="keyword">private</span> <a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="()org.jboss.netty.handler.codec.http.InterfaceHttpData" id="48310">findMultipartDisposition</a><span class="delimiter">(</span><span class="delimiter">)</span>
            throws ErrorDataDecoderException <span class="delimiter">{</span>
        int readerIndex = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.DISPOSITION<span class="delimiter">)</span> <span class="delimiter">{</span>
            currentFieldAttributes = <span class="keyword">new</span> TreeMap&lt;String, Attribute&gt;<span class="delimiter">(</span>
                    CaseIgnoringComparator.INSTANCE<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="comment">// read many lines until empty line with newline found! Store all data</span>
        <span class="keyword">while</span> <span class="delimiter">(</span>!skipOneLine<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            HttpPostBodyUtil.skipControlCharacters<span class="delimiter">(</span>undecodedChunk<span class="delimiter">)</span>;
            String newline;
            <span class="keyword">try</span> <span class="delimiter">{</span>
                newline = readLine<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NotEnoughDataDecoderException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                undecodedChunk.readerIndex<span class="delimiter">(</span>readerIndex<span class="delimiter">)</span>;
                <span class="keyword">return</span> <span class="keyword">null</span>;
            <span class="delimiter">}</span>
            String<span class="delimiter">[</span><span class="delimiter">]</span> contents = splitMultipartHeader<span class="delimiter">(</span>newline<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>contents<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span>.equalsIgnoreCase<span class="delimiter">(</span>HttpPostBodyUtil.CONTENT_DISPOSITION<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                boolean checkSecondArg = <span class="keyword">false</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.DISPOSITION<span class="delimiter">)</span> <span class="delimiter">{</span>
                    checkSecondArg = contents<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>
                            .equalsIgnoreCase<span class="delimiter">(</span>HttpPostBodyUtil.FORM_DATA<span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    checkSecondArg = contents<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>
                            .equalsIgnoreCase<span class="delimiter">(</span>HttpPostBodyUtil.ATTACHMENT<span class="delimiter">)</span> ||
                            contents<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>
                            .equalsIgnoreCase<span class="delimiter">(</span>HttpPostBodyUtil.FILE<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>checkSecondArg<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="comment">// read next values and store them in the map as Attribute</span>
                    <span class="keyword">for</span> <span class="delimiter">(</span>int i = <span class="int">2</span>; i &lt; contents.length; i ++<span class="delimiter">)</span> <span class="delimiter">{</span>
                        String<span class="delimiter">[</span><span class="delimiter">]</span> values = contents<span class="delimiter">[</span>i<span class="delimiter">]</span>.split<span class="delimiter">(</span><span class="string">&quot;=&quot;</span><span class="delimiter">)</span>;
                        Attribute attribute;
                        <span class="keyword">try</span> <span class="delimiter">{</span>
                            attribute = factory.createAttribute<span class="delimiter">(</span>request, values<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span>.trim<span class="delimiter">(</span><span class="delimiter">)</span>,
                                    decodeAttribute<span class="delimiter">(</span>cleanString<span class="delimiter">(</span>values<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span><span class="delimiter">)</span>, charset<span class="delimiter">)</span><span class="delimiter">)</span>;
                        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NullPointerException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                            <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IllegalArgumentException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                            <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                        <span class="delimiter">}</span>
                        currentFieldAttributes.put<span class="delimiter">(</span>attribute.getName<span class="delimiter">(</span><span class="delimiter">)</span>,
                                attribute<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>contents<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span>
                    .equalsIgnoreCase<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TRANSFER_ENCODING<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                Attribute attribute;
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    attribute = factory.createAttribute<span class="delimiter">(</span>request,
                            HttpHeaders.Names.CONTENT_TRANSFER_ENCODING,
                            cleanString<span class="delimiter">(</span>contents<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NullPointerException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IllegalArgumentException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                currentFieldAttributes.put<span class="delimiter">(</span>
                        HttpHeaders.Names.CONTENT_TRANSFER_ENCODING, attribute<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>contents<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span>
                    .equalsIgnoreCase<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_LENGTH<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                Attribute attribute;
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    attribute = factory.createAttribute<span class="delimiter">(</span>request,
                            HttpHeaders.Names.CONTENT_LENGTH,
                            cleanString<span class="delimiter">(</span>contents<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NullPointerException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IllegalArgumentException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                currentFieldAttributes.put<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_LENGTH,
                        attribute<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>contents<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span>.equalsIgnoreCase<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TYPE<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// Take care of possible &quot;multipart/mixed&quot;</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>contents<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>.equalsIgnoreCase<span class="delimiter">(</span>HttpPostBodyUtil.MULTIPART_MIXED<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.DISPOSITION<span class="delimiter">)</span> <span class="delimiter">{</span>
                        String<span class="delimiter">[</span><span class="delimiter">]</span> values = contents<span class="delimiter">[</span><span class="int">2</span><span class="delimiter">]</span>.split<span class="delimiter">(</span><span class="string">&quot;=&quot;</span><span class="delimiter">)</span>;
                        multipartMixedBoundary = <span class="string">&quot;--&quot;</span> + values<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span>;
                        currentStatus = MultiPartStatus.MIXEDDELIMITER;
                        <span class="keyword">return</span> decodeMultipart<span class="delimiter">(</span>MultiPartStatus.MIXEDDELIMITER<span class="delimiter">)</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>
                                <span class="string">&quot;Mixed Multipart found in a previous Mixed Multipart&quot;</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="keyword">for</span> <span class="delimiter">(</span>int i = <span class="int">1</span>; i &lt; contents.length; i ++<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>contents<span class="delimiter">[</span>i<span class="delimiter">]</span>.toLowerCase<span class="delimiter">(</span><span class="delimiter">)</span>.startsWith<span class="delimiter">(</span>
                                HttpHeaders.Values.CHARSET<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            String<span class="delimiter">[</span><span class="delimiter">]</span> values = contents<span class="delimiter">[</span>i<span class="delimiter">]</span>.split<span class="delimiter">(</span><span class="string">&quot;=&quot;</span><span class="delimiter">)</span>;
                            Attribute attribute;
                            <span class="keyword">try</span> <span class="delimiter">{</span>
                                attribute = factory.createAttribute<span class="delimiter">(</span>request,
                                        HttpHeaders.Values.CHARSET,
                                        cleanString<span class="delimiter">(</span>values<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NullPointerException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IllegalArgumentException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                            currentFieldAttributes.put<span class="delimiter">(</span>HttpHeaders.Values.CHARSET,
                                    attribute<span class="delimiter">)</span>;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                            Attribute attribute;
                            <span class="keyword">try</span> <span class="delimiter">{</span>
                                attribute = factory.createAttribute<span class="delimiter">(</span>request,
                                        contents<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span>.trim<span class="delimiter">(</span><span class="delimiter">)</span>,
                                        decodeAttribute<span class="delimiter">(</span>cleanString<span class="delimiter">(</span>contents<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span>, charset<span class="delimiter">)</span><span class="delimiter">)</span>;
                            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NullPointerException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IllegalArgumentException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                            currentFieldAttributes.put<span class="delimiter">(</span>attribute.getName<span class="delimiter">(</span><span class="delimiter">)</span>,
                                    attribute<span class="delimiter">)</span>;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span><span class="string">&quot;Unknown Params: &quot;</span> +
                        newline<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="comment">// Is it a FileUpload</span>
        Attribute filenameAttribute = currentFieldAttributes
                .get<span class="delimiter">(</span>HttpPostBodyUtil.FILENAME<span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.DISPOSITION<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>filenameAttribute != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// FileUpload</span>
                currentStatus = MultiPartStatus.FILEUPLOAD;
                <span class="comment">// do not change the buffer position</span>
                <span class="keyword">return</span> decodeMultipart<span class="delimiter">(</span>MultiPartStatus.FILEUPLOAD<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="comment">// Field</span>
                currentStatus = MultiPartStatus.FIELD;
                <span class="comment">// do not change the buffer position</span>
                <span class="keyword">return</span> decodeMultipart<span class="delimiter">(</span>MultiPartStatus.FIELD<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>filenameAttribute != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// FileUpload</span>
                currentStatus = MultiPartStatus.MIXEDFILEUPLOAD;
                <span class="comment">// do not change the buffer position</span>
                <span class="keyword">return</span> decodeMultipart<span class="delimiter">(</span>MultiPartStatus.MIXEDFILEUPLOAD<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="comment">// Field is not supported in MIXED mode</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span><span class="string">&quot;Filename not found&quot;</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Get the FileUpload (new one or current one)
     * @param delimiter the delimiter to use
     * @return the InterfaceHttpData if any
     * @throws ErrorDataDecoderException
     */</span>
    <span class="keyword">private</span> <a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="(delimiter: java.lang.String)org.jboss.netty.handler.codec.http.InterfaceHttpData" id="48311">getFileUpload</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110496">delimiter</a><span class="delimiter">)</span>
            throws ErrorDataDecoderException <span class="delimiter">{</span>
        <span class="comment">// eventually restart from existing FileUpload</span>
        <span class="comment">// Now get value according to Content-Type and Charset</span>
        Attribute encoding = currentFieldAttributes
                .get<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TRANSFER_ENCODING<span class="delimiter">)</span>;
        Charset localCharset = charset;
        <span class="comment">// Default</span>
        TransferEncodingMechanism mechanism = TransferEncodingMechanism.BIT7;
        <span class="keyword">if</span> <span class="delimiter">(</span>encoding != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            String code;
            <span class="keyword">try</span> <span class="delimiter">{</span>
                code = encoding.getValue<span class="delimiter">(</span><span class="delimiter">)</span>.toLowerCase<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>code.equals<span class="delimiter">(</span>HttpPostBodyUtil.TransferEncodingMechanism.BIT7.value<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                localCharset = HttpPostBodyUtil.US_ASCII;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>code.equals<span class="delimiter">(</span>HttpPostBodyUtil.TransferEncodingMechanism.BIT8.value<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                localCharset = HttpPostBodyUtil.ISO_8859_1;
                mechanism = TransferEncodingMechanism.BIT8;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>code
                    .equals<span class="delimiter">(</span>HttpPostBodyUtil.TransferEncodingMechanism.BINARY.value<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// no real charset, so let the default</span>
                mechanism = TransferEncodingMechanism.BINARY;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>
                        <span class="string">&quot;TransferEncoding Unknown: &quot;</span> + code<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        Attribute charsetAttribute = currentFieldAttributes
                .get<span class="delimiter">(</span>HttpHeaders.Values.CHARSET<span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>charsetAttribute != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                localCharset = Charset.forName<span class="delimiter">(</span>charsetAttribute.getValue<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>currentFileUpload == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            Attribute filenameAttribute = currentFieldAttributes
                    .get<span class="delimiter">(</span>HttpPostBodyUtil.FILENAME<span class="delimiter">)</span>;
            Attribute nameAttribute = currentFieldAttributes
                    .get<span class="delimiter">(</span>HttpPostBodyUtil.NAME<span class="delimiter">)</span>;
            Attribute contentTypeAttribute = currentFieldAttributes
                    .get<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TYPE<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>contentTypeAttribute == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>
                        <span class="string">&quot;Content-Type is absent but required&quot;</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            Attribute lengthAttribute = currentFieldAttributes
                    .get<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_LENGTH<span class="delimiter">)</span>;
            long size;
            <span class="keyword">try</span> <span class="delimiter">{</span>
                size = lengthAttribute != <span class="keyword">null</span>? Long.parseLong<span class="delimiter">(</span>lengthAttribute
                        .getValue<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> : <span class="long">0L</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NumberFormatException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                size = <span class="int">0</span>;
            <span class="delimiter">}</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                currentFileUpload = factory.createFileUpload<span class="delimiter">(</span>
                        request,
                        nameAttribute.getValue<span class="delimiter">(</span><span class="delimiter">)</span>, filenameAttribute.getValue<span class="delimiter">(</span><span class="delimiter">)</span>,
                        contentTypeAttribute.getValue<span class="delimiter">(</span><span class="delimiter">)</span>, mechanism.value,
                        localCharset, size<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NullPointerException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IllegalArgumentException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="comment">// load data as much as possible</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
            readFileUploadByteMultipart<span class="delimiter">(</span>delimiter<span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>NotEnoughDataDecoderException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// do not change the buffer position</span>
            <span class="comment">// since some can be already saved into FileUpload</span>
            <span class="comment">// So do not change the currentStatus</span>
            <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>currentFileUpload.isCompleted<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// ready to load the next one</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>currentStatus == MultiPartStatus.FILEUPLOAD<span class="delimiter">)</span> <span class="delimiter">{</span>
                currentStatus = MultiPartStatus.HEADERDELIMITER;
                currentFieldAttributes = <span class="keyword">null</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                currentStatus = MultiPartStatus.MIXEDDELIMITER;
                cleanMixedAttributes<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            FileUpload fileUpload = currentFileUpload;
            currentFileUpload = <span class="keyword">null</span>;
            <span class="keyword">return</span> fileUpload;
        <span class="delimiter">}</span>
        <span class="comment">// do not change the buffer position</span>
        <span class="comment">// since some can be already saved into FileUpload</span>
        <span class="comment">// So do not change the currentStatus</span>
        <span class="keyword">return</span> <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Clean all HttpDatas (on Disk) for the current request.
 */</span>
    public void <a title="()Unit" id="48312">cleanFiles</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        factory.cleanRequestHttpDatas<span class="delimiter">(</span>request<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Remove the given FileUpload from the list of FileUploads to clean
     */</span>
    public void <a title="(data: org.jboss.netty.handler.codec.http.InterfaceHttpData)Unit" id="48313">removeHttpDataFromClean</a><span class="delimiter">(</span><a href="InterfaceHttpData.java.html#11842" title="org.jboss.netty.handler.codec.http.InterfaceHttpData">InterfaceHttpData</a> <a title="org.jboss.netty.handler.codec.http.InterfaceHttpData" id="110497">data</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        factory.removeHttpDataFromClean<span class="delimiter">(</span>request, data<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Remove all Attributes that should be cleaned between two FileUpload in Mixed mode
     */</span>
    <span class="keyword">private</span> void <a title="()Unit" id="48314">cleanMixedAttributes</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        currentFieldAttributes.remove<span class="delimiter">(</span>HttpHeaders.Values.CHARSET<span class="delimiter">)</span>;
        currentFieldAttributes.remove<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_LENGTH<span class="delimiter">)</span>;
        currentFieldAttributes.remove<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TRANSFER_ENCODING<span class="delimiter">)</span>;
        currentFieldAttributes.remove<span class="delimiter">(</span>HttpHeaders.Names.CONTENT_TYPE<span class="delimiter">)</span>;
        currentFieldAttributes.remove<span class="delimiter">(</span>HttpPostBodyUtil.FILENAME<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Read one line up to the CRLF or LF
     * @return the String from one line
     * @throws NotEnoughDataDecoderException Need more chunks and
     *   reset the readerInder to the previous value
     */</span>
    <span class="keyword">private</span> String <a title="()java.lang.String" id="48315">readLine</a><span class="delimiter">(</span><span class="delimiter">)</span> throws NotEnoughDataDecoderException <span class="delimiter">{</span>
        int readerIndex = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">try</span> <span class="delimiter">{</span>
            StringBuilder sb = <span class="keyword">new</span> StringBuilder<span class="delimiter">(</span><span class="int">64</span><span class="delimiter">)</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                byte nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.CR<span class="delimiter">)</span> <span class="delimiter">{</span>
                    nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">return</span> sb.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">return</span> sb.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    sb.append<span class="delimiter">(</span><span class="delimiter">(</span>char<span class="delimiter">)</span> nextByte<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IndexOutOfBoundsException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            undecodedChunk.readerIndex<span class="delimiter">(</span>readerIndex<span class="delimiter">)</span>;
            <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        undecodedChunk.readerIndex<span class="delimiter">(</span>readerIndex<span class="delimiter">)</span>;
        <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Read a FileUpload data as Byte (Binary) and add the bytes directly to the
     * FileUpload. If the delimiter is found, the FileUpload is completed.
     * @param delimiter
     * @throws NotEnoughDataDecoderException Need more chunks but
     *   do not reset the readerInder since some values will be already added to the FileOutput
     * @throws ErrorDataDecoderException write IO error occurs with the FileUpload
     */</span>
    <span class="keyword">private</span> void <a title="(delimiter: java.lang.String)Unit" id="48316">readFileUploadByteMultipart</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110498">delimiter</a><span class="delimiter">)</span>
            throws NotEnoughDataDecoderException, ErrorDataDecoderException <span class="delimiter">{</span>
        int readerIndex = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="comment">// found the decoder limit</span>
        boolean newLine = <span class="keyword">true</span>;
        int index = <span class="int">0</span>;
        int lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
        boolean found = <span class="keyword">false</span>;
        <span class="keyword">while</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            byte nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>newLine<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// Check the delimiter</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == delimiter.codePointAt<span class="delimiter">(</span>index<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    index ++;
                    <span class="keyword">if</span> <span class="delimiter">(</span>delimiter.length<span class="delimiter">(</span><span class="delimiter">)</span> == index<span class="delimiter">)</span> <span class="delimiter">{</span>
                        found = <span class="keyword">true</span>;
                        break;
                    <span class="delimiter">}</span>
                    continue;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    newLine = <span class="keyword">false</span>;
                    index = <span class="int">0</span>;
                    <span class="comment">// continue until end of line</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.CR<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                            <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                                newLine = <span class="keyword">true</span>;
                                index = <span class="int">0</span>;
                                lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">2</span>;
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                        newLine = <span class="keyword">true</span>;
                        index = <span class="int">0</span>;
                        lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                        <span class="comment">// save last valid position</span>
                        lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="comment">// continue until end of line</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.CR<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                            newLine = <span class="keyword">true</span>;
                            index = <span class="int">0</span>;
                            lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">2</span>;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                    newLine = <span class="keyword">true</span>;
                    index = <span class="int">0</span>;
                    lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="comment">// save last valid position</span>
                    lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        ChannelBuffer buffer = undecodedChunk.slice<span class="delimiter">(</span>readerIndex, lastPosition -
                readerIndex<span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>found<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// found so lastPosition is correct and final</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                currentFileUpload.addContent<span class="delimiter">(</span>buffer, <span class="keyword">true</span><span class="delimiter">)</span>;
                <span class="comment">// just before the CRLF and delimiter</span>
                undecodedChunk.readerIndex<span class="delimiter">(</span>lastPosition<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="comment">// possibly the delimiter is partially found but still the last position is OK</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                currentFileUpload.addContent<span class="delimiter">(</span>buffer, <span class="keyword">false</span><span class="delimiter">)</span>;
                <span class="comment">// last valid char (not CR, not LF, not beginning of delimiter)</span>
                undecodedChunk.readerIndex<span class="delimiter">(</span>lastPosition<span class="delimiter">)</span>;
                <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Load the field value from a Multipart request
     * @throws NotEnoughDataDecoderException Need more chunks
     * @throws ErrorDataDecoderException
     */</span>
    <span class="keyword">private</span> void <a title="(delimiter: java.lang.String)Unit" id="48317">loadFieldMultipart</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110499">delimiter</a><span class="delimiter">)</span>
            throws NotEnoughDataDecoderException, ErrorDataDecoderException <span class="delimiter">{</span>
        int readerIndex = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="comment">// found the decoder limit</span>
            boolean newLine = <span class="keyword">true</span>;
            int index = <span class="int">0</span>;
            int lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
            boolean found = <span class="keyword">false</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                byte nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>newLine<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="comment">// Check the delimiter</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == delimiter.codePointAt<span class="delimiter">(</span>index<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        index ++;
                        <span class="keyword">if</span> <span class="delimiter">(</span>delimiter.length<span class="delimiter">(</span><span class="delimiter">)</span> == index<span class="delimiter">)</span> <span class="delimiter">{</span>
                            found = <span class="keyword">true</span>;
                            break;
                        <span class="delimiter">}</span>
                        continue;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                        newLine = <span class="keyword">false</span>;
                        index = <span class="int">0</span>;
                        <span class="comment">// continue until end of line</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.CR<span class="delimiter">)</span> <span class="delimiter">{</span>
                            <span class="keyword">if</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                                nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                                <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                                    newLine = <span class="keyword">true</span>;
                                    index = <span class="int">0</span>;
                                    lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">2</span>;
                                <span class="delimiter">}</span>
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                            newLine = <span class="keyword">true</span>;
                            index = <span class="int">0</span>;
                            lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span>;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                            lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="comment">// continue until end of line</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.CR<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
                            <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                                newLine = <span class="keyword">true</span>;
                                index = <span class="int">0</span>;
                                lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">2</span>;
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                        newLine = <span class="keyword">true</span>;
                        index = <span class="int">0</span>;
                        lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                        lastPosition = undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>found<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// found so lastPosition is correct</span>
                <span class="comment">// but position is just after the delimiter (either close delimiter or simple one)</span>
                <span class="comment">// so go back of delimiter size</span>
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    currentAttribute.addContent<span class="delimiter">(</span>
                            undecodedChunk.slice<span class="delimiter">(</span>readerIndex, lastPosition - readerIndex<span class="delimiter">)</span>,
                            <span class="keyword">true</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                undecodedChunk.readerIndex<span class="delimiter">(</span>lastPosition<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    currentAttribute.addContent<span class="delimiter">(</span>
                            undecodedChunk.slice<span class="delimiter">(</span>readerIndex, lastPosition - readerIndex<span class="delimiter">)</span>,
                            <span class="keyword">false</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IOException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                undecodedChunk.readerIndex<span class="delimiter">(</span>lastPosition<span class="delimiter">)</span>;
                <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>IndexOutOfBoundsException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            undecodedChunk.readerIndex<span class="delimiter">(</span>readerIndex<span class="delimiter">)</span>;
            <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughDataDecoderException<span class="delimiter">(</span>e<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Clean the String from any unallowed character
     * @return the cleaned String
     */</span>
    <span class="keyword">private</span> String <a title="(field: java.lang.String)java.lang.String" id="48318">cleanString</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110500">field</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        StringBuilder sb = <span class="keyword">new</span> StringBuilder<span class="delimiter">(</span>field.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        int i = <span class="int">0</span>;
        <span class="keyword">for</span> <span class="delimiter">(</span>i = <span class="int">0</span>; i &lt; field.length<span class="delimiter">(</span><span class="delimiter">)</span>; i ++<span class="delimiter">)</span> <span class="delimiter">{</span>
            char nextChar = field.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>nextChar == HttpCodecUtil.COLON<span class="delimiter">)</span> <span class="delimiter">{</span>
                sb.append<span class="delimiter">(</span>HttpCodecUtil.SP<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextChar == HttpCodecUtil.COMMA<span class="delimiter">)</span> <span class="delimiter">{</span>
                sb.append<span class="delimiter">(</span>HttpCodecUtil.SP<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextChar == HttpCodecUtil.EQUALS<span class="delimiter">)</span> <span class="delimiter">{</span>
                sb.append<span class="delimiter">(</span>HttpCodecUtil.SP<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextChar == HttpCodecUtil.SEMICOLON<span class="delimiter">)</span> <span class="delimiter">{</span>
                sb.append<span class="delimiter">(</span>HttpCodecUtil.SP<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextChar == HttpCodecUtil.HT<span class="delimiter">)</span> <span class="delimiter">{</span>
                sb.append<span class="delimiter">(</span>HttpCodecUtil.SP<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextChar == HttpCodecUtil.DOUBLE_QUOTE<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="comment">// nothing added, just removes it</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                sb.append<span class="delimiter">(</span>nextChar<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">return</span> sb.toString<span class="delimiter">(</span><span class="delimiter">)</span>.trim<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Skip one empty line
     * @return True if one empty line was skipped
     */</span>
    <span class="keyword">private</span> boolean <a title="()Boolean" id="48319">skipOneLine</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>!undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="keyword">false</span>;
        <span class="delimiter">}</span>
        byte nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.CR<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>!undecodedChunk.readable<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                undecodedChunk.readerIndex<span class="delimiter">(</span>undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span><span class="delimiter">)</span>;
                <span class="keyword">return</span> <span class="keyword">false</span>;
            <span class="delimiter">}</span>
            nextByte = undecodedChunk.readByte<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="keyword">true</span>;
            <span class="delimiter">}</span>
            undecodedChunk.readerIndex<span class="delimiter">(</span>undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">2</span><span class="delimiter">)</span>;
            <span class="keyword">return</span> <span class="keyword">false</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nextByte == HttpCodecUtil.LF<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="keyword">true</span>;
        <span class="delimiter">}</span>
        undecodedChunk.readerIndex<span class="delimiter">(</span>undecodedChunk.readerIndex<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> <span class="keyword">false</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Split the very first line (Content-Type value) in 2 Strings
     * @param sb
     * @return the array of 2 Strings
     */</span>
    <span class="keyword">private</span> String<span class="delimiter">[</span><span title="Array" class="delimiter">]</span> <a title="(sb: java.lang.String)Array[java.lang.String]" id="48320">splitHeaderContentType</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110501">sb</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        int size = sb.length<span class="delimiter">(</span><span class="delimiter">)</span>;
        int aStart;
        int aEnd;
        int bStart;
        int bEnd;
        aStart = HttpPostBodyUtil.findNonWhitespace<span class="delimiter">(</span>sb, <span class="int">0</span><span class="delimiter">)</span>;
        aEnd = HttpPostBodyUtil.findWhitespace<span class="delimiter">(</span>sb, aStart<span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>aEnd &gt;= size<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="keyword">new</span> String<span class="delimiter">[</span><span class="delimiter">]</span> <span class="delimiter">{</span> sb, <span class="string">&quot;&quot;</span> <span class="delimiter">}</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>sb.charAt<span class="delimiter">(</span>aEnd<span class="delimiter">)</span> == <span class="char">';'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            aEnd --;
        <span class="delimiter">}</span>
        bStart = HttpPostBodyUtil.findNonWhitespace<span class="delimiter">(</span>sb, aEnd<span class="delimiter">)</span>;
        bEnd = HttpPostBodyUtil.findEndOfString<span class="delimiter">(</span>sb<span class="delimiter">)</span>;
        <span class="keyword">return</span> <span class="keyword">new</span> String<span class="delimiter">[</span><span class="delimiter">]</span> <span class="delimiter">{</span> sb.substring<span class="delimiter">(</span>aStart, aEnd<span class="delimiter">)</span>,
                sb.substring<span class="delimiter">(</span>bStart, bEnd<span class="delimiter">)</span> <span class="delimiter">}</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Split one header in Multipart
     * @param sb
     * @return an array of String where rank 0 is the name of the header, follows by several
     *  values that were separated by ';' or ','
     */</span>
    <span class="keyword">private</span> String<span class="delimiter">[</span><span title="Array" class="delimiter">]</span> <a title="(sb: java.lang.String)Array[java.lang.String]" id="48321">splitMultipartHeader</a><span class="delimiter">(</span>String <a title="java.lang.String" id="110502">sb</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        ArrayList&lt;String&gt; headers = <span class="keyword">new</span> ArrayList&lt;String&gt;<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span>;
        int nameStart;
        int nameEnd;
        int colonEnd;
        int valueStart;
        int valueEnd;
        nameStart = HttpPostBodyUtil.findNonWhitespace<span class="delimiter">(</span>sb, <span class="int">0</span><span class="delimiter">)</span>;
        <span class="keyword">for</span> <span class="delimiter">(</span>nameEnd = nameStart; nameEnd &lt; sb.length<span class="delimiter">(</span><span class="delimiter">)</span>; nameEnd ++<span class="delimiter">)</span> <span class="delimiter">{</span>
            char ch = sb.charAt<span class="delimiter">(</span>nameEnd<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>ch == <span class="char">':'</span> || Character.isWhitespace<span class="delimiter">(</span>ch<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                break;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">for</span> <span class="delimiter">(</span>colonEnd = nameEnd; colonEnd &lt; sb.length<span class="delimiter">(</span><span class="delimiter">)</span>; colonEnd ++<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>sb.charAt<span class="delimiter">(</span>colonEnd<span class="delimiter">)</span> == <span class="char">':'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                colonEnd ++;
                break;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        valueStart = HttpPostBodyUtil.findNonWhitespace<span class="delimiter">(</span>sb, colonEnd<span class="delimiter">)</span>;
        valueEnd = HttpPostBodyUtil.findEndOfString<span class="delimiter">(</span>sb<span class="delimiter">)</span>;
        headers.add<span class="delimiter">(</span>sb.substring<span class="delimiter">(</span>nameStart, nameEnd<span class="delimiter">)</span><span class="delimiter">)</span>;
        String svalue = sb.substring<span class="delimiter">(</span>valueStart, valueEnd<span class="delimiter">)</span>;
        String<span class="delimiter">[</span><span class="delimiter">]</span> values = <span class="keyword">null</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>svalue.indexOf<span class="delimiter">(</span><span class="string">&quot;;&quot;</span><span class="delimiter">)</span> &gt;= <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            values = svalue.split<span class="delimiter">(</span><span class="string">&quot;;&quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            values = svalue.split<span class="delimiter">(</span><span class="string">&quot;,&quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">for</span> <span class="delimiter">(</span>String value: values<span class="delimiter">)</span> <span class="delimiter">{</span>
            headers.add<span class="delimiter">(</span>value.trim<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        String<span class="delimiter">[</span><span class="delimiter">]</span> array = <span class="keyword">new</span> String<span class="delimiter">[</span>headers.size<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">]</span>;
        <span class="keyword">for</span> <span class="delimiter">(</span>int i = <span class="int">0</span>; i &lt; headers.size<span class="delimiter">(</span><span class="delimiter">)</span>; i ++<span class="delimiter">)</span> <span class="delimiter">{</span>
            array<span class="delimiter">[</span>i<span class="delimiter">]</span> = headers.get<span class="delimiter">(</span>i<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> array;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Exception when try reading data from request in chunked format, and not enough
     * data are available (need more chunks)
     */</span>
    public static <span class="keyword">class</span> <a title="object org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.NotEnoughDataDecoderException" id="47246">NotEnoughDataDecoderException</a> <span class="keyword">extends</span> Exception <span class="delimiter">{</span>
        <span class="comment">/**
 */</span>
        <span class="keyword">private</span> static <span class="keyword">final</span> long <a title="Long" id="110454">serialVersionUID</a> = -<span class="long">7846841864603865638L</span>;

        <span class="comment">/**
 */</span>
        public NotEnoughDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         */</span>
        public NotEnoughDataDecoderException<a title="(arg0: java.lang.String)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.NotEnoughDataDecoderException" id="49915" class="delimiter">(</a>String <a title="java.lang.String" id="110457">arg0</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         */</span>
        public NotEnoughDataDecoderException<a title="(arg0: java.lang.Throwable)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.NotEnoughDataDecoderException" id="49916" class="delimiter">(</a>Throwable <a title="java.lang.Throwable" id="110459">arg0</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         * @param arg1
         */</span>
        public NotEnoughDataDecoderException<a title="(arg0: java.lang.String, arg1: java.lang.Throwable)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.NotEnoughDataDecoderException" id="49917" class="delimiter">(</a>String <a title="java.lang.String" id="110461">arg0</a>, Throwable <a title="java.lang.Throwable" id="110462">arg1</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0, arg1<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Exception when the body is fully decoded, even if there is still data
     */</span>
    public static <span class="keyword">class</span> <a title="object org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.EndOfDataDecoderException" id="47249">EndOfDataDecoderException</a> <span class="keyword">extends</span> Exception <span class="delimiter">{</span>
        <span class="comment">/**
 */</span>
        <span class="keyword">private</span> static <span class="keyword">final</span> long <a title="Long" id="110464">serialVersionUID</a> = <span class="long">1336267941020800769L</span>;

    <span class="delimiter">}</span>

    <span class="comment">/**
     * Exception when an error occurs while decoding
     */</span>
    public static <span class="keyword">class</span> <a title="object org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.ErrorDataDecoderException" id="47252">ErrorDataDecoderException</a> <span class="keyword">extends</span> Exception <span class="delimiter">{</span>
        <span class="comment">/**
 */</span>
        <span class="keyword">private</span> static <span class="keyword">final</span> long <a title="Long" id="110466">serialVersionUID</a> = <span class="long">5020247425493164465L</span>;

        <span class="comment">/**
 */</span>
        public ErrorDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         */</span>
        public ErrorDataDecoderException<a title="(arg0: java.lang.String)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.ErrorDataDecoderException" id="49278" class="delimiter">(</a>String <a title="java.lang.String" id="110469">arg0</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         */</span>
        public ErrorDataDecoderException<a title="(arg0: java.lang.Throwable)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.ErrorDataDecoderException" id="49279" class="delimiter">(</a>Throwable <a title="java.lang.Throwable" id="110471">arg0</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         * @param arg1
         */</span>
        public ErrorDataDecoderException<a title="(arg0: java.lang.String, arg1: java.lang.Throwable)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.ErrorDataDecoderException" id="49280" class="delimiter">(</a>String <a title="java.lang.String" id="110473">arg0</a>, Throwable <a title="java.lang.Throwable" id="110474">arg1</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0, arg1<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Exception when an unappropriated method was called on a request
     */</span>
    public static <span class="keyword">class</span> <a title="object org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.IncompatibleDataDecoderException" id="47255">IncompatibleDataDecoderException</a> <span class="keyword">extends</span> Exception <span class="delimiter">{</span>
        <span class="comment">/**
 */</span>
        <span class="keyword">private</span> static <span class="keyword">final</span> long <a title="Long" id="110476">serialVersionUID</a> = -<span class="long">953268047926250267L</span>;

        <span class="comment">/**
 */</span>
        public IncompatibleDataDecoderException<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         */</span>
        public IncompatibleDataDecoderException<a title="(arg0: java.lang.String)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.IncompatibleDataDecoderException" id="49284" class="delimiter">(</a>String <a title="java.lang.String" id="110479">arg0</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         */</span>
        public IncompatibleDataDecoderException<a title="(arg0: java.lang.Throwable)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.IncompatibleDataDecoderException" id="49285" class="delimiter">(</a>Throwable <a title="java.lang.Throwable" id="110481">arg0</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * @param arg0
         * @param arg1
         */</span>
        public IncompatibleDataDecoderException<a title="(arg0: java.lang.String, arg1: java.lang.Throwable)org.jboss.netty.handler.codec.http.HttpPostRequestDecoder.IncompatibleDataDecoderException" id="49286" class="delimiter">(</a>String <a title="java.lang.String" id="110483">arg0</a>, Throwable <a title="java.lang.Throwable" id="110484">arg1</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span>arg0, arg1<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>