<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>netty-websockets/unfiltered/netty/websockets/plans.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> unfiltered.netty.websockets

<span class="keyword">import</span> unfiltered.request._
<span class="keyword">import</span> unfiltered.response._
<span class="keyword">import</span> unfiltered.netty._

<span class="keyword">import</span> org.jboss.<span class="delimiter">{</span>netty =&gt; jnetty<span class="delimiter">}</span>

<span class="keyword">import</span> jnetty.channel.<span class="delimiter">{</span>Channel, ChannelEvent, ChannelFuture, ChannelFutureListener,
                       ChannelHandlerContext, MessageEvent, SimpleChannelUpstreamHandler<span class="delimiter">}</span>
<span class="keyword">import</span> jnetty.buffer.<span class="delimiter">{</span>ChannelBuffer, ChannelBuffers<span class="delimiter">}</span>
<span class="keyword">import</span> jnetty.handler.codec.http.HttpHeaders
<span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpRequest =&gt; NHttpRequest,
                                  HttpResponse =&gt; NHttpResponse,
                                  DefaultHttpResponse<span class="delimiter">}</span>
<span class="keyword">import</span> jnetty.handler.codec.http.<span title="object org.jboss.netty.handler.codec.http.HttpVersion">HttpVersion</span>.HTTP_1_1
<span class="keyword">import</span> jnetty.handler.codec.http.<span title="object org.jboss.netty.handler.codec.http.HttpResponseStatus">HttpResponseStatus</span>.FORBIDDEN
<span class="keyword">import</span> jnetty.handler.codec.http.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.setContentLength

<span class="keyword">import</span> jnetty.util.CharsetUtil

<span class="comment">/** Module defining function types used in the WebSockets module as well as
 *  function defaults */</span>
<span class="keyword">object</span> <a title="object unfiltered.netty.websockets.Plan" id="12658">Plan</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="comment">/** The trasition from an http request handling to websocket request handling.
   *  Note: This can not be an Async.Intent because RequestBinding is a Responder for HttpResponses */</span>
  <span class="keyword">type</span> <a title="PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent]" id="54665">Intent</a> =
    <span title="PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent]">PartialFunction</span><span class="delimiter">[</span>RequestBinding, SocketIntent<span class="delimiter">]</span>

  <span class="comment">/** A SocketIntent is the result of a handler `lift`ing a request into
   *  the WebSocket protocol. WebSockets may be responded to asynchronously,
   * thus their handler will not need to return a value */</span>
  <span class="keyword">type</span> <a title="PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]" id="54666">SocketIntent</a> =
    <span title="PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]">PartialFunction</span><span class="delimiter">[</span>SocketCallback, Unit<span class="delimiter">]</span>

  <span class="comment">/** A pass handler serves as a means to forward a request upstream for
   *  unhandled patterns and protocol messages */</span>
  <span class="keyword">type</span> <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="54667">PassHandler</a> = <span class="delimiter">(</span>ChannelHandlerContext, ChannelEvent<span class="delimiter">)</span> =&gt; Unit

  <span class="comment">/** Equivalent of an HttpResponse's Pass function
   *  A SocketIntent that does nothing */</span>
  <span class="keyword">val</span> <a title="unfiltered.netty.websockets.Plan.SocketIntent" id="54668">Pass</a>  = <span class="delimiter">(</span><a href="#54692" title="Unit" class="delimiter">{</a>
    <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>: <span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span><span class="delimiter">)</span>

  <span class="comment">/** A default implementation of a PassHandler which returns a HTTP protocol
   *  forbidden response code to the channel before closing the channel */</span>
  <span class="keyword">val</span> <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="54670">DefaultPassHandler</a> = <span class="delimiter">(</span><span class="delimiter">{</span> <span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="54694">ctx</a>, <a title="org.jboss.netty.channel.ChannelEvent" id="54695">event</a><span class="delimiter">)</span> =&gt;
    <a href="#54695" title="org.jboss.netty.channel.ChannelEvent">event</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="54696">me</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span> =&gt;
        <a href="#54696" title="org.jboss.netty.channel.MessageEvent">me</a>.<span title="()java.lang.Object">getMessage</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="54697">request</a>: <span title="org.jboss.netty.handler.codec.http.HttpRequest">NHttpRequest</span> =&gt;
            <span class="keyword">val</span> <a title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" id="54698">res</a> = <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">DefaultHttpResponse</span><span class="delimiter">(</span><span title="org.jboss.netty.handler.codec.http.HttpVersion">HTTP_1_1</span>, <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus">FORBIDDEN</span><span class="delimiter">)</span>
            <a href="#54698" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>.<span title="(x$1: org.jboss.netty.buffer.ChannelBuffer)Unit">setContent</span><span class="delimiter">(</span><span title="object org.jboss.netty.buffer.ChannelBuffers">ChannelBuffers</span>.<span title="(x$1: java.lang.CharSequence, x$2: java.nio.charset.Charset)org.jboss.netty.buffer.ChannelBuffer">copiedBuffer</span><span class="delimiter">(</span><a href="#54698" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>.<span title="()org.jboss.netty.handler.codec.http.HttpResponseStatus">getStatus</span>.<span title="()java.lang.String">toString</span>, <span title="object org.jboss.netty.util.CharsetUtil">CharsetUtil</span>.<span title="java.nio.charset.Charset">UTF_8</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44047" title="(message: org.jboss.netty.handler.codec.http.HttpMessage, length: Long)Unit">setContentLength</a><span class="delimiter">(</span><a href="#54698" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>, <a href="#54698" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>.<span title="()org.jboss.netty.buffer.ChannelBuffer">getContent</span>.<span title="=&gt; Long">readableBytes</span><span class="delimiter">)</span>
            <a href="#54694" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><a href="#54698" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a><span class="delimiter">)</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><span title="object org.jboss.netty.channel.ChannelFutureListener">ChannelFutureListener</span>.<span title="org.jboss.netty.channel.ChannelFutureListener">CLOSE</span><span class="delimiter">)</span>
          <span class="keyword">case</span> <a title="Nothing" id="54721">msg</a> =&gt;
            <span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid type of event message (%s) for Plan pass handling&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span>
              <a href="#54721" title="java.lang.Object">msg</a>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.String">getName</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// we really only care about MessageEvents but need to support the more generic ChannelEvent</span>
    <span class="delimiter">}</span>
   <span class="delimiter">}</span>: <span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** Serves the same purpose of unfiltered.netty.ServerErrorResponse, which is to
 *  satisfy ExceptionHandler#onException, except that it is not specific to the HTTP protocol.
 *  It will simply log the Throwable and close the Channel */</span>
<span class="keyword">trait</span> <a title="trait CloseOnException extends java.lang.Object with ScalaObject" id="12495">CloseOnException</a> <span title="ScalaObject" class="delimiter">{</span> self: ExceptionHandler =&gt;
  <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, t: Throwable)Unit" id="54729">onException</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="54733">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="Throwable" id="54734">t</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#54734" title="Throwable">t</a>.<span title="()Unit">printStackTrace</span>
    <a href="#54733" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/** A light wrapper around both Sec-WebSocket-Draft + Sec-WebSocket-Version headers */</span>
<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.Version" id="12718">Version</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](req: unfiltered.request.HttpRequest[T])Option[String]" id="54984">apply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="54986">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="54988">req</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#9907" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#12598" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#54998" title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketDraft">SecWebSocketDraft</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16002" title="(req: unfiltered.request.HttpRequest[T])Option[String]">unapply</a><span class="delimiter">(</span><a href="#54988" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>.<span title="(alternative: =&gt; Option[String])Option[String]">orElse</span><span class="delimiter">(</span>
    <a href="#12598" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#54996" title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketVersion">SecWebSocketVersion</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16002" title="(req: unfiltered.request.HttpRequest[T])Option[String]">unapply</a><span class="delimiter">(</span><a href="#54988" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>
  <span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** See also http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-14 */</span>
<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts" id="12598">IetfDrafts</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="comment">/** Server handshake as described in
   *  http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-14#section-4.2.2 */</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.Handshake" id="54992">Handshake</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">import</span> java.security.MessageDigest
    <span class="keyword">import</span> org.apache.commons.codec.binary.<span title="object org.apache.commons.codec.binary.Base64">Base64</span>.encodeBase64
    <span class="keyword">val</span> <a title="java.lang.String" id="55022">GUID</a> = <span title="java.lang.String(&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;)" class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="55024">Sha1</a> = <span title="java.lang.String(&quot;SHA1&quot;)" class="string">&quot;SHA1&quot;</span>
    <span class="keyword">def</span> <a title="(key: String)Array[Byte]" id="55026">sign</a><span class="delimiter">(</span><a title="String" id="55183">key</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> =
      <span title="(x$1: Array[Byte])Array[Byte]">encodeBase64</span><span class="delimiter">(</span><span title="object java.security.MessageDigest">MessageDigest</span>.<span title="(x$1: java.lang.String)java.security.MessageDigest">getInstance</span><span class="delimiter">(</span><a href="#55024" title="=&gt; java.lang.String">Sha1</a><span class="delimiter">)</span>.<span title="(x$1: Array[Byte])Array[Byte]">digest</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#55183" title="String">key</a>.<span title="()java.lang.String">trim</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#55022" title="=&gt; java.lang.String">GUID</a><span class="delimiter">)</span>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(key: String)unfiltered.response.ResponseHeader" id="55027">apply</a><span class="delimiter">(</span><a title="String" id="55276">key</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">WebSocketAccept</a><span class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#55026" title="(key: String)Array[Byte]">sign</a><span class="delimiter">(</span><a href="#55276" title="String">key</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// request headers</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketKey" id="54994">SecWebSocketKey</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#10282" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Key&quot;)" class="string">&quot;Sec-WebSocket-Key&quot;</span><span class="delimiter">)</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketVersion" id="54996">SecWebSocketVersion</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#10282" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Version&quot;)" class="string">&quot;Sec-WebSocket-Version&quot;</span><span class="delimiter">)</span>
   <span class="comment">/** Prior to draft 04, the websocket spec provided an optional draft header
   *  http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-03#section-10.8 */</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketDraft" id="54998">SecWebSocketDraft</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#10282" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Draft&quot;)" class="string">&quot;Sec-WebSocket-Draft&quot;</span><span class="delimiter">)</span>

  <span class="comment">// response headers</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.WebSocketAccept" id="55000">WebSocketAccept</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10763" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Accept&quot;)" class="string">&quot;Sec-WebSocket-Accept&quot;</span><span class="delimiter">)</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketVersionName" id="55002">SecWebSocketVersionName</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10763" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Version&quot;)" class="string">&quot;Sec-WebSocket-Version&quot;</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** An implementation of the older Websocket spec. As more browses start adopting the official
 *  spec, this module should be deprecared then removed */</span>
<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.HixieDrafts" id="12574">HixieDrafts</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> java.security.MessageDigest
  <span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpRequest =&gt; NHttpRequest<span class="delimiter">}</span>

  <span class="comment">/** Sec-WebSocket-Key(1/2) included in the hixie drafts and later removed in ietf drafts
   *  see the later in drafts 00-03
   *  http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-03#section-1.3 */</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.HixieDrafts.SecKeyOne" id="55296">SecKeyOne</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#10282" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Key1&quot;)" class="string">&quot;Sec-WebSocket-Key1&quot;</span><span class="delimiter">)</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.HixieDrafts.SecKeyTwo" id="55298">SecKeyTwo</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#10282" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Key2&quot;)" class="string">&quot;Sec-WebSocket-Key2&quot;</span><span class="delimiter">)</span>

  case <span class="keyword">class</span> <a title="class Handshake extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse] with ScalaObject with Product with Serializable" id="55492">Handshake</a><a href="#55492" title="ScalaObject" class="delimiter">(</a><a title="unfiltered.netty.RequestBinding" id="55489">binding</a>: <a href="../../../../netty/unfiltered/netty/bindings.scala.html#11465" title="unfiltered.netty.RequestBinding">RequestBinding</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#11090" title="unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">Responder</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(res: unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse])Unit" id="55345">respond</a><span class="delimiter">(</span><a title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]" id="55350">res</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#10790" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">HttpResponse</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(_1: Option[String], _2: Option[String])(Option[String], Option[String])" class="delimiter">(</span><a href="#12574" title="object unfiltered.netty.websockets.HixieDrafts">HixieDrafts</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16005" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">SecKeyOne</a><span class="delimiter">(</span><a href="#55489" title="=&gt; unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>, <a href="#12574" title="object unfiltered.netty.websockets.HixieDrafts">HixieDrafts</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16005" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">SecKeyTwo</a><span class="delimiter">(</span><a href="#55489" title="=&gt; unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="String" id="55370">k1</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="String" id="55372">k2</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
          <span class="keyword">val</span> <a title="org.jboss.netty.buffer.ChannelBuffer" id="55373">buff</a> = <span title="object org.jboss.netty.buffer.ChannelBuffers">ChannelBuffers</span>.<span title="(x$1: Int)org.jboss.netty.buffer.ChannelBuffer">buffer</span><span class="delimiter">(</span><span title="Int(16)" class="int">16</span><span class="delimiter">)</span>
          <span class="delimiter">(</span><a href="#55370" title="String">k1</a> <a href="#55376" title="(x: String)List[String]">::</a> <a href="#55372" title="String">k2</a> <a href="#55377" title="(x: String)List[String]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span> <a title="String" id="55421">k</a> =&gt;
            <a href="#55373" title="org.jboss.netty.buffer.ChannelBuffer">buff</a>.<span title="(x$1: Int)Unit">writeInt</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#55421" title="String">k</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">replaceAll</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="delimiter">(</span><span title="java.lang.String(&quot;[^0-9]&quot;)" class="string">&quot;[^0-9]&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Long">toLong</span> <span title="(x: Int)Long">/</span>
                           <a href="#55421" title="String">k</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">replaceAll</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[^ ]&quot;)" class="string">&quot;[^ ]&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>.<span title="()Int">length</span><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>
           <span class="delimiter">)</span>
          <a href="#55373" title="org.jboss.netty.buffer.ChannelBuffer">buff</a>.<span title="(x$1: Long)Unit">writeLong</span><span class="delimiter">(</span><a href="#55489" title="=&gt; unfiltered.netty.RequestBinding">binding</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13891" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../../netty/unfiltered/netty/bindings.scala.html#42642" title="=&gt; org.jboss.netty.handler.codec.http.HttpRequest">request</a>.<span title="()org.jboss.netty.buffer.ChannelBuffer">getContent</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()Long">readLong</span><span class="delimiter">)</span>
          <a href="#55350" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">res</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#25393" title="=&gt; org.jboss.netty.handler.codec.http.HttpResponse">underlying</a>.<span title="(x$1: org.jboss.netty.buffer.ChannelBuffer)Unit">setContent</span><span class="delimiter">(</span><span title="object org.jboss.netty.buffer.ChannelBuffers">ChannelBuffers</span>.<span title="(x$1: Array[Byte])org.jboss.netty.buffer.ChannelBuffer">wrappedBuffer</span><span class="delimiter">(</span>
            <span title="object java.security.MessageDigest">MessageDigest</span>.<span title="(x$1: java.lang.String)java.security.MessageDigest">getInstance</span><span class="delimiter">(</span><span title="java.lang.String(&quot;MD5&quot;)" class="string">&quot;MD5&quot;</span><span class="delimiter">)</span>.<span title="(x$1: Array[Byte])Array[Byte]">digest</span><span class="delimiter">(</span><a href="#55373" title="org.jboss.netty.buffer.ChannelBuffer">buff</a>.<span title="()Array[Byte]">array</span><span class="delimiter">)</span>
          <span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.ProtocolRequestHeader" id="12676">ProtocolRequestHeader</a>
       <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#10282" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44019" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Names">Names</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#55542" title="java.lang.String">SEC_WEBSOCKET_PROTOCOL</a><span class="delimiter">)</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.OriginRequestHeader" id="12619">OriginRequestHeader</a>
       <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#10282" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44019" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Names">Names</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#55531" title="java.lang.String">ORIGIN</a><span class="delimiter">)</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.ConnectionUpgrade" id="12517">ConnectionUpgrade</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](req: unfiltered.request.HttpRequest[T])Option[String]" id="55564">unapply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="55566">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="55568">req</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#9907" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> =
    unfiltered.request.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16005" title="(req: unfiltered.request.HttpRequest[T])Option[String]">Connection</a><span class="delimiter">(</span><a href="#55568" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>.<span title="(p: String =&gt; Boolean)Option[String]">filter</span> <span class="delimiter">{</span>
      <span title="=&gt; Boolean">!</span><a href="#55577" title="String">_</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#56027" title="java.lang.String">_</a>.<span title="()java.lang.String">trim</span><span class="delimiter">)</span>.<span title="(p: java.lang.String =&gt; Boolean)Array[java.lang.String]">filter</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#56263" title="java.lang.String">_</a>.<span title="(x$1: java.lang.String)Boolean">equalsIgnoreCase</span><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44022" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Values">Values</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#56295" title="java.lang.String">UPGRADE</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isEmpty</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.UpgradeWebsockets" id="12709">UpgradeWebsockets</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](req: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]" id="56538">unapply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="56540">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="56542">req</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#9907" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#40356" title="(req: unfiltered.request.HttpRequest[T])List[String]">Upgrade</a><span class="delimiter">(</span><a href="#56542" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>.<span title="(p: String =&gt; Boolean)List[String]">filter</span> <span class="delimiter">{</span>
      <a href="#56570" title="String">_</a>.<span title="(x$1: java.lang.String)Boolean">equalsIgnoreCase</span><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44022" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Values">Values</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#56296" title="java.lang.String">WEBSOCKET</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="=&gt; Option[String]">headOption</span>.<span title="(f: String =&gt; unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]">map</span> <span class="delimiter">{</span> <a title="String" id="56575">_</a> =&gt; <a href="#56542" title="unfiltered.request.HttpRequest[T]">req</a> <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.WSLocation" id="12748">WSLocation</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](r: unfiltered.request.HttpRequest[T])String" id="56579">apply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="56581">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="56583">r</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#9907" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s://%s%s&quot;</span> <span title="(args: Any*)String">format</span><span class="delimiter">(</span><span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#56583" title="unfiltered.request.HttpRequest[T]">r</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13903" title="=&gt; Boolean">isSecure</a><span class="delimiter">)</span> <span title="java.lang.String(&quot;wss&quot;)" class="string">&quot;wss&quot;</span> <span class="keyword">else</span> <span title="java.lang.String(&quot;ws&quot;)" class="string">&quot;ws&quot;</span>, <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16005" title="(req: unfiltered.request.HttpRequest[T])Option[String]">Host</a><span class="delimiter">(</span><a href="#56583" title="unfiltered.request.HttpRequest[T]">r</a><span class="delimiter">)</span>.<span title="=&gt; String">get</span>, <a href="#56583" title="unfiltered.request.HttpRequest[T]">r</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13898" title="=&gt; String">uri</a><span class="delimiter">)</span>
<span class="delimiter">}</span>


<span class="comment">/** Provides an extention point for netty ChannelHandlers that wish to
 *  support the WebSocket protocol */</span>
<span class="keyword">trait</span> <a title="trait Plan extends org.jboss.netty.channel.SimpleChannelUpstreamHandler with unfiltered.netty.ExceptionHandler with ScalaObject" id="12657">Plan</a> <span title="ScalaObject" class="keyword">extends</span> <span title="org.jboss.netty.channel.SimpleChannelUpstreamHandler">SimpleChannelUpstreamHandler</span> <span class="keyword">with</span> <a href="../../../../netty/unfiltered/netty/exceptions.scala.html#11378" title="unfiltered.netty.ExceptionHandler">ExceptionHandler</a> <span class="delimiter">{</span>
  <span class="keyword">import</span> jnetty.channel.<span class="delimiter">{</span>ChannelStateEvent, ExceptionEvent<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.websocket.<span class="delimiter">{</span>DefaultWebSocketFrame, WebSocketFrame,
                                             WebSocketFrameDecoder =&gt; LegacyWebSocketFrameDecoder,
                                             WebSocketFrameEncoder =&gt; LegacyWebSocketFrameEncoder<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpHeaders, HttpMethod, HttpRequest =&gt; NHttpRequest,
                                   HttpResponseStatus, HttpVersion,  DefaultHttpResponse<span class="delimiter">}</span>
  <span class="keyword">import</span> <a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>._
  <span class="keyword">import</span> <a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44019" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Names">Names</a>.<span class="delimiter">{</span>CONNECTION, ORIGIN, HOST, UPGRADE<span class="delimiter">}</span>
  <span class="keyword">import</span> <a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44022" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Values">Values</a>._

  <span class="keyword">val</span> <a title="java.lang.String" id="54679">SecWebSocketLocation</a> = <span title="java.lang.String(&quot;Sec-WebSocket-Location&quot;)" class="string">&quot;Sec-WebSocket-Location&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="54681">SecWebSocketOrigin</a> = <span title="java.lang.String(&quot;Sec-WebSocket-Origin&quot;)" class="string">&quot;Sec-WebSocket-Origin&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="54683">SecWebSocketProtocol</a> = <span title="java.lang.String(&quot;Sec-WebSocket-Protocol&quot;)" class="string">&quot;Sec-WebSocket-Protocol&quot;</span>

  <span class="keyword">def</span> <a title="=&gt; unfiltered.netty.websockets.Plan.Intent" id="54685">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span>

  <span class="keyword">def</span> <a title="=&gt; (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="54686">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.MessageEvent)Unit" id="54687">messageReceived</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="56600">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.MessageEvent" id="56601">event</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> =
    <a href="#56601" title="org.jboss.netty.channel.MessageEvent">event</a>.<span title="()java.lang.Object">getMessage</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="56604">http</a>: <span title="org.jboss.netty.handler.codec.http.HttpRequest">NHttpRequest</span> =&gt; <a href="#54688" title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, request: org.jboss.netty.handler.codec.http.HttpRequest, event: org.jboss.netty.channel.MessageEvent)Unit">upgrade</a><span class="delimiter">(</span><a href="#56600" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#56604" title="org.jboss.netty.handler.codec.http.HttpRequest">http</a>, <a href="#56601" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#54686" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#56600" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#56601" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">/** `Lifts` an HTTP request into a WebSocket request. If the HTTP request handling intent is not defined or results
   *   in a Plan.Pass the `pass` method will be invoked. If the HTTP request handling intent is
   *   defined for the HttpRequest, its SocketIntent return value will be used to
   *   evaluate WebSocket protocol requests */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, request: org.jboss.netty.handler.codec.http.HttpRequest, event: org.jboss.netty.channel.MessageEvent)Unit" id="54688">upgrade</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="56605">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.handler.codec.http.HttpRequest" id="56606">request</a>: <span title="org.jboss.netty.handler.codec.http.HttpRequest">NHttpRequest</span>,
                      <a title="org.jboss.netty.channel.MessageEvent" id="56607">event</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="unfiltered.netty.ReceivedMessage" id="56610">msg</a> = <a href="../../../../netty/unfiltered/netty/bindings.scala.html#47084" title="(request: org.jboss.netty.handler.codec.http.HttpRequest, context: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.MessageEvent)unfiltered.netty.ReceivedMessage">ReceivedMessage</a><span class="delimiter">(</span><a href="#56606" title="org.jboss.netty.handler.codec.http.HttpRequest">request</a>, <a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#56607" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="unfiltered.netty.RequestBinding" id="56611">binding</a> = <span title="unfiltered.netty.RequestBinding" class="keyword">new</span> <a href="../../../../netty/unfiltered/netty/bindings.scala.html#11465" title="unfiltered.netty.RequestBinding">RequestBinding</a><span class="delimiter">(</span><a href="#56610" title="unfiltered.netty.ReceivedMessage">msg</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Option[String]" id="56612">version</a> = <a href="#54984" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">Version</a><span class="delimiter">(</span><a href="#56611" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>

    <a href="#56611" title="unfiltered.netty.RequestBinding">binding</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#42286" title="Unit">GET</a><span class="delimiter">(</span><a href="#55564" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">ConnectionUpgrade</a><span class="delimiter">(</span>_<span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/utils.scala.html#42898" title="(a: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Some[(unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage], unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])]">&amp;</a> <a href="#56538" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]]">UpgradeWebsockets</a><span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        <a href="#54685" title="=&gt; unfiltered.netty.websockets.Plan.Intent">intent</a>.<span title="(that: PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent])PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent]">orElse</span><span title="(v1: unfiltered.netty.RequestBinding)unfiltered.netty.websockets.Plan.SocketIntent" class="delimiter">(</span><a href="#56653" title="unfiltered.netty.websockets.Plan.SocketIntent" class="delimiter">{</a> <span class="keyword">case</span> <span title="unfiltered.netty.websockets.Plan.SocketIntent">_</span> =&gt; <a href="#12658" title="object unfiltered.netty.websockets.Plan">Plan</a>.<a href="#54668" title="=&gt; unfiltered.netty.websockets.Plan.SocketIntent">Pass</a> <span class="delimiter">}</span>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#56611" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a href="#12658" title="Unit">Plan</a>.<a href="#54668" title="=&gt; unfiltered.netty.websockets.Plan.SocketIntent">Pass</a> =&gt;
            <a href="#54686" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#56607" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
          <span class="keyword">case</span> <a title="Unit" id="56658">socketIntent</a> =&gt;
            <span class="keyword">val</span> <a title="unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse] =&gt; org.jboss.netty.handler.codec.http.DefaultHttpResponse" id="56659">response</a> = <a href="#56610" title="unfiltered.netty.ReceivedMessage">msg</a>.<a href="../../../../netty/unfiltered/netty/bindings.scala.html#42649" title="(res: org.jboss.netty.handler.codec.http.DefaultHttpResponse)(rf: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">response</a><a href="#56673" title="unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse]" class="delimiter">(</a>
              <a href="#56671" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" class="keyword">new</a> <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">DefaultHttpResponse</span><span class="delimiter">(</span>
                <span title="object org.jboss.netty.handler.codec.http.HttpVersion">HttpVersion</span>.<span title="org.jboss.netty.handler.codec.http.HttpVersion">HTTP_1_1</span>,
                <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus">HttpResponseStatus</span><span class="delimiter">(</span><span title="Int(101)" class="int">101</span>, <span title="java.lang.String(&quot;Web Socket Protocol Handshake&quot;)" class="string">&quot;Web Socket Protocol Handshake&quot;</span><span class="delimiter">)</span>
              <span class="delimiter">)</span>
            <span class="delimiter">)</span>_

            <span class="keyword">def</span> <a title="=&gt; PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]" id="56660">attempt</a> = <a href="#56658" title="unfiltered.netty.websockets.Plan.SocketIntent">socketIntent</a>.<span title="(that: PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit])PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]">orElse</span><span class="delimiter">(</span><a href="#56683" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>: Plan.<span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="Protocol extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" id="56661">Protocol</a> = <a href="#56685" title="java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" id="56685">Responder</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span> <span class="delimiter">{</span>
              <span class="keyword">def</span> <a title="(res: unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse])Unit" id="56687">respond</a><span class="delimiter">(</span><a title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]" id="56688">res</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#10790" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">HttpResponse</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16005" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">ProtocolRequestHeader</a><span class="delimiter">(</span><a href="#56611" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
                  <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="String" id="56697">protocol</a><span class="delimiter">)</span> =&gt;
                    <a href="#56688" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">res</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#25404" title="(name: String, value: String)Unit">header</a><span class="delimiter">(</span><a href="#54683" title="=&gt; java.lang.String">SecWebSocketProtocol</a>, <a href="#56697" title="String">protocol</a><span class="delimiter">)</span>
                  <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>

            <span class="keyword">val</span> <a title="org.jboss.netty.channel.ChannelPipeline" id="56662">pipe</a> = <a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelPipeline">getPipeline</span>

            <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#56662" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String)org.jboss.netty.channel.ChannelHandler">get</span><span class="delimiter">(</span><span title="java.lang.String(&quot;aggregator&quot;)" class="string">&quot;aggregator&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#56662" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String)org.jboss.netty.channel.ChannelHandler">remove</span><span class="delimiter">(</span><span title="java.lang.String(&quot;aggregator&quot;)" class="string">&quot;aggregator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="Boolean" id="56663">legacy</a> = <a href="#56612" title="Option[String]">version</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Boolean(true)">None</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
              <span class="keyword">case</span> <span title="Boolean(true)">Some</span><span class="delimiter">(</span><a title="String" id="56738">earlier</a><span class="delimiter">)</span>
                <span class="keyword">if</span><span class="delimiter">(</span><a href="#56738" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">earlier</a>.<span title="=&gt; Int">toInt</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
              <span class="keyword">case</span> <span title="Boolean(false)">Some</span><span class="delimiter">(</span><a title="String" id="56794">recent</a><span class="delimiter">)</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
            <span class="delimiter">}</span>

            <a href="#56662" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: org.jboss.netty.channel.ChannelHandler)org.jboss.netty.channel.ChannelHandler">replace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;decoder&quot;)" class="string">&quot;decoder&quot;</span>, <span title="java.lang.String(&quot;wsdecoder&quot;)" class="string">&quot;wsdecoder&quot;</span>,
                         <span title="org.jboss.netty.handler.codec.replay.ReplayingDecoder[org.jboss.netty.handler.codec.replay.VoidEnum]" class="keyword">if</span><span class="delimiter">(</span><a href="#56663" title="Boolean">legacy</a><span class="delimiter">)</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameDecoder" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameDecoder">LegacyWebSocketFrameDecoder</span>
                         <span class="keyword">else</span> <span title="unfiltered.netty.websockets.Draft14WebSocketFrameDecoder" class="keyword">new</span> <a href="decoder.scala.html#12543" title="unfiltered.netty.websockets.Draft14WebSocketFrameDecoder">Draft14WebSocketFrameDecoder</a><span class="delimiter">)</span>

            <a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span>
              <a href="#56659" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">response</a><span class="delimiter">(</span>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10763" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#55552" title="java.lang.String">UPGRADE</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44022" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Values">Values</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#56296" title="java.lang.String">WEBSOCKET</a><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10763" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#55506" title="java.lang.String">CONNECTION</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#44022" title="object org.jboss.netty.handler.codec.http.HttpHeaders.Values">Values</a>.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#56295" title="java.lang.String">UPGRADE</a><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10763" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><a href="#54681" title="=&gt; java.lang.String">SecWebSocketOrigin</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16005" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">OriginRequestHeader</a><span class="delimiter">(</span><a href="#56611" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="java.lang.String(&quot;*&quot;)" class="string">&quot;*&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10763" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><a href="#54679" title="=&gt; java.lang.String">SecWebSocketLocation</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#56579" title="(r: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])String">WSLocation</a><span class="delimiter">(</span><a href="#56611" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])java.lang.Object with unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse]">~&gt;</a>
                <a href="#56661" title="Protocol extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">Protocol</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])java.lang.Object with unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse]">~&gt;</a> <span class="delimiter">(</span>
                  <span title="unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse]" class="keyword">if</span><span class="delimiter">(</span><a href="#56663" title="Boolean">legacy</a><span class="delimiter">)</span> <a href="#12574" title="object unfiltered.netty.websockets.HixieDrafts">HixieDrafts</a>.<a href="#55492" title="(binding: unfiltered.netty.RequestBinding)unfiltered.netty.websockets.HixieDrafts.Handshake">Handshake</a><span class="delimiter">(</span><a href="#56611" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>
                  <span class="keyword">else</span> <span class="delimiter">{</span>
                    <a href="#12598" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#55027" title="(key: String)unfiltered.response.ResponseHeader">Handshake</a><span class="delimiter">(</span><a href="#12598" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#54994" title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketKey">SecWebSocketKey</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#16002" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">unapply</a><span class="delimiter">(</span><a href="#56611" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>.<span title="=&gt; String">get</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#25428" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                    <a href="#12598" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#43443" title="(value: String*)unfiltered.response.ResponseHeader">SecWebSocketVersionName</a><span class="delimiter">(</span><a href="#56612" title="Option[String]">version</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="java.lang.String(&quot;0&quot;)" class="string">&quot;0&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
                  <span class="delimiter">}</span><span class="delimiter">)</span>
              <span class="delimiter">)</span>
            <span class="delimiter">)</span>

            <a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">getCloseFuture</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><a href="#56930" title="java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" id="56930">ChannelFutureListener</a> <span class="delimiter">{</span>
              <span class="keyword">def</span> <a title="(future: org.jboss.netty.channel.ChannelFuture)Unit" id="56934">operationComplete</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="56935">future</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
                <a href="#56660" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#56941" title="(socket: unfiltered.netty.websockets.WebSocket)unfiltered.netty.websockets.Close">Close</a><span class="delimiter">(</span><a href="websockets.scala.html#56954" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span><span class="delimiter">)</span>

            <a href="#56662" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: org.jboss.netty.channel.ChannelHandler)org.jboss.netty.channel.ChannelHandler">replace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;encoder&quot;)" class="string">&quot;encoder&quot;</span>, <span title="java.lang.String(&quot;wsencoder&quot;)" class="string">&quot;wsencoder&quot;</span>,
                         <span title="org.jboss.netty.handler.codec.oneone.OneToOneEncoder" class="keyword">if</span><span class="delimiter">(</span><a href="#56663" title="Boolean">legacy</a><span class="delimiter">)</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameEncoder" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameEncoder">LegacyWebSocketFrameEncoder</span>
                         <span class="keyword">else</span> <span title="unfiltered.netty.websockets.Draft14WebSocketFrameEncoder" class="keyword">new</span> <a href="encoder.scala.html#12546" title="unfiltered.netty.websockets.Draft14WebSocketFrameEncoder">Draft14WebSocketFrameEncoder</a><span class="delimiter">)</span>

            <a href="#56660" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#57002" title="(socket: unfiltered.netty.websockets.WebSocket)unfiltered.netty.websockets.Open">Open</a><span class="delimiter">(</span><a href="websockets.scala.html#56954" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

            <a href="#56662" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: org.jboss.netty.channel.ChannelHandler, x$2: java.lang.String, x$3: org.jboss.netty.channel.ChannelHandler)Unit">replace</span><span class="delimiter">(</span><a href="#12657" title="unfiltered.netty.websockets.Plan" class="keyword">this</a>, <a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()java.lang.String">getName</span>, <a href="#57270" title="(intent: unfiltered.netty.websockets.Plan.SocketIntent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.SocketPlan">SocketPlan</a><span class="delimiter">(</span><a href="#56658" title="unfiltered.netty.websockets.Plan.SocketIntent">socketIntent</a>, <a href="#54686" title="=&gt; (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">pass</a><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#54686" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#56605" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#56607" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** By default, when a websocket handler `passes` it writes an Http Forbidden response
   *  to the channel in Plan.DefaultPassHandler. To override this behavior, call this method
   *   with a function to handle the ChannelEvent with custom behavior */</span>
  <span class="keyword">def</span> <a title="(handler: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify" id="54689">onPass</a><span class="delimiter">(</span><a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="57053">handler</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> = <a href="#57061" title="(intent: unfiltered.netty.websockets.Plan.Intent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify">Planify</a><span class="delimiter">(</span><a href="#54685" title="=&gt; unfiltered.netty.websockets.Plan.Intent">intent</a>, <a href="#57053" title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">handler</a><span class="delimiter">)</span>

<span class="delimiter">}</span>

<span class="comment">/** A Plan configued to handle Throwables by printing them before closing the channel */</span>
<span class="keyword">class</span> <a title="class Planify extends org.jboss.netty.channel.SimpleChannelUpstreamHandler with unfiltered.netty.websockets.Plan with unfiltered.netty.websockets.CloseOnException with ScalaObject" id="12663">Planify</a><a href="#12663" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="unfiltered.netty.websockets.Plan.Intent" id="57078">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span>, <span class="keyword">val</span> <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="57079">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#12657" title="unfiltered.netty.websockets.Plan">Plan</a> <span class="keyword">with</span> <a href="#12495" title="unfiltered.netty.websockets.CloseOnException">CloseOnException</a>

<span class="comment">/** A companion module for building web socket Plans */</span>
<span class="keyword">object</span> <a title="object unfiltered.netty.websockets.Planify" id="12664">Planify</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> jnetty.buffer.ChannelBuffers
  <span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpRequest =&gt; NHttpRequest, DefaultHttpResponse<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.<a href="../../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#11798" title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</a>._
  <span class="keyword">import</span> jnetty.util.CharsetUtil

  <span class="keyword">def</span> <a title="(intent: unfiltered.netty.websockets.Plan.Intent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify" id="57061">apply</a><span class="delimiter">(</span><a title="unfiltered.netty.websockets.Plan.Intent" id="57067">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span>, <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="57068">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> = <span title="unfiltered.netty.websockets.Planify" class="keyword">new</span> <a href="#12663" title="unfiltered.netty.websockets.Planify">Planify</a><span class="delimiter">(</span><a href="#57067" title="unfiltered.netty.websockets.Plan.Intent">intent</a>, <a href="#57068" title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">pass</a><span class="delimiter">)</span>

  <span class="comment">/** Creates a WebSocketHandler that, when `Pass`ing, will return a forbidden
   *  response to the client */</span>
  <span class="keyword">def</span> <a title="(intent: unfiltered.netty.websockets.Plan.Intent)unfiltered.netty.websockets.Plan" id="57062">apply</a><span class="delimiter">(</span><a title="unfiltered.netty.websockets.Plan.Intent" id="57065">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span><span class="delimiter">)</span>: <a href="#12657" title="unfiltered.netty.websockets.Plan">Plan</a> =
    <a href="#57061" title="(intent: unfiltered.netty.websockets.Plan.Intent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify">Planify</a><span class="delimiter">(</span><a href="#57065" title="unfiltered.netty.websockets.Plan.Intent">intent</a>, <a href="#12658" title="object unfiltered.netty.websockets.Plan">Plan</a>.<a href="#54670" title="=&gt; (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">DefaultPassHandler</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** The result of defined Plan.Intent should result in a SocketPlan value.
 *  SocketPlans are handlers for messages in WebSocket protocol format through SocketCallbacks.
 *  If an unexpected message is recieved by a SocketPlan, the request handling will automatically
 *  be delegated the Plan.PassHandler. As part of the WebSocket protocol, server errors should
 *  be reported to the websocket before closing. This is handled for you. */</span>
case <span class="keyword">class</span> <a title="class SocketPlan extends org.jboss.netty.channel.SimpleChannelUpstreamHandler with ScalaObject with Product with Serializable" id="57270">SocketPlan</a><a href="#57270" title="ScalaObject" class="delimiter">(</a><a title="unfiltered.netty.websockets.Plan.SocketIntent" id="57040">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span>,
                      <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="57041">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="org.jboss.netty.channel.SimpleChannelUpstreamHandler">SimpleChannelUpstreamHandler</span> <span class="delimiter">{</span>
  <span class="keyword">import</span> jnetty.channel.<span class="delimiter">{</span>ChannelFuture, ChannelFutureListener, ExceptionEvent<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.websocket.WebSocketFrame

  <span class="comment">/** 0x00-0x7F typed frame becomes (UTF-8) Text
   0x80-0xFF typed frame becomes Binary */</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit unfiltered.netty.websockets.SocketPlan.wsf2msg : (wsf: org.jboss.netty.handler.codec.http.websocket.WebSocketFrame)unfiltered.netty.websockets.Msg" id="57034">wsf2msg</a><span class="delimiter">(</span><a title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame" id="57099">wsf</a>: <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">WebSocketFrame</span><span class="delimiter">)</span>: <a href="websockets.scala.html#12606" title="unfiltered.netty.websockets.Msg">Msg</a> =
    <span title="unfiltered.netty.websockets.Msg" class="keyword">if</span><span class="delimiter">(</span><a href="#57099" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">wsf</a>.<span title="()Boolean">isText</span><span class="delimiter">)</span> <a href="websockets.scala.html#57103" title="(txt: String)unfiltered.netty.websockets.Text">Text</a><span class="delimiter">(</span><a href="#57099" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">wsf</a>.<span title="()java.lang.String">getTextData</span><span class="delimiter">)</span> <span class="keyword">else</span> <a href="websockets.scala.html#57116" title="(buf: org.jboss.netty.buffer.ChannelBuffer)unfiltered.netty.websockets.Binary">Binary</a><span class="delimiter">(</span><a href="#57099" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">wsf</a>.<span title="()org.jboss.netty.buffer.ChannelBuffer">getBinaryData</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]" id="57035">attempt</a> = <a href="#57040" title="=&gt; unfiltered.netty.websockets.Plan.SocketIntent">intent</a>.<span title="(that: PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit])PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]">orElse</span><span class="delimiter">(</span><a href="#57137" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>: Plan.<span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.MessageEvent)Unit" id="57036">messageReceived</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="57139">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.MessageEvent" id="57140">event</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> =
    <a href="#57140" title="org.jboss.netty.channel.MessageEvent">event</a>.<span title="()java.lang.Object">getMessage</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="57143">c</a> @ ClosingFrame<span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt;
        <a href="#57139" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><a href="#57143" title="unfiltered.netty.websockets.ClosingFrame">c</a><span class="delimiter">)</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><a href="#57146" title="java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" id="57146">ChannelFutureListener</a> <span class="delimiter">{</span>
          <span class="keyword">override</span> <span class="keyword">def</span> <a title="(f: org.jboss.netty.channel.ChannelFuture)Unit" id="57150">operationComplete</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="57151">f</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> = <a href="#57139" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Unit" id="57156">p</a> @ PingFrame<span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <a href="#57139" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span title="Unit" class="delimiter">(</span><a href="#57156" title="unfiltered.netty.websockets.PingFrame">p</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Unit" id="57159">p</a> @ PongFrame<span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <a href="#57139" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span title="Unit" class="delimiter">(</span><a href="#57159" title="unfiltered.netty.websockets.PongFrame">p</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Unit" id="57162">f</a>: <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">WebSocketFrame</span> =&gt; <a href="#57162" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">f</a>.<span title="()Int">getType</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit" class="int">0xFF</span> =&gt; <span class="comment">/* binary not impl */</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit">_</span>    =&gt; <a href="#57035" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#57166" title="(socket: unfiltered.netty.websockets.WebSocket, msg: unfiltered.netty.websockets.Msg)unfiltered.netty.websockets.Message">Message</a><span class="delimiter">(</span><a href="websockets.scala.html#56954" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#57139" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span>, <a href="#57034" title="implicit unfiltered.netty.websockets.SocketPlan.wsf2msg : (wsf: org.jboss.netty.handler.codec.http.websocket.WebSocketFrame)unfiltered.netty.websockets.Msg">f</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#57041" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#57139" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#57140" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">// todo: if there's an error we may want to bubble this upstream</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.ExceptionEvent)Unit" id="57037">exceptionCaught</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="57186">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ExceptionEvent" id="57187">event</a>: <span title="org.jboss.netty.channel.ExceptionEvent">ExceptionEvent</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#57035" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#57193" title="(socket: unfiltered.netty.websockets.WebSocket, err: Throwable)unfiltered.netty.websockets.Error">Error</a><span class="delimiter">(</span><a href="websockets.scala.html#56954" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#57186" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span>, <a href="#57187" title="org.jboss.netty.channel.ExceptionEvent">event</a>.<span title="()java.lang.Throwable">getCause</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#57187" title="org.jboss.netty.channel.ExceptionEvent">event</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>