<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>netty-websockets/unfiltered/netty/websockets/plans.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> unfiltered.netty.websockets

<span class="keyword">import</span> unfiltered.request._
<span class="keyword">import</span> unfiltered.response._
<span class="keyword">import</span> unfiltered.netty._

<span class="keyword">import</span> org.jboss.<span class="delimiter">{</span>netty =&gt; jnetty<span class="delimiter">}</span>

<span class="keyword">import</span> jnetty.channel.<span class="delimiter">{</span>Channel, ChannelEvent, ChannelFuture, ChannelFutureListener,
                       ChannelHandlerContext, MessageEvent, SimpleChannelUpstreamHandler<span class="delimiter">}</span>
<span class="keyword">import</span> jnetty.buffer.<span class="delimiter">{</span>ChannelBuffer, ChannelBuffers<span class="delimiter">}</span>
<span class="keyword">import</span> jnetty.handler.codec.http.HttpHeaders
<span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpRequest =&gt; NHttpRequest,
                                  HttpResponse =&gt; NHttpResponse,
                                  DefaultHttpResponse<span class="delimiter">}</span>
<span class="keyword">import</span> jnetty.handler.codec.http.<span title="object org.jboss.netty.handler.codec.http.HttpVersion">HttpVersion</span>.HTTP_1_1
<span class="keyword">import</span> jnetty.handler.codec.http.<span title="object org.jboss.netty.handler.codec.http.HttpResponseStatus">HttpResponseStatus</span>.FORBIDDEN
<span class="keyword">import</span> jnetty.handler.codec.http.<span title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</span>.setContentLength

<span class="keyword">import</span> jnetty.util.CharsetUtil

<span class="comment">/** Module defining function types used in the WebSockets module as well as
 *  function defaults */</span>
<span class="keyword">object</span> <a title="object unfiltered.netty.websockets.Plan" id="11634">Plan</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="comment">/** The trasition from an http request handling to websocket request handling.
   *  Note: This can not be an Async.Intent because RequestBinding is a Responder for HttpResponses */</span>
  <span class="keyword">type</span> <a title="PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent]" id="48798">Intent</a> =
    <span title="PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent]">PartialFunction</span><span class="delimiter">[</span>RequestBinding, SocketIntent<span class="delimiter">]</span>

  <span class="comment">/** A SocketIntent is the result of a handler `lift`ing a request into
   *  the WebSocket protocol. WebSockets may be responded to asynchronously,
   * thus their handler will not need to return a value */</span>
  <span class="keyword">type</span> <a title="PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]" id="48799">SocketIntent</a> =
    <span title="PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]">PartialFunction</span><span class="delimiter">[</span>SocketCallback, Unit<span class="delimiter">]</span>

  <span class="comment">/** A pass handler serves as a means to forward a request upstream for
   *  unhandled patterns and protocol messages */</span>
  <span class="keyword">type</span> <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="48800">PassHandler</a> = <span class="delimiter">(</span>ChannelHandlerContext, ChannelEvent<span class="delimiter">)</span> =&gt; Unit

  <span class="comment">/** Equivalent of an HttpResponse's Pass function
   *  A SocketIntent that does nothing */</span>
  <span class="keyword">val</span> <a title="unfiltered.netty.websockets.Plan.SocketIntent" id="48801">Pass</a>  = <span class="delimiter">(</span><a href="#48825" title="Unit" class="delimiter">{</a>
    <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>: <span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span><span class="delimiter">)</span>

  <span class="comment">/** A default implementation of a PassHandler which returns a HTTP protocol
   *  forbidden response code to the channel before closing the channel */</span>
  <span class="keyword">val</span> <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="48803">DefaultPassHandler</a> = <span class="delimiter">(</span><span class="delimiter">{</span> <span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="48827">ctx</a>, <a title="org.jboss.netty.channel.ChannelEvent" id="48828">event</a><span class="delimiter">)</span> =&gt;
    <a href="#48828" title="org.jboss.netty.channel.ChannelEvent">event</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="48829">me</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span> =&gt;
        <a href="#48829" title="org.jboss.netty.channel.MessageEvent">me</a>.<span title="()java.lang.Object">getMessage</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a title="Unit" id="48830">request</a>: <span title="org.jboss.netty.handler.codec.http.HttpRequest">NHttpRequest</span> =&gt;
            <span class="keyword">val</span> <a title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" id="48831">res</a> = <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">DefaultHttpResponse</span><span class="delimiter">(</span><span title="org.jboss.netty.handler.codec.http.HttpVersion">HTTP_1_1</span>, <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus">FORBIDDEN</span><span class="delimiter">)</span>
            <a href="#48831" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>.<span title="(x$1: org.jboss.netty.buffer.ChannelBuffer)Unit">setContent</span><span class="delimiter">(</span><span title="object org.jboss.netty.buffer.ChannelBuffers">ChannelBuffers</span>.<span title="(x$1: java.lang.CharSequence, x$2: java.nio.charset.Charset)org.jboss.netty.buffer.ChannelBuffer">copiedBuffer</span><span class="delimiter">(</span><a href="#48831" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>.<span title="()org.jboss.netty.handler.codec.http.HttpResponseStatus">getStatus</span>.<span title="()java.lang.String">toString</span>, <span title="object org.jboss.netty.util.CharsetUtil">CharsetUtil</span>.<span title="java.nio.charset.Charset">UTF_8</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span title="(x$1: org.jboss.netty.handler.codec.http.HttpMessage, x$2: Long)Unit">setContentLength</span><span class="delimiter">(</span><a href="#48831" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>, <a href="#48831" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a>.<span title="()org.jboss.netty.buffer.ChannelBuffer">getContent</span>.<span title="=&gt; Long">readableBytes</span><span class="delimiter">)</span>
            <a href="#48827" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><a href="#48831" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">res</a><span class="delimiter">)</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><span title="object org.jboss.netty.channel.ChannelFutureListener">ChannelFutureListener</span>.<span title="org.jboss.netty.channel.ChannelFutureListener">CLOSE</span><span class="delimiter">)</span>
          <span class="keyword">case</span> <a title="Nothing" id="48851">msg</a> =&gt;
            <span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invalid type of event message (%s) for Plan pass handling&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span>
              <a href="#48851" title="java.lang.Object">msg</a>.<span title="()java.lang.Class[_]">getClass</span>.<span title="()java.lang.String">getName</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// we really only care about MessageEvents but need to support the more generic ChannelEvent</span>
    <span class="delimiter">}</span>
   <span class="delimiter">}</span>: <span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** Serves the same purpose of unfiltered.netty.ServerErrorResponse, which is to
 *  satisfy ExceptionHandler#onException, except that it is not specific to the HTTP protocol.
 *  It will simply log the Throwable and close the Channel */</span>
<span class="keyword">trait</span> <a title="trait CloseOnException extends java.lang.Object with ScalaObject" id="11744">CloseOnException</a> <span title="ScalaObject" class="delimiter">{</span> self: ExceptionHandler =&gt;
  <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, t: Throwable)Unit" id="48859">onException</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="48863">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="Throwable" id="48864">t</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#48864" title="Throwable">t</a>.<span title="()Unit">printStackTrace</span>
    <a href="#48863" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/** A light wrapper around both Sec-WebSocket-Draft + Sec-WebSocket-Version headers */</span>
<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.Version" id="11760">Version</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](req: unfiltered.request.HttpRequest[T])Option[String]" id="49114">apply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="49116">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="49118">req</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#10254" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> = <a href="#11733" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#49128" title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketDraft">SecWebSocketDraft</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15157" title="(req: unfiltered.request.HttpRequest[T])Option[String]">unapply</a><span class="delimiter">(</span><a href="#49118" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>.<span title="(alternative: =&gt; Option[String])Option[String]">orElse</span><span class="delimiter">(</span>
    <a href="#11733" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#49126" title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketVersion">SecWebSocketVersion</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15157" title="(req: unfiltered.request.HttpRequest[T])Option[String]">unapply</a><span class="delimiter">(</span><a href="#49118" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>
  <span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** See also http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-14 */</span>
<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts" id="11733">IetfDrafts</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="comment">/** Server handshake as described in
   *  http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-14#section-4.2.2 */</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.Handshake" id="49122">Handshake</a> <span title="ScalaObject" class="delimiter">{</span>
    <span class="keyword">import</span> java.security.MessageDigest
    <span class="keyword">import</span> org.apache.commons.codec.binary.<span title="object org.apache.commons.codec.binary.Base64">Base64</span>.encodeBase64
    <span class="keyword">val</span> <a title="java.lang.String" id="49152">GUID</a> = <span title="java.lang.String(&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;)" class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="49154">Sha1</a> = <span title="java.lang.String(&quot;SHA1&quot;)" class="string">&quot;SHA1&quot;</span>
    <span class="keyword">def</span> <a title="(key: String)Array[Byte]" id="49156">sign</a><span class="delimiter">(</span><a title="String" id="49315">key</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> =
      <span title="(x$1: Array[Byte])Array[Byte]">encodeBase64</span><span class="delimiter">(</span><span title="object java.security.MessageDigest">MessageDigest</span>.<span title="(x$1: java.lang.String)java.security.MessageDigest">getInstance</span><span class="delimiter">(</span><a href="#49154" title="=&gt; java.lang.String">Sha1</a><span class="delimiter">)</span>.<span title="(x$1: Array[Byte])Array[Byte]">digest</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#49315" title="String">key</a>.<span title="()java.lang.String">trim</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#49152" title="=&gt; java.lang.String">GUID</a><span class="delimiter">)</span>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(key: String)unfiltered.response.ResponseHeader" id="49157">apply</a><span class="delimiter">(</span><a title="String" id="49408">key</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#42316" title="(value: String*)unfiltered.response.ResponseHeader">WebSocketAccept</a><span class="delimiter">(</span><span title="(x$1: Array[Byte])java.lang.String" class="keyword">new</span> <span title="java.lang.String">String</span><span class="delimiter">(</span><a href="#49156" title="(key: String)Array[Byte]">sign</a><span class="delimiter">(</span><a href="#49408" title="String">key</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// request headers</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketKey" id="49124">SecWebSocketKey</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#9720" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Key&quot;)" class="string">&quot;Sec-WebSocket-Key&quot;</span><span class="delimiter">)</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketVersion" id="49126">SecWebSocketVersion</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#9720" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Version&quot;)" class="string">&quot;Sec-WebSocket-Version&quot;</span><span class="delimiter">)</span>
   <span class="comment">/** Prior to draft 04, the websocket spec provided an optional draft header
   *  http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-03#section-10.8 */</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketDraft" id="49128">SecWebSocketDraft</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#9720" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Draft&quot;)" class="string">&quot;Sec-WebSocket-Draft&quot;</span><span class="delimiter">)</span>

  <span class="comment">// response headers</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.WebSocketAccept" id="49130">WebSocketAccept</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10666" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Accept&quot;)" class="string">&quot;Sec-WebSocket-Accept&quot;</span><span class="delimiter">)</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketVersionName" id="49132">SecWebSocketVersionName</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10666" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Version&quot;)" class="string">&quot;Sec-WebSocket-Version&quot;</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** An implementation of the older Websocket spec. As more browses start adopting the official
 *  spec, this module should be deprecared then removed */</span>
<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.HixieDrafts" id="11766">HixieDrafts</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> java.security.MessageDigest
  <span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpRequest =&gt; NHttpRequest<span class="delimiter">}</span>

  <span class="comment">/** Sec-WebSocket-Key(1/2) included in the hixie drafts and later removed in ietf drafts
   *  see the later in drafts 00-03
   *  http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-03#section-1.3 */</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.HixieDrafts.SecKeyOne" id="49428">SecKeyOne</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#9720" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Key1&quot;)" class="string">&quot;Sec-WebSocket-Key1&quot;</span><span class="delimiter">)</span>
  <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.HixieDrafts.SecKeyTwo" id="49430">SecKeyTwo</a> <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#9720" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Sec-WebSocket-Key2&quot;)" class="string">&quot;Sec-WebSocket-Key2&quot;</span><span class="delimiter">)</span>

  case <span class="keyword">class</span> <a title="class Handshake extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse] with ScalaObject with Product with Serializable" id="49650">Handshake</a><a href="#49650" title="ScalaObject" class="delimiter">(</a><a title="unfiltered.netty.RequestBinding" id="49647">binding</a>: <a href="../../../../netty/unfiltered/netty/bindings.scala.html#11338" title="unfiltered.netty.RequestBinding">RequestBinding</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#10840" title="unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">Responder</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(res: unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse])Unit" id="49477">respond</a><span class="delimiter">(</span><a title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]" id="49510">res</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#10732" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">HttpResponse</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="(_1: Option[String], _2: Option[String])(Option[String], Option[String])" class="delimiter">(</span><a href="#11766" title="object unfiltered.netty.websockets.HixieDrafts">HixieDrafts</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15160" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">SecKeyOne</a><span class="delimiter">(</span><a href="#49647" title="=&gt; unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>, <a href="#11766" title="object unfiltered.netty.websockets.HixieDrafts">HixieDrafts</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15160" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">SecKeyTwo</a><span class="delimiter">(</span><a href="#49647" title="=&gt; unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>Some<span class="delimiter">(</span><a title="String" id="49528">k1</a><span class="delimiter">)</span>, Some<span class="delimiter">(</span><a title="String" id="49530">k2</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
          <span class="keyword">val</span> <a title="org.jboss.netty.buffer.ChannelBuffer" id="49531">buff</a> = <span title="object org.jboss.netty.buffer.ChannelBuffers">ChannelBuffers</span>.<span title="(x$1: Int)org.jboss.netty.buffer.ChannelBuffer">buffer</span><span class="delimiter">(</span><span title="Int(16)" class="int">16</span><span class="delimiter">)</span>
          <span class="delimiter">(</span><a href="#49528" title="String">k1</a> <a href="#49534" title="(x: String)List[String]">::</a> <a href="#49530" title="String">k2</a> <a href="#49535" title="(x: String)List[String]">::</a> <span title="object Nil">Nil</span><span class="delimiter">)</span>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span> <a title="String" id="49579">k</a> =&gt;
            <a href="#49531" title="org.jboss.netty.buffer.ChannelBuffer">buff</a>.<span title="(x$1: Int)Unit">writeInt</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#49579" title="String">k</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">replaceAll</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="delimiter">(</span><span title="java.lang.String(&quot;[^0-9]&quot;)" class="string">&quot;[^0-9]&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Long">toLong</span> <span title="(x: Int)Long">/</span>
                           <a href="#49579" title="String">k</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">replaceAll</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[^ ]&quot;)" class="string">&quot;[^ ]&quot;</span>, <span title="java.lang.String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>.<span title="()Int">length</span><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>
           <span class="delimiter">)</span>
          <a href="#49531" title="org.jboss.netty.buffer.ChannelBuffer">buff</a>.<span title="(x$1: Long)Unit">writeLong</span><span class="delimiter">(</span><a href="#49647" title="=&gt; unfiltered.netty.RequestBinding">binding</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13021" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../../netty/unfiltered/netty/bindings.scala.html#41984" title="=&gt; org.jboss.netty.handler.codec.http.HttpRequest">request</a>.<span title="()org.jboss.netty.buffer.ChannelBuffer">getContent</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()Long">readLong</span><span class="delimiter">)</span>
          <a href="#49510" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">res</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#24667" title="=&gt; org.jboss.netty.handler.codec.http.HttpResponse">underlying</a>.<span title="(x$1: org.jboss.netty.buffer.ChannelBuffer)Unit">setContent</span><span class="delimiter">(</span><span title="object org.jboss.netty.buffer.ChannelBuffers">ChannelBuffers</span>.<span title="(x$1: Array[Byte])org.jboss.netty.buffer.ChannelBuffer">wrappedBuffer</span><span class="delimiter">(</span>
            <span title="object java.security.MessageDigest">MessageDigest</span>.<span title="(x$1: java.lang.String)java.security.MessageDigest">getInstance</span><span class="delimiter">(</span><span title="java.lang.String(&quot;MD5&quot;)" class="string">&quot;MD5&quot;</span><span class="delimiter">)</span>.<span title="(x$1: Array[Byte])Array[Byte]">digest</span><span class="delimiter">(</span><a href="#49531" title="org.jboss.netty.buffer.ChannelBuffer">buff</a>.<span title="()Array[Byte]">array</span><span class="delimiter">)</span>
          <span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.ProtocolRequestHeader" id="11628">ProtocolRequestHeader</a>
       <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#9720" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span>HttpHeaders.Names.<span title="java.lang.String(&quot;Sec-WebSocket-Protocol&quot;)">SEC_WEBSOCKET_PROTOCOL</span><span class="delimiter">)</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.OriginRequestHeader" id="11721">OriginRequestHeader</a>
       <span title="ScalaObject" class="keyword">extends</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#9720" title="unfiltered.request.StringHeader">StringHeader</a><span class="delimiter">(</span>HttpHeaders.Names.<span title="java.lang.String(&quot;Origin&quot;)">ORIGIN</span><span class="delimiter">)</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.ConnectionUpgrade" id="11715">ConnectionUpgrade</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](req: unfiltered.request.HttpRequest[T])Option[String]" id="49721">unapply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="49723">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="49725">req</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#10254" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> =
    unfiltered.request.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15160" title="(req: unfiltered.request.HttpRequest[T])Option[String]">Connection</a><span class="delimiter">(</span><a href="#49725" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>.<span title="(p: String =&gt; Boolean)Option[String]">filter</span> <span class="delimiter">{</span>
      <span title="=&gt; Boolean">!</span><a href="#49734" title="String">_</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#50184" title="java.lang.String">_</a>.<span title="()java.lang.String">trim</span><span class="delimiter">)</span>.<span title="(p: java.lang.String =&gt; Boolean)Array[java.lang.String]">filter</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#50420" title="java.lang.String">_</a>.<span title="(x$1: java.lang.String)Boolean">equalsIgnoreCase</span><span class="delimiter">(</span>HttpHeaders.Values.<span title="java.lang.String(&quot;Upgrade&quot;)">UPGRADE</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isEmpty</span>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.UpgradeWebsockets" id="11646">UpgradeWebsockets</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](req: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]" id="50691">unapply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="50693">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="50695">req</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#10254" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#39500" title="(req: unfiltered.request.HttpRequest[T])List[String]">Upgrade</a><span class="delimiter">(</span><a href="#50695" title="unfiltered.request.HttpRequest[T]">req</a><span class="delimiter">)</span>.<span title="(p: String =&gt; Boolean)List[String]">filter</span> <span class="delimiter">{</span>
      <a href="#50712" title="String">_</a>.<span title="(x$1: java.lang.String)Boolean">equalsIgnoreCase</span><span class="delimiter">(</span>HttpHeaders.Values.<span title="java.lang.String(&quot;WebSocket&quot;)">WEBSOCKET</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="=&gt; Option[String]">headOption</span>.<span title="(f: String =&gt; unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]">map</span> <span class="delimiter">{</span> <a title="String" id="50717">_</a> =&gt; <a href="#50695" title="unfiltered.request.HttpRequest[T]">req</a> <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">private</span> <span class="delimiter">[</span>websockets<span class="delimiter">]</span> <span class="keyword">object</span> <a title="object unfiltered.netty.websockets.WSLocation" id="11652">WSLocation</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[T](r: unfiltered.request.HttpRequest[T])String" id="50721">apply</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="50723">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="50725">r</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#10254" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s://%s%s&quot;</span> <span title="(args: Any*)String">format</span><span class="delimiter">(</span><span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#50725" title="unfiltered.request.HttpRequest[T]">r</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13033" title="=&gt; Boolean">isSecure</a><span class="delimiter">)</span> <span title="java.lang.String(&quot;wss&quot;)" class="string">&quot;wss&quot;</span> <span class="keyword">else</span> <span title="java.lang.String(&quot;ws&quot;)" class="string">&quot;ws&quot;</span>, <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15160" title="(req: unfiltered.request.HttpRequest[T])Option[String]">Host</a><span class="delimiter">(</span><a href="#50725" title="unfiltered.request.HttpRequest[T]">r</a><span class="delimiter">)</span>.<span title="=&gt; String">get</span>, <a href="#50725" title="unfiltered.request.HttpRequest[T]">r</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#13028" title="=&gt; String">uri</a><span class="delimiter">)</span>
<span class="delimiter">}</span>


<span class="comment">/** Provides an extention point for netty ChannelHandlers that wish to
 *  support the WebSocket protocol */</span>
<span class="keyword">trait</span> <a title="trait Plan extends org.jboss.netty.channel.SimpleChannelUpstreamHandler with unfiltered.netty.ExceptionHandler with ScalaObject" id="11633">Plan</a> <span title="ScalaObject" class="keyword">extends</span> <span title="org.jboss.netty.channel.SimpleChannelUpstreamHandler">SimpleChannelUpstreamHandler</span> <span class="keyword">with</span> <a href="../../../../netty/unfiltered/netty/exceptions.scala.html#11377" title="unfiltered.netty.ExceptionHandler">ExceptionHandler</a> <span class="delimiter">{</span>
  <span class="keyword">import</span> jnetty.channel.<span class="delimiter">{</span>ChannelStateEvent, ExceptionEvent<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.websocket.<span class="delimiter">{</span>DefaultWebSocketFrame, WebSocketFrame,
                                             WebSocketFrameDecoder =&gt; LegacyWebSocketFrameDecoder,
                                             WebSocketFrameEncoder =&gt; LegacyWebSocketFrameEncoder<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpHeaders, HttpMethod, HttpRequest =&gt; NHttpRequest,
                                   HttpResponseStatus, HttpVersion,  DefaultHttpResponse<span class="delimiter">}</span>
  <span class="keyword">import</span> <span title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</span>._
  <span class="keyword">import</span> <span title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</span>.<span title="object org.jboss.netty.handler.codec.http.HttpHeaders.Names">Names</span>.<span class="delimiter">{</span>CONNECTION, ORIGIN, HOST, UPGRADE<span class="delimiter">}</span>
  <span class="keyword">import</span> <span title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</span>.<span title="object org.jboss.netty.handler.codec.http.HttpHeaders.Values">Values</span>._

  <span class="keyword">val</span> <a title="java.lang.String" id="48812">SecWebSocketLocation</a> = <span title="java.lang.String(&quot;Sec-WebSocket-Location&quot;)" class="string">&quot;Sec-WebSocket-Location&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="48814">SecWebSocketOrigin</a> = <span title="java.lang.String(&quot;Sec-WebSocket-Origin&quot;)" class="string">&quot;Sec-WebSocket-Origin&quot;</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="48816">SecWebSocketProtocol</a> = <span title="java.lang.String(&quot;Sec-WebSocket-Protocol&quot;)" class="string">&quot;Sec-WebSocket-Protocol&quot;</span>

  <span class="keyword">def</span> <a title="=&gt; unfiltered.netty.websockets.Plan.Intent" id="48818">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span>

  <span class="keyword">def</span> <a title="=&gt; (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="48819">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.MessageEvent)Unit" id="48820">messageReceived</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="50744">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.MessageEvent" id="50745">event</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> =
    <a href="#50745" title="org.jboss.netty.channel.MessageEvent">event</a>.<span title="()java.lang.Object">getMessage</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="50748">http</a>: <span title="org.jboss.netty.handler.codec.http.HttpRequest">NHttpRequest</span> =&gt; <a href="#48821" title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, request: org.jboss.netty.handler.codec.http.HttpRequest, event: org.jboss.netty.channel.MessageEvent)Unit">upgrade</a><span class="delimiter">(</span><a href="#50744" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#50748" title="org.jboss.netty.handler.codec.http.HttpRequest">http</a>, <a href="#50745" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#48819" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#50744" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#50745" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">/** `Lifts` an HTTP request into a WebSocket request. If the HTTP request handling intent is not defined or results
   *   in a Plan.Pass the `pass` method will be invoked. If the HTTP request handling intent is
   *   defined for the HttpRequest, its SocketIntent return value will be used to
   *   evaluate WebSocket protocol requests */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, request: org.jboss.netty.handler.codec.http.HttpRequest, event: org.jboss.netty.channel.MessageEvent)Unit" id="48821">upgrade</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="50749">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.handler.codec.http.HttpRequest" id="50750">request</a>: <span title="org.jboss.netty.handler.codec.http.HttpRequest">NHttpRequest</span>,
                      <a title="org.jboss.netty.channel.MessageEvent" id="50751">event</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="unfiltered.netty.ReceivedMessage" id="50754">msg</a> = <a href="../../../../netty/unfiltered/netty/bindings.scala.html#50764" title="(request: org.jboss.netty.handler.codec.http.HttpRequest, context: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.MessageEvent)unfiltered.netty.ReceivedMessage">ReceivedMessage</a><span class="delimiter">(</span><a href="#50750" title="org.jboss.netty.handler.codec.http.HttpRequest">request</a>, <a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#50751" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="unfiltered.netty.RequestBinding" id="50755">binding</a> = <span title="unfiltered.netty.RequestBinding" class="keyword">new</span> <a href="../../../../netty/unfiltered/netty/bindings.scala.html#11338" title="unfiltered.netty.RequestBinding">RequestBinding</a><span class="delimiter">(</span><a href="#50754" title="unfiltered.netty.ReceivedMessage">msg</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="Option[String]" id="50756">version</a> = <a href="#49114" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">Version</a><span class="delimiter">(</span><a href="#50755" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>

    <a href="#50755" title="unfiltered.netty.RequestBinding">binding</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#41442" title="Unit">GET</a><span class="delimiter">(</span><a href="#49721" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">ConnectionUpgrade</a><span class="delimiter">(</span>_<span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/request/utils.scala.html#42914" title="(a: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Some[(unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage], unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])]">&amp;</a> <a href="#50691" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]]">UpgradeWebsockets</a><span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        <a href="#48818" title="=&gt; unfiltered.netty.websockets.Plan.Intent">intent</a>.<span title="(that: PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent])PartialFunction[unfiltered.netty.RequestBinding,unfiltered.netty.websockets.Plan.SocketIntent]">orElse</span><span title="(v1: unfiltered.netty.RequestBinding)unfiltered.netty.websockets.Plan.SocketIntent" class="delimiter">(</span><a href="#50827" title="unfiltered.netty.websockets.Plan.SocketIntent" class="delimiter">{</a> <span class="keyword">case</span> <span title="unfiltered.netty.websockets.Plan.SocketIntent">_</span> =&gt; <a href="#11634" title="object unfiltered.netty.websockets.Plan">Plan</a>.<a href="#48801" title="=&gt; unfiltered.netty.websockets.Plan.SocketIntent">Pass</a> <span class="delimiter">}</span>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#50755" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <a href="#11634" title="Unit">Plan</a>.<a href="#48801" title="=&gt; unfiltered.netty.websockets.Plan.SocketIntent">Pass</a> =&gt;
            <a href="#48819" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#50751" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
          <span class="keyword">case</span> <a title="Unit" id="50832">socketIntent</a> =&gt;
            <span class="keyword">val</span> <a title="unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse] =&gt; org.jboss.netty.handler.codec.http.DefaultHttpResponse" id="50833">response</a> = <a href="#50754" title="unfiltered.netty.ReceivedMessage">msg</a>.<a href="../../../../netty/unfiltered/netty/bindings.scala.html#41991" title="(res: org.jboss.netty.handler.codec.http.DefaultHttpResponse)(rf: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">response</a><a href="#50847" title="unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse]" class="delimiter">(</a>
              <a href="#50845" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" class="keyword">new</a> <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">DefaultHttpResponse</span><span class="delimiter">(</span>
                <span title="object org.jboss.netty.handler.codec.http.HttpVersion">HttpVersion</span>.<span title="org.jboss.netty.handler.codec.http.HttpVersion">HTTP_1_1</span>,
                <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus">HttpResponseStatus</span><span class="delimiter">(</span><span title="Int(101)" class="int">101</span>, <span title="java.lang.String(&quot;Web Socket Protocol Handshake&quot;)" class="string">&quot;Web Socket Protocol Handshake&quot;</span><span class="delimiter">)</span>
              <span class="delimiter">)</span>
            <span class="delimiter">)</span>_

            <span class="keyword">def</span> <a title="=&gt; PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]" id="50834">attempt</a> = <a href="#50832" title="unfiltered.netty.websockets.Plan.SocketIntent">socketIntent</a>.<span title="(that: PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit])PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]">orElse</span><span class="delimiter">(</span><a href="#50857" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>: Plan.<span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="Protocol extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" id="50835">Protocol</a> = <a href="#50859" title="java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" id="50859">Responder</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span> <span class="delimiter">{</span>
              <span class="keyword">def</span> <a title="(res: unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse])Unit" id="50861">respond</a><span class="delimiter">(</span><a title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]" id="50862">res</a>: <a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#10732" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">HttpResponse</a><span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15160" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">ProtocolRequestHeader</a><span class="delimiter">(</span><a href="#50755" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
                  <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><a title="String" id="50871">protocol</a><span class="delimiter">)</span> =&gt;
                    <a href="#50862" title="unfiltered.response.HttpResponse[org.jboss.netty.handler.codec.http.HttpResponse]">res</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/response/HttpResponse.scala.html#24678" title="(name: String, value: String)Unit">header</a><span class="delimiter">(</span><a href="#48816" title="=&gt; java.lang.String">SecWebSocketProtocol</a>, <a href="#50871" title="String">protocol</a><span class="delimiter">)</span>
                  <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>

            <span class="keyword">val</span> <a title="org.jboss.netty.channel.ChannelPipeline" id="50836">pipe</a> = <a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelPipeline">getPipeline</span>

            <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#50836" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String)org.jboss.netty.channel.ChannelHandler">get</span><span class="delimiter">(</span><span title="java.lang.String(&quot;aggregator&quot;)" class="string">&quot;aggregator&quot;</span><span class="delimiter">)</span> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#50836" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String)org.jboss.netty.channel.ChannelHandler">remove</span><span class="delimiter">(</span><span title="java.lang.String(&quot;aggregator&quot;)" class="string">&quot;aggregator&quot;</span><span class="delimiter">)</span>

            <span class="keyword">val</span> <a title="Boolean" id="50837">legacy</a> = <a href="#50756" title="Option[String]">version</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <span title="Boolean(true)">None</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
              <span class="keyword">case</span> <span title="Boolean(true)">Some</span><span class="delimiter">(</span><a title="String" id="50912">earlier</a><span class="delimiter">)</span>
                <span class="keyword">if</span><span class="delimiter">(</span><a href="#50912" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">earlier</a>.<span title="=&gt; Int">toInt</span> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(4)" class="int">4</span><span class="delimiter">)</span> =&gt; <span title="Boolean(true)" class="keyword">true</span>
              <span class="keyword">case</span> <span title="Boolean(false)">Some</span><span class="delimiter">(</span><a title="String" id="50968">recent</a><span class="delimiter">)</span> =&gt; <span title="Boolean(false)" class="keyword">false</span>
            <span class="delimiter">}</span>

            <a href="#50836" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: org.jboss.netty.channel.ChannelHandler)org.jboss.netty.channel.ChannelHandler">replace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;decoder&quot;)" class="string">&quot;decoder&quot;</span>, <span title="java.lang.String(&quot;wsdecoder&quot;)" class="string">&quot;wsdecoder&quot;</span>,
                         <span title="org.jboss.netty.handler.codec.replay.ReplayingDecoder[org.jboss.netty.handler.codec.replay.VoidEnum]" class="keyword">if</span><span class="delimiter">(</span><a href="#50837" title="Boolean">legacy</a><span class="delimiter">)</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameDecoder" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameDecoder">LegacyWebSocketFrameDecoder</span>
                         <span class="keyword">else</span> <span title="unfiltered.netty.websockets.Draft14WebSocketFrameDecoder" class="keyword">new</span> <a href="decoder.scala.html#11780" title="unfiltered.netty.websockets.Draft14WebSocketFrameDecoder">Draft14WebSocketFrameDecoder</a><span class="delimiter">)</span>

            <a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span>
              <a href="#50833" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">response</a><span class="delimiter">(</span>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#42316" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10666" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Upgrade&quot;)">UPGRADE</span><span class="delimiter">)</span><span class="delimiter">(</span>Values.<span title="java.lang.String(&quot;WebSocket&quot;)">WEBSOCKET</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#24702" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#42316" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10666" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Connection&quot;)">CONNECTION</span><span class="delimiter">)</span><span class="delimiter">(</span>Values.<span title="java.lang.String(&quot;Upgrade&quot;)">UPGRADE</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#24702" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#42316" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10666" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><a href="#48814" title="=&gt; java.lang.String">SecWebSocketOrigin</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15160" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">OriginRequestHeader</a><span class="delimiter">(</span><a href="#50755" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="java.lang.String(&quot;*&quot;)" class="string">&quot;*&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#24702" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#42316" title="(value: String*)unfiltered.response.ResponseHeader" class="keyword">new</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#10666" title="unfiltered.response.HeaderName">HeaderName</a><span class="delimiter">(</span><a href="#48812" title="=&gt; java.lang.String">SecWebSocketLocation</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#50721" title="(r: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])String">WSLocation</a><span class="delimiter">(</span><a href="#50755" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#24702" title="(that: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])java.lang.Object with unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse]">~&gt;</a>
                <a href="#50835" title="Protocol extends java.lang.Object with unfiltered.response.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">Protocol</a> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#24702" title="(that: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])java.lang.Object with unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse]">~&gt;</a> <span class="delimiter">(</span>
                  <span title="unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse]" class="keyword">if</span><span class="delimiter">(</span><a href="#50837" title="Boolean">legacy</a><span class="delimiter">)</span> <a href="#11766" title="object unfiltered.netty.websockets.HixieDrafts">HixieDrafts</a>.<a href="#49650" title="(binding: unfiltered.netty.RequestBinding)unfiltered.netty.websockets.HixieDrafts.Handshake">Handshake</a><span class="delimiter">(</span><a href="#50755" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>
                  <span class="keyword">else</span> <span class="delimiter">{</span>
                    <a href="#11733" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#49157" title="(key: String)unfiltered.response.ResponseHeader">Handshake</a><span class="delimiter">(</span><a href="#11733" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="#49124" title="object unfiltered.netty.websockets.IetfDrafts.SecWebSocketKey">SecWebSocketKey</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#15157" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[String]">unapply</a><span class="delimiter">(</span><a href="#50755" title="unfiltered.netty.RequestBinding">binding</a><span class="delimiter">)</span>.<span title="=&gt; String">get</span><span class="delimiter">)</span> <a href="../../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#24702" title="(that: unfiltered.response.ResponseFunction[Any])java.lang.Object with unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                    <a href="#11733" title="object unfiltered.netty.websockets.IetfDrafts">IetfDrafts</a>.<a href="../../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#42316" title="(value: String*)unfiltered.response.ResponseHeader">SecWebSocketVersionName</a><span class="delimiter">(</span><a href="#50756" title="Option[String]">version</a>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="java.lang.String(&quot;0&quot;)" class="string">&quot;0&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
                  <span class="delimiter">}</span><span class="delimiter">)</span>
              <span class="delimiter">)</span>
            <span class="delimiter">)</span>

            <a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">getCloseFuture</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><a href="#51104" title="java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" id="51104">ChannelFutureListener</a> <span class="delimiter">{</span>
              <span class="keyword">def</span> <a title="(future: org.jboss.netty.channel.ChannelFuture)Unit" id="51108">operationComplete</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="51109">future</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
                <a href="#50834" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#51115" title="(socket: unfiltered.netty.websockets.WebSocket)unfiltered.netty.websockets.Close">Close</a><span class="delimiter">(</span><a href="websockets.scala.html#51128" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span><span class="delimiter">)</span>

            <a href="#50836" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: java.lang.String, x$2: java.lang.String, x$3: org.jboss.netty.channel.ChannelHandler)org.jboss.netty.channel.ChannelHandler">replace</span><span class="delimiter">(</span><span title="java.lang.String(&quot;encoder&quot;)" class="string">&quot;encoder&quot;</span>, <span title="java.lang.String(&quot;wsencoder&quot;)" class="string">&quot;wsencoder&quot;</span>,
                         <span title="org.jboss.netty.handler.codec.oneone.OneToOneEncoder" class="keyword">if</span><span class="delimiter">(</span><a href="#50837" title="Boolean">legacy</a><span class="delimiter">)</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameEncoder" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrameEncoder">LegacyWebSocketFrameEncoder</span>
                         <span class="keyword">else</span> <span title="unfiltered.netty.websockets.Draft14WebSocketFrameEncoder" class="keyword">new</span> <a href="encoder.scala.html#11834" title="unfiltered.netty.websockets.Draft14WebSocketFrameEncoder">Draft14WebSocketFrameEncoder</a><span class="delimiter">)</span>

            <a href="#50834" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#51176" title="(socket: unfiltered.netty.websockets.WebSocket)unfiltered.netty.websockets.Open">Open</a><span class="delimiter">(</span><a href="websockets.scala.html#51128" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

            <a href="#50836" title="org.jboss.netty.channel.ChannelPipeline">pipe</a>.<span title="(x$1: org.jboss.netty.channel.ChannelHandler, x$2: java.lang.String, x$3: org.jboss.netty.channel.ChannelHandler)Unit">replace</span><span class="delimiter">(</span><a href="#11633" title="unfiltered.netty.websockets.Plan" class="keyword">this</a>, <a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()java.lang.String">getName</span>, <a href="#51445" title="(intent: unfiltered.netty.websockets.Plan.SocketIntent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.SocketPlan">SocketPlan</a><span class="delimiter">(</span><a href="#50832" title="unfiltered.netty.websockets.Plan.SocketIntent">socketIntent</a>, <a href="#48819" title="=&gt; (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">pass</a><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#48819" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#50749" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#50751" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** By default, when a websocket handler `passes` it writes an Http Forbidden response
   *  to the channel in Plan.DefaultPassHandler. To override this behavior, call this method
   *   with a function to handle the ChannelEvent with custom behavior */</span>
  <span class="keyword">def</span> <a title="(handler: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify" id="48822">onPass</a><span class="delimiter">(</span><a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="51227">handler</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> = <a href="#51235" title="(intent: unfiltered.netty.websockets.Plan.Intent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify">Planify</a><span class="delimiter">(</span><a href="#48818" title="=&gt; unfiltered.netty.websockets.Plan.Intent">intent</a>, <a href="#51227" title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">handler</a><span class="delimiter">)</span>

<span class="delimiter">}</span>

<span class="comment">/** A Plan configued to handle Throwables by printing them before closing the channel */</span>
<span class="keyword">class</span> <a title="class Planify extends org.jboss.netty.channel.SimpleChannelUpstreamHandler with unfiltered.netty.websockets.Plan with unfiltered.netty.websockets.CloseOnException with ScalaObject" id="11609">Planify</a><a href="#11609" title="ScalaObject" class="delimiter">(</a><span class="keyword">val</span> <a title="unfiltered.netty.websockets.Plan.Intent" id="51252">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span>, <span class="keyword">val</span> <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="51253">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#11633" title="unfiltered.netty.websockets.Plan">Plan</a> <span class="keyword">with</span> <a href="#11744" title="unfiltered.netty.websockets.CloseOnException">CloseOnException</a>

<span class="comment">/** A companion module for building web socket Plans */</span>
<span class="keyword">object</span> <a title="object unfiltered.netty.websockets.Planify" id="11610">Planify</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="keyword">import</span> jnetty.buffer.ChannelBuffers
  <span class="keyword">import</span> jnetty.handler.codec.http.<span class="delimiter">{</span>HttpRequest =&gt; NHttpRequest, DefaultHttpResponse<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.<span title="object org.jboss.netty.handler.codec.http.HttpHeaders">HttpHeaders</span>._
  <span class="keyword">import</span> jnetty.util.CharsetUtil

  <span class="keyword">def</span> <a title="(intent: unfiltered.netty.websockets.Plan.Intent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify" id="51235">apply</a><span class="delimiter">(</span><a title="unfiltered.netty.websockets.Plan.Intent" id="51241">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span>, <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="51242">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> = <span title="unfiltered.netty.websockets.Planify" class="keyword">new</span> <a href="#11609" title="unfiltered.netty.websockets.Planify">Planify</a><span class="delimiter">(</span><a href="#51241" title="unfiltered.netty.websockets.Plan.Intent">intent</a>, <a href="#51242" title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">pass</a><span class="delimiter">)</span>

  <span class="comment">/** Creates a WebSocketHandler that, when `Pass`ing, will return a forbidden
   *  response to the client */</span>
  <span class="keyword">def</span> <a title="(intent: unfiltered.netty.websockets.Plan.Intent)unfiltered.netty.websockets.Plan" id="51236">apply</a><span class="delimiter">(</span><a title="unfiltered.netty.websockets.Plan.Intent" id="51239">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.Intent">Intent</span><span class="delimiter">)</span>: <a href="#11633" title="unfiltered.netty.websockets.Plan">Plan</a> =
    <a href="#51235" title="(intent: unfiltered.netty.websockets.Plan.Intent, pass: (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit)unfiltered.netty.websockets.Planify">Planify</a><span class="delimiter">(</span><a href="#51239" title="unfiltered.netty.websockets.Plan.Intent">intent</a>, <a href="#11634" title="object unfiltered.netty.websockets.Plan">Plan</a>.<a href="#48803" title="=&gt; (org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">DefaultPassHandler</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** The result of defined Plan.Intent should result in a SocketPlan value.
 *  SocketPlans are handlers for messages in WebSocket protocol format through SocketCallbacks.
 *  If an unexpected message is recieved by a SocketPlan, the request handling will automatically
 *  be delegated the Plan.PassHandler. As part of the WebSocket protocol, server errors should
 *  be reported to the websocket before closing. This is handled for you. */</span>
case <span class="keyword">class</span> <a title="class SocketPlan extends org.jboss.netty.channel.SimpleChannelUpstreamHandler with ScalaObject with Product with Serializable" id="51445">SocketPlan</a><a href="#51445" title="ScalaObject" class="delimiter">(</a><a title="unfiltered.netty.websockets.Plan.SocketIntent" id="51214">intent</a>: Plan.<span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span>,
                      <a title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit" id="51215">pass</a>: Plan.<span title="(org.jboss.netty.channel.ChannelHandlerContext, org.jboss.netty.channel.ChannelEvent) =&gt; Unit">PassHandler</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="org.jboss.netty.channel.SimpleChannelUpstreamHandler">SimpleChannelUpstreamHandler</span> <span class="delimiter">{</span>
  <span class="keyword">import</span> jnetty.channel.<span class="delimiter">{</span>ChannelFuture, ChannelFutureListener, ExceptionEvent<span class="delimiter">}</span>
  <span class="keyword">import</span> jnetty.handler.codec.http.websocket.WebSocketFrame

  <span class="comment">/** 0x00-0x7F typed frame becomes (UTF-8) Text
   0x80-0xFF typed frame becomes Binary */</span>
  <span class="keyword">implicit</span> <span class="keyword">def</span> <a title="implicit unfiltered.netty.websockets.SocketPlan.wsf2msg : (wsf: org.jboss.netty.handler.codec.http.websocket.WebSocketFrame)unfiltered.netty.websockets.Msg" id="51208">wsf2msg</a><span class="delimiter">(</span><a title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame" id="51273">wsf</a>: <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">WebSocketFrame</span><span class="delimiter">)</span>: <a href="websockets.scala.html#11681" title="unfiltered.netty.websockets.Msg">Msg</a> =
    <span title="unfiltered.netty.websockets.Msg" class="keyword">if</span><span class="delimiter">(</span><a href="#51273" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">wsf</a>.<span title="()Boolean">isText</span><span class="delimiter">)</span> <a href="websockets.scala.html#51277" title="(txt: String)unfiltered.netty.websockets.Text">Text</a><span class="delimiter">(</span><a href="#51273" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">wsf</a>.<span title="()java.lang.String">getTextData</span><span class="delimiter">)</span> <span class="keyword">else</span> <a href="websockets.scala.html#51290" title="(buf: org.jboss.netty.buffer.ChannelBuffer)unfiltered.netty.websockets.Binary">Binary</a><span class="delimiter">(</span><a href="#51273" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">wsf</a>.<span title="()org.jboss.netty.buffer.ChannelBuffer">getBinaryData</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]" id="51209">attempt</a> = <a href="#51214" title="=&gt; unfiltered.netty.websockets.Plan.SocketIntent">intent</a>.<span title="(that: PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit])PartialFunction[unfiltered.netty.websockets.SocketCallback,Unit]">orElse</span><span class="delimiter">(</span><a href="#51311" title="Unit" class="delimiter">{</a> <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>: Plan.<span title="unfiltered.netty.websockets.Plan.SocketIntent">SocketIntent</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.MessageEvent)Unit" id="51210">messageReceived</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="51313">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.MessageEvent" id="51314">event</a>: <span title="org.jboss.netty.channel.MessageEvent">MessageEvent</span><span class="delimiter">)</span> =
    <a href="#51314" title="org.jboss.netty.channel.MessageEvent">event</a>.<span title="()java.lang.Object">getMessage</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="Unit" id="51317">c</a> @ ClosingFrame<span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt;
        <a href="#51313" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><a href="#51317" title="unfiltered.netty.websockets.ClosingFrame">c</a><span class="delimiter">)</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><a href="#51320" title="java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" class="keyword">new</a> <a title="anonymous class $anon extends java.lang.Object with org.jboss.netty.channel.ChannelFutureListener" id="51320">ChannelFutureListener</a> <span class="delimiter">{</span>
          <span class="keyword">override</span> <span class="keyword">def</span> <a title="(f: org.jboss.netty.channel.ChannelFuture)Unit" id="51324">operationComplete</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="51325">f</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> = <a href="#51313" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Unit" id="51330">p</a> @ PingFrame<span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <a href="#51313" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span title="Unit" class="delimiter">(</span><a href="#51330" title="unfiltered.netty.websockets.PingFrame">p</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Unit" id="51333">p</a> @ PongFrame<span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <a href="#51313" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span title="Unit" class="delimiter">(</span><a href="#51333" title="unfiltered.netty.websockets.PongFrame">p</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <a title="Unit" id="51336">f</a>: <span title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">WebSocketFrame</span> =&gt; <a href="#51336" title="org.jboss.netty.handler.codec.http.websocket.WebSocketFrame">f</a>.<span title="()Int">getType</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Unit" class="int">0xFF</span> =&gt; <span class="comment">/* binary not impl */</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <span title="Unit">_</span>    =&gt; <a href="#51209" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#51340" title="(socket: unfiltered.netty.websockets.WebSocket, msg: unfiltered.netty.websockets.Msg)unfiltered.netty.websockets.Message">Message</a><span class="delimiter">(</span><a href="websockets.scala.html#51128" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#51313" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span>, <a href="#51208" title="implicit unfiltered.netty.websockets.SocketPlan.wsf2msg : (wsf: org.jboss.netty.handler.codec.http.websocket.WebSocketFrame)unfiltered.netty.websockets.Msg">f</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <a href="#51215" title="(v1: org.jboss.netty.channel.ChannelHandlerContext, v2: org.jboss.netty.channel.ChannelEvent)Unit">pass</a><span class="delimiter">(</span><a href="#51313" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>, <a href="#51314" title="org.jboss.netty.channel.MessageEvent">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">// todo: if there's an error we may want to bubble this upstream</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(ctx: org.jboss.netty.channel.ChannelHandlerContext, event: org.jboss.netty.channel.ExceptionEvent)Unit" id="51211">exceptionCaught</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelHandlerContext" id="51360">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="org.jboss.netty.channel.ExceptionEvent" id="51361">event</a>: <span title="org.jboss.netty.channel.ExceptionEvent">ExceptionEvent</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#51209" title="(v1: unfiltered.netty.websockets.SocketCallback)Unit">attempt</a><span class="delimiter">(</span><a href="websockets.scala.html#51368" title="(socket: unfiltered.netty.websockets.WebSocket, err: Throwable)unfiltered.netty.websockets.Error">Error</a><span class="delimiter">(</span><a href="websockets.scala.html#51128" title="(channel: org.jboss.netty.channel.Channel)unfiltered.netty.websockets.WebSocket">WebSocket</a><span class="delimiter">(</span><a href="#51360" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span>, <a href="#51361" title="org.jboss.netty.channel.ExceptionEvent">event</a>.<span title="()java.lang.Throwable">getCause</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#51361" title="org.jboss.netty.channel.ExceptionEvent">event</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()org.jboss.netty.channel.ChannelFuture">close</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>