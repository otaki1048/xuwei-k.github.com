<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>scala/tools/nsc/backend/icode/Linearizers.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* NSC -- new scala compiler
 * Copyright 2005 LAMP/EPFL
 * @author  Martin Odersky
 */</span>


<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> backend
<span class="keyword">package</span> icode

<span class="keyword">import</span> scala.tools.nsc.ast._
<span class="keyword">import</span> scala.collection.<span class="delimiter">{</span> mutable, immutable <span class="delimiter">}</span>
<span class="keyword">import</span> mutable.ListBuffer

<span class="keyword">trait</span> <a title="trait Linearizers extends java.lang.Object with ScalaObject" id="13596">Linearizers</a> <span title="ScalaObject" class="delimiter">{</span>
  self: ICodes =&gt;
  <span class="keyword">import</span> <a href="Opcodes.scala.html#96975" title="object Linearizers.this.opcodes">opcodes</a>._

  <span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class Linearizer extends java.lang.Object with ScalaObject" id="97126">Linearizer</a> <a href="#97126" title="ScalaObject" class="delimiter">{</a>
    <span class="keyword">def</span> <a title="(c: Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]" id="215296">linearize</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="215646">c</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span>
    <span class="keyword">def</span> <a title="(c: Linearizers.this.IMethod, start: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]" id="215297">linearizeAt</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="215648">c</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a>, <a title="Linearizers.this.BasicBlock" id="215649">start</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span>
  <span class="delimiter">}</span>

  <span class="comment">/** 
   * A simple linearizer which predicts all branches to 
   * take the 'success' branch and tries to schedule those
   * blocks immediately after the test. This is in sync with
   * how 'while' statements are translated (if the test is 
   * 'true', the loop continues).
   */</span>
  <span class="keyword">class</span> <a title="class NormalLinearizer extends Linearizers.this.Linearizer with scala.tools.nsc.backend.WorklistAlgorithm with ScalaObject" id="97127">NormalLinearizer</a> <a href="#97127" title="ScalaObject" class="keyword">extends</a> <a href="#97126" title="Linearizers.this.Linearizer">Linearizer</a> <span class="keyword">with</span> <a href="../WorklistAlgorithm.scala.html#13086" title="scala.tools.nsc.backend.WorklistAlgorithm">WorklistAlgorithm</a> <span class="delimiter">{</span>
    <span class="keyword">type</span> <a title="Linearizers.this.BasicBlock" id="215332">Elem</a> = <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a>
    <span class="keyword">val</span> <a title="NormalLinearizer.this.WList" id="215333">worklist</a>: <span title="NormalLinearizer.this.WList">WList</span> = <span title="()scala.collection.mutable.Stack[NormalLinearizer.this.Elem]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.Stack[NormalLinearizer.this.Elem]">Stack</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">var</span> <a title="List[Linearizers.this.BasicBlock]" id="215336">blocks</a>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
    
    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]" id="215338">linearize</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="215657">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Linearizers.this.BasicBlock" id="215659">b</a> = <a href="#215657" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197802" title="=&gt; Linearizers.this.BasicBlock">startBlock</a>;
      <a href="#215336" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <span title="object Nil">Nil</span>;

      <a href="../WorklistAlgorithm.scala.html#197591" title="(initWorklist: =&gt; Unit)Unit">run</a> <span class="delimiter">{</span>
        <a href="#215333" title="=&gt; NormalLinearizer.this.WList">worklist</a> <span title="(xs: scala.collection.TraversableOnce[NormalLinearizer.this.Elem])NormalLinearizer.this.worklist.type">pushAll</span> <span class="delimiter">(</span><a href="#215657" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197733" title="=&gt; List[Linearizers.this.ExceptionHandler]">exh</a> <span title="(f: Linearizers.this.ExceptionHandler =&gt; Linearizers.this.BasicBlock)(implicit bf: scala.collection.generic.CanBuildFrom[List[Linearizers.this.ExceptionHandler],Linearizers.this.BasicBlock,scala.collection.TraversableOnce[NormalLinearizer.this.Elem]])scala.collection.TraversableOnce[NormalLinearizer.this.Elem]">map</span> <span class="delimiter">(</span><a href="#215684" title="Linearizers.this.ExceptionHandler">_</a>.<a href="ExceptionHandlers.scala.html#203093" title="=&gt; Linearizers.this.BasicBlock">startBlock</a><span class="delimiter">)</span><span class="delimiter">)</span>;
        <a href="#215333" title="=&gt; NormalLinearizer.this.WList">worklist</a>.<span title="(elem: NormalLinearizer.this.Elem)NormalLinearizer.this.worklist.type">push</span><span title="Unit" class="delimiter">(</span><a href="#215659" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span>; 
      <span class="delimiter">}</span>

      <a href="#215336" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">reverse</span>;
    <span class="delimiter">}</span>
    
    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod, start: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]" id="215339">linearizeAt</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="215724">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a>, <a title="Linearizers.this.BasicBlock" id="215725">start</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="#215336" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <span title="object Nil">Nil</span>
      <a href="#215333" title="=&gt; NormalLinearizer.this.WList">worklist</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#215340" title="(startBlock: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]">linearize</a><span class="delimiter">(</span><a href="#215725" title="Linearizers.this.BasicBlock">start</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/** Linearize another subtree and append it to the existing blocks. */</span>
    <span class="keyword">def</span> <a title="(startBlock: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]" id="215340">linearize</a><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215731">startBlock</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="comment">//blocks = startBlock :: Nil;</span>
      <a href="../WorklistAlgorithm.scala.html#197591" title="(initWorklist: =&gt; Unit)Unit">run</a><span class="delimiter">(</span> <span class="delimiter">{</span> <a href="#215333" title="=&gt; NormalLinearizer.this.WList">worklist</a>.<span title="(elem: NormalLinearizer.this.Elem)NormalLinearizer.this.worklist.type">push</span><span title="Unit" class="delimiter">(</span><a href="#215731" title="Linearizers.this.BasicBlock">startBlock</a><span class="delimiter">)</span>; <span class="delimiter">}</span> <span class="delimiter">)</span>;
      <a href="#215336" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">reverse</span>;
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(b: Linearizers.this.BasicBlock)Unit" id="215341">processElement</a><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215738">b</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span> = 
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#215738" title="Linearizers.this.BasicBlock">b</a>.<span title="=&gt; Boolean">nonEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#215343" title="(b: Linearizers.this.BasicBlock)Unit">add</a><span class="delimiter">(</span><a href="#215738" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span>;
        <a href="#215738" title="Linearizers.this.BasicBlock">b</a>.<a href="BasicBlocks.scala.html#197675" title="=&gt; Linearizers.this.Instruction">lastInstruction</a> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Unit">JUMP</span><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215753">whereto</a><span class="delimiter">)</span> =&gt; 
            <a href="#215343" title="(b: Linearizers.this.BasicBlock)Unit">add</a><span class="delimiter">(</span><a href="#215753" title="Linearizers.this.BasicBlock">whereto</a><span class="delimiter">)</span>;
          <span class="keyword">case</span> <span title="Unit">CJUMP</span><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215764">success</a>, <a title="Linearizers.this.BasicBlock" id="215765">failure</a>, _, _<span class="delimiter">)</span> =&gt;
            <a href="#215343" title="(b: Linearizers.this.BasicBlock)Unit">add</a><span class="delimiter">(</span><a href="#215764" title="Linearizers.this.BasicBlock">success</a><span class="delimiter">)</span>;
            <a href="#215343" title="(b: Linearizers.this.BasicBlock)Unit">add</a><span class="delimiter">(</span><a href="#215765" title="Linearizers.this.BasicBlock">failure</a><span class="delimiter">)</span>;
          <span class="keyword">case</span> <span title="Unit">CZJUMP</span><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215782">success</a>, <a title="Linearizers.this.BasicBlock" id="215783">failure</a>, _, _<span class="delimiter">)</span> =&gt;
            <a href="#215343" title="(b: Linearizers.this.BasicBlock)Unit">add</a><span class="delimiter">(</span><a href="#215782" title="Linearizers.this.BasicBlock">success</a><span class="delimiter">)</span>;
            <a href="#215343" title="(b: Linearizers.this.BasicBlock)Unit">add</a><span class="delimiter">(</span><a href="#215783" title="Linearizers.this.BasicBlock">failure</a><span class="delimiter">)</span>;
          <span class="keyword">case</span> <span title="Unit">SWITCH</span><span class="delimiter">(</span>_, <a title="List[Linearizers.this.BasicBlock]" id="215798">labels</a><span class="delimiter">)</span> =&gt;
            <a href="#215344" title="(bs: List[Linearizers.this.BasicBlock])Unit">add</a><span class="delimiter">(</span><a href="#215798" title="List[Linearizers.this.BasicBlock]">labels</a><span class="delimiter">)</span>;
          <span class="keyword">case</span> <span title="Unit">RETURN</span><span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>;
          <span class="keyword">case</span> <span title="Unit">THROW</span><span class="delimiter">(</span><a title="Linearizers.this.global.Symbol" id="215807">clasz</a><span class="delimiter">)</span> =&gt;   <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="=&gt; NormalLinearizer.this.Elem" id="215342">dequeue</a>: <a href="BasicBlocks.scala.html#96970" title="NormalLinearizer.this.Elem">Elem</a> = <a href="#215333" title="=&gt; NormalLinearizer.this.WList">worklist</a>.<span title="()NormalLinearizer.this.Elem">pop</span>;

    <span class="comment">/** 
     * Prepend b to the list, if not already scheduled. 
     * TODO: use better test than linear search
     */</span>
    <span class="keyword">def</span> <a title="(b: Linearizers.this.BasicBlock)Unit" id="215343">add</a><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215748">b</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#215336" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#215748" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#215336" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <a href="#215748" title="Linearizers.this.BasicBlock">b</a> <a href="#215810" title="(x: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]">::</a> <a href="#215336" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>;
        <a href="#215333" title="=&gt; NormalLinearizer.this.WList">worklist</a> <span title="(elem: NormalLinearizer.this.Elem)NormalLinearizer.this.worklist.type">push</span> <a href="#215748" title="Linearizers.this.BasicBlock">b</a>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(bs: List[Linearizers.this.BasicBlock])Unit" id="215344">add</a><span class="delimiter">(</span><a title="List[Linearizers.this.BasicBlock]" id="215746">bs</a>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#215746" title="List[Linearizers.this.BasicBlock]">bs</a> <span title="(f: Linearizers.this.BasicBlock =&gt; Unit)Unit">foreach</span> <a href="#215343" title="(b: Linearizers.this.BasicBlock)Unit">add</a>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Linearize code using a depth first traversal.
   */</span>
  <span class="keyword">class</span> <a title="class DepthFirstLinerizer extends Linearizers.this.Linearizer with ScalaObject" id="97128">DepthFirstLinerizer</a> <a href="#97128" title="ScalaObject" class="keyword">extends</a> <a href="#97126" title="Linearizers.this.Linearizer">Linearizer</a> <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="List[Linearizers.this.BasicBlock]" id="215325">blocks</a>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span title="object Nil">Nil</span>;
    
    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]" id="215327">linearize</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="215849">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="#215325" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <span title="object Nil">Nil</span>;

      <a href="#215329" title="(b: Linearizers.this.BasicBlock)Unit">dfs</a><span class="delimiter">(</span><a href="#215849" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197802" title="=&gt; Linearizers.this.BasicBlock">startBlock</a><span class="delimiter">)</span>;
      <a href="#215849" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197733" title="=&gt; List[Linearizers.this.ExceptionHandler]">exh</a> <span title="(f: Linearizers.this.ExceptionHandler =&gt; Unit)Unit">foreach</span> <span class="delimiter">(</span><a title="Linearizers.this.ExceptionHandler" id="215874">b</a> =&gt; <a href="#215329" title="(b: Linearizers.this.BasicBlock)Unit">dfs</a><span class="delimiter">(</span><a href="#215874" title="Linearizers.this.ExceptionHandler">b</a>.<a href="ExceptionHandlers.scala.html#203093" title="=&gt; Linearizers.this.BasicBlock">startBlock</a><span class="delimiter">)</span><span class="delimiter">)</span>;

      <a href="#215325" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">reverse</span>
    <span class="delimiter">}</span>
    
    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod, start: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]" id="215328">linearizeAt</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="215877">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a>, <a title="Linearizers.this.BasicBlock" id="215878">start</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="#215325" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <span title="object Nil">Nil</span>
      <a href="#215329" title="(b: Linearizers.this.BasicBlock)Unit">dfs</a><span class="delimiter">(</span><a href="#215878" title="Linearizers.this.BasicBlock">start</a><span class="delimiter">)</span>
      <a href="#215325" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">reverse</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(b: Linearizers.this.BasicBlock)Unit" id="215329">dfs</a><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215851">b</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#215851" title="Linearizers.this.BasicBlock">b</a>.<span title="=&gt; Boolean">nonEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#215330" title="(b: Linearizers.this.BasicBlock)Boolean">add</a><span class="delimiter">(</span><a href="#215851" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#215851" title="Linearizers.this.BasicBlock">b</a>.<a href="BasicBlocks.scala.html#197682" title="=&gt; List[Linearizers.this.BasicBlock]">successors</a> <span title="(f: Linearizers.this.BasicBlock =&gt; Unit)Unit">foreach</span> <a href="#215329" title="(b: Linearizers.this.BasicBlock)Unit">dfs</a>;

    <span class="comment">/** 
     * Prepend b to the list, if not already scheduled. 
     * TODO: use better test than linear search
     * @return Returns true if the block was added.
     */</span>
    <span class="keyword">def</span> <a title="(b: Linearizers.this.BasicBlock)Boolean" id="215330">add</a><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="215881">b</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = 
      <span title="=&gt; Boolean">!</span><span class="delimiter">(</span><a href="#215325" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a> <span title="(elem: Any)Boolean">contains</span> <a href="#215881" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">{</span>
        <a href="#215325" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <a href="#215881" title="Linearizers.this.BasicBlock">b</a> <a href="#215906" title="(x: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]">::</a> <a href="#215325" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>;
        <span title="Boolean(true)" class="keyword">true</span>
      <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Linearize code in reverse post order. In fact, it does
   * a post order traversal, prepending visited nodes to the list.
   * This way, it is constructed already in reverse post order.
   */</span>
  <span class="keyword">class</span> <a title="class ReversePostOrderLinearizer extends Linearizers.this.Linearizer with ScalaObject" id="97129">ReversePostOrderLinearizer</a> <a href="#97129" title="ScalaObject" class="keyword">extends</a> <a href="#97126" title="Linearizers.this.Linearizer">Linearizer</a> <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="List[Linearizers.this.BasicBlock]" id="215313">blocks</a>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span title="object Nil">Nil</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" id="215315">visited</a> = <span title="()scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">HashSet</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span>
    <span class="keyword">val</span> <a title="scala.collection.mutable.BitSet" id="215317">added</a> = <span title="()scala.collection.mutable.BitSet" class="keyword">new</span> mutable.<span title="scala.collection.mutable.BitSet">BitSet</span>
    
    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]" id="215319">linearize</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="216023">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="#215313" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <span title="object Nil">Nil</span>;
      <a href="#215315" title="=&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">visited</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#215317" title="=&gt; scala.collection.mutable.BitSet">added</a>.<span title="()Unit">clear</span>;

      <a href="#216023" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197733" title="=&gt; List[Linearizers.this.ExceptionHandler]">exh</a> <span title="(f: Linearizers.this.ExceptionHandler =&gt; Unit)Unit">foreach</span> <span class="delimiter">(</span><a title="Linearizers.this.ExceptionHandler" id="216046">b</a> =&gt; <a href="#215321" title="(b: Linearizers.this.BasicBlock)Unit">rpo</a><span class="delimiter">(</span><a href="#216046" title="Linearizers.this.ExceptionHandler">b</a>.<a href="ExceptionHandlers.scala.html#203093" title="=&gt; Linearizers.this.BasicBlock">startBlock</a><span class="delimiter">)</span><span class="delimiter">)</span>;
      <a href="#215321" title="(b: Linearizers.this.BasicBlock)Unit">rpo</a><span class="delimiter">(</span><a href="#216023" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197802" title="=&gt; Linearizers.this.BasicBlock">startBlock</a><span class="delimiter">)</span>;
      
      <span class="comment">// if the start block has predecessors, it won't be the first one </span>
      <span class="comment">// in the linearization, so we need to enforce it here</span>
      <span title="List[Linearizers.this.BasicBlock]" class="keyword">if</span> <span class="delimiter">(</span><a href="#216023" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197802" title="=&gt; Linearizers.this.BasicBlock">startBlock</a>.<a href="BasicBlocks.scala.html#197686" title="=&gt; List[Linearizers.this.BasicBlock]">predecessors</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="object Nil">Nil</span><span class="delimiter">)</span>
        <a href="#215313" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>
      <span class="keyword">else</span>
        <a href="#216023" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197802" title="=&gt; Linearizers.this.BasicBlock">startBlock</a> <a href="#216051" title="(x: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]">::</a> <span class="delimiter">(</span><a href="#215313" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="(p: Linearizers.this.BasicBlock =&gt; Boolean)List[Linearizers.this.BasicBlock]">filterNot</span><span class="delimiter">(</span><a href="#216057" title="Linearizers.this.BasicBlock">_</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#216023" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197802" title="=&gt; Linearizers.this.BasicBlock">startBlock</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod, start: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]" id="215320">linearizeAt</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="216067">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a>, <a title="Linearizers.this.BasicBlock" id="216068">start</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="#215313" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <span title="object Nil">Nil</span>
      <a href="#215315" title="=&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">visited</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#215317" title="=&gt; scala.collection.mutable.BitSet">added</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      
      <a href="#215321" title="(b: Linearizers.this.BasicBlock)Unit">rpo</a><span class="delimiter">(</span><a href="#216068" title="Linearizers.this.BasicBlock">start</a><span class="delimiter">)</span>
      <a href="#215313" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>
    <span class="delimiter">}</span>
    
    <span class="keyword">def</span> <a title="(b: Linearizers.this.BasicBlock)Unit" id="215321">rpo</a><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="216047">b</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = 
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#216047" title="Linearizers.this.BasicBlock">b</a>.<span title="=&gt; Boolean">nonEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#215315" title="(elem: Linearizers.this.BasicBlock)Boolean">visited</a><span class="delimiter">(</span><a href="#216047" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#215315" title="=&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">visited</a> <span title="(elem: Linearizers.this.BasicBlock)ReversePostOrderLinearizer.this.visited.type">+=</span> <a href="#216047" title="Linearizers.this.BasicBlock">b</a>;
        <a href="#216047" title="Linearizers.this.BasicBlock">b</a>.<a href="BasicBlocks.scala.html#197682" title="=&gt; List[Linearizers.this.BasicBlock]">successors</a> <span title="(f: Linearizers.this.BasicBlock =&gt; Unit)Unit">foreach</span> <a href="#215321" title="(b: Linearizers.this.BasicBlock)Unit">rpo</a>
        <a href="#215322" title="(b: Linearizers.this.BasicBlock)Unit">add</a><span class="delimiter">(</span><a href="#216047" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

    <span class="comment">/** 
     * Prepend b to the list, if not already scheduled. 
     * @return Returns true if the block was added.
     */</span>
    <span class="keyword">def</span> <a title="(b: Linearizers.this.BasicBlock)Unit" id="215322">add</a><span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="216123">b</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span> = 
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#215317" title="(elem: Int)Boolean">added</a><span class="delimiter">(</span><a href="#216123" title="Linearizers.this.BasicBlock">b</a>.<a href="BasicBlocks.scala.html#197611" title="=&gt; Int">label</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#215317" title="=&gt; scala.collection.mutable.BitSet">added</a> <span title="(elem: Int)ReversePostOrderLinearizer.this.added.type">+=</span> <a href="#216123" title="Linearizers.this.BasicBlock">b</a>.<a href="BasicBlocks.scala.html#197611" title="=&gt; Int">label</a>
        <a href="#215313" title="(x$1: List[Linearizers.this.BasicBlock])Unit">blocks</a> = <a href="#216123" title="Linearizers.this.BasicBlock">b</a> <a href="#216194" title="(x: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]">::</a> <a href="#215313" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>;
      <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** A 'dump' of the blocks in this method, which does not
   *  require any well-formedness of the basic blocks (like
   *  the last instruction being a jump).
   */</span>
  <span class="keyword">class</span> <a title="class DumpLinearizer extends Linearizers.this.Linearizer with ScalaObject" id="97130">DumpLinearizer</a> <a href="#97130" title="ScalaObject" class="keyword">extends</a> <a href="#97126" title="Linearizers.this.Linearizer">Linearizer</a> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]" id="215346">linearize</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="216201">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <a href="#216201" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197800" title="=&gt; scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">blocks</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">toList</span>    
    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod, start: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]" id="215347">linearizeAt</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="216214">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a>, <a title="Linearizers.this.BasicBlock" id="216215">start</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;not implemented&quot;)" class="string">&quot;not implemented&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** The MSIL linearizer is used only for methods with at least one exception handler.
   *  It makes sure that all the blocks belonging to a `try`, `catch` or `finally` block
   *  are emitted in an order that allows the lexical nesting of try-catch-finally, just
   *  like in the source code.
   */</span>
  <span class="keyword">class</span> <a title="class MSILLinearizer extends Linearizers.this.Linearizer with ScalaObject" id="97131">MSILLinearizer</a> <a href="#97131" title="ScalaObject" class="keyword">extends</a> <a href="#97126" title="Linearizers.this.Linearizer">Linearizer</a> <span class="delimiter">{</span>
    <span class="comment">/** The MSIL linearizer first calls a NormalLInearizer. This is because the ILGenerator checks
     *  the stack size before emitting instructions. For instance, to emit a `store`, there needs
     *  to be some value on the stack. This can blow up in situations like this:
     *       ...
     *       jump 3
     *    4: store_local 0
     *       jump 5
     *    3: load_value
     *       jump 4
     *    5: ...
     *  here, 3 must be scheduled first.
     *
     *  The NormalLinearizer also removes dead blocks (blocks without predecessor). This is important
     *  in the following example:
     *     try { throw new Exception }
     *     catch { case e =&gt; throw e }
     *  which adds a dead block containing just a &quot;throw&quot; (which, again, would blow up code generation
     *  because of the stack size; there's no value on the stack when emitting that `throw`)
     */</span>
    <span class="keyword">val</span> <a title="Linearizers.this.NormalLinearizer" id="216218">normalLinearizer</a> = <span title="Linearizers.this.NormalLinearizer" class="keyword">new</span> <a href="#97127" title="Linearizers.this.NormalLinearizer">NormalLinearizer</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]" id="216220">linearize</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="216225">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>

      <span class="keyword">val</span> <a title="scala.collection.immutable.Map[scala.collection.immutable.Set[Linearizers.this.BasicBlock],List[Linearizers.this.ExceptionHandler]]" id="216227">handlersByCovered</a> = <a href="#216225" title="Linearizers.this.IMethod">m</a>.<a href="Members.scala.html#197733" title="=&gt; List[Linearizers.this.ExceptionHandler]">exh</a>.<span title="(f: Linearizers.this.ExceptionHandler =&gt; scala.collection.immutable.Set[Linearizers.this.BasicBlock])scala.collection.immutable.Map[scala.collection.immutable.Set[Linearizers.this.BasicBlock],List[Linearizers.this.ExceptionHandler]]">groupBy</span><span class="delimiter">(</span><a href="#216240" title="Linearizers.this.ExceptionHandler">_</a>.<a href="ExceptionHandlers.scala.html#203094" title="=&gt; scala.collection.immutable.Set[Linearizers.this.BasicBlock]">covered</a><span class="delimiter">)</span>

      <span class="comment">// number of basic blocks covered by the entire try-catch expression</span>
      <span class="keyword">def</span> <a title="(covered: scala.collection.immutable.Set[Linearizers.this.BasicBlock])Int" id="216228">size</a><span class="delimiter">(</span><a title="scala.collection.immutable.Set[Linearizers.this.BasicBlock]" id="216242">covered</a>: collection.immutable.<span title="scala.collection.immutable.Set[Linearizers.this.BasicBlock]">Set</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="List[Linearizers.this.ExceptionHandler]" id="216243">hs</a> = <a href="#216227" title="(key: scala.collection.immutable.Set[Linearizers.this.BasicBlock])List[Linearizers.this.ExceptionHandler]">handlersByCovered</a><span class="delimiter">(</span><a href="#216242" title="scala.collection.immutable.Set[Linearizers.this.BasicBlock]">covered</a><span class="delimiter">)</span>
        <a href="#216242" title="scala.collection.immutable.Set[Linearizers.this.BasicBlock]">covered</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Int">+</span> <span class="delimiter">(</span><a href="#216243" title="List[Linearizers.this.ExceptionHandler]">hs</a> <span title="(z: Int)(op: (Linearizers.this.ExceptionHandler, Int) =&gt; Int)Int">:\</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Linearizers.this.ExceptionHandler" id="216289">h</a>, <a title="Int" id="216290">s</a><span class="delimiter">)</span> =&gt; <a href="#216289" title="Linearizers.this.ExceptionHandler">h</a>.<a href="ExceptionHandlers.scala.html#203099" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Int">+</span> <a href="#216290" title="Int">s</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <span class="keyword">val</span> <a title="List[scala.collection.immutable.Set[Linearizers.this.BasicBlock]]" id="216229">tryBlocks</a> = <a href="#216227" title="scala.collection.immutable.Map[scala.collection.immutable.Set[Linearizers.this.BasicBlock],List[Linearizers.this.ExceptionHandler]]">handlersByCovered</a>.<span title="=&gt; Iterable[scala.collection.immutable.Set[Linearizers.this.BasicBlock]]">keys</span>.<span title="=&gt; List[scala.collection.immutable.Set[Linearizers.this.BasicBlock]]">toList</span> <span title="(f: scala.collection.immutable.Set[Linearizers.this.BasicBlock] =&gt; Int)(implicit ord: scala.math.Ordering[Int])List[scala.collection.immutable.Set[Linearizers.this.BasicBlock]]">sortBy</span> <a href="#216228" title="(covered: scala.collection.immutable.Set[Linearizers.this.BasicBlock])Int">size</a>
      <span class="keyword">var</span> <a title="List[Linearizers.this.BasicBlock]" id="216230">result</a>    = <a href="#216218" title="=&gt; Linearizers.this.NormalLinearizer">normalLinearizer</a>.<a href="#215338" title="(m: Linearizers.this.IMethod)List[Linearizers.this.BasicBlock]">linearize</a><span class="delimiter">(</span><a href="#216225" title="Linearizers.this.IMethod">m</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" id="216231">frozen</a>    = mutable.<span title="[A](elems: A*)scala.collection.mutable.HashSet[A]">HashSet</span><span title="(elems: Linearizers.this.BasicBlock*)scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" class="delimiter">[</span><a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">]</span><span class="delimiter">(</span><a href="#216230" title="List[Linearizers.this.BasicBlock]">result</a>.<span title="=&gt; Linearizers.this.BasicBlock">head</span><span class="delimiter">)</span>
      
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="scala.collection.immutable.Set[Linearizers.this.BasicBlock]" id="216399">tryBlock</a> &lt;- <a href="#216229" title="(f: scala.collection.immutable.Set[Linearizers.this.BasicBlock] =&gt; Unit)Unit">tryBlocks</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#216230" title="List[Linearizers.this.BasicBlock]">result</a> = <a href="#216221" title="(method: Linearizers.this.IMethod, blocks: List[Linearizers.this.BasicBlock], handlers: List[Linearizers.this.ExceptionHandler], frozen: scala.collection.mutable.HashSet[Linearizers.this.BasicBlock])List[Linearizers.this.BasicBlock]">groupBlocks</a><span class="delimiter">(</span><a href="#216225" title="Linearizers.this.IMethod">m</a>, <a href="#216230" title="List[Linearizers.this.BasicBlock]">result</a>, <a href="#216227" title="(key: scala.collection.immutable.Set[Linearizers.this.BasicBlock])List[Linearizers.this.ExceptionHandler]">handlersByCovered</a><span class="delimiter">(</span><a href="#216399" title="scala.collection.immutable.Set[Linearizers.this.BasicBlock]">tryBlock</a><span class="delimiter">)</span>, <a href="#216231" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">frozen</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#216230" title="List[Linearizers.this.BasicBlock]">result</a>
    <span class="delimiter">}</span>

    <span class="comment">/** @param handlers a list of handlers covering the same blocks (same try, multiple catches)
     *  @param frozen blocks can't be moved (fist block of a method, blocks directly following a try-catch)
     */</span>
    <span class="keyword">def</span> <a title="(method: Linearizers.this.IMethod, blocks: List[Linearizers.this.BasicBlock], handlers: List[Linearizers.this.ExceptionHandler], frozen: scala.collection.mutable.HashSet[Linearizers.this.BasicBlock])List[Linearizers.this.BasicBlock]" id="216221">groupBlocks</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="216400">method</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a>, <a title="List[Linearizers.this.BasicBlock]" id="216401">blocks</a>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span>, <a title="List[Linearizers.this.ExceptionHandler]" id="216402">handlers</a>: <span title="List[Linearizers.this.ExceptionHandler]">List</span><span class="delimiter">[</span>ExceptionHandler<span class="delimiter">]</span>, <a title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" id="216403">frozen</a>: mutable.<span title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">HashSet</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#216401" title="List[Linearizers.this.BasicBlock]">blocks</a>.<span title="=&gt; Linearizers.this.BasicBlock">head</span> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#216400" title="Linearizers.this.IMethod">method</a>.<a href="Members.scala.html#197727" title="=&gt; Linearizers.this.Code">code</a>.<a href="Members.scala.html#197802" title="=&gt; Linearizers.this.BasicBlock">startBlock</a>, <a href="#216400" title="Linearizers.this.IMethod">method</a><span class="delimiter">)</span>

      <span class="comment">// blocks before the try, and blocks for the try</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" id="216406">beforeAndTry</a> = <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" class="keyword">new</span> <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">ListBuffer</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">// blocks for the handlers</span>
      <span class="keyword">val</span> <a title="List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]]" id="216407">catches</a> = <a href="#216402" title="List[Linearizers.this.ExceptionHandler]">handlers</a> <span title="(f: Linearizers.this.ExceptionHandler =&gt; scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock])(implicit bf: scala.collection.generic.CanBuildFrom[List[Linearizers.this.ExceptionHandler],scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock],List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]]])List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]]">map</span> <span class="delimiter">(</span><a title="Linearizers.this.ExceptionHandler" id="216437">_</a> =&gt; <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" class="keyword">new</span> <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">ListBuffer</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="comment">// blocks to be put at the end</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" id="216408">after</a> = <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" class="keyword">new</span> <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">ListBuffer</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>

      <span class="keyword">var</span> <a title="Boolean" id="216409">beforeTry</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span class="keyword">val</span> <a title="Linearizers.this.ExceptionHandler" id="216410">head</a> = <a href="#216402" title="List[Linearizers.this.ExceptionHandler]">handlers</a>.<span title="=&gt; Linearizers.this.ExceptionHandler">head</span>

      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="216491">b</a> &lt;- <a href="#216401" title="(f: Linearizers.this.BasicBlock =&gt; scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock])Unit">blocks</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" class="keyword">if</span> <span class="delimiter">(</span><a href="#216410" title="Linearizers.this.ExceptionHandler">head</a> <a href="ExceptionHandlers.scala.html#203098" title="(b: Linearizers.this.BasicBlock)Boolean">covers</a> <a href="#216491" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#216409" title="Boolean">beforeTry</a> = <span title="Boolean(false)" class="keyword">false</span>
          <a href="#216406" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">beforeAndTry</a> <span title="(x: Linearizers.this.BasicBlock)beforeAndTry.type">+=</span> <a href="#216491" title="Linearizers.this.BasicBlock">b</a>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Int" id="216502">handlerIndex</a> = <a href="#216402" title="List[Linearizers.this.ExceptionHandler]">handlers</a>.<span title="(p: Linearizers.this.ExceptionHandler =&gt; Boolean)Int">indexWhere</span><span class="delimiter">(</span><a href="#216513" title="Linearizers.this.ExceptionHandler">_</a>.<a href="ExceptionHandlers.scala.html#203099" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#216491" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" class="keyword">if</span> <span class="delimiter">(</span><a href="#216502" title="Int">handlerIndex</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#216407" title="(n: Int)scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">catches</a><span class="delimiter">(</span><a href="#216502" title="Int">handlerIndex</a><span class="delimiter">)</span> <span title="(x: Linearizers.this.BasicBlock)scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">+=</span> <a href="#216491" title="Linearizers.this.BasicBlock">b</a>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" class="keyword">if</span> <span class="delimiter">(</span><a href="#216409" title="Boolean">beforeTry</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#216406" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">beforeAndTry</a> <span title="(x: Linearizers.this.BasicBlock)beforeAndTry.type">+=</span> <a href="#216491" title="Linearizers.this.BasicBlock">b</a>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <a href="#216408" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">after</a> <span title="(x: Linearizers.this.BasicBlock)after.type">+=</span> <a href="#216491" title="Linearizers.this.BasicBlock">b</a>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

      <span class="comment">// reorder the blocks in &quot;catches&quot; so that the &quot;firstBlock&quot; is actually first</span>
      <span title="(_1: List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]], _2: List[Linearizers.this.ExceptionHandler])(List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]], List[Linearizers.this.ExceptionHandler])" class="delimiter">(</span><a href="#216407" title="List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]]">catches</a>, <a href="#216402" title="List[Linearizers.this.ExceptionHandler]">handlers</a><span class="delimiter">)</span>.<span title="(implicit w1: List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]] =&gt; scala.collection.TraversableLike[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock],List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]]], implicit w2: List[Linearizers.this.ExceptionHandler] =&gt; scala.collection.IterableLike[Linearizers.this.ExceptionHandler,List[Linearizers.this.ExceptionHandler]])(List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]], List[Linearizers.this.ExceptionHandler])#Zipped[List[scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]],scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock],List[Linearizers.this.ExceptionHandler],Linearizers.this.ExceptionHandler]">zipped</span> <span title="(f: (scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock], Linearizers.this.ExceptionHandler) =&gt; scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock])Unit">foreach</span> <span class="delimiter">{</span> <span class="delimiter">(</span><a title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" id="216629">lb</a>, <a title="Linearizers.this.ExceptionHandler" id="216630">handler</a><span class="delimiter">)</span> =&gt;
        <a href="#216629" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">lb</a> <span title="(elem: Linearizers.this.BasicBlock)lb.type">-=</span> <a href="#216630" title="Linearizers.this.ExceptionHandler">handler</a>.<a href="ExceptionHandlers.scala.html#203093" title="=&gt; Linearizers.this.BasicBlock">startBlock</a>
        <a href="#216630" title="Linearizers.this.ExceptionHandler">handler</a>.<a href="ExceptionHandlers.scala.html#203093" title="=&gt; Linearizers.this.BasicBlock">startBlock</a> <a href="#216639" title="(x: Linearizers.this.BasicBlock)lb.type">+=:</a> <a href="#216629" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">lb</a>
      <span class="delimiter">}</span>

      <span class="comment">// The first block emitted after a try-catch must be the the one that the try / catch</span>
      <span class="comment">// blocks jump to (because in msil, these jumps cannot be emitted manually)</span>
      <span class="keyword">var</span> <a title="Option[Linearizers.this.BasicBlock]" id="216411">firstAfter</a>: <span title="Option[Linearizers.this.BasicBlock]">Option</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span title="object None">None</span>

      <span class="comment">// Find the (hopefully) unique successor, look at the try and all catch blocks</span>
      <span class="keyword">var</span> <a title="List[List[Linearizers.this.BasicBlock]]" id="216412">blks</a> = <a href="#216410" title="Linearizers.this.ExceptionHandler">head</a>.<a href="ExceptionHandlers.scala.html#203094" title="=&gt; scala.collection.immutable.Set[Linearizers.this.BasicBlock]">covered</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">toList</span> <a href="#216646" title="(x: List[Linearizers.this.BasicBlock])List[List[Linearizers.this.BasicBlock]]">::</a> <a href="#216402" title="List[Linearizers.this.ExceptionHandler]">handlers</a>.<span title="(f: Linearizers.this.ExceptionHandler =&gt; List[Linearizers.this.BasicBlock])(implicit bf: scala.collection.generic.CanBuildFrom[List[Linearizers.this.ExceptionHandler],List[Linearizers.this.BasicBlock],List[List[Linearizers.this.BasicBlock]]])List[List[Linearizers.this.BasicBlock]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,List[Linearizers.this.BasicBlock],List[List[Linearizers.this.BasicBlock]]]" class="delimiter">(</span><a href="#216664" title="Linearizers.this.ExceptionHandler">_</a>.<a href="ExceptionHandlers.scala.html#203099" title="=&gt; List[Linearizers.this.BasicBlock]">blocks</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#216411" title="Option[Linearizers.this.BasicBlock]">firstAfter</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#216412" title="List[List[Linearizers.this.BasicBlock]]">blks</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#216413" title="()Unit" class="delimiter">{</a>
        <span class="keyword">val</span> <a title="List[Linearizers.this.BasicBlock]" id="216713">b</a> = <a href="#216412" title="List[List[Linearizers.this.BasicBlock]]">blks</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">head</span>
        <a href="#216412" title="List[List[Linearizers.this.BasicBlock]]">blks</a> = <a href="#216412" title="List[List[Linearizers.this.BasicBlock]]">blks</a>.<span title="=&gt; List[List[Linearizers.this.BasicBlock]]">tail</span>

        <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" id="216714">leaving</a> = <a href="#216222" title="(blocks: List[Linearizers.this.BasicBlock])scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">leavingBlocks</a><span class="delimiter">(</span><a href="#216713" title="List[Linearizers.this.BasicBlock]">b</a><span class="delimiter">)</span>
        <span class="comment">// no leaving blocks when the try or catch ends with THROW or RET</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#216714" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">leaving</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#216714" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">leaving</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(1)" class="int">1</span>, <a href="#216714" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">leaving</a><span class="delimiter">)</span>
          <a href="#216411" title="Option[Linearizers.this.BasicBlock]">firstAfter</a> = <span title="(x: Linearizers.this.BasicBlock)Some[Linearizers.this.BasicBlock]">Some</span><span class="delimiter">(</span><a href="#216714" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">leaving</a>.<span title="=&gt; Linearizers.this.BasicBlock">head</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#216411" title="Option[Linearizers.this.BasicBlock]">firstAfter</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Linearizers.this.BasicBlock" id="216773">b</a> = <a href="#216411" title="Option[Linearizers.this.BasicBlock]">firstAfter</a>.<span title="=&gt; Linearizers.this.BasicBlock">get</span>
        <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#216403" title="(elem: Linearizers.this.BasicBlock)Boolean">frozen</a><span class="delimiter">(</span><a href="#216773" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#216408" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">after</a> <span title="(elem: Any)Boolean">contains</span> <a href="#216773" title="Linearizers.this.BasicBlock">b</a>, <a href="#216773" title="implicit scala.Predef.any2stringadd : (x: Any)scala.runtime.StringAdd">b</a> <span title="(other: String)java.lang.String">+</span><span title="java.lang.String(&quot;, &quot;)" class="string">&quot;, &quot;</span><span title="(x$1: Any)java.lang.String">+</span> <a href="#216400" title="Linearizers.this.IMethod">method</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <a href="#216403" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">frozen</a> <span title="(elem: Linearizers.this.BasicBlock)frozen.type">+=</span> <a href="#216773" title="Linearizers.this.BasicBlock">b</a>
          <span title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" class="keyword">if</span> <span class="delimiter">(</span><a href="#216406" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">beforeAndTry</a> <span title="(elem: Any)Boolean">contains</span> <a href="#216773" title="Linearizers.this.BasicBlock">b</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#216406" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">beforeAndTry</a> <span title="(elem: Linearizers.this.BasicBlock)beforeAndTry.type">-=</span> <a href="#216773" title="Linearizers.this.BasicBlock">b</a>
          <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
            <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#216408" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">after</a> <span title="(elem: Any)Boolean">contains</span> <a href="#216773" title="Linearizers.this.BasicBlock">b</a>, <a href="#216408" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">after</a><span class="delimiter">)</span>
            <a href="#216408" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">after</a> <span title="(elem: Linearizers.this.BasicBlock)after.type">-=</span> <a href="#216773" title="Linearizers.this.BasicBlock">b</a>
          <span class="delimiter">}</span>
          <a href="#216773" title="Linearizers.this.BasicBlock">b</a> <a href="#216816" title="(x: Linearizers.this.BasicBlock)after.type">+=:</a> <a href="#216408" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">after</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

      <span class="keyword">for</span> <span class="delimiter">(</span><a title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]" id="216863">lb</a> &lt;- <a href="#216407" title="(f: scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock] =&gt; scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock])Unit">catches</a><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#216406" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">beforeAndTry</a> <span title="(xs: scala.collection.TraversableOnce[Linearizers.this.BasicBlock])beforeAndTry.type">++=</span> <a href="#216863" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">lb</a> <span class="delimiter">}</span>
      <a href="#216406" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">beforeAndTry</a> <span title="(xs: scala.collection.TraversableOnce[Linearizers.this.BasicBlock])beforeAndTry.type">++=</span> <a href="#216408" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">after</a>
      <a href="#216406" title="scala.collection.mutable.ListBuffer[Linearizers.this.BasicBlock]">beforeAndTry</a>.<span title="=&gt; List[Linearizers.this.BasicBlock]">toList</span>
    <span class="delimiter">}</span>

    <span class="comment">/** Returns all direct successors of `blocks` wich are not part
     *  that list, i.e. successors outside the `blocks` list.
     */</span>
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(blocks: List[Linearizers.this.BasicBlock])scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" id="216222">leavingBlocks</a><span class="delimiter">(</span><a title="List[Linearizers.this.BasicBlock]" id="216717">blocks</a>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" id="216720">res</a> = <span title="()scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">HashSet</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Linearizers.this.BasicBlock" id="216741">b</a> &lt;- <a href="#216717" title="(f: Linearizers.this.BasicBlock =&gt; Unit)Unit">blocks</a>; <a title="Linearizers.this.BasicBlock" id="216752">s</a> &lt;- <a href="#216741" title="Linearizers.this.BasicBlock">b</a>.<a href="BasicBlocks.scala.html#197683" title="(f: Linearizers.this.BasicBlock =&gt; scala.collection.mutable.HashSet[Linearizers.this.BasicBlock])Unit">directSuccessors</a>; <span class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#216717" title="List[Linearizers.this.BasicBlock]">blocks</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#216752" title="Linearizers.this.BasicBlock">s</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#216720" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">res</a> <span title="(elem: Linearizers.this.BasicBlock)res.type">+=</span> <a href="#216752" title="Linearizers.this.BasicBlock">s</a>
      <a href="#216720" title="scala.collection.mutable.HashSet[Linearizers.this.BasicBlock]">res</a>
    <span class="delimiter">}</span>

    <span class="keyword">def</span> <a title="(m: Linearizers.this.IMethod, start: Linearizers.this.BasicBlock)List[Linearizers.this.BasicBlock]" id="216223">linearizeAt</a><span class="delimiter">(</span><a title="Linearizers.this.IMethod" id="216890">m</a>: <a href="Members.scala.html#96963" title="Linearizers.this.IMethod">IMethod</a>, <a title="Linearizers.this.BasicBlock" id="216891">start</a>: <a href="BasicBlocks.scala.html#96970" title="Linearizers.this.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="List[Linearizers.this.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span class="delimiter">{</span>
      sys.<span title="(message: String)Nothing">error</span><span class="delimiter">(</span><span title="java.lang.String(&quot;not implemented&quot;)" class="string">&quot;not implemented&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>