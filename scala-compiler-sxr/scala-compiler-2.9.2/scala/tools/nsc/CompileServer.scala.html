<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>scala/tools/nsc/CompileServer.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* NSC -- new Scala compiler
 * Copyright 2005-2011 LAMP/EPFL
 * @author  Martin Odersky
 */</span>

<span class="keyword">package</span> scala.tools.nsc

<span class="keyword">import</span> java.io.<span class="delimiter">{</span> BufferedOutputStream, FileOutputStream, PrintStream <span class="delimiter">}</span>
<span class="keyword">import</span> scala.tools.nsc.reporters.<span class="delimiter">{</span>Reporter, ConsoleReporter<span class="delimiter">}</span>
<span class="keyword">import</span> scala.tools.nsc.util.FakePos <span class="comment">//Position</span>
<span class="keyword">import</span> scala.tools.util.SocketServer
<span class="keyword">import</span> settings.FscSettings

<span class="comment">/**
 *  The server part of the fsc offline compiler.  It awaits compilation
 *  commands and executes them.  It caches a compiler instance so
 *  that it can respond more quickly.
 *
 *  @author Martin Odersky
 *  @version 1.0
 */</span>
<span class="keyword">class</span> <a title="class StandardCompileServer extends scala.tools.util.SocketServer with ScalaObject" id="23007">StandardCompileServer</a> <a href="../../ScalaObject.scala.html#464" title="ScalaObject" class="keyword">extends</a> <a href="../util/SocketServer.scala.html#43851" title="scala.tools.util.SocketServer">SocketServer</a> <span class="delimiter">{</span>
  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.tools.nsc.CompileSocket" id="502663">compileSocket</a>: <a href="CompileSocket.scala.html#22911" title="scala.tools.nsc.CompileSocket">CompileSocket</a> = <a href="CompileSocket.scala.html#22912" title="object scala.tools.nsc.CompileSocket">CompileSocket</a>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="scala.tools.nsc.Global" id="502665">compiler</a>: <a href="Global.scala.html#22521" title="scala.tools.nsc.Global">Global</a> = <span title="Null(null)" class="keyword">null</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()Unit" id="502667">clearCompiler</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#502665" title="(x$1: scala.tools.nsc.Global)Unit">compiler</a> = <span title="Null(null)" class="keyword">null</span>

  <span class="keyword">var</span> <a title="scala.tools.nsc.reporters.ConsoleReporter" id="502669">reporter</a>: <a href="reporters/ConsoleReporter.scala.html#34927" title="scala.tools.nsc.reporters.ConsoleReporter">ConsoleReporter</a> = _
  <span class="keyword">var</span> <a title="Boolean" id="502672">shutdown</a> = <span title="Boolean(false)" class="keyword">false</span>
  <span class="keyword">var</span> <a title="Boolean" id="502675">verbose</a> = <span title="Boolean(false)" class="keyword">false</span>

  <span class="keyword">val</span> <a title="java.lang.String" id="502677">versionMsg</a> = <span title="java.lang.String(&quot;Fast Scala compiler &quot;)" class="string">&quot;Fast Scala compiler &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
    <a href="Properties.scala.html#23224" title="object scala.tools.nsc.Properties">Properties</a>.<a href="../../util/Properties.scala.html#62283" title="=&gt; java.lang.String">versionString</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; -- &quot;)" class="string">&quot; -- &quot;</span> <span title="(x$1: Any)java.lang.String">+</span>
    <a href="Properties.scala.html#23224" title="object scala.tools.nsc.Properties">Properties</a>.<a href="../../util/Properties.scala.html#62285" title="=&gt; String">copyrightString</a>

  <span class="keyword">val</span> <a title="Double" id="502679">MaxCharge</a> = <span title="Double(0.8)" class="double">0.8</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.lang.Runtime" id="502681">runtime</a> = <span title="object java.lang.Runtime">Runtime</span>.<span title="()java.lang.Runtime">getRuntime</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">import</span> <a href="#502681" title="=&gt; java.lang.Runtime">runtime</a>.<span class="delimiter">{</span> totalMemory, freeMemory, maxMemory <span class="delimiter">}</span>

  <span class="comment">/** Create a new compiler instance */</span>
  <span class="keyword">def</span> <a title="(settings: scala.tools.nsc.Settings, reporter: scala.tools.nsc.reporters.Reporter)scala.tools.nsc.Global" id="502684">newGlobal</a><span class="delimiter">(</span><a title="scala.tools.nsc.Settings" id="502698">settings</a>: <a href="Settings.scala.html#22887" title="scala.tools.nsc.Settings">Settings</a>, <a title="scala.tools.nsc.reporters.Reporter" id="502699">reporter</a>: <a href="reporters/Reporter.scala.html#34933" title="scala.tools.nsc.reporters.Reporter">Reporter</a><span class="delimiter">)</span> =
    <a href="#502702" title="scala.tools.nsc.Global" class="keyword">new</a> <a href="Global.scala.html#22521" title="anonymous class $anon extends scala.tools.nsc.Global" id="502702">Global</a><span class="delimiter">(</span><a href="#502698" title="scala.tools.nsc.Settings">settings</a>, <a href="#502699" title="scala.tools.nsc.reporters.Reporter">reporter</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="(msg: String)Unit" id="502704">inform</a><span class="delimiter">(</span><a title="String" id="502706">msg</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="../util/SocketServer.scala.html#502641" title="=&gt; java.io.PrintWriter">out</a>.<span title="(x$1: java.lang.String)Unit">println</span><span class="delimiter">(</span><a href="#502706" title="String">msg</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="502685">timeout</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="../../Boolean.scala.html#55576" title="=&gt; Boolean">!</a><a href="#502662" title="=&gt; scala.tools.nsc.CompileSocket">compileSocket</a>.<a href="CompileSocket.scala.html#501873" title="(port: Int)scala.tools.nsc.io.File">portFile</a><span class="delimiter">(</span><a href="../util/SocketServer.scala.html#502648" title="=&gt; Int">port</a><span class="delimiter">)</span>.<a href="io/Path.scala.html#479436" title="=&gt; Boolean">exists</a><span class="delimiter">)</span>
      <a href="../util/SocketServer.scala.html#471065" title="(msg: String)Nothing">fatal</a><span class="delimiter">(</span><span title="java.lang.String(&quot;port file no longer exists; skipping cleanup&quot;)" class="string">&quot;port file no longer exists; skipping cleanup&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="502686">printMemoryStats</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(bytes: Long)String" id="502829">mb</a><span class="delimiter">(</span><a title="Long" id="502830">bytes</a>: <a href="../../Long.scala.html#1439" title="Long">Long</a><span class="delimiter">)</span> = <a href="../../Predef.scala.html#9682" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%dMB&quot;</a>.<a href="../../collection/immutable/StringLike.scala.html#56577" title="(args: Any*)String">format</a><span class="delimiter">(</span><a href="#502830" title="Long">bytes</a> <a href="../../Long.scala.html#55190" title="(x: Int)Long">/</a> <span title="Int(1000000)" class="int">1000000</span><span class="delimiter">)</span>
    <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><a href="../../Predef.scala.html#9682" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New session: total memory = %s, max memory = %s, free memory = %s&quot;</a>.<a href="../../collection/immutable/StringLike.scala.html#56577" title="(args: Any*)String">format</a><span class="delimiter">(</span>
      <a href="#502829" title="(bytes: Long)String">mb</a><span class="delimiter">(</span><a href="#502681" title="()Long">totalMemory</a><span class="delimiter">)</span>, <a href="#502829" title="(bytes: Long)String">mb</a><span class="delimiter">(</span><a href="#502681" title="()Long">maxMemory</a><span class="delimiter">)</span>, <a href="#502829" title="(bytes: Long)String">mb</a><span class="delimiter">(</span><a href="#502681" title="()Long">freeMemory</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Boolean" id="502687">isMemoryFullEnough</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#502681" title="=&gt; java.lang.Runtime">runtime</a>.<span title="()Unit">gc</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">(</span><a href="#502681" title="()Long">totalMemory</a> <a href="../../Long.scala.html#55177" title="(x: Long)Long">-</a> <a href="#502681" title="()Long">freeMemory</a><span class="delimiter">)</span>.<a href="../../Long.scala.html#55098" title="=&gt; Double">toDouble</a> <a href="../../Double.scala.html#55529" title="(x: Double)Double">/</a> <a href="#502681" title="()Long">maxMemory</a>.<a href="../../Long.scala.html#55098" title="=&gt; Double">toDouble</a> <a href="../../Double.scala.html#55494" title="(x: Double)Boolean">&gt;</a> <a href="#502679" title="=&gt; Double">MaxCharge</a>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(arguments: List[String], settings: scala.tools.nsc.settings.FscSettings)scala.tools.nsc.OfflineCompilerCommand" id="502688">newOfflineCompilerCommand</a><span class="delimiter">(</span><a title="List[String]" id="502856">arguments</a>: <a href="../../collection/immutable/List.scala.html#14047" title="List[String]">List</a><span class="delimiter">[</span>String<span class="delimiter">]</span>, <a title="scala.tools.nsc.settings.FscSettings" id="502857">settings</a>: <a href="settings/FscSettings.scala.html#35125" title="scala.tools.nsc.settings.FscSettings">FscSettings</a><span class="delimiter">)</span>: <a href="OfflineCompilerCommand.scala.html#23253" title="scala.tools.nsc.OfflineCompilerCommand">OfflineCompilerCommand</a> =
    <span title="scala.tools.nsc.OfflineCompilerCommand" class="keyword">new</span> <a href="OfflineCompilerCommand.scala.html#23253" title="scala.tools.nsc.OfflineCompilerCommand">OfflineCompilerCommand</a><span class="delimiter">(</span><a href="#502856" title="List[String]">arguments</a>, <a href="#502857" title="scala.tools.nsc.settings.FscSettings">settings</a><span class="delimiter">)</span>

  <span class="comment">/** Problematically, Settings are only considered equal if every setting
   *  is exactly equal.  In fsc this immediately breaks down because the randomly
   *  chosen temporary outdirs differ between client and server.  Among other
   *  things.  Long term we could use a meaningful equality; short term I'm just
   *  ignoring options which I can see causing a new compiler instance every time
   *  and which do not interestingly influence compilation products.
   */</span>
  <span class="keyword">def</span> <a title="(s1: scala.tools.nsc.Settings, s2: scala.tools.nsc.Settings)Set[scala.tools.nsc.Settings#Setting]" id="502689">unequalSettings</a><span class="delimiter">(</span><a title="scala.tools.nsc.Settings" id="502859">s1</a>: <a href="Settings.scala.html#22887" title="scala.tools.nsc.Settings">Settings</a>, <a title="scala.tools.nsc.Settings" id="502860">s2</a>: <a href="Settings.scala.html#22887" title="scala.tools.nsc.Settings">Settings</a><span class="delimiter">)</span>: <a href="../../collection/immutable/Set.scala.html#13576" title="Set[scala.tools.nsc.Settings#Setting]">Set</a><span class="delimiter">[</span>Settings#Setting<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Set[java.lang.String]" id="502868">ignoreSettings</a> = <a href="../../collection/generic/GenericCompanion.scala.html#48813" title="(elems: java.lang.String*)scala.collection.immutable.Set[java.lang.String]">Set</a><span class="delimiter">(</span><span title="java.lang.String(&quot;-d&quot;)" class="string">&quot;-d&quot;</span>, <span title="java.lang.String(&quot;-encoding&quot;)" class="string">&quot;-encoding&quot;</span>, <span title="java.lang.String(&quot;-currentDir&quot;)" class="string">&quot;-currentDir&quot;</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(s: scala.tools.nsc.Settings)Set[scala.tools.nsc.Settings#Setting]" id="502869">trim</a> <span class="delimiter">(</span><a title="scala.tools.nsc.Settings" id="502875">s</a>: <a href="Settings.scala.html#22887" title="scala.tools.nsc.Settings">Settings</a><span class="delimiter">)</span>: <a href="../../collection/immutable/Set.scala.html#13576" title="Set[scala.tools.nsc.Settings#Setting]">Set</a><span class="delimiter">[</span>Settings#Setting<span class="delimiter">]</span> = <span class="delimiter">(</span>
      <a href="#502875" title="scala.tools.nsc.Settings">s</a>.<a href="settings/AbsSettings.scala.html#469527" title="=&gt; scala.collection.Set[s.Setting]">userSetSettings</a>.<a href="../../collection/TraversableOnce.scala.html#53700" title="[B &gt;: s.Setting]=&gt; scala.collection.immutable.Set[B]">toSet</a><span title="scala.collection.immutable.Set[scala.tools.nsc.Settings#Setting]" class="delimiter">[</span>Settings#<a href="settings/MutableSettings.scala.html#469576" title="scala.tools.nsc.Settings#Setting">Setting</a><span class="delimiter">]</span> <a href="../../collection/TraversableLike.scala.html#49052" title="(p: scala.tools.nsc.Settings#Setting =&gt; Boolean)scala.collection.immutable.Set[scala.tools.nsc.Settings#Setting]">filterNot</a> <span class="delimiter">(</span><a title="scala.tools.nsc.Settings#Setting" id="502912">ss</a> =&gt; <a href="#502868" title="scala.collection.immutable.Set[java.lang.String]">ignoreSettings</a> <a href="../../collection/IterableLike.scala.html#53860" title="(p: java.lang.String =&gt; Boolean)Boolean">exists</a> <span class="delimiter">(</span><a href="#502912" title="scala.tools.nsc.Settings#Setting">ss</a> <a href="settings/AbsSettings.scala.html#469949" title="(label: String)Boolean">respondsTo</a> <a href="#502918" title="java.lang.String">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Set[scala.tools.nsc.Settings#Setting]" id="502870">ss1</a> = <a href="#502869" title="(s: scala.tools.nsc.Settings)Set[scala.tools.nsc.Settings#Setting]">trim</a><span class="delimiter">(</span><a href="#502859" title="scala.tools.nsc.Settings">s1</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Set[scala.tools.nsc.Settings#Setting]" id="502871">ss2</a> = <a href="#502869" title="(s: scala.tools.nsc.Settings)Set[scala.tools.nsc.Settings#Setting]">trim</a><span class="delimiter">(</span><a href="#502860" title="scala.tools.nsc.Settings">s2</a><span class="delimiter">)</span>

    <span class="delimiter">(</span><a href="#502870" title="Set[scala.tools.nsc.Settings#Setting]">ss1</a> <a href="../../collection/SetLike.scala.html#65663" title="(that: scala.collection.GenSet[scala.tools.nsc.Settings#Setting])scala.collection.immutable.Set[scala.tools.nsc.Settings#Setting]">union</a> <a href="#502871" title="Set[scala.tools.nsc.Settings#Setting]">ss2</a><span class="delimiter">)</span> <a href="../../collection/generic/Subtractable.scala.html#61846" title="(xs: scala.collection.GenTraversableOnce[scala.tools.nsc.Settings#Setting])scala.collection.immutable.Set[scala.tools.nsc.Settings#Setting]">--</a> <span class="delimiter">(</span><a href="#502870" title="Set[scala.tools.nsc.Settings#Setting]">ss1</a> <a href="../../collection/GenSetLike.scala.html#59063" title="(that: scala.collection.GenSet[scala.tools.nsc.Settings#Setting])scala.collection.immutable.Set[scala.tools.nsc.Settings#Setting]">intersect</a> <a href="#502871" title="Set[scala.tools.nsc.Settings#Setting]">ss2</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="502690">session</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="502933">password</a>        = <a href="#502662" title="=&gt; scala.tools.nsc.CompileSocket">compileSocket</a> <a href="CompileSocket.scala.html#501882" title="(port: Int)String">getPassword</a> <a href="../util/SocketServer.scala.html#502648" title="=&gt; Int">port</a>
    <span class="keyword">val</span> <a title="java.lang.String" id="502934">guessedPassword</a> = <a href="../util/SocketServer.scala.html#502638" title="=&gt; java.io.BufferedReader">in</a>.<span title="()java.lang.String">readLine</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="502935">input</a>           = <a href="../util/SocketServer.scala.html#502638" title="=&gt; java.io.BufferedReader">in</a>.<span title="()java.lang.String">readLine</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="keyword">def</span> <a title="(msg: String)Unit" id="502936">fscError</a><span class="delimiter">(</span><a title="String" id="502945">msg</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="../../Unit.scala.html#461" title="Unit">Unit</a> = <a href="../util/SocketServer.scala.html#502641" title="=&gt; java.io.PrintWriter">out</a> <a href="../../Tuple2.scala.html#53390" title="(x$1: Any)Unit">println</a> <span class="delimiter">(</span>
      <a href="util/Position.scala.html#502954" title="(msg: String)scala.tools.nsc.util.FakePos">FakePos</a><span class="delimiter">(</span><span title="java.lang.String(&quot;fsc&quot;)" class="string">&quot;fsc&quot;</span><span class="delimiter">)</span>,
      <a href="#502945" title="String">msg</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;\012  fsc -help  gives more information&quot;)" class="string">&quot;\n  fsc -help  gives more information&quot;</span>
    <span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502935" title="java.lang.String">input</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span> <a href="../../Boolean.scala.html#55579" title="(x: Boolean)Boolean">||</a> <a href="#502933" title="String">password</a> <span title="(x$1: AnyRef)Boolean">!=</span> <a href="#502934" title="java.lang.String">guessedPassword</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">return</span>

    <span class="keyword">val</span> <a title="List[java.lang.String]" id="502937">args</a>        = <a href="#502935" title="java.lang.String">input</a>.<span title="(x$1: java.lang.String, x$2: Int)Array[java.lang.String]">split</span><a href="../../Predef.scala.html#9626" title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</a><span title="java.lang.String(&quot;\00&quot;)" class="string">&quot;\0&quot;</span>, -<span title="Int(-1)" class="int">1</span><span class="delimiter">)</span>.<a href="../../collection/TraversableOnce.scala.html#53691" title="=&gt; List[java.lang.String]">toList</a>
    <span class="keyword">val</span> <a title="scala.tools.nsc.settings.FscSettings" id="502938">newSettings</a> = <span title="scala.tools.nsc.settings.FscSettings" class="keyword">new</span> <a href="settings/FscSettings.scala.html#35125" title="scala.tools.nsc.settings.FscSettings">FscSettings</a><span class="delimiter">(</span><a href="#502936" title="(msg: String)Unit">fscError</a><span class="delimiter">)</span>
    <a href="#23007" title="StandardCompileServer.this.type" class="keyword">this</a>.<a href="#502675" title="(x$1: Boolean)Unit">verbose</a>    = <a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>.<a href="settings/StandardScalaSettings.scala.html#469865" title="=&gt; newSettings.BooleanSetting">verbose</a>.<a href="settings/MutableSettings.scala.html#470030" title="=&gt; newSettings.verbose.T">value</a>
    <span class="keyword">val</span> <a title="scala.tools.nsc.OfflineCompilerCommand" id="502939">command</a>     = <a href="#502688" title="(arguments: List[String], settings: scala.tools.nsc.settings.FscSettings)scala.tools.nsc.OfflineCompilerCommand">newOfflineCompilerCommand</a><span class="delimiter">(</span><a href="#502937" title="List[java.lang.String]">args</a>, <a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a><span class="delimiter">)</span>

    <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Settings after normalizing paths: &quot;)" class="string">&quot;Settings after normalizing paths: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a><span class="delimiter">)</span>
    <a href="#502686" title="()Unit">printMemoryStats</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// Update the idle timeout if given</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="../../Boolean.scala.html#55576" title="=&gt; Boolean">!</a><a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>.<a href="settings/FscSettings.scala.html#501931" title="=&gt; newSettings.IntSetting">idleMins</a>.<a href="settings/MutableSettings.scala.html#470029" title="=&gt; Boolean">isDefault</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="newSettings.idleMins.T" id="503138">mins</a> = <a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>.<a href="settings/FscSettings.scala.html#501931" title="=&gt; newSettings.IntSetting">idleMins</a>.<a href="settings/MutableSettings.scala.html#470030" title="=&gt; newSettings.idleMins.T">value</a>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#503138" title="newSettings.idleMins.T">mins</a> <a href="../../Int.scala.html#54747" title="(x: Int)Boolean">==</a> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="../util/SocketServer.scala.html#471063" title="(msg: String)Unit">echo</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Disabling idle timeout on compile server.&quot;)" class="string">&quot;Disabling idle timeout on compile server.&quot;</span><span class="delimiter">)</span>
      <span class="keyword">else</span> <a href="../util/SocketServer.scala.html#471063" title="(msg: String)Unit">echo</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Setting idle timeout to &quot;)" class="string">&quot;Setting idle timeout to &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#503138" title="newSettings.idleMins.T">mins</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; minutes.&quot;)" class="string">&quot; minutes.&quot;</span><span class="delimiter">)</span>

      <a href="#23007" title="StandardCompileServer.this.type" class="keyword">this</a>.<a href="../util/SocketServer.scala.html#502651" title="(x$1: Int)Unit">idleMinutes</a> = <a href="#503138" title="newSettings.idleMins.T">mins</a>
    <span class="delimiter">}</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>.<a href="settings/FscSettings.scala.html#501925" title="=&gt; newSettings.BooleanSetting">shutdown</a>.<a href="settings/MutableSettings.scala.html#470030" title="=&gt; newSettings.shutdown.T">value</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#502672" title="(x$1: Boolean)Unit">shutdown</a> = <span title="Boolean(true)" class="keyword">true</span>
      <span title="Nothing" class="keyword">return</span> <a href="../util/SocketServer.scala.html#502641" title="=&gt; java.io.PrintWriter">out</a>.<span title="(x$1: java.lang.String)Unit">println</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[Compile server exited]&quot;)" class="string">&quot;[Compile server exited]&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>.<a href="settings/FscSettings.scala.html#501923" title="=&gt; newSettings.BooleanSetting">reset</a>.<a href="settings/MutableSettings.scala.html#470030" title="=&gt; newSettings.reset.T">value</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#502667" title="()Unit">clearCompiler</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="../util/SocketServer.scala.html#502641" title="=&gt; java.io.PrintWriter">out</a>.<span title="(x$1: java.lang.String)Unit">println</span><span class="delimiter">(</span><span title="java.lang.String(&quot;[Compile server was reset]&quot;)" class="string">&quot;[Compile server was reset]&quot;</span><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502939" title="scala.tools.nsc.OfflineCompilerCommand">command</a>.<a href="CompilerCommand.scala.html#481245" title="=&gt; List[String]">files</a>.<a href="../../collection/IterableLike.scala.html#53862" title="=&gt; Boolean">isEmpty</a><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>

    <a href="#502669" title="(x$1: scala.tools.nsc.reporters.ConsoleReporter)Unit">reporter</a> = <a href="#503159" title="scala.tools.nsc.reporters.ConsoleReporter" class="keyword">new</a> <a href="reporters/ConsoleReporter.scala.html#34927" title="anonymous class $anon extends scala.tools.nsc.reporters.ConsoleReporter" id="503159">ConsoleReporter</a><span class="delimiter">(</span><a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>, <a href="../util/SocketServer.scala.html#502638" title="=&gt; java.io.BufferedReader">in</a>, <a href="../util/SocketServer.scala.html#502641" title="=&gt; java.io.PrintWriter">out</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// disable prompts, so that compile server cannot block</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="()Unit" id="503208">displayPrompt</a> = <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">def</span> <a title="=&gt; Boolean" id="502940">isCompilerReusable</a>: <a href="../../Boolean.scala.html#65" title="Boolean">Boolean</a> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502665" title="=&gt; scala.tools.nsc.Global">compiler</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><span title="java.lang.String(&quot;[Creating new instance for compile server.]&quot;)" class="string">&quot;[Creating new instance for compile server.]&quot;</span><span class="delimiter">)</span>
        <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><span title="java.lang.String(&quot;[Compiler version: &quot;)" class="string">&quot;[Compiler version: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="Properties.scala.html#23224" title="object scala.tools.nsc.Properties">Properties</a>.<a href="../../util/Properties.scala.html#62283" title="=&gt; java.lang.String">versionString</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;.]&quot;)" class="string">&quot;.]&quot;</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">return</span> <span title="Boolean(false)" class="keyword">false</span>
      <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="Set[scala.tools.nsc.Settings#Setting]" id="503216">unequal</a> = <a href="#502689" title="(s1: scala.tools.nsc.Settings, s2: scala.tools.nsc.Settings)Set[scala.tools.nsc.Settings#Setting]">unequalSettings</a><span class="delimiter">(</span><a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>, <a href="#502665" title="=&gt; scala.tools.nsc.Global">compiler</a>.<a href="Global.scala.html#478200" title="=&gt; scala.tools.nsc.Settings">settings</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#503216" title="Set[scala.tools.nsc.Settings#Setting]">unequal</a>.<a href="../../collection/TraversableOnce.scala.html#53619" title="=&gt; Boolean">nonEmpty</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><span title="java.lang.String(&quot;[Replacing compiler with new instance because settings are unequal.]&quot;)" class="string">&quot;[Replacing compiler with new instance because settings are unequal.]&quot;</span><span class="delimiter">)</span>
        <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><span title="java.lang.String(&quot;[Asymmetric settings: &quot;)" class="string">&quot;[Asymmetric settings: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#503216" title="Set[scala.tools.nsc.Settings#Setting]">unequal</a>.<a href="../../collection/TraversableOnce.scala.html#53709" title="(sep: String)String">mkString</a><span class="delimiter">(</span><span title="java.lang.String(&quot;, &quot;)" class="string">&quot;, &quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot;]&quot;)" class="string">&quot;]&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#503216" title="Set[scala.tools.nsc.Settings#Setting]">unequal</a>.<a href="../../collection/SetLike.scala.html#65661" title="=&gt; Boolean">isEmpty</a>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502939" title="scala.tools.nsc.OfflineCompilerCommand">command</a>.<a href="CompilerCommand.scala.html#481255" title="=&gt; Boolean">shouldStopWithInfo</a><span class="delimiter">)</span>
      <a href="#502669" title="=&gt; scala.tools.nsc.reporters.ConsoleReporter">reporter</a>.<a href="reporters/Reporter.scala.html#479337" title="(pos: scala.tools.nsc.util.Position, msg: String, force: Boolean)Unit">info</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#502939" title="scala.tools.nsc.OfflineCompilerCommand">command</a>.<a href="CompilerCommand.scala.html#481256" title="(global: scala.tools.nsc.Global)String">getInfoMessage</a><span class="delimiter">(</span><a href="#502684" title="(settings: scala.tools.nsc.Settings, reporter: scala.tools.nsc.reporters.Reporter)scala.tools.nsc.Global">newGlobal</a><span class="delimiter">(</span><a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>, <a href="#502669" title="=&gt; scala.tools.nsc.reporters.ConsoleReporter">reporter</a><span class="delimiter">)</span><span class="delimiter">)</span>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502939" title="scala.tools.nsc.OfflineCompilerCommand">command</a>.<a href="CompilerCommand.scala.html#481245" title="=&gt; List[String]">files</a>.<a href="../../collection/IterableLike.scala.html#53862" title="=&gt; Boolean">isEmpty</a><span class="delimiter">)</span>
      <a href="#502669" title="=&gt; scala.tools.nsc.reporters.ConsoleReporter">reporter</a>.<a href="reporters/Reporter.scala.html#479337" title="(pos: scala.tools.nsc.util.Position, msg: String, force: Boolean)Unit">info</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <a href="#502939" title="scala.tools.nsc.OfflineCompilerCommand">command</a>.<a href="OfflineCompilerCommand.scala.html#501953" title="=&gt; java.lang.String">usageMsg</a>, <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502940" title="=&gt; Boolean">isCompilerReusable</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><span title="java.lang.String(&quot;[Reusing existing Global instance.]&quot;)" class="string">&quot;[Reusing existing Global instance.]&quot;</span><span class="delimiter">)</span>
        <a href="#502665" title="=&gt; scala.tools.nsc.Global">compiler</a>.<a href="Global.scala.html#478201" title="(x$1: scala.tools.nsc.Settings)Unit">settings</a> = <a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>
        <a href="#502665" title="=&gt; scala.tools.nsc.Global">compiler</a>.<a href="Global.scala.html#478204" title="(x$1: scala.tools.nsc.reporters.Reporter)Unit">reporter</a> = <a href="#502669" title="=&gt; scala.tools.nsc.reporters.ConsoleReporter">reporter</a>
      <span class="delimiter">}</span>
      <span class="keyword">else</span> <span class="delimiter">{</span>
        <a href="#502665" title="(x$1: scala.tools.nsc.Global)Unit">compiler</a> = <a href="#502684" title="(settings: scala.tools.nsc.Settings, reporter: scala.tools.nsc.reporters.Reporter)scala.tools.nsc.Global">newGlobal</a><span class="delimiter">(</span><a href="#502938" title="scala.tools.nsc.settings.FscSettings">newSettings</a>, <a href="#502669" title="=&gt; scala.tools.nsc.reporters.ConsoleReporter">reporter</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="scala.tools.nsc.Global" id="503309">c</a> = <a href="#502665" title="=&gt; scala.tools.nsc.Global">compiler</a>
      <span class="keyword">try</span> <span title="c.Run" class="keyword">new</span> <a href="#503309" title="scala.tools.nsc.Global">c</a>.<a href="Global.scala.html#478365" title="c.Run">Run</a><span class="delimiter">(</span><span class="delimiter">)</span> <a href="Global.scala.html#482577" title="(filenames: List[String])Unit">compile</a> <a href="#502939" title="scala.tools.nsc.OfflineCompilerCommand">command</a>.<a href="CompilerCommand.scala.html#481245" title="=&gt; List[String]">files</a>
      <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Unit" id="503314">ex</a> @ FatalError<span class="delimiter">(</span><a title="String" id="503315">msg</a><span class="delimiter">)</span> =&gt;
          <a href="#502669" title="=&gt; scala.tools.nsc.reporters.ConsoleReporter">reporter</a>.<a href="reporters/Reporter.scala.html#479339" title="(pos: scala.tools.nsc.util.Position, msg: String)Unit">error</a><span class="delimiter">(</span><span title="Null(null)" class="keyword">null</span>, <span title="java.lang.String(&quot;fatal error: &quot;)" class="string">&quot;fatal error: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#503315" title="String">msg</a><span class="delimiter">)</span>
          <a href="#502667" title="()Unit">clearCompiler</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="keyword">case</span> <a title="Nothing" id="503316">ex</a> =&gt;
          <a href="../util/SocketServer.scala.html#471064" title="(msg: String)Unit">warn</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Compile server encountered fatal condition: &quot;)" class="string">&quot;Compile server encountered fatal condition: &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#503316" title="java.lang.Throwable">ex</a><span class="delimiter">)</span>
          <a href="#502672" title="(x$1: Boolean)Unit">shutdown</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span title="Nothing" class="keyword">throw</span> <a href="#503316" title="java.lang.Throwable">ex</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#502669" title="=&gt; scala.tools.nsc.reporters.ConsoleReporter">reporter</a>.<a href="reporters/ConsoleReporter.scala.html#482474" title="()Unit">printSummary</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#502687" title="()Boolean">isMemoryFullEnough</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../util/SocketServer.scala.html#471062" title="(msg: String)Unit">info</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Nulling out compiler due to memory utilization.&quot;)" class="string">&quot;Nulling out compiler due to memory utilization.&quot;</span><span class="delimiter">)</span>
      <a href="#502667" title="()Unit">clearCompiler</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>


<span class="keyword">object</span> <a title="object scala.tools.nsc.CompileServer" id="22867">CompileServer</a> <a href="../../ScalaObject.scala.html#464" title="ScalaObject" class="keyword">extends</a> <a href="#23007" title="scala.tools.nsc.StandardCompileServer">StandardCompileServer</a> <span class="delimiter">{</span>
  <span class="comment">/** A directory holding redirected output */</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.tools.nsc.io.Directory" id="503319">redirectDir</a> = <span class="delimiter">(</span><a href="#502662" title="=&gt; scala.tools.nsc.CompileSocket">compileSocket</a>.<a href="CompileSocket.scala.html#501867" title="=&gt; scala.tools.nsc.io.Directory">tmpDir</a> <a href="io/Path.scala.html#479408" title="scala.tools.nsc.io.Path" id="503327">/</a> <a href="io/Path.scala.html#479366" title="implicit scala.tools.nsc.io.Path.string2path : (s: String)scala.tools.nsc.io.Path" class="string">&quot;output-redirects&quot;</a><span class="delimiter">)</span>.<a href="io/Path.scala.html#502789" title="Boolean" id="503329">createDirectory</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(setter: java.io.PrintStream =&gt; Unit, filename: String)Unit" id="503320">redirect</a><span class="delimiter">(</span><a title="java.io.PrintStream =&gt; Unit" id="503330">setter</a>: PrintStream =&gt; Unit, <a title="String" id="503331">filename</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="../../Unit.scala.html#461" title="Unit">Unit</a> =
    <a href="../../Function1.scala.html#53453" title="(v1: java.io.PrintStream)Unit">setter</a><span class="delimiter">(</span><span title="java.io.PrintStream" class="keyword">new</span> <span title="java.io.PrintStream">PrintStream</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#503318" title="=&gt; scala.tools.nsc.io.Directory">redirectDir</a> <a href="io/Path.scala.html#479408" title="scala.tools.nsc.io.Path" id="503345">/</a> <a href="io/Path.scala.html#479366" title="implicit scala.tools.nsc.io.Path.string2path : (s: String)scala.tools.nsc.io.Path">filename</a><span class="delimiter">)</span>.<a href="io/Path.scala.html#503344" title="Boolean" id="503348">createFile</a><a title="scala.tools.nsc.io.File" id="503364" class="delimiter">(</a><span class="delimiter">)</span>.<a href="io/File.scala.html#503352" title="Boolean" id="503367">bufferedOutput</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="(args: Array[String])Unit" id="503321">main</a><span class="delimiter">(</span><a title="Array[String]" id="503368">args</a>: <a href="../../Array.scala.html#1430" title="Array[String]">Array</a><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Boolean" id="503370">debug</a> = <a href="../../Predef.scala.html#9626" title="(xs: Array[String])scala.collection.mutable.ArrayOps[String]">args</a> <a href="../../collection/SeqLike.scala.html#54119" title="(elem: Any)Boolean">contains</a> <span title="java.lang.String(&quot;-v&quot;)" class="string">&quot;-v&quot;</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#503370" title="Boolean">debug</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../util/SocketServer.scala.html#471063" title="(msg: String)Unit">echo</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Starting CompileServer on port &quot;)" class="string">&quot;Starting CompileServer on port &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="../util/SocketServer.scala.html#502648" title="=&gt; Int">port</a><span class="delimiter">)</span>
      <a href="../util/SocketServer.scala.html#471063" title="(msg: String)Unit">echo</a><span class="delimiter">(</span><span title="java.lang.String(&quot;Redirect dir is &quot;)" class="string">&quot;Redirect dir is &quot;</span> <span title="(x$1: Any)java.lang.String">+</span> <a href="#503318" title="=&gt; scala.tools.nsc.io.Directory">redirectDir</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#503320" title="(setter: java.io.PrintStream =&gt; Unit, filename: String)Unit">redirect</a><span class="delimiter">(</span><span title="object java.lang.System">System</span>.<a href="#503395" title="(x$1: java.io.PrintStream)Unit">setOut</a>, <span title="java.lang.String(&quot;scala-compile-server-out.log&quot;)" class="string">&quot;scala-compile-server-out.log&quot;</span><span class="delimiter">)</span>
    <a href="#503320" title="(setter: java.io.PrintStream =&gt; Unit, filename: String)Unit">redirect</a><span class="delimiter">(</span><span title="object java.lang.System">System</span>.<a href="#503397" title="(x$1: java.io.PrintStream)Unit">setErr</a>, <span title="java.lang.String(&quot;scala-compile-server-err.log&quot;)" class="string">&quot;scala-compile-server-err.log&quot;</span><span class="delimiter">)</span>
    <span title="object java.lang.System">System</span>.<span title="java.io.PrintStream">err</span>.<span title="(x$1: java.lang.String)Unit">println</span><span class="delimiter">(</span><span title="java.lang.String(&quot;...starting server on socket &quot;)" class="string">&quot;...starting server on socket &quot;</span><span title="(x$1: Any)java.lang.String">+</span><a href="../util/SocketServer.scala.html#502648" title="=&gt; Int">port</a><span title="(x$1: Any)java.lang.String">+</span><span title="java.lang.String(&quot;...&quot;)" class="string">&quot;...&quot;</span><span class="delimiter">)</span>
    <span title="object java.lang.System">System</span>.<span title="java.io.PrintStream">err</span>.<span title="()Unit">flush</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#502662" title="=&gt; scala.tools.nsc.CompileSocket">compileSocket</a>.<a href="CompileSocket.scala.html#501876" title="(port: Int)Unit">setPort</a><span class="delimiter">(</span><a href="../util/SocketServer.scala.html#502648" title="=&gt; Int">port</a><span class="delimiter">)</span>
    <a href="../util/SocketServer.scala.html#502660" title="()Unit">run</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <a href="#502662" title="=&gt; scala.tools.nsc.CompileSocket">compileSocket</a>.<a href="CompileSocket.scala.html#501877" title="(port: Int)Boolean">deletePort</a><span class="delimiter">(</span><a href="../util/SocketServer.scala.html#502648" title="=&gt; Int">port</a><span class="delimiter">)</span>
    sys.<a href="../../sys/package.scala.html#48165" title="(status: Int)Nothing">exit</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>