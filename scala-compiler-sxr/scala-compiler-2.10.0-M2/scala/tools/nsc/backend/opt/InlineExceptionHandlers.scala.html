<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>scala/tools/nsc/backend/opt/InlineExceptionHandlers.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
/* NSC -- new scala compiler
 * Copyright 2005-2011 LAMP/EPFL
 */

<span class="keyword">package</span> scala.tools.nsc
<span class="keyword">package</span> backend.opt
<span class="keyword">import</span> scala.util.control.<span title="object scala.util.control.Breaks">Breaks</span>._

/**
  * This optimization phase inlines the exception handlers so that further phases can optimize the code better
  *
  * {{{
  * try {
  *   ...
  *   if (condition)
  *     throw IllegalArgumentException(&quot;sth&quot;)
  * } catch {
  *   case e: IllegalArgumentException =&gt; &lt;handler code&gt;
  *   case e: ... =&gt; ...
  * }
  * }}}
  *
  * will inline the exception handler code to:
  *
  * {{{
  * try {
  *   ...
  *   if (condition)
  *     &lt;handler code&gt; // + jump to the end of the catch statement
  * } catch {
  *   case e: IllegalArgumentException =&gt; &lt;handler code&gt;
  *   case e: ... =&gt; ...
  * }
  * }}}
  *
  * Q: How does the inlining work, ICode level?
  * A: if a block contains a THROW(A) instruction AND there is a handler that takes A or a superclass of A we do:
  *    1. We duplicate the handler code such that we can transform THROW into a JUMP
  *    2. We analyze the handler to see what local it expects the exception to be placed in
  *    3. We place the exception that is thrown in the correct &quot;local variable&quot; slot and clean up the stack
  *    4. We finally JUMP to the duplicate handler
 *    All the above logic is implemented in InlineExceptionHandlersPhase.apply(bblock: BasicBlock)
  *
  * Q: Why do we need to duplicate the handler?
  * A: An exception might be thrown in a method that we invoke in the function and we cannot see that THROW command
  * directly. In order to catch such exceptions, we keep the exception handler in place and duplicate it in order
  * to inline its code.
  *
  * @author Vlad Ureche
  */
<span class="keyword">abstract</span> <span class="keyword">class</span> <a title="class InlineExceptionHandlers extends scala.tools.nsc.SubComponent with ScalaObject" id="18002">InlineExceptionHandlers</a> <a href="#18002" title="ScalaObject" class="keyword">extends</a> <a href="../../SubComponent.scala.html#12666" title="scala.tools.nsc.SubComponent">SubComponent</a> <span class="delimiter">{</span>
  <span class="keyword">import</span> <a href="../../SubComponent.scala.html#231956" title="=&gt; scala.tools.nsc.Global">global</a>._
  <span class="keyword">import</span> <a href="../../Global.scala.html#186153" title="object InlineExceptionHandlers.this.global.icodes">icodes</a>._
  <span class="keyword">import</span> <a href="../../Global.scala.html#186153" title="object InlineExceptionHandlers.this.global.icodes">icodes</a>.<a href="../icode/Opcodes.scala.html#232654" title="object InlineExceptionHandlers.this.global.icodes.opcodes">opcodes</a>._

  <span class="keyword">val</span> <a title="String" id="243278">phaseName</a> = <span title="String(&quot;inlineExceptionHandlers&quot;)" class="string">&quot;inlineExceptionHandlers&quot;</span>

  /** Create a new phase */
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(p: scala.tools.nsc.Phase)InlineExceptionHandlers.this.InlineExceptionHandlersPhase" id="243280">newPhase</a><span class="delimiter">(</span><a title="scala.tools.nsc.Phase" id="244645">p</a>: <a href="../../../../reflect/internal/Phase.scala.html#8452" title="scala.tools.nsc.Phase">Phase</a><span class="delimiter">)</span> = <span title="InlineExceptionHandlers.this.InlineExceptionHandlersPhase" class="keyword">new</span> <a href="#243281" title="InlineExceptionHandlers.this.InlineExceptionHandlersPhase">InlineExceptionHandlersPhase</a><span class="delimiter">(</span><a href="#244645" title="scala.tools.nsc.Phase">p</a><span class="delimiter">)</span>

  /**
    * Inlining Exception Handlers
    */
  <span class="keyword">class</span> <a title="class InlineExceptionHandlersPhase extends InlineExceptionHandlers.this.global.icodes.ICodePhase with ScalaObject" id="243281">InlineExceptionHandlersPhase</a><a href="#243281" title="ScalaObject" class="delimiter">(</a><a title="scala.tools.nsc.Phase" id="244679">prev</a>: <a href="../../../../reflect/internal/Phase.scala.html#8452" title="scala.tools.nsc.Phase">Phase</a><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="../icode/ICodes.scala.html#232623" title="InlineExceptionHandlers.this.global.icodes.ICodePhase">ICodePhase</a><span class="delimiter">(</span><a href="#244679" title="scala.tools.nsc.Phase">prev</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="=&gt; String" id="244651">name</a> = <a href="#243278" title="=&gt; String">phaseName</a>

    /* This map is used to keep track of duplicated exception handlers
     * explanation: for each exception handler basic block, there is a copy of it
     * -some exception handler basic blocks might not be duplicated because they have an unknown format =&gt; Option[(...)]
     * -some exception handler duplicates expect the exception on the stack while others expect it in a local
     *   =&gt; Option[Local]
     */
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]]" id="244652">handlerCopies</a> = <a href="../../../../reflect/internal/SymbolTable.scala.html#35655" title="object InlineExceptionHandlers.this.global.perRunCaches">perRunCaches</a>.<a href="../../../../reflect/internal/SymbolTable.scala.html#110762" title="[K, V]()scala.collection.mutable.HashMap[K,V]">newMap</a><span title="()scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]]" class="delimiter">[</span><a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a>, <span title="Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]">Option</span><span class="delimiter">[</span><span class="delimiter">(</span>Option<span class="delimiter">[</span>Local<span class="delimiter">]</span>, BasicBlock<span class="delimiter">)</span><span class="delimiter">]</span><span class="delimiter">]</span>
    /* This map is the inverse of handlerCopies, used to compute the stack of duplicate blocks */
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)]" id="244654">handlerCopiesInverted</a> = <a href="../../../../reflect/internal/SymbolTable.scala.html#35655" title="object InlineExceptionHandlers.this.global.perRunCaches">perRunCaches</a>.<a href="../../../../reflect/internal/SymbolTable.scala.html#110762" title="[K, V]()scala.collection.mutable.HashMap[K,V]">newMap</a><span title="()scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)]" class="delimiter">[</span><a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a>, <span title="(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)" class="delimiter">(</span>BasicBlock, TypeKind<span class="delimiter">)</span><span class="delimiter">]</span>
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(bb: InlineExceptionHandlers.this.global.icodes.BasicBlock)Option[InlineExceptionHandlers.this.global.icodes.Local]" id="244656">handlerLocal</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380073">bb</a>: <a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="Option[InlineExceptionHandlers.this.global.icodes.Local]">Option</span><span class="delimiter">[</span>Local<span class="delimiter">]</span> =
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]" id="380082">v</a> &lt;- <a href="#244652" title="=&gt; scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]]">handlerCopies</a> <span title="(f: Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)] =&gt; Option[InlineExceptionHandlers.this.global.icodes.Local])Option[InlineExceptionHandlers.this.global.icodes.Local]">get</span> <a href="#380073" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bb</a> ; <span class="delimiter">(</span><a title="Option[InlineExceptionHandlers.this.global.icodes.Local]" id="380097">local</a>, <a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380098">block</a><span class="delimiter">)</span> &lt;- <a href="#380082" title="(f: ((Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)) =&gt; Option[InlineExceptionHandlers.this.global.icodes.Local])Option[InlineExceptionHandlers.this.global.icodes.Local]">v</a> ; <a title="InlineExceptionHandlers.this.global.icodes.Local" id="380103">l</a> &lt;- <a href="#380097" title="(f: InlineExceptionHandlers.this.global.icodes.Local =&gt; InlineExceptionHandlers.this.global.icodes.Local)Option[InlineExceptionHandlers.this.global.icodes.Local]">local</a><span class="delimiter">)</span> <span class="keyword">yield</span> <a href="#380103" title="InlineExceptionHandlers.this.global.icodes.Local">l</a>

    /* Type Flow Analysis */
    <span class="keyword">private</span> <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.analysis.MethodTFA" id="244657">tfa</a>: analysis.<a href="../icode/analysis/TypeFlowAnalysis.scala.html#239593" title="InlineExceptionHandlers.this.global.analysis.MethodTFA">MethodTFA</a> = <span title="InlineExceptionHandlers.this.global.analysis.MethodTFA" class="keyword">new</span> <a href="../../Global.scala.html#186159" title="object InlineExceptionHandlers.this.global.analysis">analysis</a>.<a href="../icode/analysis/TypeFlowAnalysis.scala.html#239593" title="InlineExceptionHandlers.this.global.analysis.MethodTFA">MethodTFA</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="Map[Int,InlineExceptionHandlersPhase.this.tfa.lattice.Elem]" id="244660">tfaCache</a>: <span title="Map[Int,InlineExceptionHandlersPhase.this.tfa.lattice.Elem]">Map</span><span class="delimiter">[</span>Int, tfa.lattice.Elem<span class="delimiter">]</span> = <span title="=&gt; scala.collection.immutable.Map.type">Map</span>.<span title="scala.collection.immutable.Map[Int,Nothing]">empty</span>
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="InlineExceptionHandlers.this.global.icodes.IMethod" id="244663">analyzedMethod</a>: <a href="../icode/Members.scala.html#232640" title="InlineExceptionHandlers.this.global.icodes.IMethod">IMethod</a> = <a href="../icode/Members.scala.html#232638" title="object InlineExceptionHandlers.this.global.icodes.NoIMethod">NoIMethod</a>

    /* Blocks that need to be analyzed */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="List[InlineExceptionHandlers.this.global.icodes.BasicBlock]" id="244666">todoBlocks</a>: <span title="List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span> = <span title="object Nil">Nil</span>

    /* Used only for warnings */
    <span class="keyword">private</span> <span class="keyword">var</span> <a title="InlineExceptionHandlers.this.global.icodes.IClass" id="244669">currentClass</a>: <a href="../icode/Members.scala.html#232636" title="InlineExceptionHandlers.this.global.icodes.IClass">IClass</a> = <span title="Null(null)" class="keyword">null</span>

    /** Apply exception handler inlining to a class */
    <span class="keyword">override</span> <span class="keyword">def</span> <a title="(c: InlineExceptionHandlers.this.global.icodes.IClass)Unit" id="244671">apply</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.IClass" id="380133">c</a>: <a href="../icode/Members.scala.html#232636" title="InlineExceptionHandlers.this.global.icodes.IClass">IClass</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="../../Global.scala.html#186138" title="=&gt; scala.tools.nsc.Settings">settings</a>.<a href="../../settings/ScalaSettings.scala.html#186774" title="=&gt; scala.tools.nsc.Settings#BooleanSetting">inlineHandlers</a>.<a href="../../settings/MutableSettings.scala.html#187054" title="=&gt; Boolean">value</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Long" id="380144">startTime</a> = <span title="object System">System</span>.<span title="()Long">currentTimeMillis</span>
        <a href="#244669" title="(x$1: InlineExceptionHandlers.this.global.icodes.IClass)Unit">currentClass</a> = <a href="#380133" title="InlineExceptionHandlers.this.global.icodes.IClass">c</a>

        <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;Starting &quot;)" class="string">&quot;Starting &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380133" title="InlineExceptionHandlers.this.global.icodes.IClass">c</a><span class="delimiter">)</span>
        <a href="#380133" title="InlineExceptionHandlers.this.global.icodes.IClass">c</a>.<a href="../icode/Members.scala.html#232936" title="=&gt; List[InlineExceptionHandlers.this.global.icodes.IMethod]">methods</a> <span title="(f: InlineExceptionHandlers.this.global.icodes.IMethod =&gt; Unit)Unit">foreach</span> <a href="#244672" title="(method: InlineExceptionHandlers.this.global.icodes.IMethod)Unit">applyMethod</a>

        <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;Finished &quot;)" class="string">&quot;Finished &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380133" title="InlineExceptionHandlers.this.global.icodes.IClass">c</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;... &quot;)" class="string">&quot;... &quot;</span> <span title="(x$1: Any)String">+</span> <span class="delimiter">(</span><span title="object System">System</span>.<span title="()Long">currentTimeMillis</span> <span title="(x: Long)Long">-</span> <a href="#380144" title="Long">startTime</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;ms&quot;)" class="string">&quot;ms&quot;</span><span class="delimiter">)</span>
        <a href="#244669" title="(x$1: InlineExceptionHandlers.this.global.icodes.IClass)Unit">currentClass</a> = <span title="Null(null)" class="keyword">null</span>
      <span class="delimiter">}</span>

    /**
      * Apply exception handler inlining to a method
      *
      * Note: for each exception handling block, we (might) create duplicates. Therefore we iterate until we get to a
      * fixed point where all the possible handlers have been inlined.
      *
      * TODO: Should we have an inlining depth limit? A nested sequence of n try-catch blocks can lead to at most 2n
      * inlined blocks, so worst case scenario we double the size of the code
      */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(method: InlineExceptionHandlers.this.global.icodes.IMethod)Unit" id="244672">applyMethod</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.IMethod" id="380169">method</a>: <a href="../icode/Members.scala.html#232640" title="InlineExceptionHandlers.this.global.icodes.IMethod">IMethod</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#380169" title="InlineExceptionHandlers.this.global.icodes.IMethod">method</a>.<a href="../icode/Members.scala.html#322246" title="=&gt; Boolean">hasCode</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        // create the list of starting blocks
        <a href="#244666" title="(x$1: List[InlineExceptionHandlers.this.global.icodes.BasicBlock])Unit">todoBlocks</a> = <a href="../../SubComponent.scala.html#231956" title="=&gt; scala.tools.nsc.Global">global</a>.<a href="../../Global.scala.html#186153" title="object InlineExceptionHandlers.this.global.icodes">icodes</a>.<a href="../icode/ICodes.scala.html#232593" title="=&gt; InlineExceptionHandlers.this.global.icodes.Linearizer">linearizer</a>.<a href="../icode/Linearizers.scala.html#339433" title="(c: InlineExceptionHandlers.this.global.icodes.IMethod)List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">linearize</a><span class="delimiter">(</span><a href="#380169" title="InlineExceptionHandlers.this.global.icodes.IMethod">method</a><span class="delimiter">)</span>

        <span title="Unit" class="keyword">while</span> <span class="delimiter">(</span><a href="#244666" title="=&gt; List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">todoBlocks</a>.<span title="=&gt; Boolean">nonEmpty</span><span class="delimiter">)</span> <a href="#380179" title="()Unit" class="delimiter">{</a>
          <span class="keyword">val</span> <a title="List[InlineExceptionHandlers.this.global.icodes.BasicBlock]" id="380181">levelBlocks</a> = <a href="#244666" title="=&gt; List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">todoBlocks</a>
          <a href="#244666" title="(x$1: List[InlineExceptionHandlers.this.global.icodes.BasicBlock])Unit">todoBlocks</a> = <span title="object Nil">Nil</span>
          <a href="#380181" title="List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">levelBlocks</a> <span title="(f: InlineExceptionHandlers.this.global.icodes.BasicBlock =&gt; Unit)Unit">foreach</span> <a href="#244673" title="(bblock: InlineExceptionHandlers.this.global.icodes.BasicBlock)Unit">applyBasicBlock</a> // new blocks will be added to todoBlocks
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

      // Cleanup the references after we finished the file
      <a href="#244652" title="=&gt; scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]]">handlerCopies</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#244654" title="=&gt; scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)]">handlerCopiesInverted</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#244666" title="(x$1: List[InlineExceptionHandlers.this.global.icodes.BasicBlock])Unit">todoBlocks</a> = <span title="object Nil">Nil</span>

      // Type flow analysis cleanup
      <a href="#244663" title="(x$1: InlineExceptionHandlers.this.global.icodes.IMethod)Unit">analyzedMethod</a> = <a href="../icode/Members.scala.html#232638" title="object InlineExceptionHandlers.this.global.icodes.NoIMethod">NoIMethod</a>
      <a href="#244660" title="(x$1: Map[Int,InlineExceptionHandlersPhase.this.tfa.lattice.Elem])Unit">tfaCache</a> = <span title="=&gt; scala.collection.immutable.Map.type">Map</span>.<span title="scala.collection.immutable.Map[Int,Nothing]">empty</span>
      //TODO: Need a way to clear tfa structures
    <span class="delimiter">}</span>

    /** Apply exception handler inlining to a basic block  */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(bblock: InlineExceptionHandlers.this.global.icodes.BasicBlock)Unit" id="244673">applyBasicBlock</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380200">bblock</a>: <a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      /*
       * The logic of this entire method:
       *  - for each basic block, we look at each instruction until we find a THROW instruction
       *  - once we found a THROW instruction, we decide if it is DECIDABLE which of handler will catch the exception
       *  (see method findExceptionHandler for more details)
       *  - if we decided there is a handler that will catch the exception, we need to replace the THROW instruction by
       *  a set of equivalent instructions:
       *    * we need to compute the static types of the stack slots
       *    * we need to clear the stack, everything but the exception instance on top (or in a local variable slot)
       *    * we need to JUMP to the duplicate exception handler
       *  - we compute the static types of the stack slots in function getTypesAtInstruction
       *  - we duplicate the exception handler (and we get back the information of whether the duplicate expects the
       *  exception instance on top of the stack or in a local variable slot)
       *  - we compute the necessary code to put the exception in its place, clear the stack and JUMP
       *  - we change the THROW exception to the new Clear stack + JUMP code
       */
      <span class="keyword">for</span> <span class="delimiter">{</span>
        <span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.opcodes.THROW" id="380234">instr</a> @ THROW<span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.global.Symbol" id="380236">clazz</a><span class="delimiter">)</span>, <a title="Int" id="380237">index</a><span class="delimiter">)</span> &lt;- <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322152" title="=&gt; Iterator[InlineExceptionHandlers.this.global.icodes.Instruction]">iterator</a>.<a href="#380214" title="(f: ((InlineExceptionHandlers.this.global.icodes.Instruction, Int)) =&gt; Unit)Unit">zipWithIndex</a>
        // Decide if any handler fits this exception
        // If not, then nothing to do, we cannot determine statically which handler will catch the exception
        <span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380256">handler</a>, <a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380257">caughtException</a><span class="delimiter">)</span>    &lt;- <a href="#244676" title="(thrownException: InlineExceptionHandlers.this.global.icodes.TypeKind, handlers: List[InlineExceptionHandlers.this.global.icodes.BasicBlock])Option[(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)]">findExceptionHandler</a><a href="#380244" title="(f: ((InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)) =&gt; Unit)Unit" class="delimiter">(</a><a href="../icode/TypeKinds.scala.html#232707" title="(t: InlineExceptionHandlers.this.global.icodes.global.Type)InlineExceptionHandlers.this.global.icodes.TypeKind">toTypeKind</a><span class="delimiter">(</span><a href="#380236" title="InlineExceptionHandlers.this.global.icodes.global.Symbol">clazz</a>.<a href="../../../../reflect/internal/Symbols.scala.html#46606" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.Type">tpe</a><span class="delimiter">)</span>, <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322184" title="=&gt; List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">exceptionSuccessors</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="delimiter">{</span>
        <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;   Replacing &quot;)" class="string">&quot;   Replacing &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380234" title="InlineExceptionHandlers.this.global.icodes.opcodes.THROW">instr</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; in &quot;)" class="string">&quot; in &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; to new handler&quot;)" class="string">&quot; to new handler&quot;</span><span class="delimiter">)</span>

        // Solve the stack and drop the element that we already stored, which should be the exception
        // needs to be done here to be the first thing before code becomes altered
        <span class="keyword">val</span> <a title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]" id="380258">typeInfo</a> = <a href="#244674" title="(bblock: InlineExceptionHandlers.this.global.icodes.BasicBlock, index: Int)List[InlineExceptionHandlers.this.global.icodes.TypeKind]">getTypesAtInstruction</a><span class="delimiter">(</span><a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>, <a href="#380237" title="Int">index</a><span class="delimiter">)</span>

        // Duplicate exception handler
        <a href="#244677" title="(handler: InlineExceptionHandlers.this.global.icodes.BasicBlock)Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]">duplicateExceptionHandlerCache</a><span class="delimiter">(</span><a href="#380256" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="Unit">None</span> =&gt;
            <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;   Could not duplicate handler for &quot;)" class="string">&quot;   Could not duplicate handler for &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380234" title="InlineExceptionHandlers.this.global.icodes.opcodes.THROW">instr</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; in &quot;)" class="string">&quot; in &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a><span class="delimiter">)</span>

          <span class="keyword">case</span> <span title="Unit">Some</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Option[InlineExceptionHandlers.this.global.icodes.Local]" id="380272">exceptionLocalOpt</a>, <a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380273">newHandler</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
            <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380274">onStackException</a> = <a href="#380258" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">typeInfo</a>.<span title="=&gt; InlineExceptionHandlers.this.global.icodes.TypeKind">head</span>
            <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380275">thrownException</a>  = <a href="../icode/TypeKinds.scala.html#232707" title="(t: InlineExceptionHandlers.this.global.icodes.global.Type)InlineExceptionHandlers.this.global.icodes.TypeKind">toTypeKind</a><span class="delimiter">(</span><a href="#380236" title="InlineExceptionHandlers.this.global.icodes.global.Symbol">clazz</a>.<a href="../../../../reflect/internal/Symbols.scala.html#46606" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.Type">tpe</a><span class="delimiter">)</span>

            // A couple of sanity checks, to make sure we don't touch code we can't safely handle
            <span class="keyword">val</span> <a title="Boolean" id="380276">canReplaceHandler</a> = <span class="delimiter">(</span>
                  <a href="#380258" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">typeInfo</a>.<span title="=&gt; Boolean">nonEmpty</span>
              <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#380237" title="Int">index</a> <span title="(x: Int)Boolean">==</span> <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322159" title="=&gt; Int">length</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
              <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#380274" title="InlineExceptionHandlers.this.global.icodes.TypeKind">onStackException</a> <a href="../icode/TypeKinds.scala.html#320544" title="(other: InlineExceptionHandlers.this.global.icodes.TypeKind)Boolean">&lt;:&lt;</a> <a href="#380275" title="InlineExceptionHandlers.this.global.icodes.TypeKind">thrownException</a><span class="delimiter">)</span>
            <span class="delimiter">)</span>
            // in other words: what's on the stack MUST conform to what's in the THROW(..)!

            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#380276" title="Boolean">canReplaceHandler</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#244669" title="=&gt; InlineExceptionHandlers.this.global.icodes.IClass">currentClass</a>.<a href="../icode/Members.scala.html#232939" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.CompilationUnit">cunit</a>.<a href="../../CompilationUnits.scala.html#188715" title="(pos: InlineExceptionHandlers.this.global.icodes.global.Position, msg: String)Unit">warning</a><span class="delimiter">(</span><a href="../../symtab/Positions.scala.html#186524" title="=&gt; tools.nsc.util.NoPosition.type">NoPosition</a>, <span class="string">&quot;Unable to inline the exception handler inside incorrect&quot;</span> <span title="String(&quot;Unable to inline the exception handler inside incorrect block:\n&quot;)">+</span>
                <span class="string">&quot; block:\n&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322152" title="=&gt; Iterator[InlineExceptionHandlers.this.global.icodes.Instruction]">iterator</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;\n&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;\nwith stack: &quot;)" class="string">&quot;\nwith stack: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380258" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">typeInfo</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; just &quot;)" class="string">&quot; just &quot;</span> <span title="(x$1: Any)String">+</span>
                <span title="String(&quot;before instruction index &quot;)" class="string">&quot;before instruction index &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380237" title="Int">index</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
              // Prepare the new code to replace the THROW instruction
              <span class="keyword">val</span> <a title="List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]" id="380291">newCode</a> = <a href="#380272" title="Option[InlineExceptionHandlers.this.global.icodes.Local]">exceptionLocalOpt</a> <span title="List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]" class="keyword">match</span> <span class="delimiter">{</span>
                // the handler duplicate expects the exception in a local: easy one :)
                <span class="keyword">case</span> <span title="List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">Some</span><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.Local" id="380293">local</a><span class="delimiter">)</span> =&gt;
                  // in the first cycle we remove the exception Type
                  <a href="../icode/Opcodes.scala.html#327716" title="(local: InlineExceptionHandlers.this.global.icodes.Local)InlineExceptionHandlers.this.global.icodes.opcodes.STORE_LOCAL">STORE_LOCAL</a><span class="delimiter">(</span><a href="#380293" title="InlineExceptionHandlers.this.global.icodes.Local">local</a><span class="delimiter">)</span> <a href="#380294" title="(elem: Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable)(implicit bf: scala.collection.generic.CanBuildFrom[List[InlineExceptionHandlers.this.global.icodes.opcodes.DROP],Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable,List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]])List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">+:</a> <a href="#380258" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">typeInfo</a>.<span title="=&gt; List[InlineExceptionHandlers.this.global.icodes.TypeKind]">tail</span>.<span title="(f: InlineExceptionHandlers.this.global.icodes.TypeKind =&gt; InlineExceptionHandlers.this.global.icodes.opcodes.DROP)(implicit bf: scala.collection.generic.CanBuildFrom[List[InlineExceptionHandlers.this.global.icodes.TypeKind],InlineExceptionHandlers.this.global.icodes.opcodes.DROP,List[InlineExceptionHandlers.this.global.icodes.opcodes.DROP]])List[InlineExceptionHandlers.this.global.icodes.opcodes.DROP]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,InlineExceptionHandlers.this.global.icodes.opcodes.DROP,List[InlineExceptionHandlers.this.global.icodes.opcodes.DROP]]" class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380320">x</a> =&gt; <a href="../icode/Opcodes.scala.html#331286" title="(typ: InlineExceptionHandlers.this.global.icodes.TypeKind)InlineExceptionHandlers.this.global.icodes.opcodes.DROP">DROP</a><span class="delimiter">(</span><a href="#380320" title="InlineExceptionHandlers.this.global.icodes.TypeKind">x</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(elem: Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable)(implicit bf: scala.collection.generic.CanBuildFrom[List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable],Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable,List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]])List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">:+</span> <a href="../icode/Opcodes.scala.html#327593" title="(whereto: InlineExceptionHandlers.this.global.icodes.BasicBlock)InlineExceptionHandlers.this.global.icodes.opcodes.JUMP">JUMP</a><span class="delimiter">(</span><a href="#380273" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">newHandler</a><span class="delimiter">)</span>

                // we already have the exception on top of the stack, only need to JUMP
                <span class="keyword">case</span> <span title="List[InlineExceptionHandlers.this.global.icodes.opcodes.JUMP]">None</span> <span class="keyword">if</span> <a href="#380258" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">typeInfo</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(1)" class="int">1</span> =&gt;
                  <a href="../icode/Opcodes.scala.html#327593" title="(whereto: InlineExceptionHandlers.this.global.icodes.BasicBlock)InlineExceptionHandlers.this.global.icodes.opcodes.JUMP">JUMP</a><span class="delimiter">(</span><a href="#380273" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">newHandler</a><span class="delimiter">)</span> <a href="#380486" title="(x: InlineExceptionHandlers.this.global.icodes.opcodes.JUMP)List[InlineExceptionHandlers.this.global.icodes.opcodes.JUMP]">::</a> <span title="object Nil">Nil</span>

                // we have the exception on top of the stack but we have other stuff on the stack
                // create a local, load exception, clear the stack and finally store the exception on the stack
                <span class="keyword">case</span> <span title="List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">_</span> =&gt;
                  <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380492">exceptionType</a> = <a href="#380258" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">typeInfo</a>.<span title="=&gt; InlineExceptionHandlers.this.global.icodes.TypeKind">head</span>
                  // Here we could create a single local for all exceptions of a certain type. TODO: try that.
                  <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.global.TermName" id="380493">localName</a>   = <a href="#244669" title="=&gt; InlineExceptionHandlers.this.global.icodes.IClass">currentClass</a>.<a href="../icode/Members.scala.html#232939" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.CompilationUnit">cunit</a>.<a href="../../CompilationUnits.scala.html#188695" title="(prefix: String)InlineExceptionHandlers.this.global.icodes.global.TermName">freshTermName</a><span class="delimiter">(</span><span title="String(&quot;exception$&quot;)" class="string">&quot;exception$&quot;</span><span class="delimiter">)</span>
                  <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380494">localType</a>   = <a href="#380492" title="InlineExceptionHandlers.this.global.icodes.TypeKind">exceptionType</a>
                  <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.global.TermSymbol" id="380495">localSymbol</a> = <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a>.<a href="../icode/Members.scala.html#322208" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.Symbol">symbol</a>.<a href="../../../../reflect/internal/Symbols.scala.html#46383" title="(name: InlineExceptionHandlers.this.global.icodes.global.TermName, pos: InlineExceptionHandlers.this.global.icodes.global.Position, newFlags: Long)InlineExceptionHandlers.this.global.icodes.global.TermSymbol">newValue</a><span class="delimiter">(</span><a href="#380493" title="InlineExceptionHandlers.this.global.icodes.global.TermName">localName</a><span class="delimiter">)</span>.<a href="../../../../reflect/internal/Symbols.scala.html#46610" title="(info: InlineExceptionHandlers.this.global.icodes.global.Type)InlineExceptionHandlers.this.global.icodes.global.TermSymbol">setInfo</a><span class="delimiter">(</span><a href="#380494" title="InlineExceptionHandlers.this.global.icodes.TypeKind">localType</a>.<a href="../icode/TypeKinds.scala.html#320530" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.Type">toType</a><span class="delimiter">)</span>
                  <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.Local" id="380496">local</a>       = <span title="InlineExceptionHandlers.this.global.icodes.Local" class="keyword">new</span> <a href="../icode/Members.scala.html#232641" title="InlineExceptionHandlers.this.global.icodes.Local">Local</a><span class="delimiter">(</span><a href="#380495" title="InlineExceptionHandlers.this.global.icodes.global.TermSymbol">localSymbol</a>, <a href="#380494" title="InlineExceptionHandlers.this.global.icodes.TypeKind">localType</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>

                  <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a>.<a href="../icode/Members.scala.html#322248" title="(l: InlineExceptionHandlers.this.global.icodes.Local)InlineExceptionHandlers.this.global.icodes.Local">addLocal</a><span class="delimiter">(</span><a href="#380496" title="InlineExceptionHandlers.this.global.icodes.Local">local</a><span class="delimiter">)</span>

                  // Save the exception, drop the stack and place back the exception
                  <a href="../icode/Opcodes.scala.html#327716" title="(local: InlineExceptionHandlers.this.global.icodes.Local)InlineExceptionHandlers.this.global.icodes.opcodes.STORE_LOCAL">STORE_LOCAL</a><span class="delimiter">(</span><a href="#380496" title="InlineExceptionHandlers.this.global.icodes.Local">local</a><span class="delimiter">)</span> <a href="#380511" title="(x: Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable)List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">::</a> <a href="#380258" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">typeInfo</a>.<span title="=&gt; List[InlineExceptionHandlers.this.global.icodes.TypeKind]">tail</span>.<span title="(f: InlineExceptionHandlers.this.global.icodes.TypeKind =&gt; InlineExceptionHandlers.this.global.icodes.opcodes.DROP)(implicit bf: scala.collection.generic.CanBuildFrom[List[InlineExceptionHandlers.this.global.icodes.TypeKind],InlineExceptionHandlers.this.global.icodes.opcodes.DROP,List[InlineExceptionHandlers.this.global.icodes.opcodes.DROP]])List[InlineExceptionHandlers.this.global.icodes.opcodes.DROP]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,InlineExceptionHandlers.this.global.icodes.opcodes.DROP,List[InlineExceptionHandlers.this.global.icodes.opcodes.DROP]]" class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380533">x</a> =&gt; <a href="../icode/Opcodes.scala.html#331286" title="(typ: InlineExceptionHandlers.this.global.icodes.TypeKind)InlineExceptionHandlers.this.global.icodes.opcodes.DROP">DROP</a><span class="delimiter">(</span><a href="#380533" title="InlineExceptionHandlers.this.global.icodes.TypeKind">x</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#380513" title="(prefix: List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable])List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">:::</a> <span title="(xs: Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable*)List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">List</span><span class="delimiter">(</span><a href="../icode/Opcodes.scala.html#330875" title="(local: InlineExceptionHandlers.this.global.icodes.Local)InlineExceptionHandlers.this.global.icodes.opcodes.LOAD_LOCAL">LOAD_LOCAL</a><span class="delimiter">(</span><a href="#380496" title="InlineExceptionHandlers.this.global.icodes.Local">local</a><span class="delimiter">)</span>, <a href="../icode/Opcodes.scala.html#327593" title="(whereto: InlineExceptionHandlers.this.global.icodes.BasicBlock)InlineExceptionHandlers.this.global.icodes.opcodes.JUMP">JUMP</a><span class="delimiter">(</span><a href="#380273" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">newHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>
              // replace THROW by the new code
              <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322164" title="(oldInstr: InlineExceptionHandlers.this.global.icodes.Instruction, is: List[InlineExceptionHandlers.this.global.icodes.Instruction])Boolean">replaceInstruction</a><span class="delimiter">(</span><a href="#380234" title="InlineExceptionHandlers.this.global.icodes.opcodes.THROW">instr</a>, <a href="#380291" title="List[Product with InlineExceptionHandlers.this.global.icodes.Instruction with Serializable]">newCode</a><span class="delimiter">)</span>

              // notify the successors changed for the current block
              // notify the predecessors changed for the inlined handler block
              <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322138" title="(b: Boolean)Unit">touched</a> = <span title="Boolean(true)" class="keyword">true</span>
              <a href="#380273" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">newHandler</a>.<a href="../icode/BasicBlocks.scala.html#322138" title="(b: Boolean)Unit">touched</a> = <span title="Boolean(true)" class="keyword">true</span>

              <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;   Replaced  &quot;)" class="string">&quot;   Replaced  &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380234" title="InlineExceptionHandlers.this.global.icodes.opcodes.THROW">instr</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; in &quot;)" class="string">&quot; in &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; to new handler&quot;)" class="string">&quot; to new handler&quot;</span><span class="delimiter">)</span>
              <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;OPTIMIZED class &quot;)" class="string">&quot;OPTIMIZED class &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#244669" title="=&gt; InlineExceptionHandlers.this.global.icodes.IClass">currentClass</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; method &quot;)" class="string">&quot; method &quot;</span> <span title="(x$1: Any)String">+</span>
                <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; block &quot;)" class="string">&quot; block &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380200" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; newhandler &quot;)" class="string">&quot; newhandler &quot;</span> <span title="(x$1: Any)String">+</span>
                <a href="#380273" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">newHandler</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;:\n\t\t&quot;)" class="string">&quot;:\n\t\t&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380274" title="InlineExceptionHandlers.this.global.icodes.TypeKind">onStackException</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; &lt;:&lt; &quot;)" class="string">&quot; &lt;:&lt; &quot;</span> <span title="(x$1: Any)String">+</span>
                <a href="#380275" title="InlineExceptionHandlers.this.global.icodes.TypeKind">thrownException</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; &lt;:&lt; &quot;)" class="string">&quot; &lt;:&lt; &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380257" title="InlineExceptionHandlers.this.global.icodes.TypeKind">caughtException</a><span class="delimiter">)</span>

          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    /**
      * Gets the types on the stack at a certain point in the program. Note that we want to analyze the method lazily
      * and therefore use the analyzedMethod variable
      */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(bblock: InlineExceptionHandlers.this.global.icodes.BasicBlock, index: Int)List[InlineExceptionHandlers.this.global.icodes.TypeKind]" id="244674">getTypesAtInstruction</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380259">bblock</a>: <a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a>, <a title="Int" id="380260">index</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">List</span><span class="delimiter">[</span>TypeKind<span class="delimiter">]</span> = <span class="delimiter">{</span>
      // get the stack at the block entry
      <span class="keyword">var</span> <a title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem" id="380612">typeInfo</a> = <a href="#244675" title="(bblock: InlineExceptionHandlers.this.global.icodes.BasicBlock)InlineExceptionHandlersPhase.this.tfa.lattice.Elem">getTypesAtBlockEntry</a><span class="delimiter">(</span><a href="#380259" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a><span class="delimiter">)</span>

      // perform tfa to the current instruction
      <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;         stack at the beginning of block &quot;)" class="string">&quot;         stack at the beginning of block &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380259" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; in function &quot;)" class="string">&quot; in function &quot;</span> <span title="(x$1: Any)String">+</span>
        <a href="#380259" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;: &quot;)" class="string">&quot;: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380612" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">typeInfo</a>.<a href="../icode/analysis/SemiLattice.scala.html#350521" title="=&gt; InlineExceptionHandlers.this.global.analysis.global.icodes.TypeStack">stack</a><span class="delimiter">)</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="380764">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">0</span> <span title="(f: Int =&gt; Unit)Unit">to</span> <span class="delimiter">(</span><a href="#380260" title="Int">index</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#380612" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">typeInfo</a> = <a href="#244657" title="=&gt; InlineExceptionHandlers.this.global.analysis.MethodTFA">tfa</a>.<a href="../icode/analysis/TypeFlowAnalysis.scala.html#353265" title="(in: InlineExceptionHandlers.this.global.analysis.typeFlowLattice.Elem, i: InlineExceptionHandlers.this.global.analysis.global.icodes.Instruction)InlineExceptionHandlers.this.global.analysis.typeFlowLattice.Elem">interpret</a><span class="delimiter">(</span><a href="#380612" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">typeInfo</a>, <a href="../icode/BasicBlocks.scala.html#322161" title="(n: Int)InlineExceptionHandlers.this.global.icodes.Instruction">bblock</a><span class="delimiter">(</span><a href="#380764" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;         stack after interpret: &quot;)" class="string">&quot;         stack after interpret: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380612" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">typeInfo</a>.<a href="../icode/analysis/SemiLattice.scala.html#350521" title="=&gt; InlineExceptionHandlers.this.global.analysis.global.icodes.TypeStack">stack</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; after instruction &quot;)" class="string">&quot; after instruction &quot;</span> <span title="(x$1: Any)String">+</span>
          <a href="../icode/BasicBlocks.scala.html#322161" title="(n: Int)InlineExceptionHandlers.this.global.icodes.Instruction">bblock</a><span class="delimiter">(</span><a href="#380764" title="Int">i</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;         stack before instruction &quot;)" class="string">&quot;         stack before instruction &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380260" title="Int">index</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; of block &quot;)" class="string">&quot; of block &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380259" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; in function &quot;)" class="string">&quot; in function &quot;</span> <span title="(x$1: Any)String">+</span>
        <a href="#380259" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;: &quot;)" class="string">&quot;: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380612" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">typeInfo</a>.<a href="../icode/analysis/SemiLattice.scala.html#350521" title="=&gt; InlineExceptionHandlers.this.global.analysis.global.icodes.TypeStack">stack</a><span class="delimiter">)</span>

      // return the result
      <a href="#380612" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">typeInfo</a>.<a href="../icode/analysis/SemiLattice.scala.html#350521" title="=&gt; InlineExceptionHandlers.this.global.analysis.global.icodes.TypeStack">stack</a>.<a href="../icode/TypeStacks.scala.html#336239" title="=&gt; InlineExceptionHandlers.this.global.analysis.global.icodes.Rep">types</a>
    <span class="delimiter">}</span>

    /**
      * Gets the stack at the block entry. Normally the typeFlowAnalysis should be run again, but we know how to compute
      * the stack for handler duplicates. For the locals, it's safe to assume the info from the original handler is
      * still valid (a more precise analysis can be done, but it's not necessary)
      */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(bblock: InlineExceptionHandlers.this.global.icodes.BasicBlock)InlineExceptionHandlersPhase.this.tfa.lattice.Elem" id="244675">getTypesAtBlockEntry</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380613">bblock</a>: <a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: tfa.lattice.<a href="../icode/analysis/SemiLattice.scala.html#347427" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">Elem</a> = <span class="delimiter">{</span>
      // lazily perform tfa, because it's expensive
      // cache results by block label, as rewriting the code messes up the block's hashCode
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#244663" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">analyzedMethod</a> <span title="(x$1: AnyRef)Boolean">eq</span> <a href="../icode/Members.scala.html#232638" title="object InlineExceptionHandlers.this.global.icodes.NoIMethod">NoIMethod</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#244663" title="(x$1: InlineExceptionHandlers.this.global.icodes.IMethod)Unit">analyzedMethod</a> = <a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a>
        <a href="#244657" title="=&gt; InlineExceptionHandlers.this.global.analysis.MethodTFA">tfa</a>.<a href="../icode/analysis/TypeFlowAnalysis.scala.html#353261" title="(m: InlineExceptionHandlers.this.global.analysis.global.icodes.IMethod)Unit">init</a><span class="delimiter">(</span><a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a><span class="delimiter">)</span>
        <a href="#244657" title="=&gt; InlineExceptionHandlers.this.global.analysis.MethodTFA">tfa</a>.<a href="../icode/analysis/TypeFlowAnalysis.scala.html#353263" title="()Unit">run</a>
        <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;      performed tfa on method: &quot;)" class="string">&quot;      performed tfa on method: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a><span class="delimiter">)</span>

        <span class="keyword">for</span> <span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380860">block</a> &lt;- <a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a>.<a href="../icode/Members.scala.html#322217" title="=&gt; List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">blocks</a>.<span title="(f: InlineExceptionHandlers.this.global.icodes.BasicBlock =&gt; Int)(implicit ord: scala.math.Ordering[Int])List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">sortBy</span><span title="(f: InlineExceptionHandlers.this.global.icodes.BasicBlock =&gt; Unit)Unit" class="delimiter">(</span><a href="#380779" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">_</a>.<a href="../icode/BasicBlocks.scala.html#322115" title="=&gt; Int">label</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#244660" title="(x$1: Map[Int,InlineExceptionHandlersPhase.this.tfa.lattice.Elem])Unit">tfaCache</a> <span title="(kv: (Int, InlineExceptionHandlersPhase.this.tfa.lattice.Elem))scala.collection.immutable.Map[Int,InlineExceptionHandlersPhase.this.tfa.lattice.Elem]">+=</span> <a href="#380860" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">block</a>.<a href="../icode/BasicBlocks.scala.html#322115" title="(x: Int)ArrowAssoc[Int]">label</a> <span title="(y: InlineExceptionHandlersPhase.this.tfa.lattice.Elem)(Int, InlineExceptionHandlersPhase.this.tfa.lattice.Elem)">-&gt;</span> <a href="#244657" title="=&gt; InlineExceptionHandlers.this.global.analysis.MethodTFA">tfa</a>.<a href="../icode/analysis/DataFlowAnalysis.scala.html#348027" title="(key: InlineExceptionHandlersPhase.this.tfa.P)InlineExceptionHandlersPhase.this.tfa.lattice.Elem">in</a><span class="delimiter">(</span><a href="#380860" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">block</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;         getting typeinfo at the beginning of block &quot;)" class="string">&quot;         getting typeinfo at the beginning of block &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a><span class="delimiter">)</span>

      <a href="#244660" title="=&gt; Map[Int,InlineExceptionHandlersPhase.this.tfa.lattice.Elem]">tfaCache</a>.<span title="(key: Int, default: =&gt; InlineExceptionHandlersPhase.this.tfa.lattice.Elem)InlineExceptionHandlersPhase.this.tfa.lattice.Elem">getOrElse</span><span class="delimiter">(</span><a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a>.<a href="../icode/BasicBlocks.scala.html#322115" title="=&gt; Int">label</a>, <span class="delimiter">{</span>
        // this block was not analyzed, but it's a copy of some other block so its stack should be the same
        <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;         getting typeinfo at the beginning of block &quot;)" class="string">&quot;         getting typeinfo at the beginning of block &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; as a copy of &quot;)" class="string">&quot; as a copy of &quot;</span> <span title="(x$1: Any)String">+</span>
          <a href="#244654" title="(key: InlineExceptionHandlers.this.global.icodes.BasicBlock)(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)">handlerCopiesInverted</a><span class="delimiter">(</span><a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a href="#381005" title="(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)" class="delimiter">(</a><a href="#381004" title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="381005">origBlock</a>, <a href="#381004" title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="381006">exception</a><span class="delimiter">)</span> = <a href="#244654" title="(key: InlineExceptionHandlers.this.global.icodes.BasicBlock)(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)">handlerCopiesInverted</a><span title="(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind) @unchecked" class="delimiter">(</span><a href="#380613" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">bblock</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem" id="381007">typeInfo</a>               = <a href="#244675" title="(bblock: InlineExceptionHandlers.this.global.icodes.BasicBlock)InlineExceptionHandlersPhase.this.tfa.lattice.Elem">getTypesAtBlockEntry</a><span class="delimiter">(</span><a href="#381005" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">origBlock</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]" id="381008">stack</a>                  =
          <span title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]" class="keyword">if</span> <span class="delimiter">(</span><a href="#244656" title="(bb: InlineExceptionHandlers.this.global.icodes.BasicBlock)Option[InlineExceptionHandlers.this.global.icodes.Local]">handlerLocal</a><span class="delimiter">(</span><a href="#381005" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">origBlock</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">nonEmpty</span><span class="delimiter">)</span> <span title="object Nil">Nil</span>   // empty stack, the handler copy expects an empty stack
          <span class="keyword">else</span> <span title="(xs: InlineExceptionHandlers.this.global.icodes.TypeKind*)List[InlineExceptionHandlers.this.global.icodes.TypeKind]">List</span><span class="delimiter">(</span><a href="#381006" title="InlineExceptionHandlers.this.global.icodes.TypeKind">exception</a><span class="delimiter">)</span>                        // one slot on the stack for the exception

        // If we use the mutability property, it crashes the analysis
        <a href="#244657" title="=&gt; InlineExceptionHandlers.this.global.analysis.MethodTFA">tfa</a>.<a href="../icode/analysis/TypeFlowAnalysis.scala.html#353254" title="=&gt; InlineExceptionHandlers.this.global.analysis.typeFlowLattice.type">lattice</a>.<a href="../icode/analysis/SemiLattice.scala.html#350574" title="(vars: InlineExceptionHandlers.this.global.analysis.VarBinding, stack: InlineExceptionHandlers.this.global.icodes.TypeStack)InlineExceptionHandlersPhase.this.tfa.lattice.IState[InlineExceptionHandlers.this.global.analysis.VarBinding,InlineExceptionHandlers.this.global.icodes.TypeStack]">IState</a><span class="delimiter">(</span><a href="../icode/analysis/TypeFlowAnalysis.scala.html#352806" title="(o: InlineExceptionHandlers.this.global.analysis.VarBinding)InlineExceptionHandlers.this.global.analysis.VarBinding" class="keyword">new</a> <a href="../../Global.scala.html#186159" title="object InlineExceptionHandlers.this.global.analysis">analysis</a>.<a href="../icode/analysis/TypeFlowAnalysis.scala.html#239588" title="InlineExceptionHandlers.this.global.analysis.VarBinding">VarBinding</a><span class="delimiter">(</span><a href="#381007" title="InlineExceptionHandlersPhase.this.tfa.lattice.Elem">typeInfo</a>.<a href="../icode/analysis/SemiLattice.scala.html#350519" title="=&gt; InlineExceptionHandlers.this.global.analysis.VarBinding">vars</a><span class="delimiter">)</span>, <span title="InlineExceptionHandlers.this.global.icodes.TypeStack" class="keyword">new</span> <a href="../../Global.scala.html#186153" title="object InlineExceptionHandlers.this.global.icodes">icodes</a>.<a href="../icode/TypeStacks.scala.html#232662" title="InlineExceptionHandlers.this.global.icodes.TypeStack">TypeStack</a><span class="delimiter">(</span><a href="#381008" title="List[InlineExceptionHandlers.this.global.icodes.TypeKind]">stack</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    /**
      * Finds the first exception handler that matches the current exception
      *
      * Note the following code:
      * {{{
      * try {
      *   throw new IllegalArgumentException(&quot;...&quot;)
      * } catch {
      *   case e: RuntimeException =&gt; log(&quot;RuntimeException&quot;)
      *   case i: IllegalArgumentException =&gt; log(&quot;IllegalArgumentException&quot;)
      * }
      * }}}
      *
      * will print &quot;RuntimeException&quot; =&gt; we need the *first* valid handler
      *
      * There's a hidden catch here: say we have the following code:
      * {{{
      * try {
      *   val exception: Throwable =
      *     if (scala.util.Random.nextInt % 2 == 0)
      *       new IllegalArgumentException(&quot;even&quot;)
      *     else
      *       new StackOverflowError(&quot;odd&quot;)
      *   throw exception
      * } catch {
      *   case e: IllegalArgumentException =&gt;
      *     println(&quot;Correct, IllegalArgumentException&quot;)
      *   case e: StackOverflowError =&gt;
      *     println(&quot;Correct, StackOverflowException&quot;)
      *   case t: Throwable =&gt;
      *     println(&quot;WROOOONG, not Throwable!&quot;)
      * }
      * }}}
      *
      * We don't want to select a handler if there's at least one that's more specific!
      */
    <span class="keyword">def</span> <a title="(thrownException: InlineExceptionHandlers.this.global.icodes.TypeKind, handlers: List[InlineExceptionHandlers.this.global.icodes.BasicBlock])Option[(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)]" id="244676">findExceptionHandler</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="380238">thrownException</a>: <a href="../icode/TypeKinds.scala.html#232671" title="InlineExceptionHandlers.this.global.icodes.TypeKind">TypeKind</a>, <a title="List[InlineExceptionHandlers.this.global.icodes.BasicBlock]" id="380239">handlers</a>: <span title="List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">List</span><span class="delimiter">[</span>BasicBlock<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)]">Option</span><span class="delimiter">[</span><span class="delimiter">(</span>BasicBlock, TypeKind<span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="381112">handler</a> &lt;- <a href="#380239" title="(f: InlineExceptionHandlers.this.global.icodes.BasicBlock =&gt; Unit)Unit">handlers</a> ; LOAD_EXCEPTION<span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.global.Symbol" id="381147">clazz</a><span class="delimiter">)</span> &lt;- <a href="#381112" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a> <a href="../icode/BasicBlocks.scala.html#322150" title="(f: InlineExceptionHandlers.this.global.icodes.Instruction =&gt; Unit)Unit">take</a> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="381148">caughtException</a> = <a href="../icode/TypeKinds.scala.html#232707" title="(t: InlineExceptionHandlers.this.global.icodes.global.Type)InlineExceptionHandlers.this.global.icodes.TypeKind">toTypeKind</a><span class="delimiter">(</span><a href="#381147" title="InlineExceptionHandlers.this.global.icodes.global.Symbol">clazz</a>.<a href="../../../../reflect/internal/Symbols.scala.html#46606" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.Type">tpe</a><span class="delimiter">)</span>
        // we'll do inlining here: createdException &lt;:&lt; thrownException &lt;:&lt; caughtException, good!
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#380238" title="InlineExceptionHandlers.this.global.icodes.TypeKind">thrownException</a> <a href="../icode/TypeKinds.scala.html#320544" title="(other: InlineExceptionHandlers.this.global.icodes.TypeKind)Boolean">&lt;:&lt;</a> <a href="#381148" title="InlineExceptionHandlers.this.global.icodes.TypeKind">caughtException</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">return</span> <span title="(x: (InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind))Some[(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)]">Some</span><span class="delimiter">(</span><span title="(_1: InlineExceptionHandlers.this.global.icodes.BasicBlock, _2: InlineExceptionHandlers.this.global.icodes.TypeKind)(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)" class="delimiter">(</span><a href="#381112" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>, <a href="#381148" title="InlineExceptionHandlers.this.global.icodes.TypeKind">caughtException</a><span class="delimiter">)</span><span class="delimiter">)</span>
        // we can't do inlining here, the handling mechanism is more precise than we can reason about
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#381148" title="InlineExceptionHandlers.this.global.icodes.TypeKind">caughtException</a> <a href="../icode/TypeKinds.scala.html#320544" title="(other: InlineExceptionHandlers.this.global.icodes.TypeKind)Boolean">&lt;:&lt;</a> <a href="#380238" title="InlineExceptionHandlers.this.global.icodes.TypeKind">thrownException</a><span class="delimiter">)</span>
          <span title="Nothing" class="keyword">return</span> <span title="object None">None</span>
        // no result yet, look deeper in the handler stack
      <span class="delimiter">}</span>
      <span title="object None">None</span>
    <span class="delimiter">}</span>

    /**
      * This function takes care of duplicating the basic block code for inlining the handler
      *
      * Note: This function does not duplicate the same basic block twice. It wil contain a map of the duplicated
      * basic blocks
      */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: InlineExceptionHandlers.this.global.icodes.BasicBlock)Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]" id="244677">duplicateExceptionHandlerCache</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380262">handler</a>: <a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a><span class="delimiter">)</span> =
      <a href="#244652" title="=&gt; scala.collection.mutable.HashMap[InlineExceptionHandlers.this.global.icodes.BasicBlock,Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]]">handlerCopies</a>.<span title="(key: InlineExceptionHandlers.this.global.icodes.BasicBlock, op: =&gt; Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)])Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]">getOrElseUpdate</span><span class="delimiter">(</span><a href="#380262" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>, <a href="#244678" title="(handler: InlineExceptionHandlers.this.global.icodes.BasicBlock)Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]">duplicateExceptionHandler</a><span class="delimiter">(</span><a href="#380262" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a><span class="delimiter">)</span><span class="delimiter">)</span>

    /** This function takes care of actual duplication */
    <span class="keyword">private</span> <span class="keyword">def</span> <a title="(handler: InlineExceptionHandlers.this.global.icodes.BasicBlock)Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]" id="244678">duplicateExceptionHandler</a><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="380267">handler</a>: <a href="../icode/BasicBlocks.scala.html#232649" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">BasicBlock</a><span class="delimiter">)</span>: <span title="Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]">Option</span><span class="delimiter">[</span><span class="delimiter">(</span>Option<span class="delimiter">[</span>Local<span class="delimiter">]</span>, BasicBlock<span class="delimiter">)</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
      <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;      duplicating handler block &quot;)" class="string">&quot;      duplicating handler block &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a><span class="delimiter">)</span>

      <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a> <a href="../icode/BasicBlocks.scala.html#322150" title="(n: Int)Seq[InlineExceptionHandlers.this.global.icodes.Instruction]">take</a> <span title="Int(2)" class="int">2</span> <span title="Option[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a href="#381163" title="Some[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]">Seq</a><span class="delimiter">(</span>LOAD_EXCEPTION<span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.global.Symbol" id="381181">caughtClass</a><span class="delimiter">)</span>, <a title="InlineExceptionHandlers.this.global.icodes.Instruction" id="381182">next</a><span class="delimiter">)</span> =&gt;
          <span class="keyword">val</span> <a href="#381184" title="(Int, Option[InlineExceptionHandlers.this.global.icodes.Local])" class="delimiter">(</a><a href="#381183" title="Int" id="381184">dropCount</a>, <a href="#381183" title="Option[InlineExceptionHandlers.this.global.icodes.Local]" id="381185">exceptionLocal</a><span class="delimiter">)</span> = <a href="#381182" title="InlineExceptionHandlers.this.global.icodes.Instruction">next</a> <span title="(Int, Option[InlineExceptionHandlers.this.global.icodes.Local])" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span title="(Int, Some[InlineExceptionHandlers.this.global.icodes.Local])">STORE_LOCAL</span><span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.Local" id="381189">local</a><span class="delimiter">)</span> =&gt; <span title="(_1: Int, _2: Some[InlineExceptionHandlers.this.global.icodes.Local])(Int, Some[InlineExceptionHandlers.this.global.icodes.Local])" class="delimiter">(</span><span title="Int(2)" class="int">2</span>, <span title="(x: InlineExceptionHandlers.this.global.icodes.Local)Some[InlineExceptionHandlers.this.global.icodes.Local]">Some</span><span class="delimiter">(</span><a href="#381189" title="InlineExceptionHandlers.this.global.icodes.Local">local</a><span class="delimiter">)</span><span class="delimiter">)</span> // we drop both LOAD_EXCEPTION and STORE_LOCAL
            <span class="keyword">case</span> <span title="(Int, None.type)">_</span>                  =&gt; <span title="(_1: Int, _2: None.type)(Int, None.type)" class="delimiter">(</span><span title="Int(1)" class="int">1</span>, <span title="object None">None</span><span class="delimiter">)</span>        // we only drop the LOAD_EXCEPTION and expect the exception on the stack
          <span class="delimiter">}</span>
          <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.TypeKind" id="381186">caughtException</a> = <a href="../icode/TypeKinds.scala.html#232707" title="(t: InlineExceptionHandlers.this.global.icodes.global.Type)InlineExceptionHandlers.this.global.icodes.TypeKind">toTypeKind</a><span class="delimiter">(</span><a href="#381181" title="InlineExceptionHandlers.this.global.icodes.global.Symbol">caughtClass</a>.<a href="../../../../reflect/internal/Symbols.scala.html#46606" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.Type">tpe</a><span class="delimiter">)</span>
          // copy the exception handler code once again, dropping the LOAD_EXCEPTION
          <span class="keyword">val</span> <a title="InlineExceptionHandlers.this.global.icodes.BasicBlock" id="381187">copy</a> = <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>.<a href="../icode/BasicBlocks.scala.html#322121" title="=&gt; InlineExceptionHandlers.this.global.icodes.Code">code</a>.<a href="../icode/Members.scala.html#322321" title="()InlineExceptionHandlers.this.global.icodes.BasicBlock">newBlock</a>
          <a href="#381187" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">copy</a>.<a href="../icode/BasicBlocks.scala.html#322172" title="(is: InlineExceptionHandlers.this.global.icodes.Instruction*)Unit">emitOnly</a><span class="delimiter">(</span><a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>.<a href="../icode/BasicBlocks.scala.html#322152" title="=&gt; Iterator[InlineExceptionHandlers.this.global.icodes.Instruction]">iterator</a> <span title="(n: Int)Iterator[InlineExceptionHandlers.this.global.icodes.Instruction]">drop</span> <a href="#381184" title="Int">dropCount</a> <span title="=&gt; Seq[InlineExceptionHandlers.this.global.icodes.Instruction]">toSeq</span>: _*<span class="delimiter">)</span>

          // extend the handlers of the handler to the copy
          <span class="keyword">for</span> <span class="delimiter">(</span><a title="InlineExceptionHandlers.this.global.icodes.ExceptionHandler" id="381257">parentHandler</a> &lt;- <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>.<a href="../icode/BasicBlocks.scala.html#322117" title="=&gt; InlineExceptionHandlers.this.global.icodes.IMethod">method</a>.<a href="../icode/Members.scala.html#322228" title="(f: InlineExceptionHandlers.this.global.icodes.ExceptionHandler =&gt; Unit)Unit">exh</a> ; <span class="keyword">if</span> <a href="#381257" title="InlineExceptionHandlers.this.global.icodes.ExceptionHandler">parentHandler</a> <a href="../icode/ExceptionHandlers.scala.html#322462" title="(b: InlineExceptionHandlers.this.global.icodes.BasicBlock)Boolean">covers</a> <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#381257" title="InlineExceptionHandlers.this.global.icodes.ExceptionHandler">parentHandler</a>.<a href="../icode/ExceptionHandlers.scala.html#322461" title="(b: InlineExceptionHandlers.this.global.icodes.BasicBlock)parentHandler.type">addCoveredBlock</a><span class="delimiter">(</span><a href="#381187" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">copy</a><span class="delimiter">)</span>
            // notify the parent handler that the successors changed
            <a href="#381257" title="InlineExceptionHandlers.this.global.icodes.ExceptionHandler">parentHandler</a>.<a href="../icode/ExceptionHandlers.scala.html#322457" title="=&gt; InlineExceptionHandlers.this.global.icodes.BasicBlock">startBlock</a>.<a href="../icode/BasicBlocks.scala.html#322138" title="(b: Boolean)Unit">touched</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>

          // notify the successors of the inlined handler might have changed
          <a href="#381187" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">copy</a>.<a href="../icode/BasicBlocks.scala.html#322138" title="(b: Boolean)Unit">touched</a>    = <span title="Boolean(true)" class="keyword">true</span>
          <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>.<a href="../icode/BasicBlocks.scala.html#322138" title="(b: Boolean)Unit">touched</a> = <span title="Boolean(true)" class="keyword">true</span>
          <a href="../../Global.scala.html#186199" title="(msg: =&gt; AnyRef)Unit">log</a><span class="delimiter">(</span><span title="String(&quot;      duplicated  handler block &quot;)" class="string">&quot;      duplicated  handler block &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; to &quot;)" class="string">&quot; to &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#381187" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">copy</a><span class="delimiter">)</span>

          // announce the duplicate handler
          <a href="#244654" title="(key: InlineExceptionHandlers.this.global.icodes.BasicBlock, value: (InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind))Unit">handlerCopiesInverted</a><span class="delimiter">(</span><a href="#381187" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">copy</a><span class="delimiter">)</span> = <span class="delimiter">(</span><span title="(_1: InlineExceptionHandlers.this.global.icodes.BasicBlock, _2: InlineExceptionHandlers.this.global.icodes.TypeKind)(InlineExceptionHandlers.this.global.icodes.BasicBlock, InlineExceptionHandlers.this.global.icodes.TypeKind)" class="delimiter">(</span><a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>, <a href="#381186" title="InlineExceptionHandlers.this.global.icodes.TypeKind">caughtException</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#244666" title="(x$1: List[InlineExceptionHandlers.this.global.icodes.BasicBlock])Unit">todoBlocks</a> <span title="(x: InlineExceptionHandlers.this.global.icodes.BasicBlock)List[InlineExceptionHandlers.this.global.icodes.BasicBlock]">::=</span> <a href="#381187" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">copy</a>

          <span title="(x: (Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock))Some[(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)]">Some</span><span class="delimiter">(</span><span title="(_1: Option[InlineExceptionHandlers.this.global.icodes.Local], _2: InlineExceptionHandlers.this.global.icodes.BasicBlock)(Option[InlineExceptionHandlers.this.global.icodes.Local], InlineExceptionHandlers.this.global.icodes.BasicBlock)" class="delimiter">(</span><a href="#381185" title="Option[InlineExceptionHandlers.this.global.icodes.Local]">exceptionLocal</a>, <a href="#381187" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">copy</a><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="keyword">case</span> <span title="None.type">_</span> =&gt;
          <a href="#244669" title="=&gt; InlineExceptionHandlers.this.global.icodes.IClass">currentClass</a>.<a href="../icode/Members.scala.html#232939" title="=&gt; InlineExceptionHandlers.this.global.icodes.global.CompilationUnit">cunit</a>.<a href="../../CompilationUnits.scala.html#188715" title="(pos: InlineExceptionHandlers.this.global.icodes.global.Position, msg: String)Unit">warning</a><span class="delimiter">(</span><a href="../../symtab/Positions.scala.html#186524" title="=&gt; tools.nsc.util.NoPosition.type">NoPosition</a>, <span title="String(&quot;Unable to inline the exception handler due to incorrect format:\n&quot;)" class="string">&quot;Unable to inline the exception handler due to incorrect format:\n&quot;</span> <span title="(x$1: Any)String">+</span>
            <a href="#380267" title="InlineExceptionHandlers.this.global.icodes.BasicBlock">handler</a>.<a href="../icode/BasicBlocks.scala.html#322152" title="=&gt; Iterator[InlineExceptionHandlers.this.global.icodes.Instruction]">iterator</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;\n&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="object None">None</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>