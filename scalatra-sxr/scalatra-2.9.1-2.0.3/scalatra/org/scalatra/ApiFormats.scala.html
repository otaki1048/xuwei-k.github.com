<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>scalatra/org/scalatra/ApiFormats.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> org.scalatra

<span class="keyword">import</span> collection.<span title="object scala.collection.JavaConversions">JavaConversions</span>._
<span class="keyword">import</span> collection.mutable.ConcurrentMap
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap
<span class="keyword">import</span> org.scalatra.util.<a href="util/RicherString.scala.html#11062" title="object org.scalatra.util.RicherString">RicherString</a>._
<span class="keyword">import</span> java.util.<span title="object java.util.Locale">Locale</span>.ENGLISH
<span class="keyword">import</span> collection.<span class="delimiter">{</span>SortedMap, mutable<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="object org.scalatra.ApiFormats" id="9651">ApiFormats</a> <span title="ScalaObject" class="delimiter">{</span>
  <span class="comment">/**
   * The request attribute key in which the format is stored.
   */</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="49517">FormatKey</a> = <span title="java.lang.String(&quot;org.scalatra.FormatKey&quot;)" class="string">&quot;org.scalatra.FormatKey&quot;</span>.<span title="()java.lang.String">intern</span>

<span class="delimiter">}</span>

<span class="comment">/**
 * Adds support for mapping and inferring formats to content types.
 *
 * $ - Provides a request-scoped format variable
 * $ - Maps formats to content types and vice versa
 * $ - Augments the content-type inferrer to use the format
 */</span>
<span class="keyword">trait</span> <a title="trait ApiFormats extends java.lang.Object with org.scalatra.ScalatraKernel with ScalaObject" id="9650">ApiFormats</a> <span title="ScalaObject" class="keyword">extends</span> <a href="ScalatraKernel.scala.html#10016" title="org.scalatra.ScalatraKernel">ScalatraKernel</a> <span class="delimiter">{</span>
  <span class="comment">/**
   * A map of suffixes to content types.
   */</span>
  <span class="keyword">val</span> <a title="scala.collection.mutable.ConcurrentMap[String,String]" id="42421">formats</a>: <span title="scala.collection.mutable.ConcurrentMap[String,String]">ConcurrentMap</span><span class="delimiter">[</span>String, String<span class="delimiter">]</span> = <span title="(m: java.util.concurrent.ConcurrentMap[String,String])scala.collection.mutable.ConcurrentMap[String,String]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,String]">ConcurrentHashMap</span><span class="delimiter">[</span>String, String<span class="delimiter">]</span><span class="delimiter">(</span><span title="(elems: (java.lang.String, java.lang.String)*)scala.collection.immutable.Map[java.lang.String,java.lang.String]">Map</span><span title="(m: scala.collection.Map[java.lang.String,java.lang.String])java.util.Map[java.lang.String,java.lang.String]" class="delimiter">(</span>
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;json&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/json&quot;)" class="string">&quot;application/json&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;xml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/xml&quot;)" class="string">&quot;application/xml&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;atom&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/atom+xml&quot;)" class="string">&quot;application/atom+xml&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;rss&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/rss+xml&quot;)" class="string">&quot;application/rss+xml&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;xslt&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/xslt+xml&quot;)" class="string">&quot;application/xslt+xml&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;svg&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/svg+xml&quot;)" class="string">&quot;application/svg+xml&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;pdf&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/pdf&quot;)" class="string">&quot;application/pdf&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;swf&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/x-shockwave-flash&quot;)" class="string">&quot;application/x-shockwave-flash&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;flv&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;video/x-flv&quot;)" class="string">&quot;video/x-flv&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;js&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;text/javascript&quot;)" class="string">&quot;text/javascript&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;css&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;text/stylesheet&quot;)" class="string">&quot;text/stylesheet&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;txt&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;text/plain&quot;)" class="string">&quot;text/plain&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;html&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;text/html&quot;)" class="string">&quot;text/html&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;html5&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;text/html&quot;)" class="string">&quot;text/html&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;xhtml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;application/xhtml+xml&quot;)" class="string">&quot;application/xhtml+xml&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * A map of content types to suffixes.  Not strictly a reverse of `formats`.
   */</span>
  <span class="keyword">val</span> <a title="scala.collection.mutable.ConcurrentMap[String,String]" id="42423">mimeTypes</a>: <span title="scala.collection.mutable.ConcurrentMap[String,String]">ConcurrentMap</span><span class="delimiter">[</span>String, String<span class="delimiter">]</span> = <span title="(m: java.util.concurrent.ConcurrentMap[String,String])scala.collection.mutable.ConcurrentMap[String,String]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[String,String]">ConcurrentHashMap</span><span class="delimiter">[</span>String, String<span class="delimiter">]</span><span class="delimiter">(</span><span title="(elems: (java.lang.String, java.lang.String)*)scala.collection.immutable.Map[java.lang.String,java.lang.String]">Map</span><span title="(m: scala.collection.Map[java.lang.String,java.lang.String])java.util.Map[java.lang.String,java.lang.String]" class="delimiter">(</span>
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/json&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;json&quot;)" class="string">&quot;json&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/xml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;xml&quot;)" class="string">&quot;xml&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/atom+xml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;atom&quot;)" class="string">&quot;atom&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/rss+xml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;rss&quot;)" class="string">&quot;rss&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/xslt+xml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;xslt&quot;)" class="string">&quot;xslt&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/pdf&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;pdf&quot;)" class="string">&quot;pdf&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/x-www-form-urlencoded&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;html&quot;)" class="string">&quot;html&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;multipart/form-data&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;html&quot;)" class="string">&quot;html&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/svg+xml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;svg&quot;)" class="string">&quot;svg&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/x-shockwave-flash&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;swf&quot;)" class="string">&quot;swf&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;video/x-flv&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;flv&quot;)" class="string">&quot;flv&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;text/javascript&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;json&quot;)" class="string">&quot;json&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/javascript&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;json&quot;)" class="string">&quot;json&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/ecmascript&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;json&quot;)" class="string">&quot;json&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/x-ecmascript&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;json&quot;)" class="string">&quot;json&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;text/stylesheet&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;css&quot;)" class="string">&quot;css&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;text/html&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;html&quot;)" class="string">&quot;html&quot;</span>,
    <span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="string">&quot;application/xhtml+xml&quot;</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <span title="java.lang.String(&quot;html&quot;)" class="string">&quot;html&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * The default format.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Symbol" id="42425">defaultFormat</a>: <span title="Symbol">Symbol</span> = <span title="(name: String)Symbol" class="symbol">'html</span>

  <span class="comment">/**
   * A list of formats accepted by default.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; List[Symbol]" id="42426">defaultAcceptedFormats</a>: <span title="List[Symbol]">List</span><span class="delimiter">[</span>Symbol<span class="delimiter">]</span> = <span title="object List">List</span>.<span title="List[Nothing]">empty</span>

  <span class="comment">/**
   * The list of media types accepted by the current request.  Parsed from the
   * `Accept` header.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; List[String]" id="42427">acceptHeader</a>: <span title="List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <a href="#42430" title="=&gt; List[String]">parseAcceptHeader</a>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Option[String]" id="42428">getFromParams</a> = <span class="delimiter">{</span>
    <a href="ScalatraKernel.scala.html#11892" title="=&gt; java.lang.Object with org.scalatra.util.MultiMapHeadView[String,String] with org.scalatra.util.MapWithIndifferentAccess[String]">params</a>.<a href="util/MapWithIndifferentAccess.scala.html#25169" title="(key: Symbol)Option[String]">get</a><span title="(xo: Option[String])Iterable[String]" class="delimiter">(</span><span title="(name: String)Symbol" class="symbol">'format</span><span class="delimiter">)</span>.<span title="(p: String =&gt; Boolean)Option[String]">find</span><span class="delimiter">(</span><a title="String" id="53112">p</a> ⇒ <a href="#42421" title="=&gt; scala.collection.mutable.ConcurrentMap[String,String]">formats</a>.<span title="(key: String)Boolean">contains</span><span class="delimiter">(</span><a href="#53112" title="String">p</a>.<span title="(x$1: java.util.Locale)java.lang.String">toLowerCase</span><span class="delimiter">(</span><span title="java.util.Locale">ENGLISH</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Option[String]" id="42429">getFromAcceptHeader</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="List[java.lang.String]" id="53119">hdrs</a> = <span title="List[java.lang.String]" class="keyword">if</span> <span class="delimiter">(</span><a href="ScalatraKernel.scala.html#11893" title="=&gt; javax.servlet.http.HttpServletRequest">request</a>.<span title="()java.lang.String">getContentType</span> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">(</span><a href="#42427" title="=&gt; List[String]">acceptHeader</a> <a href="#53125" title="(prefix: List[java.lang.String])List[java.lang.String]">:::</a> <span title="(xs: java.lang.String*)List[java.lang.String]">List</span><span class="delimiter">(</span><a href="ScalatraKernel.scala.html#11893" title="=&gt; javax.servlet.http.HttpServletRequest">request</a>.<span title="()java.lang.String">getContentType</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; List[java.lang.String]">distinct</span> <span class="keyword">else</span> <a href="#42427" title="=&gt; List[String]">acceptHeader</a>
    <a href="#42431" title="(mimeTypes: String*)Option[String]">formatForMimeTypes</a><span class="delimiter">(</span><a href="#53119" title="List[java.lang.String]">hdrs</a>: _*<span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; List[String]" id="42430">parseAcceptHeader</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.String" id="50619">s</a> = <a href="ScalatraKernel.scala.html#11893" title="=&gt; javax.servlet.http.HttpServletRequest">request</a>.<span title="(x$1: java.lang.String)java.lang.String">getHeader</span><span class="delimiter">(</span><span title="java.lang.String(&quot;Accept&quot;)" class="string">&quot;Accept&quot;</span><span class="delimiter">)</span>
    <span title="List[String]" class="keyword">if</span> <span class="delimiter">(</span><a href="util/RicherString.scala.html#24699" title="implicit org.scalatra.util.RicherString.stringToRicherString : (s: String)org.scalatra.util.RicherString">s</a>.<a href="util/RicherString.scala.html#25294" title="=&gt; Boolean">isBlank</a><span class="delimiter">)</span> <span title="object Nil">Nil</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Array[java.lang.String]" id="50627">fmts</a> = <a href="#50619" title="java.lang.String">s</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span><span title="(implicit m: scala.reflect.ClassManifest[java.lang.String])scala.collection.generic.CanBuildFrom[Array[_],java.lang.String,Array[java.lang.String]]" class="delimiter">(</span><a href="#51076" title="java.lang.String">_</a>.<span title="()java.lang.String">trim</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="scala.collection.immutable.Map[Int,List[String]]" id="50628">accepted</a> = <span class="delimiter">(</span><a href="#50627" title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]">fmts</a>.<span title="(z: scala.collection.immutable.Map[Int,List[String]])(op: (scala.collection.immutable.Map[Int,List[String]], java.lang.String) =&gt; scala.collection.immutable.Map[Int,List[String]])scala.collection.immutable.Map[Int,List[String]]">foldLeft</span><span class="delimiter">(</span><span title="=&gt; scala.collection.immutable.Map.type">Map</span>.<span title="[A, B]=&gt; scala.collection.immutable.Map[A,B]">empty</span><span title="scala.collection.immutable.Map[Int,List[String]]" class="delimiter">[</span><span title="Int">Int</span>, <span title="List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="delimiter">(</span><a title="scala.collection.immutable.Map[Int,List[String]]" id="51532">acc</a>, <a title="java.lang.String" id="51533">f</a><span class="delimiter">)</span> =&gt;
        <span class="keyword">val</span> <a title="Array[java.lang.String]" id="51534">parts</a> = <a href="#51533" title="java.lang.String">f</a>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;;&quot;)" class="string">&quot;;&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span><span title="(implicit m: scala.reflect.ClassManifest[java.lang.String])scala.collection.generic.CanBuildFrom[Array[_],java.lang.String,Array[java.lang.String]]" class="delimiter">(</span><a href="#51983" title="java.lang.String">_</a>.<span title="()java.lang.String">trim</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Int" id="51535">i</a> = <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#51534" title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]">parts</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Seq[(java.lang.String, java.lang.String)]" id="52205">pars</a> = <a href="#51534" title="(i: Int)java.lang.String">parts</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)Array[java.lang.String]">split</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><span title="java.lang.String(&quot;=&quot;)" class="string">&quot;=&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; java.lang.String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.lang.String],java.lang.String,Array[java.lang.String]])Array[java.lang.String]">map</span><span title="(xs: Array[java.lang.String])scala.collection.mutable.ArrayOps[java.lang.String]" class="delimiter">(</span><a href="#52654" title="java.lang.String">_</a>.<span title="()java.lang.String">trim</span><span class="delimiter">)</span>.<span title="(size: Int)Iterator[Array[java.lang.String]]">grouped</span><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>.<span title="(f: Array[java.lang.String] =&gt; (java.lang.String, java.lang.String))Iterator[(java.lang.String, java.lang.String)]">map</span><span class="delimiter">(</span><a title="Array[java.lang.String]" id="52724">a</a> =&gt; <a href="#52724" title="(i: Int)java.lang.String">a</a><span title="(x: java.lang.String)ArrowAssoc[java.lang.String]" class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span title="(y: java.lang.String)(java.lang.String, java.lang.String)">-&gt;</span> <a href="#52724" title="(i: Int)java.lang.String">a</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[(java.lang.String, java.lang.String)]">toSeq</span>
          <span class="keyword">val</span> <a title="scala.collection.immutable.Map[java.lang.String,java.lang.String]" id="52206">a</a> = <span title="(elems: (java.lang.String, java.lang.String)*)scala.collection.immutable.Map[java.lang.String,java.lang.String]">Map</span><span class="delimiter">(</span><a href="#52205" title="Seq[(java.lang.String, java.lang.String)]">pars</a>:_*<span class="delimiter">)</span>
          <span class="delimiter">(</span><a href="#52206" title="scala.collection.immutable.Map[java.lang.String,java.lang.String]">a</a>.<span title="(key: java.lang.String)Option[java.lang.String]">get</span><span class="delimiter">(</span><span title="java.lang.String(&quot;q&quot;)" class="string">&quot;q&quot;</span><span class="delimiter">)</span>.<span title="(f: java.lang.String =&gt; Double)Option[Double]">map</span><span class="delimiter">(</span><a href="#52753" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">_</a>.<span title="=&gt; Double">toDouble</span><span class="delimiter">)</span>.<span title="(default: =&gt; Double)Double">getOrElse</span><span class="delimiter">(</span><span title="Double(1.0)" class="double">1.0</span><span class="delimiter">)</span> <span title="implicit scala.LowPriorityImplicits.doubleWrapper : (x: Double)scala.runtime.RichDouble">*</span> <span title="Int(10)" class="int">10</span><span class="delimiter">)</span>.<span title="=&gt; Double">ceil</span>.<span title="=&gt; Int">toInt</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Int(10)" class="int">10</span>
        <a href="#51532" title="scala.collection.immutable.Map[Int,List[String]]">acc</a> <span title="(kv: (Int, List[String]))scala.collection.immutable.Map[Int,List[String]]">+</span> <span class="delimiter">(</span><a href="#51535" title="(x: Int)ArrowAssoc[Int]">i</a> <span title="(y: List[String])(Int, List[String])">-&gt;</span> <span class="delimiter">(</span><a href="#51534" title="(i: Int)java.lang.String">parts</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#52845" title="(x: String)List[String]">::</a> <a href="#51532" title="scala.collection.immutable.Map[Int,List[String]]">acc</a>.<span title="(key: Int)Option[List[String]]">get</span><span class="delimiter">(</span><a href="#51535" title="Int">i</a><span class="delimiter">)</span>.<span title="(default: =&gt; List[String])List[String]">getOrElse</span><span class="delimiter">(</span><span title="object List">List</span>.<span title="List[Nothing]">empty</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">(</span><a href="#50628" title="scala.collection.immutable.Map[Int,List[String]]">accepted</a>.<span title="=&gt; List[(Int, List[String])]">toList</span> <span title="(lt: ((Int, List[String]), (Int, List[String])) =&gt; Boolean)List[(Int, List[String])]">sortWith</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="(Int, List[String])" id="52868">kv1</a>, <a title="(Int, List[String])" id="52869">kv2</a><span class="delimiter">)</span> =&gt; <a href="#52868" title="(Int, List[String])">kv1</a>.<span title="=&gt; Int">_1</span> <span title="(x: Int)Boolean">&gt;</span> <a href="#52869" title="(Int, List[String])">kv2</a>.<span title="=&gt; Int">_1</span><span class="delimiter">)</span> <span title="(f: (Int, List[String]) =&gt; scala.collection.GenTraversableOnce[String])(implicit bf: scala.collection.generic.CanBuildFrom[List[(Int, List[String])],String,List[String]])List[String]">flatMap</span> <span class="delimiter">(</span><a href="#52901" title="(Int, List[String])">_</a>.<span title="=&gt; List[String]">_2</span>.<span title="=&gt; List[String]">reverse</span><span class="delimiter">)</span> <span title="=&gt; List[String]">toList</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(mimeTypes: String*)Option[String]" id="42431">formatForMimeTypes</a><span class="delimiter">(</span><a title="String*" id="53153">mimeTypes</a>: <span title="String*">String</span>*<span class="delimiter">)</span>: <span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="53155">defaultMimeType</a> = <a href="#42421" title="(key: String)String">formats</a><span class="delimiter">(</span><a href="#42425" title="=&gt; Symbol">defaultFormat</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span>
    <span class="keyword">def</span> <a title="(tm: String, f: String)Boolean" id="53156">matchMimeType</a><span class="delimiter">(</span><a title="String" id="53186">tm</a>: <span title="String">String</span>, <a title="String" id="53187">f</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
      <a href="#53186" title="String">tm</a>.<span title="(x$1: java.util.Locale)java.lang.String">toLowerCase</span><span class="delimiter">(</span><span title="java.util.Locale">ENGLISH</span><span class="delimiter">)</span>.<span title="(x$1: java.lang.String)Boolean">startsWith</span><span class="delimiter">(</span><a href="#53187" title="String">f</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#53155" title="String">defaultMimeType</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="#53187" title="String">f</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#53186" title="String">tm</a>.<span title="(x$1: java.lang.CharSequence)Boolean">contains</span><span class="delimiter">(</span><a href="#53155" title="String">defaultMimeType</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#53153" title="String*">mimeTypes</a> <span title="(p: String =&gt; Boolean)Option[String]">find</span> <span class="delimiter">{</span> <a title="String" id="53201">hdr</a> =&gt;
      <a href="#42421" title="=&gt; scala.collection.mutable.ConcurrentMap[String,String]">formats</a> <span title="(p: (String, String) =&gt; Boolean)Boolean">exists</span> <a href="#53207" title="Boolean" class="delimiter">{</a> <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span><a title="String" id="53210">k</a>, <a title="String" id="53211">v</a><span class="delimiter">)</span> =&gt; <a href="#53156" title="(tm: String, f: String)Boolean">matchMimeType</a><span class="delimiter">(</span><a href="#53201" title="String">hdr</a>, <a href="#53211" title="String">v</a><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span title="(f: String =&gt; Option[String])Option[String]">flatMap</span> <span class="delimiter">{</span> <a title="String" id="53216">hdr</a> =&gt;
      <a href="#42421" title="=&gt; scala.collection.mutable.ConcurrentMap[String,String]">formats</a> <span title="(p: (String, String) =&gt; Boolean)Option[(String, String)]">find</span> <a href="#53222" title="Boolean" class="delimiter">{</a> <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span><a title="String" id="53225">k</a>, <a title="String" id="53226">v</a><span class="delimiter">)</span> =&gt; <a href="#53156" title="(tm: String, f: String)Boolean">matchMimeType</a><span class="delimiter">(</span><a href="#53216" title="String">hdr</a>, <a href="#53226" title="String">v</a><span class="delimiter">)</span> <span class="delimiter">}</span> <span title="(f: (String, String) =&gt; String)Option[String]">map</span> <span class="delimiter">{</span> <a href="#53231" title="(String, String)">_</a>.<span title="=&gt; String">_1</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * A content type inferrer based on the `format` variable.  Looks up the media
   * type from the `formats` map.  If not found, returns
   * `application/octet-stream`.  This inferrer is prepended to the inherited
   * one.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; org.scalatra.package.ContentTypeInferrer" id="42432">inferFromFormats</a>: <span title="org.scalatra.package.ContentTypeInferrer">ContentTypeInferrer</span> = <a href="#53237" title="String" class="delimiter">{</a>
    <span class="keyword">case</span> <span title="String">_</span> <span class="keyword">if</span> <a href="util/RicherString.scala.html#24699" title="implicit org.scalatra.util.RicherString.stringToRicherString : (s: String)org.scalatra.util.RicherString">format</a>.<a href="util/RicherString.scala.html#25295" title="=&gt; Boolean">isNonBlank</a> =&gt; <a href="#42421" title="=&gt; scala.collection.mutable.ConcurrentMap[String,String]">formats</a>.<span title="(key: String)Option[String]">get</span><span class="delimiter">(</span><a href="#42437" title="=&gt; String">format</a><span class="delimiter">)</span> <span title="(default: =&gt; String)String">getOrElse</span> <span title="java.lang.String(&quot;application/octet-stream&quot;)" class="string">&quot;application/octet-stream&quot;</span>
  <span class="delimiter">}</span>

  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="keyword">def</span> <a title="=&gt; org.scalatra.package.ContentTypeInferrer" id="42433">contentTypeInferrer</a>: <span title="org.scalatra.package.ContentTypeInferrer">ContentTypeInferrer</span> = <a href="#42432" title="=&gt; org.scalatra.package.ContentTypeInferrer">inferFromFormats</a> <span title="(that: PartialFunction[Any,String])PartialFunction[Any,String]">orElse</span> <a href="#9650" title="org.scalatra.ApiFormats" class="keyword">super</a>.<a href="ScalatraKernel.scala.html#11886" title="=&gt; org.scalatra.package.ContentTypeInferrer">contentTypeInferrer</a>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(accepted: Symbol*)Boolean" id="42434">acceptedFormats</a><span class="delimiter">(</span><a title="Symbol*" id="53337">accepted</a>: <span title="Symbol*">Symbol</span>*<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="List[Symbol]" id="53340">conditions</a> = <span title="List[Symbol]" class="keyword">if</span> <span class="delimiter">(</span><a href="#53337" title="Symbol*">accepted</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#42426" title="=&gt; List[Symbol]">defaultAcceptedFormats</a> <span class="keyword">else</span> <a href="#53337" title="Symbol*">accepted</a>.<span title="=&gt; List[Symbol]">toList</span>
    <a href="#53340" title="List[Symbol]">conditions</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">||</span> <span class="delimiter">(</span><a href="#53340" title="List[Symbol]">conditions</a> <span title="(p: Symbol =&gt; Boolean)List[Symbol]">filter</span> <span class="delimiter">{</span> <a title="Symbol" id="53344">s</a> =&gt; <a href="#42421" title="=&gt; scala.collection.mutable.ConcurrentMap[String,String]">formats</a>.<span title="(key: String)Option[String]">get</span><span class="delimiter">(</span><a href="#53344" title="Symbol">s</a>.<span title="=&gt; String">name</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span> <span class="delimiter">}</span> <span title="(elem: Any)Boolean">contains</span> <a href="CoreDsl.scala.html#11933" title="=&gt; String">contentType</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; String" id="42435">getFormat</a> = <a href="#42428" title="=&gt; Option[String]">getFromParams</a> <span title="(alternative: =&gt; Option[String])Option[String]">orElse</span> <a href="#42429" title="=&gt; Option[String]">getFromAcceptHeader</a> <span title="(default: =&gt; String)String">getOrElse</span> <a href="#42425" title="=&gt; Symbol">defaultFormat</a>.<span title="=&gt; String">name</span>

  <span class="keyword">import</span> <a href="#9651" title="object org.scalatra.ApiFormats">ApiFormats</a>.FormatKey

  <span class="comment">/**
   * Returns the request-scoped format.  If not explicitly set, the format is:
   * $ - the `format` request parameter, if present in `formatParams`
   * $ - the first match from `Accept` header, looked up in `mimeTypes`
   * $ - the format from the `Content-Type` header, as looked up in `mimeTypes`
   * $ - the default format
   */</span>
  <span class="keyword">def</span> <a title="=&gt; String" id="42437">format</a> = <span class="delimiter">{</span>
    <a href="ServletApiImplicits.scala.html#11961" title="implicit org.scalatra.ServletApiImplicits.requestWrapper : (r: javax.servlet.http.HttpServletRequest)org.scalatra.RichRequest">request</a>.<a href="AttributesMap.scala.html#27562" title="(key: String)Option[AnyRef]">get</a><span class="delimiter">(</span><a href="#49517" title="=&gt; java.lang.String">FormatKey</a><span class="delimiter">)</span>.<span title="(f: AnyRef =&gt; String)Option[String]">map</span><span class="delimiter">(</span><a href="#53266" title="AnyRef">_</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="String" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span><span class="delimiter">)</span> <span title="(default: =&gt; String)String">getOrElse</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="String" id="53272">fmt</a> = <a href="#42435" title="=&gt; String">getFormat</a>
      <a href="ServletApiImplicits.scala.html#11961" title="(key: String, value: AnyRef)Unit">request</a><span class="delimiter">(</span><a href="#49517" title="=&gt; java.lang.String">FormatKey</a><span class="delimiter">)</span> = <a href="#53272" title="String">fmt</a>
      <a href="#53272" title="String">fmt</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Explicitly sets the request-scoped format.  This takes precedence over
   * whatever was inferred from the request.
   */</span>
  <span class="keyword">def</span> <a title="(formatValue: Symbol)Unit" id="42438">format_=</a><span class="delimiter">(</span><a title="Symbol" id="53347">formatValue</a>: <span title="Symbol">Symbol</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="ServletApiImplicits.scala.html#11961" title="(key: String, value: AnyRef)Unit">request</a><span class="delimiter">(</span><a href="#49517" title="=&gt; java.lang.String">FormatKey</a><span class="delimiter">)</span> = <a href="#53347" title="Symbol">formatValue</a>.<span title="=&gt; String">name</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Explicitly sets the request-scoped format.  This takes precedence over
   * whatever was inferred from the request.
   */</span>
  <span class="keyword">def</span> <a title="(formatValue: String)Unit" id="42439">format_=</a><span class="delimiter">(</span><a title="String" id="53386">formatValue</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="ServletApiImplicits.scala.html#11961" title="(key: String, value: AnyRef)Unit">request</a><span class="delimiter">(</span><a href="#49517" title="=&gt; java.lang.String">FormatKey</a><span class="delimiter">)</span> = <a href="#53386" title="String">formatValue</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>