<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>auth/org/scalatra/auth/Scentry.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> org.scalatra
<span class="keyword">package</span> auth

<span class="keyword">import</span> collection.mutable.<span class="delimiter">{</span> HashMap, Map =&gt; MMap <span class="delimiter">}</span>
<span class="keyword">import</span> scala.PartialFunction
<span class="keyword">import</span> <a href="ScentryAuthStore.scala.html#10529" title="object org.scalatra.auth.ScentryAuthStore">ScentryAuthStore</a>.<span class="delimiter">{</span>SessionAuthStore, ScentryAuthStore<span class="delimiter">}</span>
<span class="keyword">import</span> util.RicherString
<span class="keyword">import</span> collection.immutable.<span title="object List">List</span>._

<span class="keyword">object</span> <a title="object org.scalatra.auth.Scentry" id="10466">Scentry</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="keyword">type</span> <a title="[UserType &lt;: AnyRef]org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[UserType]" id="16667">StrategyFactory</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="16668">UserType</a> &lt;: AnyRef<span class="delimiter">]</span> = ScalatraKernel =&gt; ScentryStrategy<span class="delimiter">[</span>UserType<span class="delimiter">]</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]" id="16669">_globalStrategies</a> = <span title="()scala.collection.mutable.HashMap[Symbol,org.scalatra.auth.Scentry.StrategyFactory[_ &lt;: AnyRef]]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Symbol,org.scalatra.auth.Scentry.StrategyFactory[_ &lt;: AnyRef]]">HashMap</span><span class="delimiter">[</span>Symbol, StrategyFactory<span class="delimiter">[</span>_ &lt;: AnyRef<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="[UserType &lt;: AnyRef](name: Symbol, strategyFactory: org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[UserType])scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]" id="16671">registerStrategy</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="16673">UserType</a> &lt;: AnyRef<span class="delimiter">]</span><span class="delimiter">(</span><a title="Symbol" id="20034">name</a>: <span title="Symbol">Symbol</span>, <a title="org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[UserType]" id="20035">strategyFactory</a>: <span title="org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[UserType]">StrategyFactory</span><span class="delimiter">[</span>UserType<span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="#16669" title="=&gt; scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]">_globalStrategies</a> <span title="(kv: (Symbol, org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }))org.scalatra.auth.Scentry._globalStrategies.type">+=</span> <span class="delimiter">(</span><a href="#20034" title="(x: Symbol)ArrowAssoc[Symbol]">name</a> <span title="(y: org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[UserType])(Symbol, org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[UserType])">-&gt;</span> <a href="#20035" title="org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[UserType]">strategyFactory</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]" id="16674">globalStrategies</a> = <a href="#16669" title="=&gt; scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]">_globalStrategies</a>
  <span class="keyword">def</span> <a title="()Unit" id="16675">clearGlobalStrategies</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#16669" title="=&gt; scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]">_globalStrategies</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="java.lang.String" id="16676">scentryAuthKey</a> = <span title="java.lang.String(&quot;scentry.auth.default.user&quot;)" class="string">&quot;scentry.auth.default.user&quot;</span>.<span title="()java.lang.String">intern</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.lang.String" id="16678">ScentryRequestKey</a> = <span title="java.lang.String(&quot;org.scalatra.auth.Scentry&quot;)" class="string">&quot;org.scalatra.auth.Scentry&quot;</span>.<span title="()java.lang.String">intern</span>
<span class="delimiter">}</span>

<span class="keyword">class</span> <a title="class Scentry[UserType &lt;: AnyRef] extends java.lang.Object with ScalaObject" id="10465">Scentry</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: AnyRef" id="10589">UserType</a> &lt;: AnyRef<span class="delimiter">]</span><a href="#10465" title="ScalaObject" class="delimiter">(</a>
        <a title="org.scalatra.ScalatraKernel" id="16724">app</a>: <a href="../../../../scalatra/org/scalatra/ScalatraKernel.scala.html#10016" title="org.scalatra.ScalatraKernel">ScalatraKernel</a>,
        <a title="PartialFunction[UserType,String]" id="16725">serialize</a>: <span title="PartialFunction[UserType,String]">PartialFunction</span><span class="delimiter">[</span>UserType, String<span class="delimiter">]</span>,
        <a title="PartialFunction[String,UserType]" id="16726">deserialize</a>: <span title="PartialFunction[String,UserType]">PartialFunction</span><span class="delimiter">[</span>String, UserType<span class="delimiter">]</span> <span class="delimiter">)</span> <span class="delimiter">{</span>

  <span class="keyword">import</span> <a href="../../../../scalatra/org/scalatra/util/RicherString.scala.html#11062" title="object org.scalatra.util.RicherString">RicherString</a>._

  <span class="keyword">type</span> <a title="org.scalatra.auth.ScentryStrategy[UserType]" id="16688">StrategyType</a> = <a href="ScentryStrategy.scala.html#10489" title="org.scalatra.auth.ScentryStrategy[UserType]">ScentryStrategy</a><span class="delimiter">[</span>UserType<span class="delimiter">]</span>
  <span class="keyword">type</span> <a title="org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType" id="16689">StrategyFactory</a> = ScalatraKernel =&gt; StrategyType

  <span class="keyword">import</span> <a href="#10466" title="object org.scalatra.auth.Scentry">Scentry</a>._
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType]" id="16691">_strategies</a> = <span title="()scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType]">HashMap</span><span class="delimiter">[</span>Symbol, StrategyFactory<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="UserType" id="16694">_user</a>: <a href="#10589" title="UserType">UserType</a> = <span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="UserType" class="delimiter">[</span><a href="#10589" title="UserType">UserType</a><span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore" id="16697">_store</a>: <a href="ScentryAuthStore.scala.html#16658" title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">ScentryAuthStore</a> = <span title="org.scalatra.auth.ScentryAuthStore.SessionAuthStore" class="keyword">new</span> <a href="ScentryAuthStore.scala.html#16665" title="org.scalatra.auth.ScentryAuthStore.SessionAuthStore">SessionAuthStore</a><span class="delimiter">(</span><a href="#16724" title="org.scalatra.ScalatraKernel">app</a>.<a href="../../../../scalatra/org/scalatra/CoreDsl.scala.html#11937" title="=&gt; javax.servlet.http.HttpSession">session</a><span class="delimiter">)</span>

  @deprecated<span class="delimiter">(</span><span class="string">&quot;use store_= instead&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(newStore: org.scalatra.auth.ScentryAuthStore.ScentryAuthStore)Unit" id="16699">setStore</a><span class="delimiter">(</span><a title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore" id="24813">newStore</a>: <a href="ScentryAuthStore.scala.html#16658" title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">ScentryAuthStore</a><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#16701" title="(newStore: org.scalatra.auth.ScentryAuthStore.ScentryAuthStore)Unit">store</a> = <a href="#24813" title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">newStore</a> <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="=&gt; org.scalatra.auth.ScentryAuthStore.ScentryAuthStore" id="16700">store</a> = <a href="#16697" title="=&gt; org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">_store</a>
  <span class="keyword">def</span> <a title="(newStore: org.scalatra.auth.ScentryAuthStore.ScentryAuthStore)Unit" id="16701">store_=</a><span class="delimiter">(</span><a title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore" id="24818">newStore</a>: <a href="ScentryAuthStore.scala.html#16658" title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">ScentryAuthStore</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#16697" title="(x$1: org.scalatra.auth.ScentryAuthStore.ScentryAuthStore)Unit">_store</a> = <a href="#24818" title="org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">newStore</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Boolean" id="16702">isAuthenticated</a> = <span class="delimiter">{</span>
    <a href="#16708" title="=&gt; Option[UserType]">userOption</a>.<span title="=&gt; Boolean">isDefined</span>
  <span class="delimiter">}</span>
  @deprecated<span class="delimiter">(</span><span class="string">&quot;use isAuthenticated&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="=&gt; Boolean" id="16703">authenticated_?</a> = <a href="#16702" title="=&gt; Boolean">isAuthenticated</a>

  <span class="comment">//def session = app.session</span>
  <span class="keyword">def</span> <a title="=&gt; java.lang.Object with org.scalatra.util.MultiMapHeadView[String,String] with org.scalatra.util.MapWithIndifferentAccess[String]" id="16704">params</a> = <a href="#16724" title="org.scalatra.ScalatraKernel">app</a>.<a href="../../../../scalatra/org/scalatra/ScalatraKernel.scala.html#11892" title="=&gt; java.lang.Object with org.scalatra.util.MultiMapHeadView[String,String] with org.scalatra.util.MapWithIndifferentAccess[String]">params</a>
  <span class="keyword">def</span> <a title="(uri: String)Unit" id="16705">redirect</a><span class="delimiter">(</span><a title="String" id="25271">uri</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#16724" title="org.scalatra.ScalatraKernel">app</a>.<a href="../../../../scalatra/org/scalatra/CoreDsl.scala.html#11936" title="(uri: String)Unit">redirect</a><span class="delimiter">(</span><a href="#25271" title="String">uri</a><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(name: Symbol, strategyFactory: org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType)scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType]" id="16706">registerStrategy</a><span class="delimiter">(</span><a title="Symbol" id="25275">name</a>: <span title="Symbol">Symbol</span>, <a title="org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType" id="25276">strategyFactory</a>: <span title="org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType">StrategyFactory</span><span class="delimiter">)</span> =
    <a href="#16691" title="=&gt; scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType]">_strategies</a> <span title="(kv: (Symbol, org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType))Scentry.this._strategies.type">+=</span> <span class="delimiter">(</span><a href="#25275" title="(x: Symbol)ArrowAssoc[Symbol]">name</a> <span title="(y: org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType)(Symbol, org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType)">-&gt;</span> <a href="#25276" title="org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType">strategyFactory</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]" id="16707">strategies</a>: <span title="scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]">MMap</span><span class="delimiter">[</span>Symbol, ScentryStrategy<span class="delimiter">[</span>UserType<span class="delimiter">]</span><span class="delimiter">]</span> =
    <span class="delimiter">(</span><a href="#16674" title="=&gt; scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]">globalStrategies</a> <span title="(xs: scala.collection.GenTraversableOnce[(Symbol, org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef })])scala.collection.mutable.Map[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }]">++</span> <a href="#16691" title="=&gt; scala.collection.mutable.HashMap[Symbol,org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType]">_strategies</a><span class="delimiter">)</span> <span title="(f: (Symbol, org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }) =&gt; (Symbol, Scentry.this.StrategyType))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[Symbol,org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_$1] forSome { type _$1 &lt;: AnyRef }],(Symbol, Scentry.this.StrategyType),scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]])scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]">map</span> <a href="#25504" title="(Symbol, Scentry.this.StrategyType)" class="delimiter">{</a> <span class="keyword">case</span> <span title="(Symbol, Scentry.this.StrategyType)" class="delimiter">(</span><a title="Symbol" id="25507">nm</a>, <a title="org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_0] forSome { type _0 &lt;: AnyRef; type _$1 &lt;: java.lang.Object }" id="25508">fact</a><span class="delimiter">)</span> =&gt; <span class="delimiter">(</span><a href="#25507" title="(x: Symbol)ArrowAssoc[Symbol]">nm</a> <span title="(y: Scentry.this.StrategyType)(Symbol, Scentry.this.StrategyType)">-&gt;</span> <a href="#25508" title="org.scalatra.ScalatraKernel =&gt; org.scalatra.auth.ScentryStrategy[_0] forSome { type _0 &lt;: AnyRef; type _$1 &lt;: java.lang.Object }">fact</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="(v1: org.scalatra.ScalatraKernel)Scentry.this.StrategyType" class="delimiter">[</span><span title="org.scalatra.ScalatraKernel =&gt; Scentry.this.StrategyType">StrategyFactory</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#16724" title="org.scalatra.ScalatraKernel">app</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Option[UserType]" id="16708">userOption</a>: <span title="Option[UserType]">Option</span><span class="delimiter">[</span>UserType<span class="delimiter">]</span> = <span title="(x: UserType)Option[UserType]">Option</span><span class="delimiter">(</span><a href="#16709" title="=&gt; UserType">user</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; UserType" id="16709">user</a> : <a href="#10589" title="UserType">UserType</a> = <span title="UserType" class="keyword">if</span> <span class="delimiter">(</span><a href="#16694" title="=&gt; UserType">_user</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#16694" title="=&gt; UserType">_user</a> <span class="keyword">else</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="27792">key</a> = <a href="#16700" title="=&gt; org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">store</a>.<a href="ScentryAuthStore.scala.html#24702" title="=&gt; String">get</a>
    <span title="UserType" class="keyword">if</span> <span class="delimiter">(</span><a href="../../../../scalatra/org/scalatra/util/RicherString.scala.html#24699" title="implicit org.scalatra.util.RicherString.stringToRicherString : (s: String)org.scalatra.util.RicherString">key</a>.<a href="../../../../scalatra/org/scalatra/util/RicherString.scala.html#25295" title="=&gt; Boolean">isNonBlank</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28167" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20027" title="(userId: String)Unit">beforeFetch</a><span class="delimiter">(</span><a href="#27792" title="String">key</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="UserType" id="28159">res</a> = <a href="#16711" title="(v1: String)UserType">fromSession</a><span class="delimiter">(</span><a href="#27792" title="String">key</a><span class="delimiter">)</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#28159" title="UserType">res</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28192" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20030" title="(user: UserType)Unit">afterFetch</a><span class="delimiter">(</span><a href="#28159" title="UserType">res</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      <a href="#16694" title="(x$1: UserType)Unit">_user</a> = <a href="#28159" title="UserType">res</a>
      <a href="#28159" title="UserType">res</a>
    <span class="delimiter">}</span>
    <span class="keyword">else</span> <span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="UserType" class="delimiter">[</span><a href="#10589" title="UserType">UserType</a><span class="delimiter">]</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(v: UserType)java.lang.Object" id="16710">user_=</a><span class="delimiter">(</span><a title="UserType" id="28196">v</a>: <a href="#10589" title="UserType">UserType</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#16694" title="(x$1: UserType)Unit">_user</a> = <a href="#28196" title="UserType">v</a>
    <span title="java.lang.Object" class="keyword">if</span> <span class="delimiter">(</span><a href="#28196" title="UserType">v</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28205" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20025" title="(user: UserType)Unit">beforeSetUser</a><span class="delimiter">(</span><a href="#28196" title="UserType">v</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="String" id="28203">res</a> = <a href="#16712" title="(v1: UserType)String">toSession</a><span class="delimiter">(</span><a href="#28196" title="UserType">v</a><span class="delimiter">)</span>
      <a href="#16700" title="=&gt; org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">store</a>.<a href="ScentryAuthStore.scala.html#24703" title="(value: String)Unit">set</a><span class="delimiter">(</span><a href="#28203" title="String">res</a><span class="delimiter">)</span>
      <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28224" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20026" title="(user: UserType)Unit">afterSetUser</a><span class="delimiter">(</span><a href="#28196" title="UserType">v</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      <a href="#28203" title="String">res</a>
    <span class="delimiter">}</span> <span class="keyword">else</span> <a href="#28196" title="UserType">v</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; PartialFunction[String,UserType]" id="16711">fromSession</a> = <a href="#16726" title="PartialFunction[String,UserType]">deserialize</a> <span title="(that: PartialFunction[String,UserType])PartialFunction[String,UserType]">orElse</span> <a href="#16714" title="=&gt; PartialFunction[String,UserType]">missingDeserializer</a>

  <span class="keyword">def</span> <a title="=&gt; PartialFunction[UserType,String]" id="16712">toSession</a> = <a href="#16725" title="PartialFunction[UserType,String]">serialize</a> <span title="(that: PartialFunction[UserType,String])PartialFunction[UserType,String]">orElse</span> <a href="#16713" title="=&gt; PartialFunction[UserType,String]">missingSerializer</a>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; PartialFunction[UserType,String]" id="16713">missingSerializer</a>: <span title="PartialFunction[UserType,String]">PartialFunction</span><span class="delimiter">[</span>UserType, String<span class="delimiter">]</span> = <a href="#28241" title="String" class="delimiter">{</a>
    <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;You need to provide a session serializer for Scentry&quot;)" class="string">&quot;You need to provide a session serializer for Scentry&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; PartialFunction[String,UserType]" id="16714">missingDeserializer</a>: <span title="PartialFunction[String,UserType]">PartialFunction</span><span class="delimiter">[</span>String, UserType<span class="delimiter">]</span> = <a href="#28265" title="UserType" class="delimiter">{</a>
    <span class="keyword">case</span> <span title="Nothing">_</span> =&gt; <span title="Nothing" class="keyword">throw</span> <span title="(x$1: java.lang.String)java.lang.RuntimeException" class="keyword">new</span> <span title="java.lang.RuntimeException">RuntimeException</span><span class="delimiter">(</span><span title="java.lang.String(&quot;You need to provide a session deserializer for Scentry&quot;)" class="string">&quot;You need to provide a session deserializer for Scentry&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(names: Symbol*)Option[UserType]" id="16715">authenticate</a><span class="delimiter">(</span><a title="Symbol*" id="28270">names</a>: <span title="Symbol*">Symbol</span>*<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#16716" title="(names: Symbol*)Option[(Symbol, UserType)]">runAuthentication</a><span class="delimiter">(</span><a href="#28270" title="Symbol*">names</a>:_*<span class="delimiter">)</span> <span title="(f: (Symbol, UserType) =&gt; UserType)Option[UserType]">map</span> <a href="#28460" title="UserType" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="UserType" class="delimiter">(</span><a title="Symbol" id="28463">stratName</a>, <a title="UserType" id="28464">usr</a><span class="delimiter">)</span> =&gt;
        <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28466" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20024" title="(winningStrategy: Symbol, user: UserType)Unit">afterAuthenticate</a><span class="delimiter">(</span><a href="#28463" title="Symbol">stratName</a>, <a href="#28464" title="UserType">usr</a><span class="delimiter">)</span> <span class="delimiter">}</span>
        <a href="#16710" title="(v: UserType)java.lang.Object">user</a> = <a href="#28464" title="UserType">usr</a>
        <a href="#16709" title="=&gt; UserType">user</a>
    <span class="delimiter">}</span> <span title="(alternative: =&gt; Option[UserType])Option[UserType]">orElse</span> <span class="delimiter">{</span> <a href="#16717" title="=&gt; None.type">runUnauthenticated</a> <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(names: Symbol*)Option[(Symbol, UserType)]" id="16716">runAuthentication</a><span class="delimiter">(</span><a title="Symbol*" id="28273">names</a>: <span title="Symbol*">Symbol</span>*<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="delimiter">(</span>List<span class="delimiter">[</span><span class="delimiter">(</span>Symbol, UserType<span class="delimiter">)</span><span class="delimiter">]</span><span title="object Nil" class="delimiter">(</span><span class="delimiter">)</span> <a href="#28276" title="(z: List[(Symbol, UserType)])(op: (List[(Symbol, UserType)], (Symbol, org.scalatra.auth.ScentryStrategy[UserType])) =&gt; List[(Symbol, UserType)])List[(Symbol, UserType)]">/:</a> <a href="#16707" title="=&gt; scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]">strategies</a><span class="delimiter">)</span> <a href="#28339" title="List[(Symbol, UserType)]" class="delimiter">{</a> <span class="keyword">case</span> <span title="List[(Symbol, UserType)]" class="delimiter">(</span><a title="List[(Symbol, UserType)]" id="28349">acc</a>, <span class="delimiter">(</span><a title="Symbol" id="28352">nm</a>, <a title="org.scalatra.auth.ScentryStrategy[UserType]" id="28353">strat</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
      <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><a href="#28356" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20019" title="=&gt; Boolean">isValid</a><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28361" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20023" title="=&gt; Unit">beforeAuthenticate</a> <span class="delimiter">}</span>
      <span class="keyword">val</span> <a title="List[(Symbol, UserType)]" id="28354">r</a> = <span title="List[(Symbol, UserType)]" class="keyword">if</span><span class="delimiter">(</span><a href="#28349" title="List[(Symbol, UserType)]">acc</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#28353" title="org.scalatra.auth.ScentryStrategy[UserType]">strat</a>.<a href="ScentryStrategy.scala.html#20019" title="=&gt; Boolean">isValid</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#28273" title="Symbol*">names</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">||</span> <a href="#28273" title="Symbol*">names</a>.<span title="(elem: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#28352" title="Symbol">nm</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#28353" title="org.scalatra.auth.ScentryStrategy[UserType]">strat</a>.<a href="ScentryStrategy.scala.html#20021" title="()Option[UserType]">authenticate</a><span class="delimiter">(</span><span class="delimiter">)</span> <span title="List[(Symbol, UserType)]" class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> <span title="List[(Symbol, UserType)]">Some</span><span class="delimiter">(</span><a title="UserType" id="28416">usr</a><span class="delimiter">)</span>  =&gt; <span title="(_1: Symbol, _2: UserType)(Symbol, UserType)" class="delimiter">(</span><a href="#28352" title="Symbol">nm</a>, <a href="#28416" title="UserType">usr</a><span class="delimiter">)</span> <a href="#28417" title="(x: (Symbol, UserType))List[(Symbol, UserType)]">::</a> <span title="object Nil">Nil</span>
          <span class="keyword">case</span> <span title="List[(Symbol, UserType)]">_</span> =&gt; <span title="object List">List</span>.<span title="[A]=&gt; List[A]">empty</span><span title="List[(Symbol, UserType)]" class="delimiter">[</span><span title="(Symbol, UserType)" class="delimiter">(</span>Symbol, UserType<span class="delimiter">)</span><span class="delimiter">]</span>
        <span class="delimiter">}</span>
       <span class="delimiter">}</span> <span class="keyword">else</span> <span title="object List">List</span>.<span title="[A]=&gt; List[A]">empty</span><span title="List[(Symbol, UserType)]" class="delimiter">[</span><span title="(Symbol, UserType)" class="delimiter">(</span>Symbol, UserType<span class="delimiter">)</span><span class="delimiter">]</span>
      <a href="#28349" title="List[(Symbol, UserType)]">acc</a> <a href="#28443" title="(prefix: List[(Symbol, UserType)])List[(Symbol, UserType)]">:::</a> <a href="#28354" title="List[(Symbol, UserType)]">r</a>
    <span class="delimiter">}</span> <span title="=&gt; Option[(Symbol, UserType)]">headOption</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; None.type" id="16717">runUnauthenticated</a> = <span class="delimiter">{</span>
    <a href="#16707" title="=&gt; scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]">strategies</a> <span title="(p: (Symbol, org.scalatra.auth.ScentryStrategy[UserType]) =&gt; Boolean)scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]">filter</span> <a href="#28485" title="Boolean" class="delimiter">{</a> <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span>_, <a title="org.scalatra.auth.ScentryStrategy[UserType]" id="28488">strat</a><span class="delimiter">)</span> =&gt; <a href="#28488" title="org.scalatra.auth.ScentryStrategy[UserType]">strat</a>.<a href="ScentryStrategy.scala.html#20019" title="=&gt; Boolean">isValid</a> <span class="delimiter">}</span> <span title="(f: (Symbol, org.scalatra.auth.ScentryStrategy[UserType]) =&gt; org.scalatra.auth.ScentryStrategy[UserType])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]],org.scalatra.auth.ScentryStrategy[UserType],scala.collection.mutable.Iterable[org.scalatra.auth.ScentryStrategy[UserType]]])scala.collection.mutable.Iterable[org.scalatra.auth.ScentryStrategy[UserType]]">map</span> <a href="#28508" title="org.scalatra.auth.ScentryStrategy[UserType]" class="delimiter">{</a> <span class="keyword">case</span> <span title="org.scalatra.auth.ScentryStrategy[UserType]" class="delimiter">(</span>_, <a title="org.scalatra.auth.ScentryStrategy[UserType]" id="28511">s</a><span class="delimiter">)</span> =&gt; <a href="#28511" title="org.scalatra.auth.ScentryStrategy[UserType]">s</a> <span class="delimiter">}</span> <span title="=&gt; List[org.scalatra.auth.ScentryStrategy[UserType]]">toList</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="Unit">Nil</span> =&gt; <a href="#16719" title="=&gt; Option[() =&gt; Unit]">defaultUnauthenticated</a> <span title="(f: () =&gt; Unit =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a href="#28624" title="() =&gt; Unit">_</a>.<span title="()Unit">apply</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="keyword">case</span> <a title="Unit" id="28626">l</a> =&gt; <span class="delimiter">{</span>
        <a href="#28626" title="List[org.scalatra.auth.ScentryStrategy[UserType]]">l</a> <span title="(f: org.scalatra.auth.ScentryStrategy[UserType] =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="org.scalatra.auth.ScentryStrategy[UserType]" id="28646">s</a> =&gt; <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28648" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20033" title="()Unit">unauthenticated</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span> <span class="delimiter">}</span>
        <a href="#16719" title="=&gt; Option[() =&gt; Unit]">defaultUnauthenticated</a> <span title="(f: () =&gt; Unit =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a href="#28654" title="() =&gt; Unit">_</a>.<span title="()Unit">apply</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span title="object None">None</span>

  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[() =&gt; Unit]" id="16719">defaultUnauthenticated</a>: <span title="Option[() =&gt; Unit]">Option</span><span class="delimiter">[</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; Unit<span class="delimiter">]</span> = <span title="object None">None</span>

  <span class="keyword">def</span> <a title="(callback: =&gt; Unit)Unit" id="16721">unauthenticated</a><span class="delimiter">(</span><a title="=&gt; Unit" id="28657">callback</a>: =&gt; Unit<span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#16719" title="(x$1: Option[() =&gt; Unit])Unit">defaultUnauthenticated</a> = <span title="(x: () =&gt; Unit)Some[() =&gt; Unit]">Some</span><span class="delimiter">(</span><span class="delimiter">(</span><span class="delimiter">)</span> =&gt; <a href="#28657" title="=&gt; Unit">callback</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Unit" id="16722">logout</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="UserType" id="28664">usr</a> = <a href="#16709" title="=&gt; UserType">user</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="UserType" class="delimiter">[</span><a href="#10589" title="UserType">UserType</a><span class="delimiter">]</span>
    <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28666" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20031" title="(user: UserType)Unit">beforeLogout</a><span class="delimiter">(</span><a href="#28664" title="UserType">usr</a><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#16694" title="=&gt; UserType">_user</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <a href="#16694" title="(x$1: UserType)Unit">_user</a> = <span title="Null(null)" class="keyword">null</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="UserType" class="delimiter">[</span><a href="#10589" title="UserType">UserType</a><span class="delimiter">]</span>
    <a href="#16700" title="=&gt; org.scalatra.auth.ScentryAuthStore.ScentryAuthStore">store</a>.<a href="ScentryAuthStore.scala.html#24704" title="=&gt; Unit">invalidate</a>
    <a href="#16723" title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit">runCallbacks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#28676" title="Scentry.this.StrategyType">_</a>.<a href="ScentryStrategy.scala.html#20032" title="(user: UserType)Unit">afterLogout</a><span class="delimiter">(</span><a href="#28664" title="UserType">usr</a><span class="delimiter">)</span> <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(guard: Scentry.this.StrategyType =&gt; Boolean)(which: Scentry.this.StrategyType =&gt; Unit)Unit" id="16723">runCallbacks</a><span class="delimiter">(</span><a title="Scentry.this.StrategyType =&gt; Boolean" id="28163">guard</a>: StrategyType =&gt; Boolean = <a title="Scentry.this.StrategyType" id="28713">s</a> =&gt; <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="Scentry.this.StrategyType =&gt; Unit" id="28161">which</a>: StrategyType =&gt; Unit<span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#16707" title="=&gt; scala.collection.mutable.Map[Symbol,org.scalatra.auth.ScentryStrategy[UserType]]">strategies</a> <span title="(f: (Symbol, org.scalatra.auth.ScentryStrategy[UserType]) =&gt; Unit)Unit">foreach</span> <a href="#28705" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Unit" class="delimiter">(</span>_, <a title="org.scalatra.auth.ScentryStrategy[UserType]" id="28708">v</a><span class="delimiter">)</span> <span class="keyword">if</span> <a href="#28163" title="(v1: Scentry.this.StrategyType)Boolean">guard</a><span class="delimiter">(</span><a href="#28708" title="org.scalatra.auth.ScentryStrategy[UserType]">v</a><span class="delimiter">)</span> =&gt; <a href="#28161" title="(v1: Scentry.this.StrategyType)Unit">which</a><span class="delimiter">(</span><a href="#28708" title="org.scalatra.auth.ScentryStrategy[UserType]">v</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="Unit">_</span> =&gt; <span class="comment">// guard failed</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>