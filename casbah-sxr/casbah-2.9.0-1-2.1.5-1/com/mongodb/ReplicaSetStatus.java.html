<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>com/mongodb/ReplicaSetStatus.java</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">// ReplicaSetStatus.java</span>

<span class="keyword">package</span> com.mongodb;

<span class="keyword">import</span> java.net.UnknownHostException;
<span class="keyword">import</span> java.util.ArrayList;
<span class="keyword">import</span> java.util.Collections;
<span class="keyword">import</span> java.util.HashSet;
<span class="keyword">import</span> java.util.Iterator;
<span class="keyword">import</span> java.util.LinkedList;
<span class="keyword">import</span> java.util.List;
<span class="keyword">import</span> java.util.Random;
<span class="keyword">import</span> java.util.Set;
<span class="keyword">import</span> java.util.logging.Level;
<span class="keyword">import</span> java.util.logging.Logger;

<span class="comment">/**
 * keeps replica set status
 * has a background thread to ping so it stays current
 *
 * TODO
 *  pull config to get
 *      priority
 *      slave delay
 *      tags (when we do it)
 */</span>
public <span class="keyword">class</span> <a title="object com.mongodb.ReplicaSetStatus" id="7776">ReplicaSetStatus</a> <span class="delimiter">{</span>

    static <span class="keyword">final</span> Logger <a title="java.util.logging.Logger" id="145478">_rootLogger</a> = Logger.getLogger<span class="delimiter">(</span> <span class="string">&quot;com.mongodb.ReplicaSetStatus&quot;</span> <span class="delimiter">)</span>;
    static <span class="keyword">final</span> int <a title="Int" id="145479">UNAUTHENTICATED_ERROR_CODE</a> = <span class="int">10057</span>;

    ReplicaSetStatus<span class="delimiter">(</span> Mongo mongo, List&lt;ServerAddress&gt; initial <span class="delimiter">)</span><span class="delimiter">{</span>
        _mongo = mongo;
        _all = Collections.synchronizedList<span class="delimiter">(</span> <span class="keyword">new</span> ArrayList&lt;Node&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="keyword">for</span> <span class="delimiter">(</span> ServerAddress addr : initial <span class="delimiter">)</span><span class="delimiter">{</span>
            _all.add<span class="delimiter">(</span> <span class="keyword">new</span> Node<span class="delimiter">(</span> addr <span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        _nextResolveTime = System.currentTimeMillis<span class="delimiter">(</span><span class="delimiter">)</span> + inetAddrCacheMS;

        _updater = <span class="keyword">new</span> Updater<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    void start<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        _updater.start<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    
    boolean ready<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> _setName != <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    public String getName<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> _setName;
    <span class="delimiter">}</span>

    void _checkClosed<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span> _closed <span class="delimiter">)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException<span class="delimiter">(</span> <span class="string">&quot;ReplicaSetStatus closed&quot;</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * @return master or null if don't have one
     */</span>
    ServerAddress getMaster<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        Node n = getMasterNode<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span> n == <span class="keyword">null</span> <span class="delimiter">)</span>
            <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="keyword">return</span> n._addr;
    <span class="delimiter">}</span>

    Node getMasterNode<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        _checkClosed<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">for</span> <span class="delimiter">(</span> int i=<span class="int">0</span>; i&lt;_all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++ <span class="delimiter">)</span><span class="delimiter">{</span>
            Node n = _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> n.master<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>
                <span class="keyword">return</span> n;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * @return a good secondary or null if can't find one
     */</span>
    ServerAddress getASecondary<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        _checkClosed<span class="delimiter">(</span><span class="delimiter">)</span>;
        Node best = <span class="keyword">null</span>;
        double badBeforeBest = <span class="int">0</span>;

        int start = _random.nextInt<span class="delimiter">(</span> _all.size<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;

        double mybad = <span class="int">0</span>;

        <span class="keyword">for</span> <span class="delimiter">(</span> int i=<span class="int">0</span>; i&lt;_all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++ <span class="delimiter">)</span><span class="delimiter">{</span>
            Node n = _all.get<span class="delimiter">(</span> <span class="delimiter">(</span> start + i <span class="delimiter">)</span> % _all.size<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;

            <span class="keyword">if</span> <span class="delimiter">(</span> ! n.secondary<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                mybad++;
                continue;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span> best == <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                best = n;
                badBeforeBest = mybad;
                mybad = <span class="int">0</span>;
                continue;
            <span class="delimiter">}</span>

            long diff = best._pingTime - n._pingTime;
            <span class="keyword">if</span> <span class="delimiter">(</span> diff &gt; slaveAcceptableLatencyMS ||
                 <span class="comment">// this is a complex way to make sure we get a random distribution of slaves</span>
                 <span class="delimiter">(</span> <span class="delimiter">(</span> badBeforeBest - mybad <span class="delimiter">)</span> / <span class="delimiter">(</span> _all.size<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span> <span class="delimiter">)</span> <span class="delimiter">)</span> &gt; _random.nextDouble<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>
                <span class="delimiter">{</span>
                best = n;
                badBeforeBest = mybad;
                mybad = <span class="int">0</span>;
            <span class="delimiter">}</span>

        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> best == <span class="keyword">null</span> <span class="delimiter">)</span>
            <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="keyword">return</span> best._addr;
    <span class="delimiter">}</span>

    boolean hasServerUp<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">for</span> <span class="delimiter">(</span>int i = <span class="int">0</span>; i &lt; _all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++<span class="delimiter">)</span> <span class="delimiter">{</span>
            Node n = _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>n._ok<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="keyword">true</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">return</span> <span class="keyword">false</span>;
    <span class="delimiter">}</span>

    <span class="keyword">class</span> Node <span class="delimiter">{</span>

        Node<span class="delimiter">(</span> ServerAddress addr <span class="delimiter">)</span><span class="delimiter">{</span>
            _addr = addr;
            _port = <span class="keyword">new</span> DBPort<span class="delimiter">(</span> addr , <span class="keyword">null</span> , _mongoOptions <span class="delimiter">)</span>;
            _names.add<span class="delimiter">(</span> addr.toString<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">private</span> void updateAddr<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>_addr.updateInetAddr<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="comment">// address changed, need to use new ports</span>
                    _port = <span class="keyword">new</span> DBPort<span class="delimiter">(</span>_addr, <span class="keyword">null</span>, _mongoOptions<span class="delimiter">)</span>;
                    _mongo.getConnector<span class="delimiter">(</span><span class="delimiter">)</span>.updatePortPool<span class="delimiter">(</span>_addr<span class="delimiter">)</span>;
                    _logger.log<span class="delimiter">(</span>Level.INFO, <span class="string">&quot;Address of host &quot;</span> + _addr.toString<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="string">&quot; changed to &quot;</span> + _addr.getSocketAddress<span class="delimiter">(</span><span class="delimiter">)</span>.toString<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>UnknownHostException ex<span class="delimiter">)</span> <span class="delimiter">{</span>
                _logger.log<span class="delimiter">(</span>Level.WARNING, <span class="keyword">null</span>, ex<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        synchronized void update<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
            update<span class="delimiter">(</span><span class="keyword">null</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        synchronized void update<span class="delimiter">(</span>Set&lt;Node&gt; seenNodes<span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                long start = System.currentTimeMillis<span class="delimiter">(</span><span class="delimiter">)</span>;
                CommandResult res = _port.runCommand<span class="delimiter">(</span> _mongo.getDB<span class="delimiter">(</span><span class="string">&quot;admin&quot;</span><span class="delimiter">)</span> , _isMasterCmd <span class="delimiter">)</span>;
                _lastCheck = System.currentTimeMillis<span class="delimiter">(</span><span class="delimiter">)</span>;
                _pingTime = _lastCheck - start;

                <span class="keyword">if</span> <span class="delimiter">(</span> res == <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> MongoInternalException<span class="delimiter">(</span><span class="string">&quot;Invalid null value returned from isMaster&quot;</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>

                <span class="keyword">if</span> <span class="delimiter">(</span>!_ok<span class="delimiter">)</span> <span class="delimiter">{</span>
                    _logger.log<span class="delimiter">(</span> Level.WARNING , <span class="string">&quot;Server seen up: &quot;</span> + _addr <span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                _ok = <span class="keyword">true</span>;
                _isMaster = res.getBoolean<span class="delimiter">(</span> <span class="string">&quot;ismaster&quot;</span> , <span class="keyword">false</span> <span class="delimiter">)</span>;
                _isSecondary = res.getBoolean<span class="delimiter">(</span> <span class="string">&quot;secondary&quot;</span> , <span class="keyword">false</span> <span class="delimiter">)</span>;
                _lastPrimarySignal = res.getString<span class="delimiter">(</span> <span class="string">&quot;primary&quot;</span> <span class="delimiter">)</span>;

                <span class="keyword">if</span> <span class="delimiter">(</span> res.containsField<span class="delimiter">(</span> <span class="string">&quot;hosts&quot;</span> <span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                    <span class="keyword">for</span> <span class="delimiter">(</span> Object x : <span class="delimiter">(</span>List<span class="delimiter">)</span>res.get<span class="delimiter">(</span><span class="string">&quot;hosts&quot;</span><span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                        String host = x.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
                        Node node = _addIfNotHere<span class="delimiter">(</span>host<span class="delimiter">)</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>node != <span class="keyword">null</span> &amp;&amp; seenNodes != <span class="keyword">null</span><span class="delimiter">)</span>
                            seenNodes.add<span class="delimiter">(</span>node<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>

                <span class="keyword">if</span> <span class="delimiter">(</span> res.containsField<span class="delimiter">(</span> <span class="string">&quot;passives&quot;</span> <span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                    <span class="keyword">for</span> <span class="delimiter">(</span> Object x : <span class="delimiter">(</span>List<span class="delimiter">)</span>res.get<span class="delimiter">(</span><span class="string">&quot;passives&quot;</span><span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                        String host = x.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
                        Node node = _addIfNotHere<span class="delimiter">(</span>host<span class="delimiter">)</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>node != <span class="keyword">null</span> &amp;&amp; seenNodes != <span class="keyword">null</span><span class="delimiter">)</span>
                            seenNodes.add<span class="delimiter">(</span>node<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>

                <span class="keyword">if</span> <span class="delimiter">(</span>_isMaster <span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="comment">// max size was added in 1.8</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>res.containsField<span class="delimiter">(</span><span class="string">&quot;maxBsonObjectSize&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
                        maxBsonObjectSize = <span class="delimiter">(</span><span class="delimiter">(</span>Integer<span class="delimiter">)</span>res.get<span class="delimiter">(</span> <span class="string">&quot;maxBsonObjectSize&quot;</span> <span class="delimiter">)</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="keyword">else</span>
                        maxBsonObjectSize = Bytes.MAX_OBJECT_SIZE;
                <span class="delimiter">}</span>

                <span class="keyword">if</span> <span class="delimiter">(</span>res.containsField<span class="delimiter">(</span><span class="string">&quot;setName&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	                String setName = res.get<span class="delimiter">(</span> <span class="string">&quot;setName&quot;</span> <span class="delimiter">)</span>.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
	                <span class="keyword">if</span> <span class="delimiter">(</span> _setName == <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
	                    _setName = setName;
	                    _logger = Logger.getLogger<span class="delimiter">(</span> _rootLogger.getName<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="string">&quot;.&quot;</span> + setName <span class="delimiter">)</span>;
	                <span class="delimiter">}</span>
	                <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span> !_setName.equals<span class="delimiter">(</span> setName <span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
	                    _logger.log<span class="delimiter">(</span> Level.SEVERE , <span class="string">&quot;mis match set name old: &quot;</span> + _setName + <span class="string">&quot; new: &quot;</span> + setName <span class="delimiter">)</span>;
	                    <span class="keyword">return</span>;
	                <span class="delimiter">}</span>
                <span class="delimiter">}</span>

            <span class="delimiter">}</span>
            <span class="keyword">catch</span> <span class="delimiter">(</span> Exception e <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>_ok == <span class="keyword">true</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    _logger.log<span class="delimiter">(</span> Level.WARNING , <span class="string">&quot;Server seen down: &quot;</span> + _addr, e <span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>Math.random<span class="delimiter">(</span><span class="delimiter">)</span> &lt; <span class="double">0.1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    _logger.log<span class="delimiter">(</span> Level.WARNING , <span class="string">&quot;Server seen down: &quot;</span> + _addr <span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                _ok = <span class="keyword">false</span>;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span> ! _isMaster <span class="delimiter">)</span>
                <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        public boolean master<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">return</span> _ok &amp;&amp; _isMaster;
        <span class="delimiter">}</span>

        public boolean secondary<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">return</span> _ok &amp;&amp; _isSecondary;
        <span class="delimiter">}</span>

        public String toString<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
            StringBuilder buf = <span class="keyword">new</span> StringBuilder<span class="delimiter">(</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span> <span class="string">&quot;Replica Set Node: &quot;</span> <span class="delimiter">)</span>.append<span class="delimiter">(</span> _addr <span class="delimiter">)</span>.append<span class="delimiter">(</span> <span class="string">&quot;\n&quot;</span> <span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span> <span class="string">&quot;\t ok \t&quot;</span> <span class="delimiter">)</span>.append<span class="delimiter">(</span> _ok <span class="delimiter">)</span>.append<span class="delimiter">(</span> <span class="string">&quot;\n&quot;</span> <span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span> <span class="string">&quot;\t ping \t&quot;</span> <span class="delimiter">)</span>.append<span class="delimiter">(</span> _pingTime <span class="delimiter">)</span>.append<span class="delimiter">(</span> <span class="string">&quot;\n&quot;</span> <span class="delimiter">)</span>;

            buf.append<span class="delimiter">(</span> <span class="string">&quot;\t master \t&quot;</span> <span class="delimiter">)</span>.append<span class="delimiter">(</span> _isMaster <span class="delimiter">)</span>.append<span class="delimiter">(</span> <span class="string">&quot;\n&quot;</span> <span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span> <span class="string">&quot;\t secondary \t&quot;</span> <span class="delimiter">)</span>.append<span class="delimiter">(</span> _isSecondary <span class="delimiter">)</span>.append<span class="delimiter">(</span> <span class="string">&quot;\n&quot;</span> <span class="delimiter">)</span>;

            buf.append<span class="delimiter">(</span> <span class="string">&quot;\t priority \t&quot;</span> <span class="delimiter">)</span>.append<span class="delimiter">(</span> _priority <span class="delimiter">)</span>.append<span class="delimiter">(</span> <span class="string">&quot;\n&quot;</span> <span class="delimiter">)</span>;

            <span class="keyword">return</span> buf.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        public void close<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            _port.close<span class="delimiter">(</span><span class="delimiter">)</span>;
            _port = <span class="keyword">null</span>;
        <span class="delimiter">}</span>
        
        <span class="keyword">final</span> ServerAddress _addr;
        <span class="keyword">final</span> Set&lt;String&gt; _names = Collections.synchronizedSet<span class="delimiter">(</span> <span class="keyword">new</span> HashSet&lt;String&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        DBPort _port; <span class="comment">// we have our own port so we can set different socket options and don't have to owrry about the pool</span>

        boolean _ok = <span class="keyword">false</span>;
        long _lastCheck = <span class="int">0</span>;
        long _pingTime = <span class="int">0</span>;

        boolean _isMaster = <span class="keyword">false</span>;
        boolean _isSecondary = <span class="keyword">false</span>;

        double _priority = <span class="int">0</span>;
    <span class="delimiter">}</span>

    <span class="keyword">class</span> Updater <span class="keyword">extends</span> Thread <span class="delimiter">{</span>
        Updater<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">super</span><span class="delimiter">(</span> <span class="string">&quot;ReplicaSetStatus:Updater&quot;</span> <span class="delimiter">)</span>;
            setDaemon<span class="delimiter">(</span> <span class="keyword">true</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        public void run<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">while</span> <span class="delimiter">(</span> ! _closed <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    updateAll<span class="delimiter">(</span><span class="delimiter">)</span>;

                    long now = System.currentTimeMillis<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>inetAddrCacheMS &gt; <span class="int">0</span> &amp;&amp; _nextResolveTime &lt; now<span class="delimiter">)</span> <span class="delimiter">{</span>
                        _nextResolveTime = now + inetAddrCacheMS;
                        <span class="keyword">for</span> <span class="delimiter">(</span>Node node : _all<span class="delimiter">)</span> <span class="delimiter">{</span>
                            node.updateAddr<span class="delimiter">(</span><span class="delimiter">)</span>;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span>

                    <span class="comment">// force check on master</span>
                    <span class="comment">// otherwise master change may go unnoticed for a while if no write concern</span>
                    _mongo.getConnector<span class="delimiter">(</span><span class="delimiter">)</span>.checkMaster<span class="delimiter">(</span><span class="keyword">true</span>, <span class="keyword">false</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">catch</span> <span class="delimiter">(</span> Exception e <span class="delimiter">)</span><span class="delimiter">{</span>
                    _logger.log<span class="delimiter">(</span> Level.WARNING , <span class="string">&quot;couldn't do update pass&quot;</span> , e <span class="delimiter">)</span>;
                <span class="delimiter">}</span>

                <span class="keyword">try</span> <span class="delimiter">{</span>
                    Thread.sleep<span class="delimiter">(</span> updaterIntervalMS <span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">catch</span> <span class="delimiter">(</span> InterruptedException ie <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="delimiter">}</span>

            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    Node ensureMaster<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        Node n = getMasterNode<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span> n != <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
            n.update<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> n._isMaster <span class="delimiter">)</span>
                <span class="keyword">return</span> n;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> _lastPrimarySignal != <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
            n = findNode<span class="delimiter">(</span> _lastPrimarySignal <span class="delimiter">)</span>;
            n.update<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> n._isMaster <span class="delimiter">)</span>
                <span class="keyword">return</span> n;
        <span class="delimiter">}</span>

        updateAll<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> getMasterNode<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    synchronized void updateAll<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        HashSet&lt;Node&gt; seenNodes = <span class="keyword">new</span> HashSet&lt;Node&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">for</span> <span class="delimiter">(</span> int i=<span class="int">0</span>; i&lt;_all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++ <span class="delimiter">)</span><span class="delimiter">{</span>
            Node n = _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            n.update<span class="delimiter">(</span>seenNodes<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span>!seenNodes.isEmpty<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// not empty, means that at least 1 server gave node list</span>
            <span class="comment">// remove unused hosts</span>
            Iterator&lt;Node&gt; it = _all.iterator<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span>it.hasNext<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>!seenNodes.contains<span class="delimiter">(</span>it.next<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
                    it.remove<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    List&lt;ServerAddress&gt; getServerAddressList<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        List&lt;ServerAddress&gt; addrs = <span class="keyword">new</span> ArrayList&lt;ServerAddress&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">for</span> <span class="delimiter">(</span>Node node : _all<span class="delimiter">)</span>
            addrs.add<span class="delimiter">(</span>node._addr<span class="delimiter">)</span>;
        <span class="keyword">return</span> addrs;
    <span class="delimiter">}</span>

    Node _addIfNotHere<span class="delimiter">(</span> String host <span class="delimiter">)</span><span class="delimiter">{</span>
        Node n = findNode<span class="delimiter">(</span> host <span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span> n == <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">try</span> <span class="delimiter">{</span>
                n = <span class="keyword">new</span> Node<span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> host <span class="delimiter">)</span> <span class="delimiter">)</span>;
                _all.add<span class="delimiter">(</span> n <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">catch</span> <span class="delimiter">(</span> UnknownHostException un <span class="delimiter">)</span><span class="delimiter">{</span>
                _logger.log<span class="delimiter">(</span> Level.WARNING , <span class="string">&quot;couldn't resolve host [&quot;</span> + host + <span class="string">&quot;]&quot;</span> <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <span class="keyword">return</span> n;
    <span class="delimiter">}</span>

    Node findNode<span class="delimiter">(</span> String host <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">for</span> <span class="delimiter">(</span> int i=<span class="int">0</span>; i&lt;_all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++ <span class="delimiter">)</span>
            <span class="keyword">if</span> <span class="delimiter">(</span> _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>._names.contains<span class="delimiter">(</span> host <span class="delimiter">)</span> <span class="delimiter">)</span>
                <span class="keyword">return</span> _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>;

        ServerAddress addr = <span class="keyword">null</span>;
        <span class="keyword">try</span> <span class="delimiter">{</span>
            addr = <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> host <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">catch</span> <span class="delimiter">(</span> UnknownHostException un <span class="delimiter">)</span><span class="delimiter">{</span>
            _logger.log<span class="delimiter">(</span> Level.WARNING , <span class="string">&quot;couldn't resolve host [&quot;</span> + host + <span class="string">&quot;]&quot;</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span> <span class="keyword">null</span>;
        <span class="delimiter">}</span>

        <span class="keyword">for</span> <span class="delimiter">(</span> int i=<span class="int">0</span>; i&lt;_all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++ <span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span> _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>._addr.equals<span class="delimiter">(</span> addr <span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>._names.add<span class="delimiter">(</span> host <span class="delimiter">)</span>;
                <span class="keyword">return</span> _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">return</span> <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    void printStatus<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">for</span> <span class="delimiter">(</span> int i=<span class="int">0</span>; i&lt;_all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++ <span class="delimiter">)</span>
            System.out.println<span class="delimiter">(</span> _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    void close<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>!_closed<span class="delimiter">)</span> <span class="delimiter">{</span>
            _closed = <span class="keyword">true</span>;
            <span class="keyword">for</span> <span class="delimiter">(</span>int i = <span class="int">0</span>; i &lt; _all.size<span class="delimiter">(</span><span class="delimiter">)</span>; i++<span class="delimiter">)</span> <span class="delimiter">{</span>
                _all.get<span class="delimiter">(</span>i<span class="delimiter">)</span>.close<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the maximum size for a BSON object supported by the current master server.
     * Note that this value may change over time depending on which server is master.
     * @return the maximum size, or 0 if not obtained from servers yet.
     */</span>
    public int getMaxBsonObjectSize<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> maxBsonObjectSize;
    <span class="delimiter">}</span>

    <span class="keyword">final</span> List&lt;Node&gt; _all;
    Updater _updater;
    Mongo _mongo;
    String _setName = <span class="keyword">null</span>; <span class="comment">// null until init</span>
    int maxBsonObjectSize = <span class="int">0</span>;
    Logger _logger = _rootLogger; <span class="comment">// will get changed to use set name once its found</span>

    String _lastPrimarySignal;
    boolean _closed = <span class="keyword">false</span>;

    <span class="keyword">final</span> Random _random = <span class="keyword">new</span> Random<span class="delimiter">(</span><span class="delimiter">)</span>;
    long _nextResolveTime;

    static int <a title="Int" id="145480">updaterIntervalMS</a>;
    static int <a title="Int" id="145481">slaveAcceptableLatencyMS</a>;
    static int <a title="Int" id="145482">inetAddrCacheMS</a>;

    static <span class="keyword">final</span> <a href="MongoOptions.java.html#7785" title="com.mongodb.MongoOptions">MongoOptions</a> <a title="com.mongodb.MongoOptions" id="145483">_mongoOptions</a> = <span class="keyword">new</span> MongoOptions<span class="delimiter">(</span><span class="delimiter">)</span>;

    static <span class="delimiter">{</span>
        updaterIntervalMS = Integer.parseInt<span class="delimiter">(</span>System.getProperty<span class="delimiter">(</span><span class="string">&quot;com.mongodb.updaterIntervalMS&quot;</span>, <span class="string">&quot;5000&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        slaveAcceptableLatencyMS = Integer.parseInt<span class="delimiter">(</span>System.getProperty<span class="delimiter">(</span><span class="string">&quot;com.mongodb.slaveAcceptableLatencyMS&quot;</span>, <span class="string">&quot;15&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        inetAddrCacheMS = Integer.parseInt<span class="delimiter">(</span>System.getProperty<span class="delimiter">(</span><span class="string">&quot;com.mongodb.inetAddrCacheMS&quot;</span>, <span class="string">&quot;300000&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        _mongoOptions.connectTimeout = Integer.parseInt<span class="delimiter">(</span>System.getProperty<span class="delimiter">(</span><span class="string">&quot;com.mongodb.updaterConnectTimeoutMS&quot;</span>, <span class="string">&quot;20000&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        _mongoOptions.socketTimeout = Integer.parseInt<span class="delimiter">(</span>System.getProperty<span class="delimiter">(</span><span class="string">&quot;com.mongodb.updaterSocketTimeoutMS&quot;</span>, <span class="string">&quot;20000&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    static <span class="keyword">final</span> <a href="DBObject.java.html#7932" title="com.mongodb.DBObject">DBObject</a> <a title="com.mongodb.DBObject" id="145484">_isMasterCmd</a> = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span> <span class="string">&quot;ismaster&quot;</span> , <span class="int">1</span> <span class="delimiter">)</span>;

    public static void <a title="(args: Array[java.lang.String])Unit" id="145485">main</a><span class="delimiter">(</span> String <a title="Array[java.lang.String]" id="145486">args</a><span class="delimiter">[</span><span title="Array" class="delimiter">]</span> <span class="delimiter">)</span>
        throws Exception <span class="delimiter">{</span>
        List&lt;ServerAddress&gt; addrs = <span class="keyword">new</span> LinkedList&lt;ServerAddress&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
        addrs.add<span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> <span class="string">&quot;127.0.0.1&quot;</span> , <span class="int">27017</span> <span class="delimiter">)</span> <span class="delimiter">)</span>;
        addrs.add<span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> <span class="string">&quot;127.0.0.1&quot;</span> , <span class="int">27018</span> <span class="delimiter">)</span> <span class="delimiter">)</span>;

        Mongo m = <span class="keyword">new</span> Mongo<span class="delimiter">(</span> addrs <span class="delimiter">)</span>;

        ReplicaSetStatus status = <span class="keyword">new</span> ReplicaSetStatus<span class="delimiter">(</span> m, addrs <span class="delimiter">)</span>;
        status.start<span class="delimiter">(</span><span class="delimiter">)</span>;
        System.out.println<span class="delimiter">(</span> status.ensureMaster<span class="delimiter">(</span><span class="delimiter">)</span>._addr <span class="delimiter">)</span>;

        <span class="keyword">while</span> <span class="delimiter">(</span> <span class="keyword">true</span> <span class="delimiter">)</span><span class="delimiter">{</span>
            System.out.println<span class="delimiter">(</span> status.ready<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> status.ready<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                status.printStatus<span class="delimiter">(</span><span class="delimiter">)</span>;
                System.out.println<span class="delimiter">(</span> <span class="string">&quot;master: &quot;</span> + status.getMaster<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="string">&quot;\t secondary: &quot;</span> + status.getASecondary<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            System.out.println<span class="delimiter">(</span> <span class="string">&quot;-----------------------&quot;</span> <span class="delimiter">)</span>;
            Thread.sleep<span class="delimiter">(</span> <span class="int">5000</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

    <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>