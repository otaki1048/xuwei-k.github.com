<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>com/mongodb/util/JSON.java</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">// JSON.java</span>

<span class="keyword">package</span> com.mongodb.util;

<span class="keyword">import</span> java.lang.reflect.Array;
<span class="keyword">import</span> java.text.SimpleDateFormat;
<span class="keyword">import</span> java.util.*;
<span class="keyword">import</span> java.util.regex.Pattern;

<span class="keyword">import</span> org.bson.BSONCallback;
<span class="keyword">import</span> org.bson.types.*;

<span class="keyword">import</span> com.mongodb.*;

<span class="comment">/**
 *   Helper methods for JSON serialization and de-serialization
 */</span>
public <span class="keyword">class</span> <a title="object com.mongodb.util.JSON" id="8251">JSON</a> <span class="delimiter">{</span>

    <span class="comment">/**
     *  Serializes an object into it's JSON form
     *
     * @param o object to serialize
     * @return  String containing JSON form of the object
     */</span>
    public static String <a title="(o: Any)java.lang.String" id="146445">serialize</a><span class="delimiter">(</span> Object <a title="Any" id="146450">o</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        StringBuilder buf = <span class="keyword">new</span> StringBuilder<span class="delimiter">(</span><span class="delimiter">)</span>;
        serialize<span class="delimiter">(</span> o , buf <span class="delimiter">)</span>;
        <span class="keyword">return</span> buf.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    static void <a title="(a: java.lang.StringBuilder, s: java.lang.String)Unit" id="146446">string</a><span class="delimiter">(</span> StringBuilder <a title="java.lang.StringBuilder" id="146452">a</a> , String <a title="java.lang.String" id="146453">s</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        a.append<span class="delimiter">(</span><span class="string">&quot;\&quot;&quot;</span><span class="delimiter">)</span>;
        <span class="keyword">for</span><span class="delimiter">(</span>int i = <span class="int">0</span>; i &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span>; ++i<span class="delimiter">)</span><span class="delimiter">{</span>
            char c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'\\'</span><span class="delimiter">)</span>
                a.append<span class="delimiter">(</span><span class="string">&quot;\\\\&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">else</span> <span class="keyword">if</span><span class="delimiter">(</span>c == <span class="char">'&quot;'</span><span class="delimiter">)</span>
                a.append<span class="delimiter">(</span><span class="string">&quot;\\\&quot;&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">else</span> <span class="keyword">if</span><span class="delimiter">(</span>c == <span class="char">'\n'</span><span class="delimiter">)</span>
                a.append<span class="delimiter">(</span><span class="string">&quot;\\n&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">else</span> <span class="keyword">if</span><span class="delimiter">(</span>c == <span class="char">'\r'</span><span class="delimiter">)</span>
                a.append<span class="delimiter">(</span><span class="string">&quot;\\r&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">else</span> <span class="keyword">if</span><span class="delimiter">(</span>c == <span class="char">'\t'</span><span class="delimiter">)</span>
                a.append<span class="delimiter">(</span><span class="string">&quot;\\t&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">else</span> <span class="keyword">if</span><span class="delimiter">(</span>c == <span class="char">'\b'</span><span class="delimiter">)</span>
                a.append<span class="delimiter">(</span><span class="string">&quot;\\b&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span> c &lt; <span class="int">32</span> <span class="delimiter">)</span>
                continue;
            <span class="keyword">else</span>
                a.append<span class="delimiter">(</span>c<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        a.append<span class="delimiter">(</span><span class="string">&quot;\&quot;&quot;</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    @SuppressWarnings<span class="delimiter">(</span><span class="string">&quot;unchecked&quot;</span><span class="delimiter">)</span>
    public static void <a title="(o: Any, buf: java.lang.StringBuilder)Unit" id="146447">serialize</a><span class="delimiter">(</span> Object <a title="Any" id="146681">o</a> , StringBuilder <a title="java.lang.StringBuilder" id="146682">buf</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        
        o = Bytes.applyEncodingHooks<span class="delimiter">(</span> o <span class="delimiter">)</span>;

        <span class="keyword">if</span> <span class="delimiter">(</span> o == <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
            buf.append<span class="delimiter">(</span> <span class="string">&quot; null &quot;</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        
        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof Number <span class="delimiter">)</span><span class="delimiter">{</span>
            buf.append<span class="delimiter">(</span> o <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        
        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof String <span class="delimiter">)</span><span class="delimiter">{</span>
            string<span class="delimiter">(</span> buf , o.toString<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof Iterable<span class="delimiter">)</span><span class="delimiter">{</span>

            boolean first = <span class="keyword">true</span>;
            buf.append<span class="delimiter">(</span> <span class="string">&quot;[ &quot;</span> <span class="delimiter">)</span>;
            
            <span class="keyword">for</span> <span class="delimiter">(</span> Object n : <span class="delimiter">(</span>Iterable<span class="delimiter">)</span>o <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span> first <span class="delimiter">)</span> first = <span class="keyword">false</span>;
                <span class="keyword">else</span> buf.append<span class="delimiter">(</span> <span class="string">&quot; , &quot;</span> <span class="delimiter">)</span>;
                
                serialize<span class="delimiter">(</span> n , buf <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            
            buf.append<span class="delimiter">(</span> <span class="string">&quot;]&quot;</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>


        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof ObjectId<span class="delimiter">)</span> <span class="delimiter">{</span>
	    serialize<span class="delimiter">(</span><span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="string">&quot;$oid&quot;</span>, o.toString<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>, buf<span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        
        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof DBObject<span class="delimiter">)</span><span class="delimiter">{</span>
 
            boolean first = <span class="keyword">true</span>;
            buf.append<span class="delimiter">(</span> <span class="string">&quot;{ &quot;</span> <span class="delimiter">)</span>;
            
            DBObject dbo = <span class="delimiter">(</span>DBObject<span class="delimiter">)</span>o;
            
            <span class="keyword">for</span> <span class="delimiter">(</span> String name : dbo.keySet<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span> first <span class="delimiter">)</span> first = <span class="keyword">false</span>;
                <span class="keyword">else</span> buf.append<span class="delimiter">(</span> <span class="string">&quot; , &quot;</span> <span class="delimiter">)</span>;
                
                string<span class="delimiter">(</span> buf , name <span class="delimiter">)</span>;
                buf.append<span class="delimiter">(</span> <span class="string">&quot; : &quot;</span> <span class="delimiter">)</span>;
                serialize<span class="delimiter">(</span> dbo.get<span class="delimiter">(</span> name <span class="delimiter">)</span> , buf <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            
            buf.append<span class="delimiter">(</span> <span class="string">&quot;}&quot;</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof Map <span class="delimiter">)</span><span class="delimiter">{</span>
 
            boolean first = <span class="keyword">true</span>;
            buf.append<span class="delimiter">(</span> <span class="string">&quot;{ &quot;</span> <span class="delimiter">)</span>;
            
            Map m = <span class="delimiter">(</span>Map<span class="delimiter">)</span>o;

            <span class="keyword">for</span> <span class="delimiter">(</span> Map.Entry entry : <span class="delimiter">(</span>Set&lt;Map.Entry&gt;<span class="delimiter">)</span>m.entrySet<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span> first <span class="delimiter">)</span> first = <span class="keyword">false</span>;
                <span class="keyword">else</span> buf.append<span class="delimiter">(</span> <span class="string">&quot; , &quot;</span> <span class="delimiter">)</span>;
                
                string<span class="delimiter">(</span> buf , entry.getKey<span class="delimiter">(</span><span class="delimiter">)</span>.toString<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
                buf.append<span class="delimiter">(</span> <span class="string">&quot; : &quot;</span> <span class="delimiter">)</span>;
                serialize<span class="delimiter">(</span> entry.getValue<span class="delimiter">(</span><span class="delimiter">)</span> , buf <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            
            buf.append<span class="delimiter">(</span> <span class="string">&quot;}&quot;</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>


        <span class="keyword">if</span> <span class="delimiter">(</span>o instanceof Date<span class="delimiter">)</span> <span class="delimiter">{</span>
            Date d = <span class="delimiter">(</span>Date<span class="delimiter">)</span> o;
            SimpleDateFormat format = 
		<span class="keyword">new</span> SimpleDateFormat<span class="delimiter">(</span><span class="string">&quot;yyyy-MM-dd'T'HH:mm:ss'Z'&quot;</span><span class="delimiter">)</span>;
            format.setCalendar<span class="delimiter">(</span><span class="keyword">new</span> GregorianCalendar<span class="delimiter">(</span><span class="keyword">new</span> SimpleTimeZone<span class="delimiter">(</span><span class="int">0</span>, <span class="string">&quot;GMT&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>;
	    serialize<span class="delimiter">(</span><span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="string">&quot;$date&quot;</span>, format.format<span class="delimiter">(</span>d<span class="delimiter">)</span><span class="delimiter">)</span>, buf<span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span>o instanceof DBRefBase<span class="delimiter">)</span> <span class="delimiter">{</span>
            DBRefBase ref = <span class="delimiter">(</span>DBRefBase<span class="delimiter">)</span>o;
            BasicDBObject temp = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$ref&quot;</span> , ref.getRef<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$id&quot;</span> , ref.getId<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            serialize<span class="delimiter">(</span> temp, buf <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span>o instanceof Boolean<span class="delimiter">)</span> <span class="delimiter">{</span>
            buf.append<span class="delimiter">(</span>o<span class="delimiter">)</span>;
            <span class="keyword">return</span>;
	<span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span>o instanceof byte<span class="delimiter">[</span><span class="delimiter">]</span> || o instanceof Binary<span class="delimiter">)</span> <span class="delimiter">{</span>
            buf.append<span class="delimiter">(</span><span class="string">&quot;&lt;Binary Data&gt;&quot;</span><span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span>o instanceof Pattern<span class="delimiter">)</span> <span class="delimiter">{</span>
	    DBObject externalForm = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="delimiter">)</span>;
	    externalForm.put<span class="delimiter">(</span><span class="string">&quot;$regex&quot;</span>, o.toString<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
	    externalForm.put<span class="delimiter">(</span><span class="string">&quot;$options&quot;</span>, Bytes.regexFlags<span class="delimiter">(</span> <span class="delimiter">(</span><span class="delimiter">(</span>Pattern<span class="delimiter">)</span>o<span class="delimiter">)</span>.flags<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span> <span class="delimiter">)</span>;
	    serialize<span class="delimiter">(</span>externalForm, buf<span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> o.getClass<span class="delimiter">(</span><span class="delimiter">)</span>.isArray<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span><span class="delimiter">{</span>
            buf.append<span class="delimiter">(</span> <span class="string">&quot;[ &quot;</span> <span class="delimiter">)</span>;
            
            <span class="keyword">for</span> <span class="delimiter">(</span> int i=<span class="int">0</span>; i&lt;Array.getLength<span class="delimiter">(</span> o <span class="delimiter">)</span>; i++<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span> i &gt; <span class="int">0</span> <span class="delimiter">)</span> buf.append<span class="delimiter">(</span> <span class="string">&quot; , &quot;</span> <span class="delimiter">)</span>;
                serialize<span class="delimiter">(</span> Array.get<span class="delimiter">(</span> o , i <span class="delimiter">)</span> , buf <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            
            buf.append<span class="delimiter">(</span> <span class="string">&quot;]&quot;</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof BSONTimestamp <span class="delimiter">)</span><span class="delimiter">{</span>
            BSONTimestamp t = <span class="delimiter">(</span>BSONTimestamp<span class="delimiter">)</span>o;
            BasicDBObject temp = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$ts&quot;</span> , t.getTime<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$inc&quot;</span> , t.getInc<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            serialize<span class="delimiter">(</span> temp, buf <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        
        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof UUID <span class="delimiter">)</span><span class="delimiter">{</span>
            UUID uuid = <span class="delimiter">(</span>UUID<span class="delimiter">)</span>o;
            BasicDBObject temp = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$uuid&quot;</span> , uuid.toString<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            serialize<span class="delimiter">(</span> temp, buf <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof CodeWScope <span class="delimiter">)</span><span class="delimiter">{</span>
            CodeWScope c = <span class="delimiter">(</span>CodeWScope<span class="delimiter">)</span>o;
            
            BasicDBObject temp = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$code&quot;</span> , c.getCode<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$scope&quot;</span> , c.getScope<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            serialize<span class="delimiter">(</span> temp, buf <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> o instanceof Code <span class="delimiter">)</span><span class="delimiter">{</span>
            Code c = <span class="delimiter">(</span>Code<span class="delimiter">)</span>o;
            BasicDBObject temp = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="delimiter">)</span>;
            temp.put<span class="delimiter">(</span> <span class="string">&quot;$code&quot;</span> , c.getCode<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            serialize<span class="delimiter">(</span> temp, buf <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        
        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException<span class="delimiter">(</span> <span class="string">&quot;json can't serialize type : &quot;</span> + o.getClass<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>


    <span class="comment">/**
     *  Parses a JSON string representing a JSON value
     *
     * @param s the string to parse
     * @return the object
     */</span>
    public static Object <a title="(s: java.lang.String)java.lang.Object" id="146448">parse</a><span class="delimiter">(</span> String <a title="java.lang.String" id="146684">s</a> <span class="delimiter">)</span><span class="delimiter">{</span>
	<span class="keyword">return</span> parse<span class="delimiter">(</span> s, <span class="keyword">null</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses a JSON string representing a JSON value
     *
     * @param s the string to parse
     * @return the object
     */</span>
    public static Object <a title="(s: java.lang.String, c: org.bson.BSONCallback)java.lang.Object" id="146449">parse</a><span class="delimiter">(</span> String <a title="java.lang.String" id="146686">s</a>, BSONCallback <a title="org.bson.BSONCallback" id="146687">c</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>s == <span class="keyword">null</span> || <span class="delimiter">(</span>s=s.trim<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>.equals<span class="delimiter">(</span><span class="string">&quot;&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="delimiter">(</span>DBObject<span class="delimiter">)</span><span class="keyword">null</span>;
        <span class="delimiter">}</span>

        JSONParser p = <span class="keyword">new</span> JSONParser<span class="delimiter">(</span>s, c<span class="delimiter">)</span>;
        <span class="keyword">return</span> p.parse<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

<span class="delimiter">}</span>


<span class="comment">/**
 * Parser for JSON objects.
 *
 * Supports all types described at www.json.org, except for
 * numbers with &quot;e&quot; or &quot;E&quot; in them.
 */</span>
<span class="keyword">class</span> <a title="object com.mongodb.util.JSONParser" id="8317">JSONParser</a> <span class="delimiter">{</span>

    String s;
    int pos = <span class="int">0</span>;
    BSONCallback _callback;

    <span class="comment">/**
     * Create a new parser.
     */</span>
    public JSONParser<span class="delimiter">(</span>String s<span class="delimiter">)</span> <span class="delimiter">{</span>
	<span class="keyword">this</span><span class="delimiter">(</span>s, <span class="keyword">null</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Create a new parser.
     */</span>
    public JSONParser<span class="delimiter">(</span>String s, BSONCallback callback<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">this</span>.s = s;
	_callback = <span class="delimiter">(</span>callback == <span class="keyword">null</span><span class="delimiter">)</span> ? <span class="keyword">new</span> JSONCallback<span class="delimiter">(</span><span class="delimiter">)</span> : callback;
    <span class="delimiter">}</span>


    <span class="comment">/**
     * Parse an unknown type.
     *
     * @return Object the next item
     * @throws JSONParseException if invalid JSON is found
     */</span>
    public Object parse<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	<span class="keyword">return</span> parse<span class="delimiter">(</span><span class="keyword">null</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parse an unknown type.
     *
     * @return Object the next item
     * @throws JSONParseException if invalid JSON is found
     */</span>
    <span class="keyword">protected</span> Object parse<span class="delimiter">(</span>String name<span class="delimiter">)</span> <span class="delimiter">{</span>
        Object value = <span class="keyword">null</span>;
        char current = get<span class="delimiter">(</span><span class="delimiter">)</span>;

        switch<span class="delimiter">(</span>current<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// null</span>
        <span class="keyword">case</span> <span class="char">'n'</span>:
            read<span class="delimiter">(</span><span class="char">'n'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'u'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'l'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'l'</span><span class="delimiter">)</span>;
	    value = <span class="keyword">null</span>;
            break;
        <span class="comment">// NaN</span>
        <span class="keyword">case</span> <span class="char">'N'</span>:
            read<span class="delimiter">(</span><span class="char">'N'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'a'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'N'</span><span class="delimiter">)</span>;
	    value = Double.NaN;
            break;
        <span class="comment">// true</span>
        <span class="keyword">case</span> <span class="char">'t'</span>:
            read<span class="delimiter">(</span><span class="char">'t'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'r'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'u'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'e'</span><span class="delimiter">)</span>;
            value = <span class="keyword">true</span>;
            break;
        <span class="comment">// false</span>
        <span class="keyword">case</span> <span class="char">'f'</span>:
            read<span class="delimiter">(</span><span class="char">'f'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'a'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'l'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'s'</span><span class="delimiter">)</span>; read<span class="delimiter">(</span><span class="char">'e'</span><span class="delimiter">)</span>;
            value = <span class="keyword">false</span>;
            break;
        <span class="comment">// string</span>
        <span class="keyword">case</span> <span class="char">'\''</span>:
        <span class="keyword">case</span> <span class="char">'\&quot;'</span>:
            value = parseString<span class="delimiter">(</span><span class="delimiter">)</span>;
            break;
        <span class="comment">// number</span>
        <span class="keyword">case</span> <span class="char">'0'</span>: <span class="keyword">case</span> <span class="char">'1'</span>: <span class="keyword">case</span> <span class="char">'2'</span>: <span class="keyword">case</span> <span class="char">'3'</span>: <span class="keyword">case</span> <span class="char">'4'</span>: <span class="keyword">case</span> <span class="char">'5'</span>:
        <span class="keyword">case</span> <span class="char">'6'</span>: <span class="keyword">case</span> <span class="char">'7'</span>: <span class="keyword">case</span> <span class="char">'8'</span>: <span class="keyword">case</span> <span class="char">'9'</span>: <span class="keyword">case</span> <span class="char">'+'</span>: <span class="keyword">case</span> <span class="char">'-'</span>:
            value = parseNumber<span class="delimiter">(</span><span class="delimiter">)</span>;
            break;
        <span class="comment">// array</span>
        <span class="keyword">case</span> <span class="char">'['</span>:
            value = parseArray<span class="delimiter">(</span>name<span class="delimiter">)</span>;
            break;
        <span class="comment">// object</span>
        <span class="keyword">case</span> <span class="char">'{'</span>:
            value = parseObject<span class="delimiter">(</span>name<span class="delimiter">)</span>;
            break;
        default:
            <span class="keyword">throw</span> <span class="keyword">new</span> JSONParseException<span class="delimiter">(</span>s, pos<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> value;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses an object for the form &lt;i&gt;{}&lt;/i&gt; and &lt;i&gt;{ members }&lt;/i&gt;.
     *
     * @return DBObject the next object
     * @throws JSONParseException if invalid JSON is found
     */</span>
    public Object parseObject<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	<span class="keyword">return</span> parseObject<span class="delimiter">(</span><span class="keyword">null</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses an object for the form &lt;i&gt;{}&lt;/i&gt; and &lt;i&gt;{ members }&lt;/i&gt;.
     *
     * @return DBObject the next object
     * @throws JSONParseException if invalid JSON is found
     */</span>
    <span class="keyword">protected</span> Object parseObject<span class="delimiter">(</span>String name<span class="delimiter">)</span><span class="delimiter">{</span>
	<span class="keyword">if</span> <span class="delimiter">(</span>name != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.objectStart<span class="delimiter">(</span>name<span class="delimiter">)</span>;
	<span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
	    _callback.objectStart<span class="delimiter">(</span><span class="delimiter">)</span>;
	<span class="delimiter">}</span>

        read<span class="delimiter">(</span><span class="char">'{'</span><span class="delimiter">)</span>;
        char current = get<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">while</span><span class="delimiter">(</span>get<span class="delimiter">(</span><span class="delimiter">)</span> != <span class="char">'}'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            String key = parseString<span class="delimiter">(</span><span class="delimiter">)</span>;
            read<span class="delimiter">(</span><span class="char">':'</span><span class="delimiter">)</span>;
            Object value = parse<span class="delimiter">(</span>key<span class="delimiter">)</span>;
	    doCallback<span class="delimiter">(</span>key, value<span class="delimiter">)</span>;

            <span class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span>current = get<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> == <span class="char">','</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                read<span class="delimiter">(</span><span class="char">','</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
                break;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        read<span class="delimiter">(</span><span class="char">'}'</span><span class="delimiter">)</span>;

        <span class="keyword">return</span> _callback.objectDone<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    
    <span class="keyword">protected</span> void doCallback<span class="delimiter">(</span>String name, Object value<span class="delimiter">)</span> <span class="delimiter">{</span>
	<span class="keyword">if</span> <span class="delimiter">(</span>value == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.gotNull<span class="delimiter">(</span>name<span class="delimiter">)</span>;
	<span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>value instanceof String<span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.gotString<span class="delimiter">(</span>name, <span class="delimiter">(</span>String<span class="delimiter">)</span>value<span class="delimiter">)</span>;
	<span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>value instanceof Boolean<span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.gotBoolean<span class="delimiter">(</span>name, <span class="delimiter">(</span>Boolean<span class="delimiter">)</span>value<span class="delimiter">)</span>;
	<span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>value instanceof Integer<span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.gotInt<span class="delimiter">(</span>name, <span class="delimiter">(</span>Integer<span class="delimiter">)</span>value<span class="delimiter">)</span>;
	<span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>value instanceof Long<span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.gotLong<span class="delimiter">(</span>name, <span class="delimiter">(</span>Long<span class="delimiter">)</span>value<span class="delimiter">)</span>;
	<span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>value instanceof Double<span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.gotDouble<span class="delimiter">(</span>name, <span class="delimiter">(</span>Double<span class="delimiter">)</span>value<span class="delimiter">)</span>;
	<span class="delimiter">}</span> 
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Read the current character, making sure that it is the expected character.
     * Advances the pointer to the next character.
     *
     * @param ch the character expected
     *
     * @throws JSONParseException if the current character does not match the given character
     */</span>
    public void read<span class="delimiter">(</span>char ch<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">if</span><span class="delimiter">(</span>!check<span class="delimiter">(</span>ch<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> JSONParseException<span class="delimiter">(</span>s, pos<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        pos++;
    <span class="delimiter">}</span>

    public char read<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span> pos &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException<span class="delimiter">(</span> <span class="string">&quot;string done&quot;</span> <span class="delimiter">)</span>;
        <span class="keyword">return</span> s.charAt<span class="delimiter">(</span> pos++ <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/** 
     * Read the current character, making sure that it is a hexidecimal character.
     *
     * @throws JSONParseException if the current character is not a hexidecimal character
     */</span>
    public void readHex<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>pos &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; 
            <span class="delimiter">(</span><span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span> &gt;= <span class="char">'0'</span> &amp;&amp; s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span> &lt;= <span class="char">'9'</span><span class="delimiter">)</span> ||
             <span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span> &gt;= <span class="char">'A'</span> &amp;&amp; s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span> &lt;= <span class="char">'F'</span><span class="delimiter">)</span> ||
             <span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span> &gt;= <span class="char">'a'</span> &amp;&amp; s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span> &lt;= <span class="char">'f'</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            pos++;
        <span class="delimiter">}</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> JSONParseException<span class="delimiter">(</span>s, pos<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Checks the current character, making sure that it is the expected character.
     *
     * @param ch the character expected
     *
     * @throws JSONParseException if the current character does not match the given character
     */</span>
    public boolean check<span class="delimiter">(</span>char ch<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> get<span class="delimiter">(</span><span class="delimiter">)</span> == ch;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Advances the position in the string past any whitespace.
     */</span>
    public void skipWS<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">while</span><span class="delimiter">(</span>pos &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; Character.isWhitespace<span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            pos++;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Returns the current character.
     * Returns -1 if there are no more characters.
     *
     * @return the next character
     */</span>
    public char get<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        skipWS<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span><span class="delimiter">(</span>pos &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="keyword">return</span> s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span>;
        <span class="keyword">return</span> <span class="delimiter">(</span>char<span class="delimiter">)</span>-<span class="int">1</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses a string.
     *
     * @return the next string.
     * @throws JSONParseException if invalid JSON is found
     */</span>
    public String parseString<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        char quot;
        <span class="keyword">if</span><span class="delimiter">(</span>check<span class="delimiter">(</span><span class="char">'\''</span><span class="delimiter">)</span><span class="delimiter">)</span>
            quot = <span class="char">'\''</span>;
        <span class="keyword">else</span> <span class="keyword">if</span><span class="delimiter">(</span>check<span class="delimiter">(</span><span class="char">'\&quot;'</span><span class="delimiter">)</span><span class="delimiter">)</span>
            quot = <span class="char">'\&quot;'</span>;
        <span class="keyword">else</span> 
            <span class="keyword">throw</span> <span class="keyword">new</span> JSONParseException<span class="delimiter">(</span>s, pos<span class="delimiter">)</span>;

        char current;

        read<span class="delimiter">(</span>quot<span class="delimiter">)</span>;
        StringBuilder buf = <span class="keyword">new</span> StringBuilder<span class="delimiter">(</span><span class="delimiter">)</span>;
        int start = pos;
        <span class="keyword">while</span><span class="delimiter">(</span>pos &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; 
              <span class="delimiter">(</span>current = s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span><span class="delimiter">)</span> != quot<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">if</span><span class="delimiter">(</span>current == <span class="char">'\\'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                pos++;
                
                char x = get<span class="delimiter">(</span><span class="delimiter">)</span>;
                
                char special = <span class="int">0</span>;

                switch <span class="delimiter">(</span> x <span class="delimiter">)</span><span class="delimiter">{</span>

                <span class="keyword">case</span> <span class="char">'u'</span>:
                    <span class="delimiter">{</span> <span class="comment">// decode unicode</span>
                        buf.append<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>start, pos-<span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                        pos++;
                        int tempPos = pos;
                        
                        readHex<span class="delimiter">(</span><span class="delimiter">)</span>;
                        readHex<span class="delimiter">(</span><span class="delimiter">)</span>;
                        readHex<span class="delimiter">(</span><span class="delimiter">)</span>;
                        readHex<span class="delimiter">(</span><span class="delimiter">)</span>;
                        
                        int codePoint = Integer.parseInt<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>tempPos, tempPos+<span class="int">4</span><span class="delimiter">)</span>, <span class="int">16</span><span class="delimiter">)</span>;
                        buf.append<span class="delimiter">(</span><span class="delimiter">(</span>char<span class="delimiter">)</span>codePoint<span class="delimiter">)</span>;
                        
                        start = pos;
                        continue;
                    <span class="delimiter">}</span>
                <span class="keyword">case</span> <span class="char">'n'</span>: special = <span class="char">'\n'</span>; break;
                <span class="keyword">case</span> <span class="char">'r'</span>: special = <span class="char">'\r'</span>; break;
                <span class="keyword">case</span> <span class="char">'t'</span>: special = <span class="char">'\t'</span>; break;
                <span class="keyword">case</span> <span class="char">'b'</span>: special = <span class="char">'\b'</span>; break;
                <span class="keyword">case</span> <span class="char">'&quot;'</span>: special = <span class="char">'\&quot;'</span>; break;
                <span class="keyword">case</span> <span class="char">'\\'</span>: special = <span class="char">'\\'</span>; break;
                <span class="delimiter">}</span>

                buf.append<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>start, pos-<span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span> special != <span class="int">0</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                    pos++;
                    buf.append<span class="delimiter">(</span> special <span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                start = pos;
                continue;
            <span class="delimiter">}</span>
            pos++;
        <span class="delimiter">}</span>
        read<span class="delimiter">(</span>quot<span class="delimiter">)</span>;

        buf.append<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>start, pos-<span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> buf.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses a number.
     *
     * @return the next number (int or double).
     * @throws JSONParseException if invalid JSON is found
     */</span>
    public Number parseNumber<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>

        char current = get<span class="delimiter">(</span><span class="delimiter">)</span>;
        int start = <span class="keyword">this</span>.pos;
        boolean isDouble = <span class="keyword">false</span>;

        <span class="keyword">if</span><span class="delimiter">(</span>check<span class="delimiter">(</span><span class="char">'-'</span><span class="delimiter">)</span> || check<span class="delimiter">(</span><span class="char">'+'</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            pos++;
        <span class="delimiter">}</span>

        outer:
        <span class="keyword">while</span><span class="delimiter">(</span>pos &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            switch<span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span class="char">'0'</span>: <span class="keyword">case</span> <span class="char">'1'</span>: <span class="keyword">case</span> <span class="char">'2'</span>: <span class="keyword">case</span> <span class="char">'3'</span>: <span class="keyword">case</span> <span class="char">'4'</span>: 
            <span class="keyword">case</span> <span class="char">'5'</span>: <span class="keyword">case</span> <span class="char">'6'</span>: <span class="keyword">case</span> <span class="char">'7'</span>: <span class="keyword">case</span> <span class="char">'8'</span>: <span class="keyword">case</span> <span class="char">'9'</span>:
                pos++;
                break;
            <span class="keyword">case</span> <span class="char">'.'</span>:
                isDouble = <span class="keyword">true</span>;
                parseFraction<span class="delimiter">(</span><span class="delimiter">)</span>;
                break;
            <span class="keyword">case</span> <span class="char">'e'</span>: <span class="keyword">case</span> <span class="char">'E'</span>:
                isDouble = <span class="keyword">true</span>;
                parseExponent<span class="delimiter">(</span><span class="delimiter">)</span>;
                break;
            default:
                break outer;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">if</span> <span class="delimiter">(</span>isDouble<span class="delimiter">)</span>
          <span class="keyword">return</span> Double.valueOf<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>start, pos<span class="delimiter">)</span><span class="delimiter">)</span>;
        
        Long <span class="keyword">val</span> = Long.valueOf<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>start, pos<span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">val</span> &lt;= Integer.MAX_VALUE<span class="delimiter">)</span>
            <span class="keyword">return</span> <span class="keyword">val</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> <span class="keyword">val</span>;
    <span class="delimiter">}</span>

    <span class="comment">/** 
     * Advances the pointed through &lt;i&gt;.digits&lt;/i&gt;.
     */</span>
    public void parseFraction<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// get past .</span>
        pos++;

        outer:
        <span class="keyword">while</span><span class="delimiter">(</span>pos &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            switch<span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span class="char">'0'</span>: <span class="keyword">case</span> <span class="char">'1'</span>: <span class="keyword">case</span> <span class="char">'2'</span>: <span class="keyword">case</span> <span class="char">'3'</span>: <span class="keyword">case</span> <span class="char">'4'</span>: 
            <span class="keyword">case</span> <span class="char">'5'</span>: <span class="keyword">case</span> <span class="char">'6'</span>: <span class="keyword">case</span> <span class="char">'7'</span>: <span class="keyword">case</span> <span class="char">'8'</span>: <span class="keyword">case</span> <span class="char">'9'</span>:
                pos++;
                break;
            <span class="keyword">case</span> <span class="char">'e'</span>: <span class="keyword">case</span> <span class="char">'E'</span>:
                parseExponent<span class="delimiter">(</span><span class="delimiter">)</span>;
                break;
            default:
                break outer;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/** 
     * Advances the pointer through the exponent.
     */</span>
    public void parseExponent<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="comment">// get past E</span>
        pos++;

        <span class="keyword">if</span><span class="delimiter">(</span>check<span class="delimiter">(</span><span class="char">'-'</span><span class="delimiter">)</span> || check<span class="delimiter">(</span><span class="char">'+'</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            pos++;
        <span class="delimiter">}</span>

        outer:
        <span class="keyword">while</span><span class="delimiter">(</span>pos &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            switch<span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span class="char">'0'</span>: <span class="keyword">case</span> <span class="char">'1'</span>: <span class="keyword">case</span> <span class="char">'2'</span>: <span class="keyword">case</span> <span class="char">'3'</span>: <span class="keyword">case</span> <span class="char">'4'</span>: 
            <span class="keyword">case</span> <span class="char">'5'</span>: <span class="keyword">case</span> <span class="char">'6'</span>: <span class="keyword">case</span> <span class="char">'7'</span>: <span class="keyword">case</span> <span class="char">'8'</span>: <span class="keyword">case</span> <span class="char">'9'</span>:
                pos++;
                break;
            default:
                break outer;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses the next array.
     *
     * @return the array
     * @throws JSONParseException if invalid JSON is found
     */</span>
    public Object parseArray<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	<span class="keyword">return</span> parseArray<span class="delimiter">(</span><span class="keyword">null</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses the next array.
     *
     * @return the array
     * @throws JSONParseException if invalid JSON is found
     */</span>
    <span class="keyword">protected</span> Object parseArray<span class="delimiter">(</span>String name<span class="delimiter">)</span> <span class="delimiter">{</span>
	<span class="keyword">if</span> <span class="delimiter">(</span>name != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    _callback.arrayStart<span class="delimiter">(</span>name<span class="delimiter">)</span>;
	<span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
	    _callback.arrayStart<span class="delimiter">(</span><span class="delimiter">)</span>;
	<span class="delimiter">}</span>

        read<span class="delimiter">(</span><span class="char">'['</span><span class="delimiter">)</span>;

	int i = <span class="int">0</span>;
        char current = get<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">while</span><span class="delimiter">(</span> current != <span class="char">']'</span> <span class="delimiter">)</span> <span class="delimiter">{</span>
	    String elemName = String.valueOf<span class="delimiter">(</span>i++<span class="delimiter">)</span>;
            Object elem = parse<span class="delimiter">(</span>elemName<span class="delimiter">)</span>;
	    doCallback<span class="delimiter">(</span>elemName, elem<span class="delimiter">)</span>;

            <span class="keyword">if</span><span class="delimiter">(</span><span class="delimiter">(</span>current = get<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> == <span class="char">','</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                read<span class="delimiter">(</span><span class="char">','</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">else</span> <span class="keyword">if</span><span class="delimiter">(</span>current == <span class="char">']'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                break;
            <span class="delimiter">}</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> JSONParseException<span class="delimiter">(</span>s, pos<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        read<span class="delimiter">(</span><span class="char">']'</span><span class="delimiter">)</span>;

        <span class="keyword">return</span> _callback.arrayDone<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="comment">/**
 * Exception throw when invalid JSON is passed to JSONParser.
 * 
 * This exception creates a message that points to the first 
 * offending character in the JSON string:
 * &lt;pre&gt;
 * { &quot;x&quot; : 3, &quot;y&quot; : 4, some invalid json.... }
 *                     ^
 * &lt;/pre&gt;
 */</span>
<span class="keyword">class</span> <a title="object com.mongodb.util.JSONParseException" id="8284">JSONParseException</a> <span class="keyword">extends</span> RuntimeException <span class="delimiter">{</span> 

    <span class="keyword">private</span> static <span class="keyword">final</span> long <a title="Long" id="146691">serialVersionUID</a> = -<span class="long">4415279469780082174L</span>;

    String s;
    int pos;

    public String getMessage<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        StringBuilder sb = <span class="keyword">new</span> StringBuilder<span class="delimiter">(</span><span class="delimiter">)</span>;
        sb.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
        sb.append<span class="delimiter">(</span>s<span class="delimiter">)</span>;
        sb.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
        <span class="keyword">for</span><span class="delimiter">(</span>int i=<span class="int">0</span>;i&lt;pos;i++<span class="delimiter">)</span> <span class="delimiter">{</span>
            sb.append<span class="delimiter">(</span><span class="string">&quot; &quot;</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        sb.append<span class="delimiter">(</span><span class="string">&quot;^&quot;</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> sb.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public JSONParseException<span class="delimiter">(</span>String s, int pos<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">this</span>.s = s;
        <span class="keyword">this</span>.pos = pos;
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>