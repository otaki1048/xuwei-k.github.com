<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>com/mongodb/Mongo.java</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">// Mongo.java</span>

<span class="comment">/**
 *      Copyright (C) 2008 10gen Inc.
 *
 *   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 */</span>

<span class="keyword">package</span> com.mongodb;

<span class="keyword">import</span> java.net.UnknownHostException;
<span class="keyword">import</span> java.util.*;
<span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;
<span class="keyword">import</span> java.util.concurrent.ConcurrentMap;

<span class="keyword">import</span> org.bson.io.PoolOutputBuffer;

<span class="comment">/**
 * A database connection with internal pooling.
 * For most application, you should have 1 Mongo instance for the entire JVM.
 *
 * The following are equivalent, and all connect to the
 * local database running on the default port:
 *
 * &lt;blockquote&gt;&lt;pre&gt;
 * Mongo mongo1 = new Mongo( &quot;127.0.0.1&quot; );
 * Mongo mongo2 = new Mongo( &quot;127.0.0.1&quot;, 27017 );
 * Mongo mongo3 = new Mongo( new DBAddress( &quot;127.0.0.1&quot;, 27017, &quot;test&quot; ) );
 * Mongo mongo4 = new Mongo( new ServerAddress( &quot;127.0.0.1&quot;) );
 * &lt;/pre&gt;&lt;/blockquote&gt;
 *
 * Mongo instances have connection pooling built in - see the requestStart
 * and requestDone methods for more information.
 * http://www.mongodb.org/display/DOCS/Java+Driver+Concurrency
 *
 * &lt;h3&gt;Connecting to a Replica Pair&lt;/h3&gt;
 * &lt;p&gt;
 * You can connect to a
 * &lt;a href=&quot;http://www.mongodb.org/display/DOCS/Replica+Pairs&quot;&gt;replica pair&lt;/a&gt;
 * using the Java driver by passing two DBAddresses to the Mongo constructor.
 * For example:
 * &lt;/p&gt;
 * &lt;blockquote&gt;&lt;pre&gt;
 * DBAddress left = new DBAddress(&quot;127.0.0.1:27017/test&quot;);
 * DBAddress right = new DBAddress(&quot;127.0.0.1:27018/test&quot;);
 *
 * Mongo mongo = new Mongo(left, right);
 * &lt;/pre&gt;&lt;/blockquote&gt;
 *
 * &lt;p&gt;
 * If the master of a replica pair goes down, there will be a brief lag before
 * the slave becomes master.  Thus, your application should be prepared to catch
 * the exceptions that might be thrown in such a case: IllegalArgumentException,
 * MongoException, and MongoException.Network (depending on when the connection
 * drops).
 * &lt;/p&gt;
 * &lt;p&gt;
 * Once the slave becomes master, the driver will begin using that connection
 * as the master connection and the exceptions will stop being thrown.
 * &lt;/p&gt;
 *
 * &lt;h3&gt;Connecting to a Replica Set&lt;/h3&gt;
 * &lt;p&gt;
 * You can connect to a
 * &lt;a href=&quot;http://www.mongodb.org/display/DOCS/Replica+Sets&quot;&gt;replica set&lt;/a&gt;
 * using the Java driver by passing several a list if ServerAddress to the
 * Mongo constructor.
 * For example:
 * &lt;/p&gt;
 * &lt;blockquote&gt;&lt;pre&gt;
 * List&lt;ServerAddress&gt; addrs = new ArrayList&lt;ServerAddress&gt;();
 * addrs.add( new ServerAddress( &quot;127.0.0.1&quot; , 27017 ) );
 * addrs.add( new ServerAddress( &quot;127.0.0.1&quot; , 27018 ) );
 * addrs.add( new ServerAddress( &quot;127.0.0.1&quot; , 27019 ) );
 *
 * Mongo mongo = new Mongo( addrs );
 * &lt;/pre&gt;&lt;/blockquote&gt;
 *
 * &lt;p&gt;
 * By default, all read and write operations will be made on the master.
 * But it's possible to read from the slave(s) by using slaveOk:
 * &lt;/p&gt;
 * &lt;blockquote&gt;&lt;pre&gt;
 * mongo.slaveOk();
 * &lt;/pre&gt;&lt;/blockquote&gt;
 */</span>
public <span class="keyword">class</span> <a title="object com.mongodb.Mongo" id="7809">Mongo</a> <span class="delimiter">{</span>

    <span class="comment">/**
     *
     */</span>
    public static <span class="keyword">final</span> int <a title="Int" id="52351">MAJOR_VERSION</a> = <span class="int">2</span>;
    <span class="comment">/**
     *
     */</span>
    public static <span class="keyword">final</span> int <a title="Int" id="52352">MINOR_VERSION</a> = <span class="int">6</span>;

    static int <a title="Int" id="52353">cleanerIntervalMS</a>;
    static <span class="delimiter">{</span>
        cleanerIntervalMS = Integer.parseInt<span class="delimiter">(</span>System.getProperty<span class="delimiter">(</span><span class="string">&quot;com.mongodb.cleanerIntervalMS&quot;</span>, <span class="string">&quot;1000&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * returns a database object
     * @param addr the database address
     * @return
     */</span>
    public static <a href="DB.java.html#7845" title="com.mongodb.DB">DB</a> <a title="(addr: com.mongodb.DBAddress)com.mongodb.DB" id="52354">connect</a><span class="delimiter">(</span> <a href="DBAddress.java.html#7986" title="com.mongodb.DBAddress">DBAddress</a> <a title="com.mongodb.DBAddress" id="52892">addr</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> <span class="keyword">new</span> Mongo<span class="delimiter">(</span> addr <span class="delimiter">)</span>.getDB<span class="delimiter">(</span> addr.getDBName<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Creates a Mongo instance based on a (single) mongodb node (localhost, default port)
     * @throws UnknownHostException
     * @throws MongoException
     */</span>
    public Mongo<a href="#7809" title="com.mongodb.Mongo" class="delimiter">(</a><span class="delimiter">)</span>
        throws UnknownHostException , MongoException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Creates a Mongo instance based on a (single) mongodb node (default port)
     * @param host server to connect to
     * @throws UnknownHostException if the database host cannot be resolved
     * @throws MongoException
     */</span>
    public Mongo<a title="(host: java.lang.String)com.mongodb.Mongo" id="43535" class="delimiter">(</a> String <a title="java.lang.String" id="52373">host</a> <span class="delimiter">)</span>
        throws UnknownHostException , MongoException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> host <span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Creates a Mongo instance based on a (single) mongodb node (default port)
     * @param host server to connect to
     * @param options default query options
     * @throws UnknownHostException if the database host cannot be resolved
     * @throws MongoException
     */</span>
    public Mongo<a title="(host: java.lang.String, options: com.mongodb.MongoOptions)com.mongodb.Mongo" id="43536" class="delimiter">(</a> String <a title="java.lang.String" id="52371">host</a> , <a href="MongoOptions.java.html#7785" title="com.mongodb.MongoOptions">MongoOptions</a> <a title="com.mongodb.MongoOptions" id="52372">options</a> <span class="delimiter">)</span>
        throws UnknownHostException , MongoException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> host <span class="delimiter">)</span> , options <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Creates a Mongo instance based on a (single) mongodb node
     * @param host the database's host address
     * @param port the port on which the database is running
     * @throws UnknownHostException if the database host cannot be resolved
     * @throws MongoException
     */</span>
    public Mongo<a title="(host: java.lang.String, port: Int)com.mongodb.Mongo" id="43537" class="delimiter">(</a> String <a title="java.lang.String" id="52369">host</a> , int <a title="Int" id="52370">port</a> <span class="delimiter">)</span>
        throws UnknownHostException , MongoException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> host , port <span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Creates a Mongo instance based on a (single) mongodb node
     * @see com.mongodb.ServerAddress
     * @param addr the database address
     * @throws MongoException
     */</span>
    public Mongo<a title="(addr: com.mongodb.ServerAddress)com.mongodb.Mongo" id="43538" class="delimiter">(</a> <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="com.mongodb.ServerAddress" id="52368">addr</a> <span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span> addr , <span class="keyword">new</span> MongoOptions<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>


    <span class="comment">/**
     * Creates a Mongo instance based on a (single) mongo node using a given ServerAddress
     * @see com.mongodb.ServerAddress
     * @param addr the database address
     * @param options default query options
     * @throws MongoException
     */</span>
    public Mongo<a title="(addr: com.mongodb.ServerAddress, options: com.mongodb.MongoOptions)com.mongodb.Mongo" id="43539" class="delimiter">(</a> <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="com.mongodb.ServerAddress" id="52366">addr</a> , <a href="MongoOptions.java.html#7785" title="com.mongodb.MongoOptions">MongoOptions</a> <a title="com.mongodb.MongoOptions" id="52367">options</a> <span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>
        _addr = addr;
        _addrs = <span class="keyword">null</span>;
        _options = options;
        _applyMongoOptions<span class="delimiter">(</span><span class="delimiter">)</span>;
        _connector = <span class="keyword">new</span> DBTCPConnector<span class="delimiter">(</span> <span class="keyword">this</span> , _addr <span class="delimiter">)</span>;
        _connector.start<span class="delimiter">(</span><span class="delimiter">)</span>;
        _cleaner = <span class="keyword">new</span> DBCleanerThread<span class="delimiter">(</span><span class="delimiter">)</span>;
        _cleaner.start<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * &lt;p&gt;Creates a Mongo in paired mode. &lt;br/&gt; This will also work for
     * a replica set and will find all members (the master will be used by
     * default).&lt;/p&gt;
     *
     * @see com.mongodb.ServerAddress
     * @param left left side of the pair
     * @param right right side of the pair
     * @throws MongoException
     */</span>
    public Mongo<a title="(left: com.mongodb.ServerAddress, right: com.mongodb.ServerAddress)com.mongodb.Mongo" id="43540" class="delimiter">(</a> <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="com.mongodb.ServerAddress" id="52364">left</a> , <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="com.mongodb.ServerAddress" id="52365">right</a> <span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span> left , right , <span class="keyword">new</span> MongoOptions<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * &lt;p&gt;Creates a Mongo connection in paired mode. &lt;br/&gt; This will also work for
     * a replica set and will find all members (the master will be used by
     * default).&lt;/p&gt;
     *
     * @see com.mongodb.ServerAddress
     * @param left left side of the pair
     * @param right right side of the pair
     * @param options
     * @throws MongoException
     */</span>
    public Mongo<a title="(left: com.mongodb.ServerAddress, right: com.mongodb.ServerAddress, options: com.mongodb.MongoOptions)com.mongodb.Mongo" id="43541" class="delimiter">(</a> <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="com.mongodb.ServerAddress" id="52361">left</a> , <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="com.mongodb.ServerAddress" id="52362">right</a> , <a href="MongoOptions.java.html#7785" title="com.mongodb.MongoOptions">MongoOptions</a> <a title="com.mongodb.MongoOptions" id="52363">options</a> <span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>
        _addr = <span class="keyword">null</span>;
        _addrs = Arrays.asList<span class="delimiter">(</span> left , right <span class="delimiter">)</span>;
        _options = options;
        _applyMongoOptions<span class="delimiter">(</span><span class="delimiter">)</span>;
        _connector = <span class="keyword">new</span> DBTCPConnector<span class="delimiter">(</span> <span class="keyword">this</span> , _addrs <span class="delimiter">)</span>;
        _connector.start<span class="delimiter">(</span><span class="delimiter">)</span>;

        _cleaner = <span class="keyword">new</span> DBCleanerThread<span class="delimiter">(</span><span class="delimiter">)</span>;
        _cleaner.start<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * &lt;p&gt;Creates a Mongo based on a replica set, or pair.
     * It will find all members (the master will be used by default).&lt;/p&gt;
     * @see com.mongodb.ServerAddress
     * @param replicaSetSeeds Put as many servers as you can in the list and
     * the system will figure out the rest.
     * @throws MongoException
     */</span>
    public Mongo<a title="(replicaSetSeeds: java.util.List[com.mongodb.ServerAddress])com.mongodb.Mongo" id="43542" class="delimiter">(</a> List&lt;<a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a>&gt; <a title="java.util.List[com.mongodb.ServerAddress]" id="52360">replicaSetSeeds</a> <span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>
        <span class="keyword">this</span><span class="delimiter">(</span> replicaSetSeeds , <span class="keyword">new</span> MongoOptions<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * &lt;p&gt;Creates a Mongo based on a replica set, or pair.
     * It will find all members (the master will be used by default).&lt;/p&gt;
     * @see com.mongodb.ServerAddress
     * @param replicaSetSeeds put as many servers as you can in the list.
     *                       the system will figure the rest out
     * @param options default query options
     * @throws MongoException
     */</span>
    public Mongo<a title="(replicaSetSeeds: java.util.List[com.mongodb.ServerAddress], options: com.mongodb.MongoOptions)com.mongodb.Mongo" id="43543" class="delimiter">(</a> List&lt;<a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a>&gt; <a title="java.util.List[com.mongodb.ServerAddress]" id="52358">replicaSetSeeds</a> , <a href="MongoOptions.java.html#7785" title="com.mongodb.MongoOptions">MongoOptions</a> <a title="com.mongodb.MongoOptions" id="52359">options</a> <span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>

        _addr = <span class="keyword">null</span>;
        _addrs = replicaSetSeeds;
        _options = options;
        _applyMongoOptions<span class="delimiter">(</span><span class="delimiter">)</span>;
        _connector = <span class="keyword">new</span> DBTCPConnector<span class="delimiter">(</span> <span class="keyword">this</span> , _addrs <span class="delimiter">)</span>;
        _connector.start<span class="delimiter">(</span><span class="delimiter">)</span>;

        _cleaner = <span class="keyword">new</span> DBCleanerThread<span class="delimiter">(</span><span class="delimiter">)</span>;
        _cleaner.start<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Creates a Mongo described by a URI.
     * If only one address is used it will only connect to that node, otherwise it will discover all nodes.
     * @param uri
     * @see MongoURI
     * &lt;p&gt;examples:
     *   &lt;li&gt;mongodb://127.0.0.1&lt;/li&gt;
     *   &lt;li&gt;mongodb://fred:foobar@127.0.0.1/&lt;/li&gt;
     *  &lt;/p&gt;
     *  @throws MongoException
     * @throws UnknownHostException
     * @dochub connections
     */</span>

    public Mongo<a title="(uri: com.mongodb.MongoURI)com.mongodb.Mongo" id="43544" class="delimiter">(</a> <a href="MongoURI.java.html#7944" title="com.mongodb.MongoURI">MongoURI</a> <a title="com.mongodb.MongoURI" id="52349">uri</a> <span class="delimiter">)</span>
        throws MongoException , UnknownHostException <span class="delimiter">{</span>

        _options = uri.getOptions<span class="delimiter">(</span><span class="delimiter">)</span>;
        _applyMongoOptions<span class="delimiter">(</span><span class="delimiter">)</span>;

        <span class="keyword">if</span> <span class="delimiter">(</span> uri.getHosts<span class="delimiter">(</span><span class="delimiter">)</span>.size<span class="delimiter">(</span><span class="delimiter">)</span> == <span class="int">1</span> <span class="delimiter">)</span><span class="delimiter">{</span>
            _addr = <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> uri.getHosts<span class="delimiter">(</span><span class="delimiter">)</span>.get<span class="delimiter">(</span><span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            _addrs = <span class="keyword">null</span>;
            _connector = <span class="keyword">new</span> DBTCPConnector<span class="delimiter">(</span> <span class="keyword">this</span> , _addr <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
            List&lt;ServerAddress&gt; replicaSetSeeds = <span class="keyword">new</span> ArrayList&lt;ServerAddress&gt;<span class="delimiter">(</span> uri.getHosts<span class="delimiter">(</span><span class="delimiter">)</span>.size<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            <span class="keyword">for</span> <span class="delimiter">(</span> String host : uri.getHosts<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>
                replicaSetSeeds.add<span class="delimiter">(</span> <span class="keyword">new</span> ServerAddress<span class="delimiter">(</span> host <span class="delimiter">)</span> <span class="delimiter">)</span>;
            _addr = <span class="keyword">null</span>;
            _addrs = replicaSetSeeds;
            _connector = <span class="keyword">new</span> DBTCPConnector<span class="delimiter">(</span> <span class="keyword">this</span> , replicaSetSeeds <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        _connector.start<span class="delimiter">(</span><span class="delimiter">)</span>;
        _cleaner = <span class="keyword">new</span> DBCleanerThread<span class="delimiter">(</span><span class="delimiter">)</span>;
        _cleaner.start<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * gets a database object
     * @param dbname the database name
     * @return
     */</span>
    public <a href="DB.java.html#7845" title="com.mongodb.DB">DB</a> <a title="(dbname: java.lang.String)com.mongodb.DB" id="43545">getDB</a><span class="delimiter">(</span> String <a title="java.lang.String" id="52902">dbname</a> <span class="delimiter">)</span><span class="delimiter">{</span>

        DB db = _dbs.get<span class="delimiter">(</span> dbname <span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span> db != <span class="keyword">null</span> <span class="delimiter">)</span>
            <span class="keyword">return</span> db;

        db = <span class="keyword">new</span> DBApiLayer<span class="delimiter">(</span> <span class="keyword">this</span> , dbname , _connector <span class="delimiter">)</span>;
        DB temp = _dbs.putIfAbsent<span class="delimiter">(</span> dbname , db <span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span> temp != <span class="keyword">null</span> <span class="delimiter">)</span>
            <span class="keyword">return</span> temp;
        <span class="keyword">return</span> db;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * gets a collection of DBs used by the driver since this Mongo instance was created.
     * This may include DBs that exist in the client but not yet on the server.
     * @return
     */</span>
    public Collection&lt;<a href="DB.java.html#7845" title="com.mongodb.DB">DB</a>&gt; <a title="()java.util.Collection[com.mongodb.DB]" id="43546">getUsedDatabases</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> _dbs.values<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * gets a list of all database names present on the server
     * @return
     * @throws MongoException
     */</span>
    public List&lt;String&gt; <a title="()java.util.List[java.lang.String]" id="43547">getDatabaseNames</a><span class="delimiter">(</span><span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>

        BasicDBObject cmd = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="delimiter">)</span>;
        cmd.put<span class="delimiter">(</span><span class="string">&quot;listDatabases&quot;</span>, <span class="int">1</span><span class="delimiter">)</span>;


        CommandResult res = getDB<span class="delimiter">(</span> <span class="string">&quot;admin&quot;</span> <span class="delimiter">)</span>.command<span class="delimiter">(</span>cmd, getOptions<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        res.throwOnError<span class="delimiter">(</span><span class="delimiter">)</span>;

        List l = <span class="delimiter">(</span>List<span class="delimiter">)</span>res.get<span class="delimiter">(</span><span class="string">&quot;databases&quot;</span><span class="delimiter">)</span>;

        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;

        <span class="keyword">for</span> <span class="delimiter">(</span>Object o : l<span class="delimiter">)</span> <span class="delimiter">{</span>
            list.add<span class="delimiter">(</span><span class="delimiter">(</span><span class="delimiter">(</span>BasicDBObject<span class="delimiter">)</span>o<span class="delimiter">)</span>.getString<span class="delimiter">(</span><span class="string">&quot;name&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> list;
    <span class="delimiter">}</span>


    <span class="comment">/**
     * Drops the database if it exists.
     * @param dbName name of database to drop
     * @throws MongoException
     */</span>
    public void <a title="(dbName: java.lang.String)Unit" id="43548">dropDatabase</a><span class="delimiter">(</span>String <a title="java.lang.String" id="53025">dbName</a><span class="delimiter">)</span>
        throws MongoException <span class="delimiter">{</span>

        getDB<span class="delimiter">(</span> dbName <span class="delimiter">)</span>.dropDatabase<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * gets this driver version
     * @return
     */</span>
    public String <a title="()java.lang.String" id="43549">getVersion</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> MAJOR_VERSION + <span class="string">&quot;.&quot;</span> + MINOR_VERSION;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * returns a string representing the hosts used in this Mongo instance
     * @return
     */</span>
    public String <a title="()java.lang.String" id="43550">debugString</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> _connector.debugString<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the current master's hostname
     * @return
     */</span>
    public String <a title="()java.lang.String" id="43551">getConnectPoint</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> _connector.getConnectPoint<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the underlying TCP connector
     * @return
     */</span>
    public <a href="DBTCPConnector.java.html#7971" title="com.mongodb.DBTCPConnector">DBTCPConnector</a> <a title="()com.mongodb.DBTCPConnector" id="43552">getConnector</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> _connector;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the replica set status object
     * @return
     */</span>
    public <a href="ReplicaSetStatus.java.html#7776" title="com.mongodb.ReplicaSetStatus">ReplicaSetStatus</a> <a title="()com.mongodb.ReplicaSetStatus" id="43553">getReplicaSetStatus</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> _connector.getReplicaSetStatus<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the address of the current master
     * @return the address
     */</span>
    public <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="()com.mongodb.ServerAddress" id="43554">getAddress</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> _connector.getAddress<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets a list of all server addresses used when this Mongo was created
     * @return
     */</span>
    public List&lt;<a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a>&gt; <a title="()java.util.List[com.mongodb.ServerAddress]" id="43555">getAllAddress</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        List&lt;ServerAddress&gt; result = _connector.getAllAddress<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>result == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> Arrays.asList<span class="delimiter">(</span>getAddress<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> result;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the list of server addresses currently seen by the connector.
     * This includes addresses auto-discovered from a replica set.
     * @return
     */</span>
    public List&lt;<a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a>&gt; <a title="()java.util.List[com.mongodb.ServerAddress]" id="43556">getServerAddressList</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> _connector.getServerAddressList<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * closes the underlying connector, which in turn closes all open connections.
     * Once called, this Mongo instance can no longer be used.
     */</span>
    public void <a title="()Unit" id="43557">close</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        _connector.close<span class="delimiter">(</span><span class="delimiter">)</span>;
        _cleaner.interrupt<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">try</span> <span class="delimiter">{</span>
            _cleaner.join<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>InterruptedException e<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">//end early</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Sets the write concern for this database. Will be used as default for
     * writes to any collection in any database. See the
     * documentation for {@link WriteConcern} for more information.
     *
     * @param concern write concern to use
     */</span>
    public void <a title="(concern: com.mongodb.WriteConcern)Unit" id="43558">setWriteConcern</a><span class="delimiter">(</span> <a href="WriteConcern.java.html#7896" title="com.mongodb.WriteConcern">WriteConcern</a> <a title="com.mongodb.WriteConcern" id="53083">concern</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        _concern = concern;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the default write concern
     * @return
     */</span>
    public <a href="WriteConcern.java.html#7896" title="com.mongodb.WriteConcern">WriteConcern</a> <a title="()com.mongodb.WriteConcern" id="43559">getWriteConcern</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> _concern;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * makes it possible to run read queries on slave nodes
     */</span>
    public void <a title="()Unit" id="43560">slaveOk</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        addOption<span class="delimiter">(</span> Bytes.QUERYOPTION_SLAVEOK <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * adds a default query option
     * @param option
     */</span>
    public void <a title="(option: Int)Unit" id="43561">addOption</a><span class="delimiter">(</span> int <a title="Int" id="53068">option</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        _netOptions.add<span class="delimiter">(</span> option <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * sets the default query options
     * @param options
     */</span>
    public void <a title="(options: Int)Unit" id="43562">setOptions</a><span class="delimiter">(</span> int <a title="Int" id="145367">options</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        _netOptions.set<span class="delimiter">(</span> options <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * reset the default query options
     */</span>
    public void <a title="()Unit" id="43563">resetOptions</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        _netOptions.reset<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * gets the default query options
     * @return
     */</span>
    public int <a title="()Int" id="43564">getOptions</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">return</span> _netOptions.get<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Helper method for setting up MongoOptions at instantiation
     * so that any options which affect this connection can be set.
     */</span>
    void <a title="()Unit" id="43565">_applyMongoOptions</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>_options.slaveOk<span class="delimiter">)</span> slaveOk<span class="delimiter">(</span><span class="delimiter">)</span>;
        setWriteConcern<span class="delimiter">(</span> _options.getWriteConcern<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Returns the mongo options.
     */</span>
    public <a href="MongoOptions.java.html#7785" title="com.mongodb.MongoOptions">MongoOptions</a> <a title="()com.mongodb.MongoOptions" id="43566">getMongoOptions</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> _options;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Gets the maximum size for a BSON object supported by the current master server.
     * Note that this value may change over time depending on which server is master.
     * If the size is not known yet, a request may be sent to the master server
     * @return the maximum size
     */</span>
    public int <a title="()Int" id="43567">getMaxBsonObjectSize</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        int maxsize = _connector.getMaxBsonObjectSize<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>maxsize == <span class="int">0</span><span class="delimiter">)</span>
            maxsize = _connector.fetchMaxBsonObjectSize<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> maxsize &gt; <span class="int">0</span> ? maxsize : Bytes.MAX_OBJECT_SIZE;
    <span class="delimiter">}</span>

    <span class="keyword">final</span> <a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a> <a title="com.mongodb.ServerAddress" id="43568">_addr</a>;
    <span class="keyword">final</span> List&lt;<a href="ServerAddress.java.html#7911" title="com.mongodb.ServerAddress">ServerAddress</a>&gt; <a title="java.util.List[com.mongodb.ServerAddress]" id="43569">_addrs</a>;
    <span class="keyword">final</span> <a href="MongoOptions.java.html#7785" title="com.mongodb.MongoOptions">MongoOptions</a> <a title="com.mongodb.MongoOptions" id="43570">_options</a>;
    <span class="keyword">final</span> <a href="DBTCPConnector.java.html#7971" title="com.mongodb.DBTCPConnector">DBTCPConnector</a> <a title="com.mongodb.DBTCPConnector" id="43571">_connector</a>;
    <span class="keyword">final</span> ConcurrentMap&lt;String,<a href="DB.java.html#7845" title="com.mongodb.DB">DB</a>&gt; <a title="java.util.concurrent.ConcurrentMap[java.lang.String,com.mongodb.DB]" id="43572">_dbs</a> = <span class="keyword">new</span> ConcurrentHashMap&lt;String,DB&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="keyword">private</span> <a href="WriteConcern.java.html#7896" title="com.mongodb.WriteConcern">WriteConcern</a> <a title="com.mongodb.WriteConcern" id="43573">_concern</a> = WriteConcern.NORMAL;
    <span class="keyword">final</span> <a href="Bytes.java.html#7963" title="object com.mongodb.Bytes">Bytes</a>.<a href="Bytes.java.html#66824" title="com.mongodb.Bytes.OptionHolder">OptionHolder</a> <a title="com.mongodb.Bytes.OptionHolder" id="43574">_netOptions</a> = <span class="keyword">new</span> Bytes.OptionHolder<span class="delimiter">(</span> <span class="keyword">null</span> <span class="delimiter">)</span>;
    <span class="keyword">final</span> DBCleanerThread <a title="Mongo.this.DBCleanerThread" id="43575">_cleaner</a>;

    org.bson.util.<a href="../../org/bson/util/SimplePool.java.html#8594" title="org.bson.util.SimplePool">SimplePool</a>&lt;PoolOutputBuffer&gt; <a title="org.bson.util.SimplePool[org.bson.io.PoolOutputBuffer]" id="43576">_bufferPool</a> =
        <span class="keyword">new</span> org.bson.util.SimplePool&lt;PoolOutputBuffer&gt;<span class="delimiter">(</span> <span class="int">1000</span> <span class="delimiter">)</span><span class="delimiter">{</span>

        <span class="keyword">protected</span> PoolOutputBuffer createNew<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="keyword">new</span> PoolOutputBuffer<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

    <span class="delimiter">}</span>;

    <span class="comment">/**
     * Forces the master server to fsync the RAM data to disk
     * This is done automatically by the server at intervals, but can be forced for better reliability. 
     * @param async if true, the fsync will be done asynchronously on the server.
     * @return 
     */</span>
    public <a href="CommandResult.java.html#7890" title="com.mongodb.CommandResult">CommandResult</a> <a title="(async: Boolean)com.mongodb.CommandResult" id="43577">fsync</a><span class="delimiter">(</span>boolean <a title="Boolean" id="145376">async</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        DBObject cmd = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="string">&quot;fsync&quot;</span>, <span class="int">1</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>async<span class="delimiter">)</span> <span class="delimiter">{</span>
            cmd.put<span class="delimiter">(</span><span class="string">&quot;async&quot;</span>, <span class="int">1</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> getDB<span class="delimiter">(</span><span class="string">&quot;admin&quot;</span><span class="delimiter">)</span>.command<span class="delimiter">(</span>cmd<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Forces the master server to fsync the RAM data to disk, then lock all writes.
     * The database will be read-only after this command returns.
     * @return 
     */</span>
    public <a href="CommandResult.java.html#7890" title="com.mongodb.CommandResult">CommandResult</a> <a title="()com.mongodb.CommandResult" id="43578">fsyncAndLock</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        DBObject cmd = <span class="keyword">new</span> BasicDBObject<span class="delimiter">(</span><span class="string">&quot;fsync&quot;</span>, <span class="int">1</span><span class="delimiter">)</span>;
        cmd.put<span class="delimiter">(</span><span class="string">&quot;lock&quot;</span>, <span class="int">1</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> getDB<span class="delimiter">(</span><span class="string">&quot;admin&quot;</span><span class="delimiter">)</span>.command<span class="delimiter">(</span>cmd<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Unlocks the database, allowing the write operations to go through.
     * This command may be asynchronous on the server, which means there may be a small delay before the database becomes writable.
     * @return 
     */</span>
    public <a href="DBObject.java.html#7932" title="com.mongodb.DBObject">DBObject</a> <a title="()com.mongodb.DBObject" id="43579">unlock</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        DB db = getDB<span class="delimiter">(</span><span class="string">&quot;admin&quot;</span><span class="delimiter">)</span>;
        DBCollection col = db.getCollection<span class="delimiter">(</span><span class="string">&quot;$cmd.sys.unlock&quot;</span><span class="delimiter">)</span>;
        <span class="keyword">return</span> col.findOne<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Returns true if the database is locked (read-only), false otherwise.
     * @return 
     */</span>
    public boolean <a title="()Boolean" id="43580">isLocked</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        DB db = getDB<span class="delimiter">(</span><span class="string">&quot;admin&quot;</span><span class="delimiter">)</span>;
        DBCollection col = db.getCollection<span class="delimiter">(</span><span class="string">&quot;$cmd.sys.inprog&quot;</span><span class="delimiter">)</span>;
        BasicDBObject res = <span class="delimiter">(</span>BasicDBObject<span class="delimiter">)</span> col.findOne<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>res.containsField<span class="delimiter">(</span><span class="string">&quot;fsyncLock&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> res.getInt<span class="delimiter">(</span><span class="string">&quot;fsyncLock&quot;</span><span class="delimiter">)</span> == <span class="int">1</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> <span class="keyword">false</span>;
    <span class="delimiter">}</span>

    <span class="comment">// -------</span>


    <span class="comment">/**
     * Mongo.Holder can be used as a static place to hold several instances of Mongo.
     * Security is not enforced at this level, and needs to be done on the application side.
     */</span>
    public static <span class="keyword">class</span> <a title="object com.mongodb.Mongo.Holder" id="52357">Holder</a> <span class="delimiter">{</span>

        <span class="comment">/**
         * Attempts to find an existing Mongo instance matching that URI in the holder, and returns it if exists.
         * Otherwise creates a new Mongo instance based on this URI and adds it to the holder.
         * @param uri the Mongo URI
         * @return
         * @throws MongoException
         * @throws UnknownHostException
         */</span>
        public Mongo connect<span class="delimiter">(</span> MongoURI uri <span class="delimiter">)</span>
            throws MongoException , UnknownHostException <span class="delimiter">{</span>

            String key = _toKey<span class="delimiter">(</span> uri <span class="delimiter">)</span>;

            Mongo m = _mongos.get<span class="delimiter">(</span>key<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> m != <span class="keyword">null</span> <span class="delimiter">)</span>
                <span class="keyword">return</span> m;

            m = <span class="keyword">new</span> Mongo<span class="delimiter">(</span> uri <span class="delimiter">)</span>;

            Mongo temp = _mongos.putIfAbsent<span class="delimiter">(</span> key , m <span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> temp == <span class="keyword">null</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="comment">// ours got in</span>
                <span class="keyword">return</span> m;
            <span class="delimiter">}</span>

            <span class="comment">// there was a race and we lost</span>
            <span class="comment">// close ours and return the other one</span>
            m.close<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">return</span> temp;
        <span class="delimiter">}</span>

        String _toKey<span class="delimiter">(</span> MongoURI uri <span class="delimiter">)</span><span class="delimiter">{</span>
            StringBuilder buf = <span class="keyword">new</span> StringBuilder<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">for</span> <span class="delimiter">(</span> String h : uri.getHosts<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>
                buf.append<span class="delimiter">(</span> h <span class="delimiter">)</span>.append<span class="delimiter">(</span> <span class="string">&quot;,&quot;</span> <span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span> uri.getOptions<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span> uri.getUsername<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            <span class="keyword">return</span> buf.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        
        public static Holder <a title="()com.mongodb.Mongo.Holder" id="145353">singleton</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="keyword">return</span> _default; <span class="delimiter">}</span>

        <span class="keyword">private</span> static Holder <a title="com.mongodb.Mongo.Holder" id="145354">_default</a> = <span class="keyword">new</span> Holder<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String,Mongo&gt; _mongos = <span class="keyword">new</span> ConcurrentHashMap&lt;String,Mongo&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;

    <span class="delimiter">}</span>

    <span class="keyword">class</span> <a title="object Mongo.this.DBCleanerThread" id="43583">DBCleanerThread</a> <span class="keyword">extends</span> Thread <span class="delimiter">{</span>

        DBCleanerThread<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            setDaemon<span class="delimiter">(</span><span class="keyword">true</span><span class="delimiter">)</span>;
            setName<span class="delimiter">(</span><span class="string">&quot;MongoCleaner&quot;</span> + hashCode<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        public void run<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">while</span> <span class="delimiter">(</span>_connector.isOpen<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    <span class="keyword">try</span> <span class="delimiter">{</span>
                        Thread.sleep<span class="delimiter">(</span>cleanerIntervalMS<span class="delimiter">)</span>;
                    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>InterruptedException e<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="comment">//caused by the Mongo instance being closed -- proceed with cleanup</span>
                    <span class="delimiter">}</span>
                    <span class="keyword">for</span> <span class="delimiter">(</span>DB db : _dbs.values<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        db.cleanCursors<span class="delimiter">(</span><span class="keyword">true</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>Throwable t<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="comment">// thread must never die</span>
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    @Override
    public String <a title="()java.lang.String" id="43584">toString</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        String str = <span class="string">&quot;Mongo: &quot;</span>;
        List&lt;ServerAddress&gt; list = getServerAddressList<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>list == <span class="keyword">null</span> || list.isEmpty<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
            str += <span class="string">&quot;null&quot;</span>;
        <span class="keyword">else</span> <span class="delimiter">{</span>
            <span class="keyword">for</span> <span class="delimiter">(</span>ServerAddress addr : list<span class="delimiter">)</span> <span class="delimiter">{</span>
                str += addr.toString<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="string">&quot;,&quot;</span>;
            <span class="delimiter">}</span>
            str = str.substring<span class="delimiter">(</span><span class="int">0</span>, str.length<span class="delimiter">(</span><span class="delimiter">)</span> - <span class="int">1</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> str;
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>