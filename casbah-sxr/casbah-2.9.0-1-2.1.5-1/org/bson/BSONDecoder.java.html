<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>org/bson/BSONDecoder.java</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">// BSONDecoder.java</span>

<span class="keyword">package</span> org.bson;

<span class="keyword">import</span> static org.bson.BSON.*;

<span class="keyword">import</span> java.io.*;

<span class="keyword">import</span> org.bson.io.Bits;
<span class="keyword">import</span> org.bson.io.PoolOutputBuffer;
<span class="keyword">import</span> org.bson.types.ObjectId;

public <span class="keyword">class</span> <a title="object org.bson.BSONDecoder" id="8438">BSONDecoder</a> <span class="delimiter">{</span>
    
    public BSONObject readObject<span class="delimiter">(</span> byte<span class="delimiter">[</span><span class="delimiter">]</span> b <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> readObject<span class="delimiter">(</span> <span class="keyword">new</span> ByteArrayInputStream<span class="delimiter">(</span> b <span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">catch</span> <span class="delimiter">(</span> IOException ioe <span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> BSONException<span class="delimiter">(</span> <span class="string">&quot;should be impossible&quot;</span> , ioe <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    public BSONObject readObject<span class="delimiter">(</span> InputStream in <span class="delimiter">)</span>
        throws IOException <span class="delimiter">{</span>
        BasicBSONCallback c = <span class="keyword">new</span> BasicBSONCallback<span class="delimiter">(</span><span class="delimiter">)</span>;
        decode<span class="delimiter">(</span> in , c <span class="delimiter">)</span>;
        <span class="keyword">return</span> <span class="delimiter">(</span>BSONObject<span class="delimiter">)</span>c.get<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public int decode<span class="delimiter">(</span> byte<span class="delimiter">[</span><span class="delimiter">]</span> b , BSONCallback callback <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> _decode<span class="delimiter">(</span> <span class="keyword">new</span> Input<span class="delimiter">(</span> <span class="keyword">new</span> ByteArrayInputStream<span class="delimiter">(</span>b<span class="delimiter">)</span> <span class="delimiter">)</span> , callback <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">catch</span> <span class="delimiter">(</span> IOException ioe <span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> BSONException<span class="delimiter">(</span> <span class="string">&quot;should be impossible&quot;</span> , ioe <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>


    public int decode<span class="delimiter">(</span> InputStream in , BSONCallback callback <span class="delimiter">)</span>
        throws IOException <span class="delimiter">{</span>
        <span class="keyword">return</span> _decode<span class="delimiter">(</span> <span class="keyword">new</span> Input<span class="delimiter">(</span> in <span class="delimiter">)</span> , callback <span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    
    <span class="keyword">private</span> int _decode<span class="delimiter">(</span> Input in  , BSONCallback callback <span class="delimiter">)</span>
        throws IOException <span class="delimiter">{</span>

        <span class="keyword">if</span> <span class="delimiter">(</span> _in != <span class="keyword">null</span> || _callback != <span class="keyword">null</span> <span class="delimiter">)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException<span class="delimiter">(</span> <span class="string">&quot;not ready&quot;</span> <span class="delimiter">)</span>;
        
        _in = in;
        _callback = callback;
        
        <span class="keyword">if</span> <span class="delimiter">(</span> in._read != <span class="int">0</span> <span class="delimiter">)</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span> <span class="string">&quot;i'm confused&quot;</span> <span class="delimiter">)</span>;

        <span class="keyword">try</span> <span class="delimiter">{</span>
            
            <span class="keyword">final</span> int len = _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
            _in._max = len;

            _callback.objectStart<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span> decodeElement<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            _callback.objectDone<span class="delimiter">(</span><span class="delimiter">)</span>;
            
            <span class="keyword">if</span> <span class="delimiter">(</span> _in._read != len <span class="delimiter">)</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span> <span class="string">&quot;bad data.  lengths don't match read:&quot;</span> + _in._read + <span class="string">&quot; != len:&quot;</span> + len <span class="delimiter">)</span>;
            
            <span class="keyword">return</span> len;
        <span class="delimiter">}</span>
        <span class="keyword">finally</span> <span class="delimiter">{</span>
            _in = <span class="keyword">null</span>;
            _callback = <span class="keyword">null</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    
    int decode<span class="delimiter">(</span> boolean first <span class="delimiter">)</span>
        throws IOException <span class="delimiter">{</span>

        <span class="keyword">final</span> int start = _in._read;
        
        <span class="keyword">final</span> int len = _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span> first <span class="delimiter">)</span>
            _in._max = len;

        _callback.objectStart<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">while</span> <span class="delimiter">(</span> decodeElement<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        _callback.objectDone<span class="delimiter">(</span><span class="delimiter">)</span>;
        
        <span class="keyword">final</span> int read = _in._read - start;

        <span class="keyword">if</span> <span class="delimiter">(</span> read != len <span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="comment">//throw new IllegalArgumentException( &quot;bad data.  lengths don't match &quot; + read + &quot; != &quot; + len );</span>
        <span class="delimiter">}</span>

        <span class="keyword">return</span> len;
    <span class="delimiter">}</span>
    
    boolean decodeElement<span class="delimiter">(</span><span class="delimiter">)</span>
        throws IOException <span class="delimiter">{</span>

        <span class="keyword">final</span> byte <span class="keyword">type</span> = _in.read<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span> <span class="keyword">type</span> == EOO <span class="delimiter">)</span>
            <span class="keyword">return</span> <span class="keyword">false</span>;
        
        String name = _in.readCStr<span class="delimiter">(</span><span class="delimiter">)</span>;
        
        switch <span class="delimiter">(</span> <span class="keyword">type</span> <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">case</span> NULL:
            _callback.gotNull<span class="delimiter">(</span> name <span class="delimiter">)</span>; 
            break;
            
        <span class="keyword">case</span> UNDEFINED:
            _callback.gotUndefined<span class="delimiter">(</span> name <span class="delimiter">)</span>; 
            break;

        <span class="keyword">case</span> BOOLEAN:
            _callback.gotBoolean<span class="delimiter">(</span> name , _in.read<span class="delimiter">(</span><span class="delimiter">)</span> &gt; <span class="int">0</span> <span class="delimiter">)</span>;
            break;

        <span class="keyword">case</span> NUMBER:
            _callback.gotDouble<span class="delimiter">(</span> name , _in.readDouble<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;
	    
        <span class="keyword">case</span> NUMBER_INT:
            _callback.gotInt<span class="delimiter">(</span> name , _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;

        <span class="keyword">case</span> NUMBER_LONG:
            _callback.gotLong<span class="delimiter">(</span> name , _in.readLong<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;	    

            
        <span class="keyword">case</span> SYMBOL:
            _callback.gotSymbol<span class="delimiter">(</span> name , _in.readUTF8String<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;
            

        <span class="keyword">case</span> STRING:
            _callback.gotString<span class="delimiter">(</span> name , _in.readUTF8String<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;

        <span class="keyword">case</span> OID:
            <span class="comment">// OID is stored as big endian</span>
            _callback.gotObjectId<span class="delimiter">(</span> name , <span class="keyword">new</span> ObjectId<span class="delimiter">(</span> _in.readIntBE<span class="delimiter">(</span><span class="delimiter">)</span> , _in.readIntBE<span class="delimiter">(</span><span class="delimiter">)</span> , _in.readIntBE<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;
            
        <span class="keyword">case</span> REF:
            _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;  <span class="comment">// length of ctring that follows</span>
            String ns = _in.readCStr<span class="delimiter">(</span><span class="delimiter">)</span>;
            ObjectId theOID = <span class="keyword">new</span> ObjectId<span class="delimiter">(</span> _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span> , _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span> , _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            _callback.gotDBRef<span class="delimiter">(</span> name , ns , theOID <span class="delimiter">)</span>;
            break;
            
        <span class="keyword">case</span> DATE:
            _callback.gotDate<span class="delimiter">(</span> name , _in.readLong<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;
            
        <span class="keyword">case</span> REGEX:
            _callback.gotRegex<span class="delimiter">(</span> name , _in.readCStr<span class="delimiter">(</span><span class="delimiter">)</span> , _in.readCStr<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;

        <span class="keyword">case</span> BINARY:
            _binary<span class="delimiter">(</span> name <span class="delimiter">)</span>;
            break;
            
        <span class="keyword">case</span> CODE:
            _callback.gotCode<span class="delimiter">(</span> name , _in.readUTF8String<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            break;

        <span class="keyword">case</span> CODE_W_SCOPE:
            _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
            _callback.gotCodeWScope<span class="delimiter">(</span> name , _in.readUTF8String<span class="delimiter">(</span><span class="delimiter">)</span> , _readBasicObject<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;

            break;

        <span class="keyword">case</span> ARRAY:
            _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;  <span class="comment">// total size - we don't care....</span>

            _callback.arrayStart<span class="delimiter">(</span> name <span class="delimiter">)</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span> decodeElement<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            _callback.arrayDone<span class="delimiter">(</span><span class="delimiter">)</span>;

            break;
            
            
        <span class="keyword">case</span> OBJECT:
            _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;  <span class="comment">// total size - we don't care....</span>
            
            _callback.objectStart<span class="delimiter">(</span> name <span class="delimiter">)</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span> decodeElement<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
            _callback.objectDone<span class="delimiter">(</span><span class="delimiter">)</span>;

            break;
            
        <span class="keyword">case</span> TIMESTAMP:
            int i = _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
            int time = _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
            _callback.gotTimestamp<span class="delimiter">(</span> name , time , i <span class="delimiter">)</span>;
            break;

        <span class="keyword">case</span> MINKEY:
            _callback.gotMinKey<span class="delimiter">(</span> name <span class="delimiter">)</span>;
            break;

        <span class="keyword">case</span> MAXKEY:
            _callback.gotMaxKey<span class="delimiter">(</span> name <span class="delimiter">)</span>;
            break;

        default:
            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException<span class="delimiter">(</span> <span class="string">&quot;BSONDecoder doesn't understand type : &quot;</span> + <span class="keyword">type</span> + <span class="string">&quot; name: &quot;</span> + name  <span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        
        <span class="keyword">return</span> <span class="keyword">true</span>;
    <span class="delimiter">}</span>

    <span class="keyword">protected</span> void _binary<span class="delimiter">(</span> String name <span class="delimiter">)</span>
        throws IOException <span class="delimiter">{</span>
        <span class="keyword">final</span> int totalLen = _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="keyword">final</span> byte bType = _in.read<span class="delimiter">(</span><span class="delimiter">)</span>;
        
        switch <span class="delimiter">(</span> bType <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">case</span> B_GENERAL: <span class="delimiter">{</span>
                <span class="keyword">final</span> byte<span class="delimiter">[</span><span class="delimiter">]</span> data = <span class="keyword">new</span> byte<span class="delimiter">[</span>totalLen<span class="delimiter">]</span>;
                _in.fill<span class="delimiter">(</span> data <span class="delimiter">)</span>;
                _callback.gotBinary<span class="delimiter">(</span> name, bType, data <span class="delimiter">)</span>;
                <span class="keyword">return</span>;
        <span class="delimiter">}</span>
        <span class="keyword">case</span> B_BINARY:
            <span class="keyword">final</span> int len = _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> len + <span class="int">4</span> != totalLen <span class="delimiter">)</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span> <span class="string">&quot;bad data size subtype 2 len: &quot;</span> + len + <span class="string">&quot; totalLen: &quot;</span> + totalLen <span class="delimiter">)</span>;
            
            <span class="keyword">final</span> byte<span class="delimiter">[</span><span class="delimiter">]</span> data = <span class="keyword">new</span> byte<span class="delimiter">[</span>len<span class="delimiter">]</span>;
            _in.fill<span class="delimiter">(</span> data <span class="delimiter">)</span>;
            _callback.gotBinary<span class="delimiter">(</span> name , bType , data <span class="delimiter">)</span>;
            <span class="keyword">return</span>;
        <span class="keyword">case</span> B_UUID:
            <span class="keyword">if</span> <span class="delimiter">(</span> totalLen != <span class="int">16</span> <span class="delimiter">)</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span> <span class="string">&quot;bad data size subtype 3 len: &quot;</span> + totalLen + <span class="string">&quot; != 16&quot;</span><span class="delimiter">)</span>;
            
            long part1 = _in.readLong<span class="delimiter">(</span><span class="delimiter">)</span>;
            long part2 = _in.readLong<span class="delimiter">(</span><span class="delimiter">)</span>;
            _callback.gotUUID<span class="delimiter">(</span>name, part1, part2<span class="delimiter">)</span>;
            <span class="keyword">return</span>;	
        <span class="delimiter">}</span>
        
        byte<span class="delimiter">[</span><span class="delimiter">]</span> data = <span class="keyword">new</span> byte<span class="delimiter">[</span>totalLen<span class="delimiter">]</span>;
        _in.fill<span class="delimiter">(</span> data <span class="delimiter">)</span>;

        _callback.gotBinary<span class="delimiter">(</span> name , bType , data <span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    
    Object _readBasicObject<span class="delimiter">(</span><span class="delimiter">)</span>
        throws IOException <span class="delimiter">{</span>
        _in.readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
        
        BSONCallback save = _callback;
        BSONCallback _basic = _callback.createBSONCallback<span class="delimiter">(</span><span class="delimiter">)</span>;
        _callback = _basic;
        _basic.reset<span class="delimiter">(</span><span class="delimiter">)</span>;
        _basic.objectStart<span class="delimiter">(</span><span class="keyword">false</span><span class="delimiter">)</span>;

        <span class="keyword">while</span><span class="delimiter">(</span> decodeElement<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        _callback = save;
        <span class="keyword">return</span> _basic.get<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    
    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">class</span> Input <span class="delimiter">{</span>
        
        Input<span class="delimiter">(</span> InputStream in <span class="delimiter">)</span><span class="delimiter">{</span>
            _raw = in;
            _read = <span class="int">0</span>;

            _pos = <span class="int">0</span>;
            _len = <span class="int">0</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * ensure that there are num bytes to read
         * _pos is where to start reading from
         * @return where to start reading from
         */</span>
        int _need<span class="delimiter">(</span> <span class="keyword">final</span> int num <span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>

            <span class="comment">//System.out.println( &quot;p: &quot; + _pos + &quot; l: &quot; + _len + &quot; want: &quot; + num );</span>
            
            <span class="keyword">if</span> <span class="delimiter">(</span> _len - _pos &gt;= num <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">final</span> int ret = _pos;
                _pos += num;
                _read += num;
                <span class="keyword">return</span> ret;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span> num &gt;= _inputBuffer.length <span class="delimiter">)</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span> <span class="string">&quot;you can't need that much&quot;</span> <span class="delimiter">)</span>;
            
                <span class="keyword">final</span> int remaining = _len - _pos;
            <span class="keyword">if</span> <span class="delimiter">(</span> _pos &gt; <span class="int">0</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                System.arraycopy<span class="delimiter">(</span> _inputBuffer , _pos , _inputBuffer , <span class="int">0</span>  , remaining <span class="delimiter">)</span>;
                
                _pos = <span class="int">0</span>;
                _len = remaining;
            <span class="delimiter">}</span>
            
            <span class="comment">// read as much as possible into buffer</span>
            int maxToRead = Math.min<span class="delimiter">(</span> _max - _read - remaining , _inputBuffer.length - _len <span class="delimiter">)</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span> maxToRead &gt; <span class="int">0</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                int x = _raw.read<span class="delimiter">(</span> _inputBuffer , _len ,  maxToRead<span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span> x &lt;= <span class="int">0</span> <span class="delimiter">)</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException<span class="delimiter">(</span> <span class="string">&quot;unexpected EOF&quot;</span> <span class="delimiter">)</span>;
                maxToRead -= x;
                _len += x;
            <span class="delimiter">}</span>
            
            int ret = _pos;
            _pos += num;
            _read += num;
            <span class="keyword">return</span> ret;
        <span class="delimiter">}</span>
        
        public int readInt<span class="delimiter">(</span><span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            <span class="keyword">return</span> Bits.readInt<span class="delimiter">(</span> _inputBuffer , _need<span class="delimiter">(</span><span class="int">4</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        int readIntBE<span class="delimiter">(</span><span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            <span class="keyword">return</span> Bits.readIntBE<span class="delimiter">(</span> _inputBuffer , _need<span class="delimiter">(</span><span class="int">4</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        long readLong<span class="delimiter">(</span><span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            <span class="keyword">return</span> Bits.readLong<span class="delimiter">(</span> _inputBuffer , _need<span class="delimiter">(</span><span class="int">8</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        double readDouble<span class="delimiter">(</span><span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            <span class="keyword">return</span> Double.longBitsToDouble<span class="delimiter">(</span> readLong<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        public byte read<span class="delimiter">(</span><span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span> _pos &lt; _len <span class="delimiter">)</span><span class="delimiter">{</span>
                ++_read;
                <span class="keyword">return</span> _inputBuffer<span class="delimiter">[</span>_pos++<span class="delimiter">]</span>;
            <span class="delimiter">}</span>
            <span class="keyword">return</span> _inputBuffer<span class="delimiter">[</span>_need<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span><span class="delimiter">]</span>;
        <span class="delimiter">}</span>

        public void fill<span class="delimiter">(</span> byte b<span class="delimiter">[</span><span class="delimiter">]</span> <span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            fill<span class="delimiter">(</span> b , b.length <span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        public void fill<span class="delimiter">(</span> byte b<span class="delimiter">[</span><span class="delimiter">]</span> , int len <span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>  
            <span class="comment">// first use what we have</span>
            int have = _len - _pos;
            int tocopy = Math.min<span class="delimiter">(</span> len , have <span class="delimiter">)</span>;
            System.arraycopy<span class="delimiter">(</span> _inputBuffer , _pos , b , <span class="int">0</span> , tocopy <span class="delimiter">)</span>;
            
            _pos += tocopy;
            _read += tocopy;

            len -= tocopy;
            
            int off = tocopy;
            <span class="keyword">while</span> <span class="delimiter">(</span> len &gt; <span class="int">0</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                int x = _raw.read<span class="delimiter">(</span> b , off , len <span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>x &lt;= <span class="int">0</span><span class="delimiter">)</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException<span class="delimiter">(</span> <span class="string">&quot;unexpected EOF&quot;</span> <span class="delimiter">)</span>;
                _read += x;
                off += x;
                len -= x;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        boolean _isAscii<span class="delimiter">(</span> byte b <span class="delimiter">)</span><span class="delimiter">{</span>
            <span class="keyword">return</span> b &gt;=<span class="int">0</span> &amp;&amp; b &lt;= <span class="int">127</span>;
        <span class="delimiter">}</span>

        String readCStr<span class="delimiter">(</span><span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            
            boolean isAscii = <span class="keyword">true</span>;

            <span class="comment">// short circuit 1 byte strings</span>
            _random<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span> = read<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>_random<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span> == <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;
            <span class="delimiter">}</span>

            _random<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span> = read<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>_random<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span> == <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                String out = ONE_BYTE_STRINGS<span class="delimiter">[</span>_random<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span><span class="delimiter">]</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>out != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">return</span> out;
                <span class="delimiter">}</span>
                <span class="keyword">return</span> <span class="keyword">new</span> String<span class="delimiter">(</span>_random, <span class="int">0</span>, <span class="int">1</span>, <span class="string">&quot;UTF-8&quot;</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>

            _stringBuffer.reset<span class="delimiter">(</span><span class="delimiter">)</span>;
            _stringBuffer.write<span class="delimiter">(</span>_random<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span><span class="delimiter">)</span>;
            _stringBuffer.write<span class="delimiter">(</span>_random<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span><span class="delimiter">)</span>;

            isAscii = _isAscii<span class="delimiter">(</span>_random<span class="delimiter">[</span><span class="int">0</span><span class="delimiter">]</span><span class="delimiter">)</span> &amp;&amp; _isAscii<span class="delimiter">(</span>_random<span class="delimiter">[</span><span class="int">1</span><span class="delimiter">]</span><span class="delimiter">)</span>;
            
            <span class="keyword">while</span> <span class="delimiter">(</span> <span class="keyword">true</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                byte b = read<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span> b == <span class="int">0</span> <span class="delimiter">)</span>
                    break;
                _stringBuffer.write<span class="delimiter">(</span> b <span class="delimiter">)</span>;
                isAscii = isAscii &amp;&amp; _isAscii<span class="delimiter">(</span> b <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            
            String out = <span class="keyword">null</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span> isAscii <span class="delimiter">)</span><span class="delimiter">{</span>
                out = _stringBuffer.asAscii<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    out = _stringBuffer.asString<span class="delimiter">(</span> <span class="string">&quot;UTF-8&quot;</span> <span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">catch</span> <span class="delimiter">(</span> UnsupportedOperationException e <span class="delimiter">)</span><span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> BSONException<span class="delimiter">(</span> <span class="string">&quot;impossible&quot;</span> , e <span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>
            _stringBuffer.reset<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">return</span> out;
        <span class="delimiter">}</span>

        String readUTF8String<span class="delimiter">(</span><span class="delimiter">)</span>
            throws IOException <span class="delimiter">{</span>
            int size = readInt<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="comment">// this is just protection in case it's corrupted, to avoid huge strings</span>
            <span class="keyword">if</span> <span class="delimiter">(</span> size &lt;= <span class="int">0</span> || size &gt; <span class="delimiter">(</span> <span class="int">32</span> * <span class="int">1024</span> * <span class="int">1024</span> <span class="delimiter">)</span> <span class="delimiter">)</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> BSONException<span class="delimiter">(</span> <span class="string">&quot;bad string size: &quot;</span> + size <span class="delimiter">)</span>;
            
            <span class="keyword">if</span> <span class="delimiter">(</span> size &lt; _inputBuffer.length / <span class="int">2</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span> size == <span class="int">1</span> <span class="delimiter">)</span><span class="delimiter">{</span>
                    read<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;
                <span class="delimiter">}</span>

                <span class="keyword">return</span> <span class="keyword">new</span> String<span class="delimiter">(</span> _inputBuffer , _need<span class="delimiter">(</span>size<span class="delimiter">)</span> , size - <span class="int">1</span> , <span class="string">&quot;UTF-8&quot;</span> <span class="delimiter">)</span>;
            <span class="delimiter">}</span>

            byte<span class="delimiter">[</span><span class="delimiter">]</span> b = size &lt; _random.length ? _random : <span class="keyword">new</span> byte<span class="delimiter">[</span>size<span class="delimiter">]</span>;
            
            fill<span class="delimiter">(</span> b , size <span class="delimiter">)</span>;
            
            <span class="keyword">try</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="keyword">new</span> String<span class="delimiter">(</span> b , <span class="int">0</span> , size - <span class="int">1</span> , <span class="string">&quot;UTF-8&quot;</span> <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">catch</span> <span class="delimiter">(</span> java.io.UnsupportedEncodingException uee <span class="delimiter">)</span><span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> BSONException<span class="delimiter">(</span> <span class="string">&quot;impossible&quot;</span> , uee <span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        
        int _read;
        <span class="keyword">final</span> InputStream _raw;

        int _pos; <span class="comment">// current offset into _inputBuffer</span>
        int _len; <span class="comment">// length of valid data in _inputBuffer</span>

        int _max = <span class="int">4</span>; <span class="comment">// max number of total bytes allowed to ready</span>
        
    <span class="delimiter">}</span>


    <span class="keyword">protected</span> Input _in;
    <span class="keyword">protected</span> BSONCallback _callback;
    <span class="keyword">private</span> byte<span class="delimiter">[</span><span class="delimiter">]</span> _random = <span class="keyword">new</span> byte<span class="delimiter">[</span><span class="int">1024</span><span class="delimiter">]</span>; <span class="comment">// has to be used within a single function</span>
    <span class="keyword">private</span> byte<span class="delimiter">[</span><span class="delimiter">]</span> _inputBuffer = <span class="keyword">new</span> byte<span class="delimiter">[</span><span class="int">1024</span><span class="delimiter">]</span>;

    <span class="keyword">private</span> PoolOutputBuffer _stringBuffer = <span class="keyword">new</span> PoolOutputBuffer<span class="delimiter">(</span><span class="delimiter">)</span>;

    static <span class="keyword">final</span> String<span class="delimiter">[</span><span title="Array" class="delimiter">]</span> <a title="Array[java.lang.String]" id="147671">ONE_BYTE_STRINGS</a> = <span class="keyword">new</span> String<span class="delimiter">[</span><span class="int">128</span><span class="delimiter">]</span>;
    static void <a title="(min: Byte, max: Byte)Unit" id="147672">_fillRange</a><span class="delimiter">(</span> byte <a title="Byte" id="147673">min</a>, byte <a title="Byte" id="147674">max</a> <span class="delimiter">)</span><span class="delimiter">{</span>
        <span class="keyword">while</span> <span class="delimiter">(</span> min &lt; max <span class="delimiter">)</span><span class="delimiter">{</span>
            String s = <span class="string">&quot;&quot;</span>;
            s += <span class="delimiter">(</span>char<span class="delimiter">)</span>min;
            ONE_BYTE_STRINGS<span class="delimiter">[</span><span class="delimiter">(</span>int<span class="delimiter">)</span>min<span class="delimiter">]</span> = s;
            min++;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    static <span class="delimiter">{</span>
        _fillRange<span class="delimiter">(</span> <span class="delimiter">(</span>byte<span class="delimiter">)</span><span class="char">'0'</span> , <span class="delimiter">(</span>byte<span class="delimiter">)</span><span class="char">'9'</span> <span class="delimiter">)</span>;
        _fillRange<span class="delimiter">(</span> <span class="delimiter">(</span>byte<span class="delimiter">)</span><span class="char">'a'</span> , <span class="delimiter">(</span>byte<span class="delimiter">)</span><span class="char">'z'</span> <span class="delimiter">)</span>;
        _fillRange<span class="delimiter">(</span> <span class="delimiter">(</span>byte<span class="delimiter">)</span><span class="char">'A'</span> , <span class="delimiter">(</span>byte<span class="delimiter">)</span><span class="char">'Z'</span> <span class="delimiter">)</span>;
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>