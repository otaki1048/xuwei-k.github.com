<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>fj/control/Trampoline.java</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> fj.control;

<span class="keyword">import</span> fj.Bottom;
<span class="keyword">import</span> fj.F;
<span class="keyword">import</span> fj.F2;
<span class="keyword">import</span> fj.P1;
<span class="keyword">import</span> fj.data.Either;

<span class="keyword">import</span> static fj.Function.curry;
<span class="keyword">import</span> static fj.data.Either.left;
<span class="keyword">import</span> static fj.data.Either.right;

<span class="comment">/**
 * A Trampoline is a potentially branching computation that can be stepped through and executed in constant stack.
 * It represent suspendable coroutines with subroutine calls, reified as a data structure.
 */</span>
public <span class="keyword">abstract</span> <span class="keyword">class</span> <a title="object fj.control.Trampoline" id="9834">Trampoline</a>&lt;<a title="Nothing" id="9835">A</a>&gt; <span class="delimiter">{</span>

  <span class="comment">// A Normal Trampoline is either done or suspended, and is allowed to be a subcomputation of a Codense.</span>
  <span class="comment">// This is the pointed functor part of the Trampoline monad.</span>
  <span class="keyword">private</span> static <span class="keyword">abstract</span> <span class="keyword">class</span> <a title="object fj.control.Trampoline.Normal" id="25136">Normal</a>&lt;<a id="25137">A</a>&gt; <span class="keyword">extends</span> Trampoline&lt;A&gt; <span class="delimiter">{</span>
    public <span class="keyword">abstract</span> &lt;R&gt; R foldNormal<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, R&gt; pure, <span class="keyword">final</span> F&lt;P1&lt;Trampoline&lt;A&gt;&gt;, R&gt; k<span class="delimiter">)</span>;

    public &lt;B&gt; Trampoline&lt;B&gt; bind<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, Trampoline&lt;B&gt;&gt; f<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> codense<span class="delimiter">(</span><span class="keyword">this</span>, f<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// A Codense Trampoline delimits a subcomputation and tracks its current continuation. Subcomputations are only</span>
  <span class="comment">// allowed to be Normal, so all of the continuations accumulate on the right.</span>
  <span class="keyword">private</span> static <span class="keyword">final</span> <span class="keyword">class</span> <a title="object fj.control.Trampoline.Codense" id="25140">Codense</a>&lt;<a id="25141">A</a>&gt; <span class="keyword">extends</span> Trampoline&lt;A&gt; <span class="delimiter">{</span>

    <span class="comment">// The Normal subcomputation</span>
    <span class="keyword">private</span> <span class="keyword">final</span> Normal&lt;Object&gt; sub;

    <span class="comment">// The current continuation</span>
    <span class="keyword">private</span> <span class="keyword">final</span> F&lt;Object, Trampoline&lt;A&gt;&gt; cont;

    <span class="keyword">private</span> Codense<span class="delimiter">(</span><span class="keyword">final</span> Normal&lt;Object&gt; t, <span class="keyword">final</span> F&lt;Object, Trampoline&lt;A&gt;&gt; k<span class="delimiter">)</span> <span class="delimiter">{</span>
      sub = t;
      cont = k;
    <span class="delimiter">}</span>

    public &lt;R&gt; R fold<span class="delimiter">(</span><span class="keyword">final</span> F&lt;Normal&lt;A&gt;, R&gt; n,
                      <span class="keyword">final</span> F&lt;Codense&lt;A&gt;, R&gt; gs<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> gs.f<span class="delimiter">(</span><span class="keyword">this</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">// The monadic bind constructs a new Codense whose subcomputation is still `sub`, and Kleisli-composes the</span>
    <span class="comment">// continuations.</span>
    public &lt;B&gt; Trampoline&lt;B&gt; bind<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, Trampoline&lt;B&gt;&gt; f<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> codense<span class="delimiter">(</span>sub, <span class="keyword">new</span> F&lt;Object, Trampoline&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        public Trampoline&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Object o<span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">return</span> suspend<span class="delimiter">(</span><span class="keyword">new</span> P1&lt;Trampoline&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            public Trampoline&lt;B&gt; _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span class="keyword">return</span> cont.f<span class="delimiter">(</span>o<span class="delimiter">)</span>.bind<span class="delimiter">(</span>f<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
          <span class="delimiter">}</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">// The resumption of a Codense is the resumption of its subcomputation. If that computation is done, its result</span>
    <span class="comment">// gets shifted into the continuation.</span>
    public Either&lt;P1&lt;Trampoline&lt;A&gt;&gt;, A&gt; resume<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> left<span class="delimiter">(</span>sub.resume<span class="delimiter">(</span><span class="delimiter">)</span>.either<span class="delimiter">(</span><span class="keyword">new</span> F&lt;P1&lt;Trampoline&lt;Object&gt;&gt;, P1&lt;Trampoline&lt;A&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            public P1&lt;Trampoline&lt;A&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;Object&gt;&gt; p<span class="delimiter">)</span> <span class="delimiter">{</span>
              <span class="keyword">return</span> p.map<span class="delimiter">(</span><span class="keyword">new</span> F&lt;Trampoline&lt;Object&gt;, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Trampoline&lt;Object&gt; ot<span class="delimiter">)</span> <span class="delimiter">{</span>
                  <span class="keyword">return</span> ot.fold<span class="delimiter">(</span><span class="keyword">new</span> F&lt;Normal&lt;Object&gt;, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Normal&lt;Object&gt; o<span class="delimiter">)</span> <span class="delimiter">{</span>
                          <span class="keyword">return</span> o.foldNormal<span class="delimiter">(</span><span class="keyword">new</span> F&lt;Object, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                                public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Object o<span class="delimiter">)</span> <span class="delimiter">{</span>
                                  <span class="keyword">return</span> cont.f<span class="delimiter">(</span>o<span class="delimiter">)</span>;
                                <span class="delimiter">}</span>
                              <span class="delimiter">}</span>, <span class="keyword">new</span> F&lt;P1&lt;Trampoline&lt;Object&gt;&gt;, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;Object&gt;&gt; t<span class="delimiter">)</span> <span class="delimiter">{</span>
                              <span class="keyword">return</span> t._1<span class="delimiter">(</span><span class="delimiter">)</span>.bind<span class="delimiter">(</span>cont<span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                          <span class="delimiter">}</span>
                          <span class="delimiter">)</span>;
                        <span class="delimiter">}</span>
                      <span class="delimiter">}</span>, <span class="keyword">new</span> F&lt;Codense&lt;Object&gt;, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Codense&lt;Object&gt; c<span class="delimiter">)</span> <span class="delimiter">{</span>
                      <span class="keyword">return</span> codense<span class="delimiter">(</span>c.sub, <span class="keyword">new</span> F&lt;Object, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Object o<span class="delimiter">)</span> <span class="delimiter">{</span>
                          <span class="keyword">return</span> c.cont.f<span class="delimiter">(</span>o<span class="delimiter">)</span>.bind<span class="delimiter">(</span>cont<span class="delimiter">)</span>;
                        <span class="delimiter">}</span>
                      <span class="delimiter">}</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                  <span class="delimiter">}</span>
                  <span class="delimiter">)</span>;
                <span class="delimiter">}</span>
              <span class="delimiter">}</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>, <span class="keyword">new</span> F&lt;Object, P1&lt;Trampoline&lt;A&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        public P1&lt;Trampoline&lt;A&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Object o<span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">return</span> <span class="keyword">new</span> P1&lt;Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            public Trampoline&lt;A&gt; _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span class="keyword">return</span> cont.f<span class="delimiter">(</span>o<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>;
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// A suspended computation that can be resumed.</span>
  <span class="keyword">private</span> static <span class="keyword">final</span> <span class="keyword">class</span> <a title="object fj.control.Trampoline.Suspend" id="25144">Suspend</a>&lt;<a id="25145">A</a>&gt; <span class="keyword">extends</span> Normal&lt;A&gt; <span class="delimiter">{</span>

    <span class="keyword">private</span> <span class="keyword">final</span> P1&lt;Trampoline&lt;A&gt;&gt; suspension;

    <span class="keyword">private</span> Suspend<span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;A&gt;&gt; s<span class="delimiter">)</span> <span class="delimiter">{</span>
      suspension = s;
    <span class="delimiter">}</span>

    public &lt;R&gt; R foldNormal<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, R&gt; pure, <span class="keyword">final</span> F&lt;P1&lt;Trampoline&lt;A&gt;&gt;, R&gt; k<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> k.f<span class="delimiter">(</span>suspension<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public &lt;R&gt; R fold<span class="delimiter">(</span><span class="keyword">final</span> F&lt;Normal&lt;A&gt;, R&gt; n, <span class="keyword">final</span> F&lt;Codense&lt;A&gt;, R&gt; gs<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> n.f<span class="delimiter">(</span><span class="keyword">this</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public Either&lt;P1&lt;Trampoline&lt;A&gt;&gt;, A&gt; resume<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> left<span class="delimiter">(</span>suspension<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// A pure value at the leaf of a computation.</span>
  <span class="keyword">private</span> static <span class="keyword">final</span> <span class="keyword">class</span> <a title="object fj.control.Trampoline.Pure" id="25148">Pure</a>&lt;<a id="25149">A</a>&gt; <span class="keyword">extends</span> Normal&lt;A&gt; <span class="delimiter">{</span>
    <span class="keyword">private</span> <span class="keyword">final</span> A value;

    <span class="keyword">private</span> Pure<span class="delimiter">(</span><span class="keyword">final</span> A a<span class="delimiter">)</span> <span class="delimiter">{</span>
      value = a;
    <span class="delimiter">}</span>

    public &lt;R&gt; R foldNormal<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, R&gt; pure, <span class="keyword">final</span> F&lt;P1&lt;Trampoline&lt;A&gt;&gt;, R&gt; k<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> pure.f<span class="delimiter">(</span>value<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public &lt;R&gt; R fold<span class="delimiter">(</span><span class="keyword">final</span> F&lt;Normal&lt;A&gt;, R&gt; n, <span class="keyword">final</span> F&lt;Codense&lt;A&gt;, R&gt; gs<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> n.f<span class="delimiter">(</span><span class="keyword">this</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public Either&lt;P1&lt;Trampoline&lt;A&gt;&gt;, A&gt; resume<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> right<span class="delimiter">(</span>value<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  @SuppressWarnings<span class="delimiter">(</span><span class="string">&quot;unchecked&quot;</span><span class="delimiter">)</span>
  <span class="keyword">protected</span> static &lt;<a title="Nothing" id="25153">A</a>, <a title="Nothing" id="25154">B</a>&gt; Codense&lt;<a href="#25154" title="B">B</a>&gt; <a title="[A, B](a: fj.control.Trampoline.Normal[A], k: fj.F[A,fj.control.Trampoline[B]])fj.control.Trampoline.Codense[B]" id="25150">codense</a><span class="delimiter">(</span><span class="keyword">final</span> Normal&lt;<a href="#25153" title="A">A</a>&gt; <a title="fj.control.Trampoline.Normal[A]" id="25191">a</a>, <span class="keyword">final</span> F&lt;<a href="#25153" title="A">A</a>, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25154" title="B">B</a>&gt;&gt; <a title="fj.F[A,fj.control.Trampoline[B]]" id="25192">k</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Codense&lt;B&gt;<span class="delimiter">(</span><span class="delimiter">(</span>Normal&lt;Object&gt;<span class="delimiter">)</span> a, <span class="delimiter">(</span>F&lt;Object, Trampoline&lt;B&gt;&gt;<span class="delimiter">)</span> k<span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @return The first-class version of `pure`.
   */</span>
  public static &lt;<a title="Nothing" id="25157">A</a>&gt; F&lt;<a href="#25157" title="A">A</a>, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25157" title="A">A</a>&gt;&gt; <a title="[A]()fj.F[A,fj.control.Trampoline[A]]" id="25155">pure</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;A, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> A a<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> pure<span class="delimiter">(</span>a<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Constructs a pure computation that results in the given value.
   *
   * @param a The value of the result.
   * @return A trampoline that results in the given value.
   */</span>
  public static &lt;<a title="Nothing" id="25160">A</a>&gt; <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25160" title="A">A</a>&gt; <a title="[A](a: A)fj.control.Trampoline[A]" id="25158">pure</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="#25160" title="A">A</a> <a title="A" id="25240">a</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Pure&lt;A&gt;<span class="delimiter">(</span>a<span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Suspends the given computation in a thunk.
   *
   * @param a A trampoline suspended in a thunk.
   * @return A trampoline whose next step runs the given thunk.
   */</span>
  public static &lt;<a title="Nothing" id="25163">A</a>&gt; <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25163" title="A">A</a>&gt; <a title="[A](a: fj.P1[fj.control.Trampoline[A]])fj.control.Trampoline[A]" id="25161">suspend</a><span class="delimiter">(</span><span class="keyword">final</span> P1&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25163" title="A">A</a>&gt;&gt; <a title="fj.P1[fj.control.Trampoline[A]]" id="25243">a</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Suspend&lt;A&gt;<span class="delimiter">(</span>a<span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @return The first-class version of `suspend`.
   */</span>
  public static &lt;<a title="Nothing" id="25166">A</a>&gt; F&lt;P1&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25166" title="A">A</a>&gt;&gt;, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25166" title="A">A</a>&gt;&gt; <a title="[A]()fj.F[fj.P1[fj.control.Trampoline[A]],fj.control.Trampoline[A]]" id="25164">suspend_</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;P1&lt;Trampoline&lt;A&gt;&gt;, Trampoline&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Trampoline&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;A&gt;&gt; trampolineP1<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> suspend<span class="delimiter">(</span>trampolineP1<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;<a title="Nothing" id="25200">R</a>&gt; <a href="#25200" title="R">R</a> <a title="[R](n: fj.F[fj.control.Trampoline.Normal[A],R], gs: fj.F[fj.control.Trampoline.Codense[A],R])R" id="25198">fold</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;Normal&lt;<a href="#9835" title="A">A</a>&gt;, <a href="#25200" title="R">R</a>&gt; <a title="fj.F[fj.control.Trampoline.Normal[A],R]" id="25253">n</a>, <span class="keyword">final</span> F&lt;Codense&lt;<a href="#9835" title="A">A</a>&gt;, <a href="#25200" title="R">R</a>&gt; <a title="fj.F[fj.control.Trampoline.Codense[A],R]" id="25254">gs</a><span class="delimiter">)</span>;

  <span class="comment">/**
   * Binds the given continuation to the result of this trampoline.
   *
   * @param f A function that constructs a trampoline from the result of this trampoline.
   * @return A new trampoline that runs this trampoline, then continues with the given function.
   */</span>
  public <span class="keyword">abstract</span> &lt;<a title="Nothing" id="25203">B</a>&gt; <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25203" title="B">B</a>&gt; <a title="[B](f: fj.F[A,fj.control.Trampoline[B]])fj.control.Trampoline[B]" id="25201">bind</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#9835" title="A">A</a>, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25203" title="B">B</a>&gt;&gt; <a title="fj.F[A,fj.control.Trampoline[B]]" id="25257">f</a><span class="delimiter">)</span>;

  <span class="comment">/**
   * Maps the given function across the result of this trampoline.
   *
   * @param f A function that gets applied to the result of this trampoline.
   * @return A new trampoline that runs this trampoline, then applies the given function to the result.
   */</span>
  public <span class="keyword">final</span> &lt;<a title="Nothing" id="25206">B</a>&gt; <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25206" title="B">B</a>&gt; <a title="[B](f: fj.F[A,B])fj.control.Trampoline[B]" id="25204">map</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#9835" title="A">A</a>, <a href="#25206" title="B">B</a>&gt; <a title="fj.F[A,B]" id="25259">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> bind<span class="delimiter">(</span>Trampoline.&lt;B&gt;pure<span class="delimiter">(</span><span class="delimiter">)</span>.o<span class="delimiter">(</span>f<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @return The first-class version of `bind`.
   */</span>
  public static &lt;<a title="Nothing" id="25170">A</a>, <a title="Nothing" id="25171">B</a>&gt; F&lt;F&lt;<a href="#25170" title="A">A</a>, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25171" title="B">B</a>&gt;&gt;, F&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25170" title="A">A</a>&gt;, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25171" title="B">B</a>&gt;&gt;&gt; <a title="[A, B]()fj.F[fj.F[A,fj.control.Trampoline[B]],fj.F[fj.control.Trampoline[A],fj.control.Trampoline[B]]]" id="25167">bind_</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;F&lt;A, Trampoline&lt;B&gt;&gt;, F&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public F&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, Trampoline&lt;B&gt;&gt; f<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> <span class="keyword">new</span> F&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          public Trampoline&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Trampoline&lt;A&gt; a<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> a.bind<span class="delimiter">(</span>f<span class="delimiter">)</span>;
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @return The first-class version of `map`.
   */</span>
  public static &lt;<a title="Nothing" id="25175">A</a>, <a title="Nothing" id="25176">B</a>&gt; F&lt;F&lt;<a href="#25175" title="A">A</a>, <a href="#25176" title="B">B</a>&gt;, F&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25175" title="A">A</a>&gt;, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25176" title="B">B</a>&gt;&gt;&gt; <a title="[A, B]()fj.F[fj.F[A,B],fj.F[fj.control.Trampoline[A],fj.control.Trampoline[B]]]" id="25172">map_</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;F&lt;A, B&gt;, F&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public F&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, B&gt; f<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> <span class="keyword">new</span> F&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          public Trampoline&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Trampoline&lt;A&gt; a<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> a.map<span class="delimiter">(</span>f<span class="delimiter">)</span>;
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @return The first-class version of `resume`.
   */</span>
  public static &lt;<a title="Nothing" id="25179">A</a>&gt; F&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25179" title="A">A</a>&gt;, Either&lt;P1&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25179" title="A">A</a>&gt;&gt;, <a href="#25179" title="A">A</a>&gt;&gt; <a title="[A]()fj.F[fj.control.Trampoline[A],fj.data.Either[fj.P1[fj.control.Trampoline[A]],A]]" id="25177">resume_</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;Trampoline&lt;A&gt;, Either&lt;P1&lt;Trampoline&lt;A&gt;&gt;, A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Either&lt;P1&lt;Trampoline&lt;A&gt;&gt;, A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Trampoline&lt;A&gt; aTrampoline<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> aTrampoline.resume<span class="delimiter">(</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Runs a single step of this computation.
   *
   * @return The next step of this compuation.
   */</span>
  public <span class="keyword">abstract</span> Either&lt;P1&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#9835" title="A">A</a>&gt;&gt;, <a href="#9835" title="A">A</a>&gt; <a title="()fj.data.Either[fj.P1[fj.control.Trampoline[A]],A]" id="25207">resume</a><span class="delimiter">(</span><span class="delimiter">)</span>;

  <span class="comment">/**
   * Runs this computation all the way to the end, in constant stack.
   *
   * @return The end result of this computation.
   */</span>
  @SuppressWarnings<span class="delimiter">(</span><span class="string">&quot;LoopStatementThatDoesntLoop&quot;</span><span class="delimiter">)</span>
  public <a href="#9835" title="A">A</a> <a title="()A" id="25208">run</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    Trampoline&lt;A&gt; current = <span class="keyword">this</span>;
    <span class="keyword">while</span> <span class="delimiter">(</span><span class="keyword">true</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">final</span> Either&lt;P1&lt;Trampoline&lt;A&gt;&gt;, A&gt; x = current.resume<span class="delimiter">(</span><span class="delimiter">)</span>;
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;A&gt;&gt; t : x.left<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        current = t._1<span class="delimiter">(</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> A a : x.right<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> a;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Performs function application within a Trampoline (applicative functor pattern).
   *
   * @param lf A Trampoline resulting in the function to apply.
   * @return A new Trampoline after applying the given function through this Trampoline.
   */</span>
  public <span class="keyword">final</span> &lt;<a title="Nothing" id="25211">B</a>&gt; <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25211" title="B">B</a>&gt; <a title="[B](lf: fj.control.Trampoline[fj.F[A,B]])fj.control.Trampoline[B]" id="25209">apply</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;F&lt;<a href="#9835" title="A">A</a>, <a href="#25211" title="B">B</a>&gt;&gt; <a title="fj.control.Trampoline[fj.F[A,B]]" id="25261">lf</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> lf.bind<span class="delimiter">(</span><span class="keyword">new</span> F&lt;F&lt;A, B&gt;, Trampoline&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Trampoline&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, B&gt; f<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> map<span class="delimiter">(</span>f<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Binds the given function across the result of this Trampoline and the given Trampoline.
   *
   * @param lb A given Trampoline to bind the given function with.
   * @param f  The function to combine the results of this Trampoline and the given Trampoline.
   * @return A new Trampoline combining the results of the two trampolines with the given function.
   */</span>
  public <span class="keyword">final</span> &lt;<a title="Nothing" id="25215">B</a>, <a title="Nothing" id="25216">C</a>&gt; <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25216" title="C">C</a>&gt; <a title="[B, C](lb: fj.control.Trampoline[B], f: fj.F[A,fj.F[B,C]])fj.control.Trampoline[C]" id="25212">bind</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25215" title="B">B</a>&gt; <a title="fj.control.Trampoline[B]" id="25263">lb</a>, <span class="keyword">final</span> F&lt;<a href="#9835" title="A">A</a>, F&lt;<a href="#25215" title="B">B</a>, <a href="#25216" title="C">C</a>&gt;&gt; <a title="fj.F[A,fj.F[B,C]]" id="25264">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> lb.apply<span class="delimiter">(</span>map<span class="delimiter">(</span>f<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>


  <span class="comment">/**
   * Promotes the given function of arity-2 to a function on Trampolines.
   *
   * @param f The function to promote to a function on Trampolines.
   * @return The given function, promoted to operate on Trampolines.
   */</span>
  public static &lt;<a title="Nothing" id="25184">A</a>, <a title="Nothing" id="25185">B</a>, <a title="Nothing" id="25186">C</a>&gt; F&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25184" title="A">A</a>&gt;, F&lt;<a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25185" title="B">B</a>&gt;, <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25186" title="C">C</a>&gt;&gt;&gt; <a title="[A, B, C](f: fj.F[A,fj.F[B,C]])fj.F[fj.control.Trampoline[A],fj.F[fj.control.Trampoline[B],fj.control.Trampoline[C]]]" id="25180">liftM2</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#25184" title="A">A</a>, F&lt;<a href="#25185" title="B">B</a>, <a href="#25186" title="C">C</a>&gt;&gt; <a title="fj.F[A,fj.F[B,C]]" id="25250">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> curry<span class="delimiter">(</span><span class="keyword">new</span> F2&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;, Trampoline&lt;C&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Trampoline&lt;C&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Trampoline&lt;A&gt; as, <span class="keyword">final</span> Trampoline&lt;B&gt; bs<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> as.bind<span class="delimiter">(</span>bs, f<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Combines two trampolines so they run cooperatively. The results are combined with the given function.
   *
   * @param b Another trampoline to combine with this trampoline.
   * @param f A function to combine the results of the two trampolines.
   * @return A new trampoline that runs this trampoline and the given trampoline simultaneously.
   */</span>
  @SuppressWarnings<span class="delimiter">(</span><span class="string">&quot;LoopStatementThatDoesntLoop&quot;</span><span class="delimiter">)</span>
  public &lt;<a title="Nothing" id="25220">B</a>, <a title="Nothing" id="25221">C</a>&gt; <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25221" title="C">C</a>&gt; <a title="[B, C](b: fj.control.Trampoline[B], f: fj.F2[A,B,C])fj.control.Trampoline[C]" id="25217">zipWith</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="#9834" title="fj.control.Trampoline">Trampoline</a>&lt;<a href="#25220" title="B">B</a>&gt; <a title="fj.control.Trampoline[B]" id="25267">b</a>, <span class="keyword">final</span> F2&lt;<a href="#9835" title="A">A</a>, <a href="#25220" title="B">B</a>, <a href="#25221" title="C">C</a>&gt; <a title="fj.F2[A,B,C]" id="25268">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">final</span> Either&lt;P1&lt;Trampoline&lt;A&gt;&gt;, A&gt; ea = resume<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="keyword">final</span> Either&lt;P1&lt;Trampoline&lt;B&gt;&gt;, B&gt; eb = b.resume<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;A&gt;&gt; x : ea.left<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;B&gt;&gt; y : eb.left<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> suspend<span class="delimiter">(</span>P1.bind<span class="delimiter">(</span>x, y, <span class="keyword">new</span> F2&lt;Trampoline&lt;A&gt;, Trampoline&lt;B&gt;, Trampoline&lt;C&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          public Trampoline&lt;C&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Trampoline&lt;A&gt; ta, <span class="keyword">final</span> Trampoline&lt;B&gt; tb<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> suspend<span class="delimiter">(</span><span class="keyword">new</span> P1&lt;Trampoline&lt;C&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              public Trampoline&lt;C&gt; _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> ta.zipWith<span class="delimiter">(</span>tb, f<span class="delimiter">)</span>;
              <span class="delimiter">}</span>
            <span class="delimiter">}</span><span class="delimiter">)</span>;
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>.curry<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> B y : eb.right<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> suspend<span class="delimiter">(</span>x.map<span class="delimiter">(</span><span class="keyword">new</span> F&lt;Trampoline&lt;A&gt;, Trampoline&lt;C&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          public Trampoline&lt;C&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Trampoline&lt;A&gt; ta<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> ta.map<span class="delimiter">(</span>f.flip<span class="delimiter">(</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>y<span class="delimiter">)</span><span class="delimiter">)</span>;
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> A x : ea.right<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> B y : eb.right<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> suspend<span class="delimiter">(</span><span class="keyword">new</span> P1&lt;Trampoline&lt;C&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          public Trampoline&lt;C&gt; _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> pure<span class="delimiter">(</span>f.f<span class="delimiter">(</span>x, y<span class="delimiter">)</span><span class="delimiter">)</span>;
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="keyword">final</span> P1&lt;Trampoline&lt;B&gt;&gt; y : eb.left<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> suspend<span class="delimiter">(</span>y.map<span class="delimiter">(</span>liftM2<span class="delimiter">(</span>f.curry<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>pure<span class="delimiter">(</span>x<span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="keyword">throw</span> Bottom.error<span class="delimiter">(</span><span class="string">&quot;Match error: Trampoline is neither done nor suspended.&quot;</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>