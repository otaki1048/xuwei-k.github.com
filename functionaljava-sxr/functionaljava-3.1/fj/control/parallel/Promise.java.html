<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>fj/control/parallel/Promise.java</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> fj.control.parallel;

<span class="keyword">import</span> fj.Effect;
<span class="keyword">import</span> fj.F;
<span class="keyword">import</span> fj.F2;
<span class="keyword">import</span> fj.P;
<span class="keyword">import</span> fj.P1;
<span class="keyword">import</span> fj.P2;
<span class="keyword">import</span> fj.Unit;
<span class="keyword">import</span> static fj.P.p;
<span class="keyword">import</span> static fj.Function.curry;
<span class="keyword">import</span> static fj.Function.identity;
<span class="keyword">import</span> static fj.control.parallel.Actor.actor;
<span class="keyword">import</span> static fj.control.parallel.Callables.normalise;
<span class="keyword">import</span> static fj.control.parallel.Actor.queueActor;
<span class="keyword">import</span> fj.data.Either;
<span class="keyword">import</span> fj.data.List;
<span class="keyword">import</span> fj.data.Option;
<span class="keyword">import</span> static fj.data.Option.none;
<span class="keyword">import</span> static fj.data.Option.some;
<span class="keyword">import</span> fj.data.Stream;

<span class="keyword">import</span> java.util.LinkedList;
<span class="keyword">import</span> java.util.Queue;
<span class="keyword">import</span> java.util.concurrent.Callable;
<span class="keyword">import</span> java.util.concurrent.CountDownLatch;
<span class="keyword">import</span> java.util.concurrent.TimeUnit;

<span class="comment">/**
 * Represents a non-blocking future value. Products, functions, and actors, given to the methods on this class,
 * are executed concurrently, and the Promise serves as a handle on the result of the computation. Provides monadic
 * operations so that future computations can be combined
 * &lt;p/&gt;
 * Author: Runar
 */</span>
public <span class="keyword">final</span> <span class="keyword">class</span> <a title="object fj.control.parallel.Promise" id="9951">Promise</a>&lt;<a title="Nothing" id="9952">A</a>&gt; <span class="delimiter">{</span>

  <span class="keyword">private</span> <span class="keyword">final</span> <a href="Actor.java.html#9875" title="fj.control.parallel.Actor">Actor</a>&lt;P2&lt;Either&lt;P1&lt;<a href="#9952" title="A">A</a>&gt;, <a href="Actor.java.html#9875" title="fj.control.parallel.Actor">Actor</a>&lt;<a href="#9952" title="A">A</a>&gt;&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#9952" title="A">A</a>&gt;&gt;&gt; <a title="fj.control.parallel.Actor[fj.P2[fj.data.Either[fj.P1[A],fj.control.parallel.Actor[A]],fj.control.parallel.Promise[A]]]" id="19746">actor</a>;

  <span class="keyword">private</span> <span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="19747">s</a>;

  <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch <a title="java.util.concurrent.CountDownLatch" id="19748">l</a> = <span class="keyword">new</span> CountDownLatch<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span>;
  <span class="keyword">private</span> volatile Option&lt;<a href="#9952" title="A">A</a>&gt; <a title="fj.data.Option[A]" id="19749">v</a> = none<span class="delimiter">(</span><span class="delimiter">)</span>;
  <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;<a href="Actor.java.html#9875" title="fj.control.parallel.Actor">Actor</a>&lt;<a href="#9952" title="A">A</a>&gt;&gt; <a title="java.util.Queue[fj.control.parallel.Actor[A]]" id="19750">waiting</a> = <span class="keyword">new</span> LinkedList&lt;Actor&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;

  <span class="keyword">private</span> Promise<span class="delimiter">(</span><span class="keyword">final</span> Strategy&lt;Unit&gt; s, <span class="keyword">final</span> Actor&lt;P2&lt;Either&lt;P1&lt;A&gt;, Actor&lt;A&gt;&gt;, Promise&lt;A&gt;&gt;&gt; qa<span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">this</span>.s = s;
    actor = qa;
  <span class="delimiter">}</span>

  <span class="keyword">private</span> static &lt;<a title="Nothing" id="25780">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25780" title="A">A</a>&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit])fj.control.parallel.Promise[A]" id="25778">mkPromise</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25838">s</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">final</span> Actor&lt;P2&lt;Either&lt;P1&lt;A&gt;, Actor&lt;A&gt;&gt;, Promise&lt;A&gt;&gt;&gt; q =
        queueActor<span class="delimiter">(</span>s, <span class="keyword">new</span> Effect&lt;P2&lt;Either&lt;P1&lt;A&gt;, Actor&lt;A&gt;&gt;, Promise&lt;A&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          public void e<span class="delimiter">(</span><span class="keyword">final</span> P2&lt;Either&lt;P1&lt;A&gt;, Actor&lt;A&gt;&gt;, Promise&lt;A&gt;&gt; p<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">final</span> Promise&lt;A&gt; snd = p._2<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">final</span> Queue&lt;Actor&lt;A&gt;&gt; as = snd.waiting;
            <span class="keyword">if</span> <span class="delimiter">(</span>p._1<span class="delimiter">(</span><span class="delimiter">)</span>.isLeft<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <span class="keyword">final</span> A a = p._1<span class="delimiter">(</span><span class="delimiter">)</span>.left<span class="delimiter">(</span><span class="delimiter">)</span>.value<span class="delimiter">(</span><span class="delimiter">)</span>._1<span class="delimiter">(</span><span class="delimiter">)</span>;
              snd.v = some<span class="delimiter">(</span>a<span class="delimiter">)</span>;
              snd.l.countDown<span class="delimiter">(</span><span class="delimiter">)</span>;
              <span class="keyword">while</span> <span class="delimiter">(</span>!as.isEmpty<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
                as.remove<span class="delimiter">(</span><span class="delimiter">)</span>.act<span class="delimiter">(</span>a<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>snd.v.isNone<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
              as.add<span class="delimiter">(</span>p._1<span class="delimiter">(</span><span class="delimiter">)</span>.right<span class="delimiter">(</span><span class="delimiter">)</span>.value<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            <span class="keyword">else</span>
              p._1<span class="delimiter">(</span><span class="delimiter">)</span>.right<span class="delimiter">(</span><span class="delimiter">)</span>.value<span class="delimiter">(</span><span class="delimiter">)</span>.act<span class="delimiter">(</span>snd.v.some<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>;
    <span class="keyword">return</span> <span class="keyword">new</span> Promise&lt;A&gt;<span class="delimiter">(</span>s, q<span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Promises to provide the value of the given 1-product, in the future.
   * Represents the unit function for promises.
   *
   * @param s The strategy with which to fulfil the promise.
   * @param a The 1-product to evaluate concurrently.
   * @return A promise representing the future result of evaluating the given 1-product.
   */</span>
  public static &lt;<a title="Nothing" id="25783">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25783" title="A">A</a>&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit], a: fj.P1[A])fj.control.parallel.Promise[A]" id="25781">promise</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25840">s</a>, <span class="keyword">final</span> P1&lt;<a href="#25783" title="A">A</a>&gt; <a title="fj.P1[A]" id="25841">a</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">final</span> Promise&lt;A&gt; p = mkPromise<span class="delimiter">(</span>s<span class="delimiter">)</span>;
    p.actor.act<span class="delimiter">(</span>P.p<span class="delimiter">(</span>Either.&lt;P1&lt;A&gt;, Actor&lt;A&gt;&gt;left<span class="delimiter">(</span>a<span class="delimiter">)</span>, p<span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="keyword">return</span> p;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Provides a first-class unit function for promises.
   *
   * @param s The strategy with which to fulfil promises.
   * @return A function that, given a 1-product, yields a promise of that product's value.
   */</span>
  public static &lt;<a title="Nothing" id="25786">A</a>&gt; F&lt;P1&lt;<a href="#25786" title="A">A</a>&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25786" title="A">A</a>&gt;&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit])fj.F[fj.P1[A],fj.control.parallel.Promise[A]]" id="25784">promise</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25845">s</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;P1&lt;A&gt;, Promise&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;A&gt; f<span class="delimiter">(</span><span class="keyword">final</span> P1&lt;A&gt; a<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> promise<span class="delimiter">(</span>s, a<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Provides a promise to call the given Callable in the future.
   *
   * @param s The strategy with which to fulfil the promise.
   * @param a The Callable to evaluate concurrently.
   * @return A promise of a new Callable that will return the result of calling the given Callable.
   */</span>
  public static &lt;<a title="Nothing" id="25789">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;Callable&lt;<a href="#25789" title="A">A</a>&gt;&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit], a: java.util.concurrent.Callable[A])fj.control.parallel.Promise[java.util.concurrent.Callable[A]]" id="25787">promise</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25847">s</a>, <span class="keyword">final</span> Callable&lt;<a href="#25789" title="A">A</a>&gt; <a title="java.util.concurrent.Callable[A]" id="25848">a</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> promise<span class="delimiter">(</span>s, <span class="keyword">new</span> P1&lt;Callable&lt;A&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Callable&lt;A&gt; _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> normalise<span class="delimiter">(</span>a<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Transforms any function so that it returns a promise of a value instead of an actual value.
   * Represents the Kleisli arrow for the Promise monad.
   *
   * @param s The strategy with which to fulfil the promise.
   * @param f The function to turn into a promise-valued function.
   * @return The given function transformed into a function that returns a promise.
   */</span>
  public static &lt;<a title="Nothing" id="25793">A</a>, <a title="Nothing" id="25794">B</a>&gt; F&lt;<a href="#25793" title="A">A</a>, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25794" title="B">B</a>&gt;&gt; <a title="[A, B](s: fj.control.parallel.Strategy[fj.Unit], f: fj.F[A,B])fj.F[A,fj.control.parallel.Promise[B]]" id="25790">promise</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25852">s</a>, <span class="keyword">final</span> F&lt;<a href="#25793" title="A">A</a>, <a href="#25794" title="B">B</a>&gt; <a title="fj.F[A,B]" id="25853">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;A, Promise&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> A a<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> promise<span class="delimiter">(</span>s, P1.curry<span class="delimiter">(</span>f<span class="delimiter">)</span>.f<span class="delimiter">(</span>a<span class="delimiter">)</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Promises to send a value to the given actor in the future.
   *
   * @param a An actor that will receive this Promise's value in the future.
   */</span>
  public void <a title="(a: fj.control.parallel.Actor[A])Unit" id="19752">to</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Actor.java.html#9875" title="fj.control.parallel.Actor">Actor</a>&lt;<a href="#9952" title="A">A</a>&gt; <a title="fj.control.parallel.Actor[A]" id="25916">a</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    actor.act<span class="delimiter">(</span>P.p<span class="delimiter">(</span>Either.&lt;P1&lt;A&gt;, Actor&lt;A&gt;&gt;right<span class="delimiter">(</span>a<span class="delimiter">)</span>, <span class="keyword">this</span><span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Provides a promise to apply the given function to this promise's future value (covariant functor pattern).
   *
   * @param f The function to apply to this promise's future value.
   * @return A promise representing the future result of applying the given function to this promised value.
   */</span>
  public &lt;<a title="Nothing" id="19755">B</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19755" title="B">B</a>&gt; <a title="[B](f: fj.F[A,B])fj.control.parallel.Promise[B]" id="19753">fmap</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#9952" title="A">A</a>, <a href="#19755" title="B">B</a>&gt; <a title="fj.F[A,B]" id="25917">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> bind<span class="delimiter">(</span>promise<span class="delimiter">(</span>s, f<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Promotes any function to a transformation between promises (covariant functor pattern).
   *
   * @param f The function to promote to a transformation between promises.
   * @return That function lifted to a function on Promises.
   */</span>
  public static &lt;<a title="Nothing" id="25798">A</a>, <a title="Nothing" id="25799">B</a>&gt; F&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25798" title="A">A</a>&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25799" title="B">B</a>&gt;&gt; <a title="[A, B](f: fj.F[A,B])fj.F[fj.control.parallel.Promise[A],fj.control.parallel.Promise[B]]" id="25795">fmap_</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#25798" title="A">A</a>, <a href="#25799" title="B">B</a>&gt; <a title="fj.F[A,B]" id="25857">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;Promise&lt;A&gt;, Promise&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Promise&lt;A&gt; a<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> a.fmap<span class="delimiter">(</span>f<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Turns a promise of a promise into just a promise. The join function for the Promise monad.
   * Promise to give it a Promise of an A, and it will promise you an A in return.
   *
   * @param p A promise of a promise.
   * @return The promised promise.
   */</span>
  public static &lt;<a title="Nothing" id="25802">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25802" title="A">A</a>&gt; <a title="[A](p: fj.control.parallel.Promise[fj.control.parallel.Promise[A]])fj.control.parallel.Promise[A]" id="25800">join</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25802" title="A">A</a>&gt;&gt; <a title="fj.control.parallel.Promise[fj.control.parallel.Promise[A]]" id="25860">p</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">final</span> F&lt;Promise&lt;A&gt;, Promise&lt;A&gt;&gt; id = identity<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="keyword">return</span> p.bind<span class="delimiter">(</span>id<span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Turns a product of a promise into just a promise. Does not block on the product by calling it,
   * but creates a new promise with a final join.
   *
   * @param s The strategy with which to fulfil the promise.
   * @param p A product-1 of a promise to turn into just a promise.
   * @return The joined promise.
   */</span>
  public static &lt;<a title="Nothing" id="25805">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25805" title="A">A</a>&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit], p: fj.P1[fj.control.parallel.Promise[A]])fj.control.parallel.Promise[A]" id="25803">join</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25863">s</a>, <span class="keyword">final</span> P1&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25805" title="A">A</a>&gt;&gt; <a title="fj.P1[fj.control.parallel.Promise[A]]" id="25864">p</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> join<span class="delimiter">(</span>promise<span class="delimiter">(</span>s, p<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Binds the given function over this promise, with a final join.
   * The bind function for the Promise monad.
   *
   * @param f The function to bind over this promise.
   * @return The result of applying the given function to this promised value.
   */</span>
  public &lt;<a title="Nothing" id="19758">B</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19758" title="B">B</a>&gt; <a title="[B](f: fj.F[A,fj.control.parallel.Promise[B]])fj.control.parallel.Promise[B]" id="19756">bind</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#9952" title="A">A</a>, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19758" title="B">B</a>&gt;&gt; <a title="fj.F[A,fj.control.parallel.Promise[B]]" id="25919">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">final</span> Promise&lt;B&gt; r = mkPromise<span class="delimiter">(</span>s<span class="delimiter">)</span>;
    <span class="keyword">final</span> Actor&lt;B&gt; ab = actor<span class="delimiter">(</span>s, <span class="keyword">new</span> Effect&lt;B&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public void e<span class="delimiter">(</span><span class="keyword">final</span> B b<span class="delimiter">)</span> <span class="delimiter">{</span>
        r.actor.act<span class="delimiter">(</span>P.p<span class="delimiter">(</span>Either.&lt;P1&lt;B&gt;, Actor&lt;B&gt;&gt;left<span class="delimiter">(</span>P.p<span class="delimiter">(</span>b<span class="delimiter">)</span><span class="delimiter">)</span>, r<span class="delimiter">)</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>;
    to<span class="delimiter">(</span>ab.promise<span class="delimiter">(</span><span class="delimiter">)</span>.comap<span class="delimiter">(</span>f<span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="keyword">return</span> r;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Performs function application within a promise (applicative functor pattern).
   *
   * @param pf The promised function to apply.
   * @return A new promise after applying the given promised function to this promise.
   */</span>
  public &lt;<a title="Nothing" id="19761">B</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19761" title="B">B</a>&gt; <a title="[B](pf: fj.control.parallel.Promise[fj.F[A,B]])fj.control.parallel.Promise[B]" id="19759">apply</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;F&lt;<a href="#9952" title="A">A</a>, <a href="#19761" title="B">B</a>&gt;&gt; <a title="fj.control.parallel.Promise[fj.F[A,B]]" id="25921">pf</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> pf.bind<span class="delimiter">(</span><span class="keyword">new</span> F&lt;F&lt;A, B&gt;, Promise&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> F&lt;A, B&gt; f<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> fmap<span class="delimiter">(</span>f<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Binds the given function to this promise and the given promise, with a final join.
   *
   * @param pb A promise with which to bind the given function.
   * @param f  The function to apply to the given promised values.
   * @return A new promise after performing the map, then final join.
   */</span>
  public &lt;<a title="Nothing" id="19765">B</a>, <a title="Nothing" id="19766">C</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19766" title="C">C</a>&gt; <a title="[B, C](pb: fj.control.parallel.Promise[B], f: fj.F[A,fj.F[B,C]])fj.control.parallel.Promise[C]" id="19762">bind</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19765" title="B">B</a>&gt; <a title="fj.control.parallel.Promise[B]" id="25923">pb</a>, <span class="keyword">final</span> F&lt;<a href="#9952" title="A">A</a>, F&lt;<a href="#19765" title="B">B</a>, <a href="#19766" title="C">C</a>&gt;&gt; <a title="fj.F[A,fj.F[B,C]]" id="25924">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> pb.apply<span class="delimiter">(</span>fmap<span class="delimiter">(</span>f<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Binds the given function to this promise and the given promise, with a final join.
   *
   * @param p A promise with which to bind the given function.
   * @param f The function to apply to the given promised values.
   * @return A new promise after performing the map, then final join.
   */</span>
  public &lt;<a title="Nothing" id="19770">B</a>, <a title="Nothing" id="19771">C</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19771" title="C">C</a>&gt; <a title="[B, C](p: fj.P1[fj.control.parallel.Promise[B]], f: fj.F[A,fj.F[B,C]])fj.control.parallel.Promise[C]" id="19767">bind</a><span class="delimiter">(</span><span class="keyword">final</span> P1&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19770" title="B">B</a>&gt;&gt; <a title="fj.P1[fj.control.parallel.Promise[B]]" id="25927">p</a>, <span class="keyword">final</span> F&lt;<a href="#9952" title="A">A</a>, F&lt;<a href="#19770" title="B">B</a>, <a href="#19771" title="C">C</a>&gt;&gt; <a title="fj.F[A,fj.F[B,C]]" id="25928">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> join<span class="delimiter">(</span>s, p<span class="delimiter">)</span>.apply<span class="delimiter">(</span>fmap<span class="delimiter">(</span>f<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Promotes a function of arity-2 to a function on promises.
   *
   * @param f The function to promote.
   * @return A function of arity-2 promoted to map over promises.
   */</span>
  public static &lt;<a title="Nothing" id="25810">A</a>, <a title="Nothing" id="25811">B</a>, <a title="Nothing" id="25812">C</a>&gt; F&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25810" title="A">A</a>&gt;, F&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25811" title="B">B</a>&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25812" title="C">C</a>&gt;&gt;&gt; <a title="[A, B, C](f: fj.F[A,fj.F[B,C]])fj.F[fj.control.parallel.Promise[A],fj.F[fj.control.parallel.Promise[B],fj.control.parallel.Promise[C]]]" id="25806">liftM2</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#25810" title="A">A</a>, F&lt;<a href="#25811" title="B">B</a>, <a href="#25812" title="C">C</a>&gt;&gt; <a title="fj.F[A,fj.F[B,C]]" id="25868">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> curry<span class="delimiter">(</span><span class="keyword">new</span> F2&lt;Promise&lt;A&gt;, Promise&lt;B&gt;, Promise&lt;C&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;C&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Promise&lt;A&gt; ca, <span class="keyword">final</span> Promise&lt;B&gt; cb<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> ca.bind<span class="delimiter">(</span>cb, f<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Turns a List of promises into a single promise of a List.
   *
   * @param s  The strategy with which to sequence the promises.
   * @param as The list of promises to transform.
   * @return A single promise for the given List.
   */</span>
  public static &lt;<a title="Nothing" id="25815">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;List&lt;<a href="#25815" title="A">A</a>&gt;&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit], as: fj.data.List[fj.control.parallel.Promise[A]])fj.control.parallel.Promise[fj.data.List[A]]" id="25813">sequence</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25871">s</a>, <span class="keyword">final</span> List&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25815" title="A">A</a>&gt;&gt; <a title="fj.data.List[fj.control.parallel.Promise[A]]" id="25872">as</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> join<span class="delimiter">(</span>foldRight<span class="delimiter">(</span>s, liftM2<span class="delimiter">(</span>List.&lt;A&gt;cons<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>, promise<span class="delimiter">(</span>s, P.p<span class="delimiter">(</span>List.&lt;A&gt;nil<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>as<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * First-class version of the sequence function through a List.
   *
   * @param s The strategy with which to sequence a given list of promises.
   * @return A function that turns a list of promises into a single promise of a list.
   */</span>
  public static &lt;<a title="Nothing" id="25818">A</a>&gt; F&lt;List&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25818" title="A">A</a>&gt;&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;List&lt;<a href="#25818" title="A">A</a>&gt;&gt;&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit])fj.F[fj.data.List[fj.control.parallel.Promise[A]],fj.control.parallel.Promise[fj.data.List[A]]]" id="25816">sequence</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25876">s</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;List&lt;Promise&lt;A&gt;&gt;, Promise&lt;List&lt;A&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;List&lt;A&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> List&lt;Promise&lt;A&gt;&gt; as<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> sequence<span class="delimiter">(</span>s, as<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Turns a Stream of promises into a single promise of a Stream.
   *
   * @param s  The strategy with which to sequence the promises.
   * @param as The Stream of promises to transform.
   * @return A single promise for the given Stream.
   */</span>
  public static &lt;<a title="Nothing" id="25821">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;Stream&lt;<a href="#25821" title="A">A</a>&gt;&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit], as: fj.data.Stream[fj.control.parallel.Promise[A]])fj.control.parallel.Promise[fj.data.Stream[A]]" id="25819">sequence</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25878">s</a>, <span class="keyword">final</span> Stream&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25821" title="A">A</a>&gt;&gt; <a title="fj.data.Stream[fj.control.parallel.Promise[A]]" id="25879">as</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> join<span class="delimiter">(</span>foldRightS<span class="delimiter">(</span>s, curry<span class="delimiter">(</span><span class="keyword">new</span> F2&lt;Promise&lt;A&gt;, P1&lt;Promise&lt;Stream&lt;A&gt;&gt;&gt;, Promise&lt;Stream&lt;A&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;Stream&lt;A&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Promise&lt;A&gt; o, <span class="keyword">final</span> P1&lt;Promise&lt;Stream&lt;A&gt;&gt;&gt; p<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> o.bind<span class="delimiter">(</span><span class="keyword">new</span> F&lt;A, Promise&lt;Stream&lt;A&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          public Promise&lt;Stream&lt;A&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> A a<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> p._1<span class="delimiter">(</span><span class="delimiter">)</span>.fmap<span class="delimiter">(</span>Stream.&lt;A&gt;cons_<span class="delimiter">(</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>a<span class="delimiter">)</span><span class="delimiter">)</span>;
          <span class="delimiter">}</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>, promise<span class="delimiter">(</span>s, P.p<span class="delimiter">(</span>Stream.&lt;A&gt;nil<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>as<span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * First-class version of the sequence function through a Stream.
   *
   * @param s The strategy with which to sequence a given Stream of promises.
   * @return A function that turns a list of promises into a single promise of a Stream..
   */</span>
  public static &lt;<a title="Nothing" id="25824">A</a>&gt; F&lt;List&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25824" title="A">A</a>&gt;&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;List&lt;<a href="#25824" title="A">A</a>&gt;&gt;&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit])fj.F[fj.data.List[fj.control.parallel.Promise[A]],fj.control.parallel.Promise[fj.data.List[A]]]" id="25822">sequenceS</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25883">s</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;List&lt;Promise&lt;A&gt;&gt;, Promise&lt;List&lt;A&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;List&lt;A&gt;&gt; f<span class="delimiter">(</span><span class="keyword">final</span> List&lt;Promise&lt;A&gt;&gt; as<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> sequence<span class="delimiter">(</span>s, as<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Transforms a product of a promise to a promise of a product.
   *
   * @param s The strategy with which to traverse the promise.
   * @param p A product of a promise to traverse.
   * @return A promised product.
   */</span>
  public static &lt;<a title="Nothing" id="25827">A</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;P1&lt;<a href="#25827" title="A">A</a>&gt;&gt; <a title="[A](s: fj.control.parallel.Strategy[fj.Unit], p: fj.P1[fj.control.parallel.Promise[A]])fj.control.parallel.Promise[fj.P1[A]]" id="25825">sequence</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25885">s</a>, <span class="keyword">final</span> P1&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25827" title="A">A</a>&gt;&gt; <a title="fj.P1[fj.control.parallel.Promise[A]]" id="25886">p</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> join<span class="delimiter">(</span>promise<span class="delimiter">(</span>s, p<span class="delimiter">)</span><span class="delimiter">)</span>.fmap<span class="delimiter">(</span>P.&lt;A&gt;p1<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Performs a right-fold reduction across a list in constant stack space.
   *
   * @param s The strategy with which to fold the list.
   * @param f The function to apply on each element of the list.
   * @param b The beginning value to start the application from.
   * @return The final result after the right-fold reduction.
   */</span>
  public static &lt;<a title="Nothing" id="25831">A</a>, <a title="Nothing" id="25832">B</a>&gt; F&lt;List&lt;<a href="#25831" title="A">A</a>&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25832" title="B">B</a>&gt;&gt; <a title="[A, B](s: fj.control.parallel.Strategy[fj.Unit], f: fj.F[A,fj.F[B,B]], b: B)fj.F[fj.data.List[A],fj.control.parallel.Promise[B]]" id="25828">foldRight</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25890">s</a>, <span class="keyword">final</span> F&lt;<a href="#25831" title="A">A</a>, F&lt;<a href="#25832" title="B">B</a>, <a href="#25832" title="B">B</a>&gt;&gt; <a title="fj.F[A,fj.F[B,B]]" id="25891">f</a>, <span class="keyword">final</span> <a href="#25832" title="B">B</a> <a title="B" id="25892">b</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;List&lt;A&gt;, Promise&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> List&lt;A&gt; as<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> as.isEmpty<span class="delimiter">(</span><span class="delimiter">)</span> ? promise<span class="delimiter">(</span>s, p<span class="delimiter">(</span>b<span class="delimiter">)</span><span class="delimiter">)</span> : liftM2<span class="delimiter">(</span>f<span class="delimiter">)</span>.f<span class="delimiter">(</span>promise<span class="delimiter">(</span>s, P.p<span class="delimiter">(</span>as.head<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>
            join<span class="delimiter">(</span>s, P1.curry<span class="delimiter">(</span><span class="keyword">this</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>as.tail<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Performs a right-fold reduction across a Stream in constant stack space.
   *
   * @param s The strategy with which to fold the Stream.
   * @param f The function to apply on each element of the Stream.
   * @param b The beginning value to start the application from.
   * @return The final result after the right-fold reduction.
   */</span>
  public static &lt;<a title="Nothing" id="25836">A</a>, <a title="Nothing" id="25837">B</a>&gt; F&lt;Stream&lt;<a href="#25836" title="A">A</a>&gt;, <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#25837" title="B">B</a>&gt;&gt; <a title="[A, B](s: fj.control.parallel.Strategy[fj.Unit], f: fj.F[A,fj.F[fj.P1[B],B]], b: B)fj.F[fj.data.Stream[A],fj.control.parallel.Promise[B]]" id="25833">foldRightS</a><span class="delimiter">(</span><span class="keyword">final</span> <a href="Strategy.java.html#9975" title="fj.control.parallel.Strategy">Strategy</a>&lt;Unit&gt; <a title="fj.control.parallel.Strategy[fj.Unit]" id="25897">s</a>, <span class="keyword">final</span> F&lt;<a href="#25836" title="A">A</a>, F&lt;P1&lt;<a href="#25837" title="B">B</a>&gt;, <a href="#25837" title="B">B</a>&gt;&gt; <a title="fj.F[A,fj.F[fj.P1[B],B]]" id="25898">f</a>,
                                                           <span class="keyword">final</span> <a href="#25837" title="B">B</a> <a title="B" id="25899">b</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> <span class="keyword">new</span> F&lt;Stream&lt;A&gt;, Promise&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public Promise&lt;B&gt; f<span class="delimiter">(</span><span class="keyword">final</span> Stream&lt;A&gt; as<span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> as.isEmpty<span class="delimiter">(</span><span class="delimiter">)</span> ? promise<span class="delimiter">(</span>s, P.p<span class="delimiter">(</span>b<span class="delimiter">)</span><span class="delimiter">)</span> : liftM2<span class="delimiter">(</span>f<span class="delimiter">)</span>.f<span class="delimiter">(</span>promise<span class="delimiter">(</span>s, P.p<span class="delimiter">(</span>as.head<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.f<span class="delimiter">(</span>
            Promise.&lt;P1&lt;B&gt;&gt;join<span class="delimiter">(</span>s, <span class="keyword">new</span> P1&lt;Promise&lt;P1&lt;B&gt;&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              public Promise&lt;P1&lt;B&gt;&gt; _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> f<span class="delimiter">(</span>as.tail<span class="delimiter">(</span><span class="delimiter">)</span>._1<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>.fmap<span class="delimiter">(</span>P.&lt;B&gt;p1<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
              <span class="delimiter">}</span>
            <span class="delimiter">}</span><span class="delimiter">)</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Waits if necessary for the computation to complete, and then retrieves its result.
   *
   * @return The promised value.
   */</span>
  public <a href="#9952" title="A">A</a> <a title="()A" id="19772">claim</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      l.await<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>InterruptedException e<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> Error<span class="delimiter">(</span>e<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    <span class="keyword">return</span> v.some<span class="delimiter">(</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Waits if necessary for the computation to complete, and then retrieves its result.
   *
   * @param timeout the maximum time to wait
   * @param unit    the time unit of the timeout argument
   * @return The promised value, or none if the timeout was reached.
   */</span>
  public Option&lt;<a href="#9952" title="A">A</a>&gt; <a title="(timeout: Long, unit: java.util.concurrent.TimeUnit)fj.data.Option[A]" id="19773">claim</a><span class="delimiter">(</span><span class="keyword">final</span> long <a title="Long" id="25931">timeout</a>, <span class="keyword">final</span> TimeUnit <a title="java.util.concurrent.TimeUnit" id="25932">unit</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <span class="keyword">if</span> <span class="delimiter">(</span>l.await<span class="delimiter">(</span>timeout, unit<span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="keyword">return</span> v;
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>InterruptedException e<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">throw</span> <span class="keyword">new</span> Error<span class="delimiter">(</span>e<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    <span class="keyword">return</span> none<span class="delimiter">(</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns true if this promise has been fulfilled.
   *
   * @return true if this promise has been fulfilled.
   */</span>
  public boolean <a title="()Boolean" id="19774">isFulfilled</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> v.isSome<span class="delimiter">(</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Binds the given function across a promise of this promise (Comonad pattern).
   *
   * @param f A function to apply within a new promise of this promise.
   * @return A new promise of the result of applying the given function to this promise.
   */</span>
  public &lt;<a title="Nothing" id="19777">B</a>&gt; <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#19777" title="B">B</a>&gt; <a title="[B](f: fj.F[fj.control.parallel.Promise[A],B])fj.control.parallel.Promise[B]" id="19775">cobind</a><span class="delimiter">(</span><span class="keyword">final</span> F&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#9952" title="A">A</a>&gt;, <a href="#19777" title="B">B</a>&gt; <a title="fj.F[fj.control.parallel.Promise[A],B]" id="25988">f</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> promise<span class="delimiter">(</span>s, <span class="keyword">new</span> P1&lt;B&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      public B _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> f.f<span class="delimiter">(</span>Promise.<span class="keyword">this</span><span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Duplicates this promise to a promise of itself (Comonad pattern).
   *
   * @return a promise of this promise.
   */</span>
  public <a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#9952" title="A">A</a>&gt;&gt; <a title="()fj.control.parallel.Promise[fj.control.parallel.Promise[A]]" id="19778">cojoin</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">final</span> F&lt;Promise&lt;A&gt;, Promise&lt;A&gt;&gt; id = identity<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="keyword">return</span> cobind<span class="delimiter">(</span>id<span class="delimiter">)</span>;
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Applies a stream of comonadic functions to this promise, returning a stream of values.
   *
   * @param fs A stream of functions to apply to this promise.
   * @return A stream of the results of applying the given stream of functions to this promise.
   */</span>
  public &lt;<a title="Nothing" id="19781">B</a>&gt; Stream&lt;<a href="#19781" title="B">B</a>&gt; <a title="[B](fs: fj.data.Stream[fj.F[fj.control.parallel.Promise[A],B]])fj.data.Stream[B]" id="19779">sequenceW</a><span class="delimiter">(</span><span class="keyword">final</span> Stream&lt;F&lt;<a href="#9951" title="fj.control.parallel.Promise">Promise</a>&lt;<a href="#9952" title="A">A</a>&gt;, <a href="#19781" title="B">B</a>&gt;&gt; <a title="fj.data.Stream[fj.F[fj.control.parallel.Promise[A],B]]" id="25990">fs</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">return</span> fs.isEmpty<span class="delimiter">(</span><span class="delimiter">)</span>
           ? Stream.&lt;B&gt;nil<span class="delimiter">(</span><span class="delimiter">)</span>
           : Stream.cons<span class="delimiter">(</span>fs.head<span class="delimiter">(</span><span class="delimiter">)</span>.f<span class="delimiter">(</span><span class="keyword">this</span><span class="delimiter">)</span>, <span class="keyword">new</span> P1&lt;Stream&lt;B&gt;&gt;<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
             public Stream&lt;B&gt; _1<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
               <span class="keyword">return</span> sequenceW<span class="delimiter">(</span>fs.tail<span class="delimiter">(</span><span class="delimiter">)</span>._1<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
             <span class="delimiter">}</span>
           <span class="delimiter">}</span><span class="delimiter">)</span>;
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>